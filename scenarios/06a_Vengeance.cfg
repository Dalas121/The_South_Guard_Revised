#textdomain wesnoth-tsg

#define TURN_LIMIT
20#enddef

[scenario]
    id=06a_Vengeance
    map_file=06a_Vengeance.map
    name= _ "Vengeance"
    next_scenario=06x_Epilogue
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER}
    
    {DEFAULT_SCHEDULE}
    turns={TURN_LIMIT}
    
    {SCENARIO_MUSIC nunc_dimittis.ogg}
    {EXTRA_SCENARIO_MUSIC heroes_rite.ogg}
    
    {SG_LONGMARCH}
    {TSG_BIGMAP {JOURNEY_06a_NEW} }
    
    
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=good
        user_team_name=_"South Guard"
        gold=30
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
    [/side]
    
    #############################
    # TOWN GUARD
    #############################
    [side]
        side,controller,color=2,ai,wesred
        gold,income=15,{ON_DIFFICULTY 1 4 7}
        recruit=
        team_name=good
        user_team_name=_"Westin"
        no_leader=yes
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Spearman" {ON_DIFFICULTY 2 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Peasant"  {ON_DIFFICULTY 1 1 1}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Woodsman" {ON_DIFFICULTY 1 2 2}}
#define MAIN_AVOID_AREA
    x=0-23,  24,  24, 25,  25, 26,  26, 27,  27, 28, 28,   28, 29,  29,   30,   31,   32,   33
    y=0-99, 0-4,6-99,0-4,7-99,0-3,6-99,0-5,7-99,0-4,7-9,11-99,0-5,8-99,12-99,10-99,10-99,11-99
#enddef
    [event]
        name=side 2 turn refresh
        first_time_only=no
        {RESET_SIDE_AI 2 no -1 1}
        {MODIFY_SIDE_AI 2 ([avoid]
            {MAIN_AVOID_AREA}
        [/avoid])}
        
        # prevent our crucial units from getting themselves killed
        {MODIFY_UNIT side,id=2,Mari moves 0}
        {MODIFY_UNIT side,id=2,"Sir Gerrick" moves 0}
        {MODIFY_UNIT side,id=2,"Minister Hylas" moves 0}
        {MODIFY_UNIT side,id=2,Asheviere moves 0}
        
        # if we have units out of the main area, use a MAI to have them retreat
        [micro_ai]
            side,action,ai_type=2,add,coward
            {FILTER( {FILTER_LOCATION {MAIN_AVOID_AREA}} )}
            distance,attack_if_trapped=20,yes
            seek_x,seek_y=31,7
        [/micro_ai]
        
        # if the player is being aggressive (and we have extra soldiers) we should help out
        [if]{HAVE_UNIT( side,count=2,5-999 )}
            {HAVE_UNIT( side,count=1,3-999 {FILTER_LOCATION( x,y,radius=14,9,6 {OR x,y,radius=1,9,11} )} )}
            [then]
                [micro_ai]
                    side,action,ai_type=2,delete,coward
                [/micro_ai]
                {RESET_SIDE_AI 2 offensive 0.4 0.25}
                {MODIFY_SIDE_AI 2 ([avoid]
                    x=0-10,  11,  11, 12,  12, 13,   13, 14,   14, 15,   15, 16,   16, 17,   17, 18,   18, 19,   19, 20,   20, 21-99
                    y=0-99, 0-6,8-99,0-6,9-99,0-5,10-99,0-3,12-99,0-5,13-99,0-7,14-99,0-7,15-99,0-8,15-99,0-7,18-99,0-7,17-99, 19-99
                [/avoid])}
            [/then]
        [/if]
    [/event]
    
    #############################
    # ELVES
    #############################
    [side]
        side,controller,color=3,ai,green
        type,facing=Elvish Captain,ne
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_STRONG}
        [/modifications]
        gold,income={ON_DIFFICULTY 15 30 45},{ON_DIFFICULTY 0 2 4}
        recruit=Elvish Fighter
        team_name,user_team_name=elves,_"Aethenwood"
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Elvish Archer" ({ON_DIFFICULTY 0 1 1})}
    [side]
        side,controller,color=4,ai,green
        type,facing=Elvish Hero,ne
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
        gold,income={ON_DIFFICULTY 15 30 45},{ON_DIFFICULTY 0 2 4}
        recruit=Elvish Fighter
        team_name,user_team_name=elves,_"Aethenwood"
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Elvish Archer" ({ON_DIFFICULTY 1 1 2})}
    [side]
        side,controller,color=5,ai,green
        type,facing=Elvish Sorceress,ne
        [modifications]
            {TRAIT_QUICK}
            {TRAIT_STRONG}
        [/modifications]
        gold,income={ON_DIFFICULTY 15 30 45},{ON_DIFFICULTY 0 2 4}
        recruit=Elvish Shaman
        team_name,user_team_name=elves,_"Aethenwood"
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Elvish Fighter" ({ON_DIFFICULTY 0 1 2})}
    [event]
        name=side 3 turn
        first_time_only=no
        {RESET_SIDE_AI 3,4,5 offensive 0.4 0.25}
        {MODIFY_SIDE_AI 3,4,5 retreat_factor=0.75}
        {VARY_AI_BY_SCHEDULE 3,4,5}
        {MODIFY_SIDE_AI 3,4,5 ({GOAL_LOCATION 9 x,y=31,7})}
    [/event]
    
    # Ethiliel
    [side]
        side=6
        color=green
        controller=ai
        team_name=elves
        no_leader,hidden=yes,yes
        gold,income=0,-2
    [/side]
    [event]
        name=side 6 turn refresh
        first_time_only=no
        {RESET_SIDE_AI 6 no 0.4 0.25}
        {MODIFY_UNIT id=Ethiliel moves 3} # enough to reach a village if she needs healing
        {MODIFY_SIDE_AI 6 ({GOAL_LOCATION 99 x,y=4,6})}
        {MODIFY_AI_DELETE_CANDIDATE_ACTION 6 main_loop move_leader_to_keep}
    [/event]
    
    
    
    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        
        #############################
        # WESTIN SCENERY
        #############################
        [item]
            halo="units/statue-westin.png~FL()"
            x,y=31,9
        [/item]
        {PLACE_IMAGE halo/stairway.png 31 7}
        
        {PLACE_IMAGE scenery/temple1.png 28 5}
        {PLACE_IMAGE scenery/tent-fancy-red.png 24 13}
        {PLACE_IMAGE scenery/tent-shop-weapons.png 25 14}
        
        {PLACE_IMAGE items/archery-target-right.png 16 12}
        {PLACE_IMAGE items/archery-target-right.png 17 12}
        
        {BRAZIER_ILLUMINATION 26 8}
        {BRAZIER_ILLUMINATION 30 9}
        {BRAZIER_ILLUMINATION 25 13}
        
        #############################
        # ELVES
        #############################
        [unstore_unit]
            variable=stored_ethiliel
            x,y=4,9
        [/unstore_unit]
        {MODIFY_UNIT id=Ethiliel facing se}
        {MODIFY_UNIT id=Ethiliel side 6}
        {GENERIC_UNITC 3 (Elvish Druid  )  13  9  ({ZONE_GUARDIAN 13  9 x,y,radius=13,10,4})}
        {GENERIC_UNITC 3 (Elvish Fighter)  16  8  ({ZONE_GUARDIAN 16  8 x,y,radius=13,10,4})}
        {GENERIC_UNITC 4 (Elvish Archer )   3 16  ({ZONE_GUARDIAN  3 16 x,y,radius=1,12,7})}
        {GENERIC_UNITC 4 (Elvish Archer )   1 17  ({ZONE_GUARDIAN  1 17 x,y,radius=1,12,7})}
        {GENERIC_UNITC 4 (Elvish Fighter)   2 14  ({ZONE_GUARDIAN  2 14 x,y,radius=1,12,7})}
        {GENERIC_UNITC 5 (Elvish Fighter)   4  6  ({ZONE_GUARDIAN  4  6 x,y,radius=1,7,10})}
        {GENERIC_UNITC 5 (Elvish Fighter)   1  6  ({ZONE_GUARDIAN  1  6 x,y,radius=1,7,10})}
        {GENERIC_UNITC 5 (Elvish Archer )   4  3  ({ZONE_GUARDIAN  4  3 x,y,radius=1,7,10})}
        {GENERIC_UNITC 5 (Elvish Archer )   3  3  ({ZONE_GUARDIAN  3  3 x,y,radius=1,7,10})}
        
        # archers are good against Deoran. These guys are here to hinder him if he tries to run straight in
        {GENERIC_UNITC 3 ({ON_DIFFICULTY "none" "Elvish Archer" "Elvish Archer"})  22 15   ({ZONE_GUARDIAN 22 15 x,y,radius=23,16,7})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY "none" "Elvish Archer" "Elvish Archer"})  19 17   ({ZONE_GUARDIAN 19 17 x,y,radius=23,16,7})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY "none" "none"          "Elvish Archer"})  23 17   ({ZONE_GUARDIAN 23 17 x,y,radius=23,16,7})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY "none" "none"          "Elvish Archer"})  25 15   ({ZONE_GUARDIAN 25 15 x,y,radius=23,16,7})}
        
        #############################
        # HEROES
        #############################
        [unit]
            side,x,y=2,1,1
            {SINGLEUNITWML_HYLAS}
        [/unit]
        [unit]
            side,x,y=2,1,1
            {SINGLEUNITWML_GERRICK}
        [/unit]
        [unit]
            side,x,y=2,1,1
            {SINGLEUNITWML_MARI}
        [/unit]
        {MODIFY_UNIT id="Minister Hylas","Sir Gerrick",Mari facing sw}
        {KILL side,id=2,$companion_id} # our companion is still on our recall list
        [if] {HAVE_UNIT side,id=2,"Minister Hylas"}
            [then]
                {MODIFY_UNIT   side,id=2,"Minister Hylas" canrecruit yes}
                {TELEPORT_UNIT side,id=2,"Minister Hylas" 32 8}
                
                {TELEPORT_UNIT side,id=2,Mari             30 7}
                {TELEPORT_UNIT side,id=2,"Sir Gerrick"    30 7}
            [/then]
            [else]
                {MODIFY_UNIT   side,id=2,"Sir Gerrick"    canrecruit yes}
                {TELEPORT_UNIT side,id=2,"Sir Gerrick"    32 8}
                
                {TELEPORT_UNIT side,id=2,Mari             30 7}
                {TELEPORT_UNIT side,id=2,"Minister Hylas" 30 7}
            [/else]
        [/if]
        [capture_village]
            side,x,y=2,23-99,0-15
        [/capture_village]
        
        [unit]
            side,x,y,facing=2,30,6,sw
            {SINGLEUNITWML_ASHEVIERE}
        [/unit]
        
        #############################
        # TOWN GUARDS
        #############################
        {GENERIC_UNITC 2 Spearman  24  5  ({ZONE_GUARDIAN 24  5 x,y,radius=24,5,1})}
        {GENERIC_UNITC 2 Spearman  28 10  ({ZONE_GUARDIAN 28 10 x,y,radius=28,10,1})}
        {GENERIC_UNITC 2 Peasant   28  6  ()}
        {GENERIC_UNITC 2 Woodsman  33  4  ()}
        {GENERIC_UNITC 2 Peasant   30  8  ()}
        
#define TOWNSFOLK X Y IMAGE ROLENAME
        {GENERIC_UNIT 2 (Townsfolk) {X} {Y}} {ROLE {ROLENAME}}
        [object]
            {FILTER x,y={X},{Y}}
            [effect]
                apply_to=image_mod
                add="O(0)~CROP(0,0,72,72)~BLIT(units/townsfolk/{IMAGE})"
            [/effect]
        [/object]
#enddef
        {TOWNSFOLK 29 9 scribe.png        town1}
        {TOWNSFOLK 32 5 madame.png        town2}
        {TOWNSFOLK 31 8 worker+female.png town3}
        
        {SCROLL_TO 32 8}
    [/event]

    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        #############################
        # GETTING TOWNSFOLK TO SAFETY 
        #############################
        {DELAY 500}
        {MOVE_UNIT role=town1 31 7} {KILL role=town1} {DELAY 100}
        {MOVE_UNIT role=town2 31 7} {KILL role=town2} {DELAY 100}
        {MOVE_UNIT role=town3 31 7} {KILL role=town3} {DELAY 100}
        {MOVE_UNIT id=Asheviere 31 7} {MODIFY_UNIT id=Asheviere facing sw}
        {SAY_IF_HAVE
            "Sir Gerrick" "C‘mon, keep movin‘, everyone get underground. We don‘ have much time left ‘til—"
            Mari          "Could you go any slower? Come on, everyone get underground. We don‘t have much time left until—"
        }
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "This is your last warning, humans. Return to us our sage or I shall be forced to resume our attack!"
        [/message]
        
        #############################
        # DEORAN ARRIVES 
        #############################
        {SCROLL_TO               9 30} {DELAY 500}
        {RECALL_XY Deoran        9 30} {DELAY 500}
        {RECALL_XY $companion_id 8 30} {DELAY 500}
        [message]
            speaker,image=Deoran,portraits/deoran-mad.webp
            message= _ "Ethiliel! What‘s going on here? What have you done?!"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "Deoran — good, you‘re here. And even better, I see you no longer shelter that snake Afalas! Does this mean you humans have reconsidered your decisions, and have finally freed Mebrin from his bonds?"
        [/message]
        [message]
            speaker,image=Deoran,portraits/deoran-mad.webp
            message= _ "Mebrin is dead, Ethiliel. Afalas was right. I saw the lich Mal M’Brin with my own two eyes, heard his ravings with my own two ears! I watched him raise the dead up out of the ground!"
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "Then where is his corpse, mayfly? Where is the evidence for the horrible things of which you accuse? I have known Mebrin my whole life — you, scarely four months. Who shall I believe?"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "No, I felt Mebrin‘s elfin presence. I felt him reaching out to me, I felt him in pain! No elf would fall to undeath, much less our wisest teacher."
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "I don‘t know why you won‘t just admit what you‘ve truly done with him — you fool humans‘ stubbornness will be all of your undoing! Until you return Mebrin to us I have no choice but to cut you down!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Ethiliel, listen to yourself! ...there‘s no reasoning with her, is there?"
        [/message]
        
        #############################
        # DISCUSSING WHAT TO DO 
        #############################
        {MOVE_UNIT id=Deoran 10 28} {DELAY 150}
        {MOVE_UNIT id=$companion_id 8 29}
        {MODIFY_TERRAIN Ke 10 28} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Ce  9 28} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Ce 10 27} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Ce 11 28} [redraw][/redraw] {DELAY 150}
        
        [message]
            speaker=Deoran
            message= _ "Whether this rage is Ethiliel herself, Mebrin‘s dark influence, or a mix of both, it‘s clear that words alone are not going to change her mind."
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"Guess it‘s time to take her down, then? Not my favorite plan, but what‘s one little elf after an entire undead lich?"
            MESSAGE_GERRICK=_"Time t‘ take her down by force? Shame to break a pretty face, but nothin‘ can be as bad as tha‘ lich."
            MESSAGE_HYLAS=_"Then it seems our only option is the violent one. This is not my preferred course of action, but I will do what I must."
        }
        [message]
            speaker=Deoran
            message= _ "No, absolutely not. I‘ve spent enough time with Ethiliel to understand her and her home. If we kill an elf of this importance in offensive action, never again in our lifetimes will there be peace between Wesnoth and the Aethenwood."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Instead we make for Westin. We rendezvous with the town defenders and hold the walls — the self-righteous fury that drives Ethiliel can only burn for so long. Once the dust settles, the elves may finally be willing to talk."
        [/message]
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            side=1
            [objective]
                description= _ "Reach Westin, then survive until turns run out"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Deoran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Asheviere"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Ethiliel"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
        [/objectives]
    [/event]
    
    #############################
    # MAYFLIES
    #############################
    [event]
        name=attack
        {FILTER side=3,4,5}
        [message]
            speaker=unit
            message= _ "You mayflies should never have interfered in our affairs. Now all your kind shall pay the price."
        [/message]
    [/event]
    
    #############################
    # REFUND ELVISH GOLD
    #############################
    [event]
        name=last breath
        {FILTER side=3,4,5}
        [message]
            speaker=unit
            message= _ "My kin will avenge me! For every one of us you strike down... more will come..."
        [/message]
        [event]
            name=die
            {DELAY 250}
            [message]
                speaker=Deoran
                message= _ "Every elf who dies only serves to further enrage the rest, drawing more warriors out of the Aethenwood!"
            [/message]
        [/event]
    [/event]
    [event]
        name=die
        first_time_only=no
        {FILTER side=3,4,5}
        [gold]
            side,amount=$unit.side,$unit.cost
        [/gold]
        [floating_text]
            x,y=$unit.x,$unit.y
            text= _ "<span color='#FFD700' size='x-small'>$unit.cost gold refunded</span>"
        [/floating_text]
    [/event]
#define TRANSFER_DEAD_LEADER_GOLD DEAD_SIDE LIVE_SIDE
    [event]
        name=new turn
        first_time_only=no
        {FILTER_CONDITION( {NOT({HAVE_UNIT side,canrecruit=3,yes})} )}
        [store_gold]
            side={DEAD_SIDE}
        [/store_gold]
        [gold]
            side,amount={LIVE_SIDE},$gold
        [/gold]
        [modify_side]
            side,gold={DEAD_SIDE},0
        [/modify_side]
        {CLEAR_VARIABLE gold}
    [/event]
#enddef
    {TRANSFER_DEAD_LEADER_GOLD 3 4}
    {TRANSFER_DEAD_LEADER_GOLD 4 5}
    {TRANSFER_DEAD_LEADER_GOLD 5 3}
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                DEORAN REACHES WESTIN
    #######################################################################################################################################################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION( radius=2 {FILTER side=2} )} )}
        
        #############################
        # RE-INTRODUCTIONS
        #############################
        {SAY_IF_HAVE
            "Sir Gerrick" (_"Look out, more elves at the perimeter! No, wait... it‘s sir Deoran. He‘s alive!")
            "Minister Hylas" (_"Take care! More elves approach our ramparts. No, wait... ‘tis commander Deoran. He yet lives!")
            SIDE=2
        }
        [message]
            speaker=Deoran
            message= _ "Hail, friends! I am relieved to see the town walls still standing, but I am sorry to confess that this whole problem with the elves is rather my doing. The full story is too long to speak of now."
        [/message]
        {SAY_IF_HAVE
            "Mari" (_"Figures this‘d all be the rookie‘s fault. While you‘ve been running around causing problems, we‘ve been trying to actually keep the town safe.")
            "Minister Hylas" (_"The elves demand that we produce someone called “Mebrin” — I take it you know who that is? In his absence, we have instead focused our efforts on protecting the townsfolk.")
            SIDE=2
        }
        {SAY_IF_HAVE
            "Sir Gerrick" (_"Aye, I‘ve got most o‘ the civilians safe underground in th‘ cellars, with magistrate Fiore‘s daughter watchin‘ the entrance. Lucky for us Fiore himself ‘aint here to see this mess.")
            "Minister Hylas" (_"Indeed, most of the civilians are now safely underground in the cellars. Magistrate Fiore‘s daughter wanted to watch the entrance — probably trying to get herself killed so she doesn‘t have to get married and rule over our sorry behinds.")
            SIDE=2
        }
        [message]
            speaker=Asheviere
            message= _ "I‘ve never had this much freedom before. Only in times of crisis, it should seem..."
        [/message]
        {SAY_IF_HAVE
            "Minister Hylas" (_"Deoran, you have the most experience dealing with these elves, and a more complete understanding of the situation than I. If you wish to command the defense, our soldiers are at your service.")
            "Sir Gerrick" (_"Deoran, sounds like you‘ve got the most experience dealin‘ with these elves, an‘ a better idea o‘ what‘s really goin‘ on. If you want to take charge, my boys‘re yours to command.")
            SIDE=2
        }
        
        #############################
        # CHOICE
        #############################
        [message]
            speaker=Deoran
            [option]
                label= _ "Assume command of Westin‘s defense"
                [command]
                    [capture_village]
                            owner_side,side=2,1
                    [/capture_village]
                    {MODIFY_UNIT side,canrecruit=2,yes canrecruit no}
                    {MODIFY_UNIT (side=2 {NOT id=Asheviere}) side 1}
                    [heal_unit]
                        {FILTER side=1}
                        amount=0
                        moves=full
                        restore_attacks=yes
                    [/heal_unit]
                    
                    [message]
                        speaker=Deoran
                        message= _ "I shall assume command, my friend. Now hold fast, men of the South Guard! No matter how daunting the armies that oppose us, we must weather this shadow and defend our homes!"
                    [/message]
                [/command]
            [/option]
            [option]
                label= _ "Leave Westin‘s defenders under AI control"
                [command] # leaving this as an option. 1) new players may prefer to let the AI help out, and 2) the AI gets 3/6/9 base income, which can be meaningful on higher difficulties
                    [message]
                        speaker=Deoran
                        message= _ "Command of Westin remains yours, my friend. Hold fast, men of the South Guard! No matter how daunting the armies that oppose us, we must weather this shadow and defend our homes!"
                    [/message]
                [/command]
            [/option]
        [/message]
        
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            side=1
            [objective]
                description= _ "Survive until turns run out"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Deoran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Asheviere"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Ethiliel"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
        [/objectives]
        
        #############################
        # FLAVOR
        #############################
        [event]
            name=new turn
            [event]
                name=new turn
                [event]
                    name=new turn
                    [message]
                        speaker=Deoran
                        message= _ "I curse our isolation, so far removed from the great cities of the north. The capitol garrison alone would make Westin‘s walls impenetrable, if only they could have been contacted in time!"
                    [/message]
                    # it's possible but unlikely that both Hylas and Gerrick are dead here
                    {SAY_IF_HAVE
                        Mari _"That‘s assuming Weldyn would even bother to help out a podunk like this. Capitol of the southern province, sure, but that‘s not saying much. Without magistrate Fiore‘s capitol connections, I doubt anybody — you and I included — would much care what happened here."
                        "Minister Hylas" "Even then, Westin is small and inaccessible, and thus easy for others to overlook. Magistrate Fiore‘s political connections are the better part of the reason we have any significance at all — as well as the reason you were deployed here, Deoran."
                    }
                    {SAY_IF_HAVE
                        "Sir Gerrick" "O‘ course, without them connections Fiore wouldn‘t‘ve needed to leave for Weldyn last month, an‘ then we might‘ve still had ‘is escort here t‘ help fight... "
                        Mari "Of course, without those political connections the magistrate wouldn‘t have had to leave for Weldyn last month, and we would‘ve still had his escort here to help fight..."
                    }
                [/event]
            [/event]
        [/event]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                 VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # ETHILIEL DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Ethiliel}
        [message]
            speaker=Ethiliel
            message = _"Mebrin, I’m sorry... I tried..."
        [/message]
        [event]
            name=die
            [message]
                speaker=Deoran
                message = _"Ethiliel is dead! Even if we win by force of arms today, there will never again be peace between Wesnoth and the Aethenwood..."
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
    [/event]
    
    
    #############################
    # TIME OVER
    #############################
    [event]
        name=side 1 turn {TURN_LIMIT} end
        
        #############################
        # AFALAS ARRIVES
        #############################
        {SCROLL_TO 1 12} {DELAY 250}
        {NAMED_UNIT 6 (Elvish Marshal) 1 12 Ithelden  _"Ithelden" ()} {FACING ne} {ANIMATE}
        [+unit]
            canrecruit=yes
            profile=portraits/ithelden.webp
        [/unit]
        {MOVE_UNIT id=Ithelden 2 11}
        {DELAY 250}
        [unstore_unit]
            variable=stored_afalas
            x,y,animate=1,11,yes
        [/unstore_unit]
        {MODIFY_UNIT id=Afalas facing ne}
        {MODIFY_UNIT id=Ethiliel facing sw}
        {DELAY 250}
        
        [message]
            speaker=Ithelden
            message = _"Ethiliel! What in the world is going on here? "
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message = _"These snakes have captured Mebrin, and committed who knows what horrible atrocities against him! Ithelden, we must take him back!"
        [/message]
        [message]
            speaker=Ithelden
            message = _"Kidnapped Mebrin? I have heard otherwise. Ethiliel, this is Urza Afalas of the humans."
        [/message]
        {MOVE_UNIT id=Ethiliel 2 10}
        [message]
            speaker=Ethiliel
            message = _"We‘ve met. This absolute scum, pig of a human—"
        [/message]
        [harm_unit]
            {FILTER id=Ethiliel}
            {FILTER_SECOND id=Afalas}
            [primary_attack]
                name=ensnare
            [/primary_attack]
            amount,type,hits=6,impact,yes
            animate,delay=yes,0
        [/harm_unit]
        {MODIFY_UNIT id=Afalas status.slowed yes}
        [message]
            speaker=Afalas
            message = _"Hey! Hands off, lady! I try to make things right, come back t‘ try an‘ explain, an‘ this be what I get? Trussed up in vines an‘ called names by some—"
        [/message]
        
        #############################
        # EXPLAINING MEBRIN
        #############################
        [message]
            speaker=Ithelden
            message = _"What Urza Afalas <i><b>means</b></i> to say, is that I can corroborate the humans‘ story. Some weeks ago, this outlaw came to me with unlikely words."
        [/message]
        [message]
            speaker=Afalas
            message = _"...yeah, I did. I heard them rangers in the forest southways, knew they‘d be wantin‘ my head. I could‘a ran an‘ hid, but I wanted to make things right. I went back t‘ where we fought Mebrin, then t‘ the Aethenwood."
        [/message]
        [message]
            speaker=Afalas
            message = _"You may think us men t‘ all be criminals an‘ outlaws, but we‘re still human bei— err, livin‘ beings, and we still know justice an‘ truth. I may‘ve also been feelin‘ a touch guilty, Mebrin bein‘ partly my fault an‘ all."
        [/message]
        [message]
            speaker=Ithelden
            message = _"Afalas‘ words could have seen him imprisoned, or worse, but at the height of my anger he produced the skull of a lich. I would recognize Mebrin‘s bones anywhere, Ethiliel."
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message = _"The Mebrin I know is so gentle. So wise! It cannot be... can it?"
        [/message]
        [message]
            speaker=Ethiliel
            message = _"I did not want to believe the humans‘ words. I could not bear to believe... But if Mebrin really did turn to undeath, then I have been the cause of so much meaningless bloodshed."
        [/message]
        [message]
            speaker=Ethiliel
            message = _"It‘s true, isn‘t it..."
        [/message]
        [message]
            speaker=Ethiliel
            message = _"..."
        [/message]
        {DELAY 250}
        {MOVE_UNIT id=Ethiliel 3 10}
        {DELAY 250}
        {MODIFY_UNIT id=Ethiliel facing sw}
        
        #############################
        # ETHILIEL APOLOGIZES
        #############################
        [message]
            speaker=Ethiliel
            message = _"Urza Afalas, thank you. I see now that not all humans are alike, and that you, too, are capable of courage and loyalty. Vengeance only begets more vengeance. You — and your brothers, posthumously — are forgiven."
        [/message]
        [message]
            speaker=Afalas
            message = _"<i>You</i> forgive <i>me</i>! After all the blood—"
        [/message]
        [message]
            speaker=Ithelden
            message = _"And Urza Afalas graciously accepts your forgiveness. Now come, Ethiliel. You have been away from home for far too long."
        [/message]
        
        {VARIABLE epilogue elves}
        [endlevel]
            result=victory
            carryover_report,linger_mode=no,no
        [/endlevel]
    [/event]
    
[/scenario]



