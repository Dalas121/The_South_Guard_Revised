#textdomain wesnoth-tsg

#define TURN_LIMIT
35#enddef
#define TURN_WARNING
30#enddef

[scenario]
    id=04_Blight
    map_file=04_Blight.map
    name= _ "Blight"
    next_scenario=04_Blight
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER}
    
    {DEFAULT_SCHEDULE_AFTERNOON}
    turns=15
    
    {SCENARIO_MUSIC the_deep_path.ogg}
    {EXTRA_SCENARIO_MUSIC suspense.ogg}
    {EXTRA_SCENARIO_MUSIC northerners.ogg}
    {EXTRA_SCENARIO_MUSIC heroes_rite.ogg}
    
    {SG_BLIGHT}
    {TSG_BIGMAP {JOURNEY_04_NEW} }
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=good
        user_team_name=_"South Guard"
        gold=50
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
        fog,shroud=yes,yes
    [/side]
    {STARTING_VILLAGES 1 5}
    
    #############################
    # BANDITS
    #############################
    # wmllint: local spelling Afalas
    [side]
        side=2
        color=blue
        controller=ai
        type=Outlaw
        id=Afalas
        name= _ "Urza Afalas"
        profile=portraits/urza-afalas-masked.webp
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_STRONG}
        [/modifications]
        facing=se
        team_name=bandits
        user_team_name=_"Urza Afalas"
        gold,income=20,6 # enough that he's at no risk of dying to the zombies
        recruit=Poacher
        fog,shroud=yes,yes
        {FLAG_VARIANT6 ragged}
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Thug" {ON_DIFFICULTY 2 3 4}} # 1 thug guard on all difficulties
    {SILENTLY_LIMIT_LEADER_MOVES 2 1}
    {STARTING_VILLAGES 2 5}
    [event]
        name=side 2 turn # this gets overwritten later when we meet Afalas
        first_time_only=no
        {RESET_SIDE_AI 2 defensive 0.4 0.25}
        {MODIFY_SIDE_AI 2 ({GOAL_SEEK_SIDE 99 4,5 0})} # don't go near side 3 zombies, because we'll be likely to fight the player
        {MODIFY_SIDE_AI 2 ([avoid]
            x,y,radius=30,19,5
        [/avoid])}
    [/event]
    
    #############################
    # UNDEAD
    #############################
#define UNDEAD_SIDE SIDE NAME INITIAL_GOLD
    [side]
        side={SIDE}
        color=black
        controller=ai
        type=Ghoul
        id={NAME}
        name=_"{NAME}"
        team_name=undead
        user_team_name=_"Undead"
        gold,income={INITIAL_GOLD},{ON_DIFFICULTY -1 1 3}
        recruit=Walking Corpse
        {FLAG_VARIANT undead}
    [/side]
    {STARTING_VILLAGES {SIDE} 5}
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 1}
#enddef
    {UNDEAD_SIDE 3 _"Gruth" {ON_DIFFICULTY 20 40 60}}
    {UNDEAD_SIDE 4 _"Gerd"  20}
    {UNDEAD_SIDE 5 _"Gral"  20}
    {UNDEAD_SIDE 6 _"Grish" 20}
    [event]
        name=side 3 turn
        first_time_only=no
        {RESET_SIDE_AI 3,4,5,6 offensive 0.9 0.1}
        {VARY_AI_BY_SCHEDULE_ENEMY 3,4,5,6 1,2}
        {MODIFY_SIDE_AI 3,4,5,6 retreat_factor=0}
        {MODIFY_SIDE_AI 3,4,6 ({GOAL_SEEK_SIDE 99 1 0})} # not side 5, or they'll bypass afalas
    [/event]
    
    [side]
        side=7
        controller=null
        hidden,no_leader=yes,yes
        team_name=undead,bandits
    [/side]
    
    
    
    
    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
#define SOUTH_GUARD_LOCS
    x=17-22,   23, 24-25
    y= 5-12, 6-18,  6-12
    {NOT terrain=Wo*^*}
#enddef
#define NORTH_GUARD_LOCS
    x=21-25,   26, 27-30
    y= 6-11, 6-11,  7-10
    {NOT terrain=Wo*^*}
#enddef
    [event]
        name=prestart
        
        #############################
        # BANDIT GUARDS
        #############################
        {GENERIC_UNITC 2 ({ON_DIFFICULTY none    Poacher Poacher}) 18 11  ({ZONE_GUARDIAN 18 11 {SOUTH_GUARD_LOCS}})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY Thug    Thug    Thug   }) 23 12  ({ZONE_GUARDIAN 23 12 {SOUTH_GUARD_LOCS}})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY Poacher Poacher Poacher}) 29  8  ({ZONE_GUARDIAN 29  8 {NORTH_GUARD_LOCS}})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY none    none    Poacher}) 26  7  ({ZONE_GUARDIAN 26  7 {NORTH_GUARD_LOCS}})}
        
        #############################
        # UNDEAD GUARDS
        #############################
        {GENERIC_UNITC 3 ({ON_DIFFICULTY none "Walking Corpse" "Walking Corpse"})   8 14  ({ZONE_GUARDIAN  8 14 x,y,radius=8,17,4})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY none none             "Walking Corpse"})  12 15  ({ZONE_GUARDIAN 12 15 x,y,radius=12,17,4})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY none "Walking Corpse" "Walking Corpse"})  36 14  ({ZONE_GUARDIAN 36 14 x,y,radius=39,14,4})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY none none             "Walking Corpse"})  33 12  ({ZONE_GUARDIAN 33 12 x,y,radius=33,12,1})}
        
        [remove_shroud]
            side,x,y,radius=1,4,4,6
        [/remove_shroud]
        {SCROLL_TO 3 1}
    [/event]
    
    #######################################################################################################################################################
    #                                                                     PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        #############################
        # DISCUSSING THE SITUATION
        #############################
        {DELAY 500}
        {RECALL_XY Deoran 4 4}
        {MODIFY_UNIT id=Deoran facing se}
        [redraw]{BR}side=1{BR}[/redraw]
        {DELAY 500}
        {RECALL_XY Ethiliel 5 3}
        {MODIFY_UNIT id=Ethiliel facing se}
        [redraw]{BR}side=1{BR}[/redraw]
        {DELAY 500}
        {RECALL_XY $companion_id 3 5}
        {MODIFY_UNIT id=$companion_id facing se}
        [redraw]{BR}side=1{BR}[/redraw]
        
        [message]
            speaker=Deoran
            message= _ "It’s so cold here! And this fog is so thick. This is quite a change from fighting bandits in the farmlands near Westin!"
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"This cannot be natural. Black Forest, this place is called? I see where it gets its name..."
            MESSAGE_GERRICK=_"Mus’ be black magic, sir. I’ve fought on many a dark and foggy night, but ne’er seen anything like this."
            MESSAGE_HYLAS=_"Dark magic — an apt name, in this case. It would take a powerful spell indeed to shadow such an expanse."
        }
        [message]
            speaker=Ethiliel
            message= _ "Before us lies the Black River — and too Mebrin, if he yet lives. And he must live, surely! I feel wisps of his magic reaching out to me from nearby..."
        [/message]
        [message]
            speaker=Deoran
            message= _ "With the three elder Urza brothers defeated, only the youngest remains to oppose us. Mebrin must be his captive, and these woods must be filled with bandits and undead."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Dangerous though the task may be, I promise to help rescue your sage, Ethiliel."
        [/message]
        {DELAY 500}
        
        #############################
        # NEW RECRUITS
        #############################
        {SAY_COMPANION
            MESSAGE_MARI=_"Rookie, you’re in luck. Despite looking like sacks of flour, some of our soldiers are suprisingly nimble. I’ve been training them during our march south — from now on, in addition to Spearmen and Bowmen you’ll also be able to recruit <b><i>Fencers</i></b>."
            MESSAGE_GERRICK=_"Deoran, we’ve got some brawny lads among us, an’ on the march I’ve been training ’em in heavy armor. From ’ere on out, in addition to Spearmen and Bowmen you’ll also be able to recruit <b><i>Heavy Infantrymen</i></b>."
            MESSAGE_HYLAS=_"Fortunate news, Deoran: several amongst our company once trained at the Mages’ Academy on Alduin. Though they dropped out before completion, our journey southwards has given me an opportunity to advance their education."
        }
        {SAY_COMPANION
            MESSAGE_MARI=_"Like me, Fencers have the <b><i>skirmisher</i></b> ability. They’re fragile but fast, and their <b><i>blade damage</i></b> will be more effective against any Ghouls and Skeletons we run into than our other recruits’ pierce damage."
            MESSAGE_GERRICK=_"Like me, Heavy Infantrymen are slow and tough. They ’aint so good at movin’ through forests, but their <b><i>impact damage</i></b> will be great for beatin’ down any Ghouls or Skeletons we run into."
            MESSAGE_HYLAS=_"In addition to Spearmen and Bowmen, you can now recruit <b><i>Mages</i></b>. Though frail and expensive, Mages’ ranged attack deals <b><i>fire damage</i></b> — highly effective against both Ghouls and Skeletons, should we encounter any."
        }
        [if] {HAVE_UNIT id=Mari}{BR}[then]
            [allow_extra_recruit]{BR}id,extra_recruit=Deoran,Fencer{BR}[/allow_extra_recruit]
        [/then]{BR}[/if]
        [if] {HAVE_UNIT id="Sir Gerrick"}{BR}[then]
            [allow_extra_recruit]{BR}id,extra_recruit=Deoran,Heavy Infantryman{BR}[/allow_extra_recruit]
        [/then]{BR}[/if]
        [if] {HAVE_UNIT id="Minister Hylas"}{BR}[then]
            [allow_extra_recruit]{BR}id,extra_recruit=Deoran,Mage{BR}[/allow_extra_recruit]
        [/then]{BR}[/if]

        [display_tip]
            title=_"Resistances and Damage Types"
            image=tutor/resistances.png
            message=_"Different units have resistances
to different damage types.
To see a unit’s resistances,
right-click on it and select
“Unit Description.”

Most undead are resistant to
pierce damage, but vulnerable
to fire, impact, and arcane."
        [/display_tip]
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Find the final Urza brother"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
        {VARIABLE s04_phase intro}
    [/event]
    
    #############################
    # BANDIT ATTACKS UNDEAD
    #############################
    [event]
        name=turn 2
        {GENERIC_UNIT 7 Thug 16 13}             {ROLE cutscene_thug}
        {GENERIC_UNIT 7 "Walking Corpse" 16 14} {ROLE cutscene_corpse}
        {TEAM_COLOR_OVERRIDE role=cutscene_thug   blue}
        {TEAM_COLOR_OVERRIDE role=cutscene_corpse black}
    [/event]
    [event]
        name=sighted
        {FILTER role=cutscene_thug}
        {MODIFY_UNIT role=cutscene_thug   side 2}
        {MODIFY_UNIT role=cutscene_corpse side 3}
        [event]
            name=side 2 turn refresh
            {MODIFY_UNIT role=cutscene_thug moves 0}
        [/event]
        [event]
            name=attack end
            {FILTER side=2} {FILTER_SECOND side=3,4,5,6}
            {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals intro} )}
            {SAY_COMPANION # guaranteed to be a "him", since Afalas only recruits Thugs and Poachers
                MESSAGE_MARI=_"This bandit fights against the undead instead of alongside them? That’s new."
                MESSAGE_GERRICK=_"Good lad, that bandit. I wonder what turned him ’gainst the dead?"
                MESSAGE_HYLAS=_"That outlaw struck at one of his own undead allies. How unexpected."
            }
            [message]
                speaker=Deoran
                message= _ "We should find their leader, the final Urza brother. That will clarify the situation."
            [/message]
        [/event]
    [/event]
    
    #############################
    # AFALAS DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Afalas}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals intro} )}
        [message]
            speaker=Afalas
            message= _ "These undead are too much! I am slain..."
        [/message]
        [message]
            speaker=Deoran
            message= _ "We came here to fight the bandits, but for them to have perished on their own? Something feels very wrong here..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    
    #############################
    # URZA SPOTTED
    #############################
    [event]
        name=sighted
        {FILTER id=Afalas} {FILTER_SECOND side=1}
        {FIRE_EVENT choice}
    [/event]
    [event]
        name=moveto # don't let the player cheese Afalas by disabling fog/shroud updates (and also make him show up earlier if you're using slow units)
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=23,10,7}  )}
        {FIRE_EVENT choice}
    [/event]
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=32,18,10} )} # ensure we meet Urza before Mebrin
        {FIRE_EVENT choice}
    [/event]
    [event]
        name=choice
        [cancel_action]
        [/cancel_action]
        [remove_shroud]
            side,x,y,radius=1,23,10,2
        [/remove_shroud]
        [lift_fog]
            side,x,y,radius=1,23,10,2
        [/lift_fog]
        
        [message]
            speaker=Afalas
            message= _ "I see torches movin’ in the fog... Thank th’ light, it’s living men!"
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"What, do women not count as “living”? You Urzas have caused enough havoc with your undead raising, and I for one am fed up with it. Prepare to join your brothers, boy."
            MESSAGE_GERRICK=_"Ye need not thank anyone for our presence, wrech. You and yer brothers’ve killed too many good men, and defiled too many peaceful corpses. You’ll pay for what ye’ve done to our home."
            MESSAGE_HYLAS=_"Dare not invoke the light in my presence, wielder of evil. You and your brothers have spread darkness and filth across this land. We are here to excise your corruption."
        }
        [message]
            speaker=Afalas
            message= _ "Please, please, jus’ hear me out. I knows my men and I’ve done evil, and I knows that you seek to destroy us out o’ revenge. Ah’m sorry my brothers attacked you. It was never my intention to cause everyone so much sufferin’."
        [/message]
        [message]
            speaker=Deoran
            message= _ "If you’re truly sorry, then cease your fighting and tell us what you know of the undead. How did you gain your dark powers? Make one wrong move and we will not hesitate to finish you off!"
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "It was “never your intention”!? You loathsome vermin dared kidnap Mebrin! Deoran, why are we stooping so low as to even speak with this pig?"
        [/message]
        [message]
            speaker=Afalas
            message= _ "I swear I ’aint your enemy! I’ll gladly tell ye what I know. A year ago, me brothers and I ventured into the land of the elves in secret and we captured a great sage. We forced ’im to teach us the secrets o’ summonin’ the dead."
        [/message]
        [message]
            speaker=Afalas
            message= _ "I saw the folly in doin’ such a thing, but m’ brothers were weak an’ foolish, and soon fell under the sway of the corrupting magic — becomin’ thralls of the very elf they’d sought to enslave. They called ’im “master”, and went from here to do ’is bidding."
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "A complete and utter lie from complete and utter scum. I studied magic under Mebrin for many decades and know him well — our sage would never lead undead, he would destroy them!"
        [/message]
        [message]
            speaker=Afalas
            message= _ "It’s true that Mebrin was more powerful than any o’ the undead we summoned, yet he didn’ resist ’em. They took ’im into the caves, and soon after skeletal horrors started to emerge."
        [/message]
        [message]
            speaker=Afalas
            message= _ "Now my boys and I have returned to try an’ put a stop to it, but there’s jus’ too many. Unless ye helps me now, Mebrin’s undead may soon be strong enough to besiege Westin itself!"
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"(to Deoran) I’ve fought a lot of skeletons in my time, and you’d have to be daft to raise them on purpose. If this Mebrin played any part in their summoning, then he’s no better than the Urza brothers."
            MESSAGE_GERRICK=_"(to Deoran) Elves ’aint so incorruptible and pure as they like to believe. I say this sage Mebrin’s pride made ’im think he could control somethin’ uncontrollable."
            MESSAGE_HYLAS=_"(to Deoran) Sages and mystics of great skill and age are often the first to succumb to the taint of black magic. Knowledge and power are not enough to master undeath — the only way to conquer it is to resist the temptation altogether."
        }
        [message]
            speaker=Afalas
            message= _ "I knows I’m a criminal. My men and I have committed wrongdoin’s in the past, but at least in the fight against the undead, we can be your friends! They’re as much our enemies as they’re yours!

If ye spare my life and the lifes of m’ followers, I promise we’ll fight loyally by your side forevermore. Cross me heart and hope to die, I do."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "Deoran, you would trust the word of a thief and murderer over I, your friend and ally? Think of the destruction this man and his brothers wrought on your people! Think of how they kidnapped and coerced my gentle Mebrin!

No fake niceties can reverse the deaths that have already happened; no atonement taken now can set right the transgressions that have already come to pass!"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "It is lucky for this bandit that I, one aligned with the faerie path of peace and healing, am the only one to hear the venom already spewed. If it were Ithelden or Eltenmir in my stead..."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Peace, let me think! <i>If I listen to Ethiliel I must fight the bandits, but if I ally with the bandits Ethiliel will surely abandon us...</i>"
            [option]
                label= _ "Side with Ethiliel"
                [command]{FIRE_EVENT elf_alliance}[/command]
            [/option]
            [option]
                label= _ "Side with Afalas"
                [command]{FIRE_EVENT bandit_alliance}[/command]
            [/option]
        [/message]
        [modify_turns]
            value={TURN_LIMIT}
        [/modify_turns]
    [/event]
    
    
    
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     ELF ALLIANCE
    #######################################################################################################################################################
    [event]
        name=elf_alliance
        {VARIABLE s04_phase elf_alliance}
        [message]
            speaker=Deoran
            message= _ "Your crimes are too great, Urza Afalas, and your word cannot be trusted. You will fall alongside the undead you helped create!"
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "You will pay for taking Mebrin from us! Once I rescue him from your clutches, I never again intend to leave his side."
        [/message]
        [message]
            speaker=Afalas
            message= _ "Then this parley is over! You may have caused the doom of all of us!"
        [/message]
        [reset_fog]
            reset_view=yes
        [/reset_fog]
        [redraw]
            clear_shroud=yes
        [/redraw]
        
        #############################
        # PREPARE AI
        #############################
        [modify_side]
            side,gold=2,{ON_DIFFICULTY 25 80 120} # he has 1 extra guard on Easy, so cut his Easy gold by 15
        [/modify_side]
        [event]
            name=side 2 turn
            first_time_only=no
            {RESET_SIDE_AI 2 no 0.4 0.25}
            {VARY_AI_BY_SCHEDULE 2}
            {MODIFY_SIDE_AI 2 ([avoid]
                x,y,radius=30,19,5
            [/avoid])}
        [/event]
        
        {GENERIC_UNITC 6 (Walking Corpse)  30 18  ({ZONE_GUARDIAN 36 14 x,y,radius=34,19,4})}
        {GENERIC_UNITC 6 (Walking Corpse)  33 17  ({ZONE_GUARDIAN 33 12 x,y,radius=34,19,4})}
        {GENERIC_UNITC 6 (Walking Corpse)  36 19  ({ZONE_GUARDIAN 33 12 x,y,radius=36,19,2})}
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat Urza Afalas"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]
    
    #############################
    # ENTER CAVE
    #############################
    [event] 
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=33,19,4} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals elf_alliance} )}
        [message]
            speaker=Deoran
            message= _ "This must be cave the bandit spoke about, but there is no sign of Mebrin. Perhaps Afalas really was lying."
        [/message]
    [/event]
    
    #############################
    # GHOUL DIES
    #############################
    [event] 
        name=die
        {FILTER side,canrecruit=6,yes}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals elf_alliance} )}
        [message]
            speaker=Deoran
            message= _ "The ghoul guarding the cave is defeated! I agreed to help Ethiliel bring Urza Afalas to justice, but perhaps there would be merit in venturing further inside..."
            [option]
                label= _ "Continue fighting Urza Afalas"
                [command]{BR}[return][/return]{BR}[/command]
            [/option]
            [option]
                label= _ "Enter the cave"
                [command]
                [/command]
            [/option]
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "Deoran, what are you doing? You would abandon our fight and let this criminal walk free!?"
        [/message]
        [message]
            speaker,image=narrator,wesnoth-icon.png
            message= _ "Author’s note - this is a “secret” path, and quite a bit more challenging than the regular options. Are you sure you want to proceed?"
            [option]
                label= _ "Continue fighting Urza Afalas"
                [command]{BR}[return][/return]{BR}[/command]
            [/option]
            [option]
                label= _ "Enter the cave"
                [command]
                [/command]
            [/option]
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "So it comes to this. All you humans are the same! You are no better than these Urzas, the very pigs who defiled your dead and sacked your farms."
        [/message]
        [message]
            speaker=Deoran
            message= _ "I’m sorry, Ethiliel, but fighting these bandits doesn’t feel right. I’m going to descend down into this cave and find the truth for myself."
        [/message]
        [message]
            speaker,image=narrator,wesnoth-icon.png
            message= _ "TODO - Implement the cave scenario"
        [/message]
    [/event]
    
    #############################
    # AFALAS DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Afalas}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals elf_alliance} )}
        [message]
            speaker=Afalas
            message= _ "You... have doomed us all..."
        [/message]
    [/event]
    [event]
        name=die
        {FILTER id=Afalas}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals elf_alliance} )}
        {KILL side=2}
        [message]
            speaker=Ethiliel
            message= _ "Justice. Thank you for your aid, Deoran. I know it was hard for you to turn against your own kind — you have earned my respect."
        [/message]
        [message]
            speaker=Deoran
            message= _ "I’ve searched all the tents, but cannot find Mebrin anywhere in the bandit camp. Ethiliel, do you still sense his magic nearby?"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "Yes I do, and without that distracting criminal on my mind I can feel Mebrin clearer than ever. I sense joy. I sense power... I sense..."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "..."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "...Humans, we should leave."
        [/message]
        [message]
            speaker=Deoran
            message= _ "What? But what about rescuing—"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "We need to leave, now!!"
        [/message]
        
        {CLEAR_VARIABLE s04_phase}
        [endlevel]
            result=victory
            bonus=yes
            next_scenario=05b_Pebbles_in_the_Flood
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     BANDIT ALLIANCE
    #######################################################################################################################################################
    [event]
        name=bandit_alliance
        {VARIABLE s04_phase bandit_alliance}
        [message]
            speaker=Deoran
            message= _ "I am sorry Ethiliel, but Afalas’s words ring true. If Mebrin has fallen to undeath, then we must all unite against him."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "So it comes to this. All you humans are the same! You are no better than these Urzas, the very pigs who defiled your dead and sacked your farms."
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "Deoran, even your conspiring with criminals shall not keep from us our greatest sage. Soon all of you vile humans shall learn that the Aethenwood protects its own!"
        [/message]
        {MOVE_UNIT id=Ethiliel 3 1}
        [store_unit]
            {FILTER id=Ethiliel}
            variable,kill=stored_ethiliel,yes
        [/store_unit]
        {DELAY 500}
        [modify_unit]
            {FILTER id=Afalas}
            profile=portraits/urza-afalas.webp
        [/modify_unit]
        [message]
            speaker=Afalas
            message= _ "That must’ve been a tough decision. Thank ye."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Don’t make me regret it. Guide us to Mebrin, and we will verify your story ourselves."
        [/message]
        
        #############################
        # AFALAS JOINS YOU
        #############################
        [modify_side]
            side,team_name=2,good
        [/modify_side]
        [reset_fog]
            reset_view=yes
        [/reset_fog]
        [redraw]
            clear_shroud=yes
        [/redraw]
        [remove_shroud]
            side,x,y,radius=1,34,19,4
        [/remove_shroud]
        [remove_shroud]
            side,x,y,radius=1,27,17,2
        [/remove_shroud]
        {SCROLL_TO 34 19}
        {DELAY 500}
        [message]
            speaker,scroll=Afalas,no
            message= _ "The old elf’s cave is southeast of m’ camp. My outlaws’ll fight the zombie hordes, but I leave it up to you soldiers to push into Mebrin’s cave and strike the finishin’ blow."
        [/message]
        
        #############################
        # PREPARE AI
        #############################
        [event]
            name=side 2 turn
            first_time_only=no
            {RESET_SIDE_AI 2 offensive 0.4 0.25}
            {VARY_AI_BY_SCHEDULE_ENEMY 2 3,4,5,6} # retreat at day, so we better match up with the player
            {MODIFY_SIDE_AI 2 ({GOAL_SEEK_SIDE 99 3,4,5 0})}
            {MODIFY_SIDE_AI 2 ([avoid]
                x=0-17,    18,   19,   20,   21,   22,   23,   24,   25,   26,   27,   28,   29,  29,  30
                y=0-99, 12-99,13-99,12-99,13-99,12-99,13-99,12-99,11-99,11-99,11-99,11-99,10-99, 0-6,0-99
                {OR terrain=W*^*}
            [/avoid])}
        [/event]
        
        {KILL side,canrecruit=6,yes}
        [unit]
            side=6
            x,y,facing=34,19,nw
            {SINGLEUNITWML_MEBRIN}
        [/unit]
        {GENERIC_UNITC 6 ({ON_DIFFICULTY "none" "Walking Corpse" "Skeleton"       })  30 18  ({ZONE_GUARDIAN 30 18 x,y,radius=34,19,4})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY "none" "Walking Corpse" "Skeleton Archer"})  33 17  ({ZONE_GUARDIAN 33 17 x,y,radius=34,19,4})}
        {GENERIC_UNITC 6 ({ON_DIFFICULTY "none" "Walking Corpse" "Skeleton Archer"})  36 19  ({ZONE_GUARDIAN 36 19 x,y,radius=36,19,2})}
        [modify_side]
            side=6
            gold=0
            income={ON_DIFFICULTY 0 3 6}
            recruit=Skeleton Archer # prefer archers, to devalue mages a little bit
        [/modify_side]
        {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Skeleton" {ON_DIFFICULTY 2 2 3}} 
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat Mebrin"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]
    
    #############################
    # AFALAS FLEES
    #############################
    [event]
        name=attacker hits
        [filter_second]
            id,formula=Afalas,(self.hitpoints < self.max_hitpoints/2)
        [/filter_second]
        {FIRE_EVENT afalas_flees}
    [/event]
    [event]
        name=defender hits
        [filter]
            id,formula=Afalas,(self.hitpoints < self.max_hitpoints/2)
        [/filter]
        {FIRE_EVENT afalas_flees}
    [/event]
    [event]
        name=afalas_flees
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals bandit_alliance} )}
        [message]
            speaker=Afalas
            message = _ "Ack, that stings! Well, thanks for yer help with the undead — now it’s time for my men and I to make our great escape."
        [/message]
        [message]
            speaker=Deoran
            message = _ "You’re leaving? What happened to fighting loyally by my side forevermore? We still need your aid!"
        [/message]
        [message]
            speaker=Afalas
            message = _ "Did I say somethin’ like that? Don’ ring a bell."
        [/message]
        {MOVE_UNIT id=Afalas 3 1}
        [store_unit]
            {FILTER id=Afalas}
            variable,kill=stored_afalas,yes
        [/store_unit]
        {KILL side=2}
        [message]
            speaker=Deoran
            message = _ "I suppose that’s what I get for trusting an outlaw... We’ll have to defeat Mebrin and his undead on our own."
        [/message]
        {VARIABLE afalas_fled yes}
    [/event]
    
    #############################
    # MEBRIN SIGHTED
    #############################
    [event]
        name=sighted
        {FILTER id=Mebrin}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals bandit_alliance} )}
        [message]
            speaker=Mebrin
            message = _ "Who comes... My old tormentors?"
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"Gods... that skull, those eyes. I had almost hoped the lady was right, but now... even in the Estmarks I never thought I’d live to lay eyes on an lich."
            MESSAGE_GERRICK=_"Dear Haldric! I had almost hoped the lady was right, but now... Whatever that creature used to be in life, in death it’s become something far, far worse."
            MESSAGE_HYLAS=_"Light protect us. I had almost hoped the lady was right, but now... Here lies the souce of the spreading corruption: a lich most foul."
        }
        [message]
            speaker=Deoran
            message = _ "I am Deoran, soldier of the South Guard. We have come to put an end to your villainy, Mebrin of the elves."
        [/message]
        [message]
            speaker=Mebrin
            message = _ "Mebrin? No, I am called Mal M’Brin now, mortals. It is the name I took when I unchained myself from the shallow-mindedness of my kind and passed over into enlightenment."
        [/message]
        [message]
            speaker=Mebrin
            message = _ "There is infinity at the brink of death... I have touched the void at the heart of all things, and I have begun to probe the mystic arts far beyond what any living elf knows."
        [/message]
        [if] {HAVE_UNIT id=Afalas}
            [then]
                [message]
                    speaker=Afalas
                    message = _ "You’ve gone even more mad than before! I wish to Haldric my brothers and I had never laid eyes upon you."
                [/message]
                [message]
                    speaker=Mebrin
                    message = _ "You! Vermin! You and your brothers bound me, you accursed humans; took me and bound me in iron! Ahh, the cold iron on my skin... it burned me day and night for days, weeks, tormenting me endlessly as you humans tried to pry the secrets of the undead from me!"
                [/message]
                [message]
                    speaker=Afalas
                    message = _ "What is this? Elves bear steel swords! How should I have known that iron would hurt your kind so."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Deoran
                    message = _ "Ethiliel spoke so highly of you. But you truly have become evil."
                [/message]
                [message]
                    speaker=Mebrin
                    message = _ "You bound me, you accursed humans; took me and bound me in iron! Ahh, the cold iron on my skin... it burned me day and night for days, weeks, tormenting me endlessly as you humans tried to pry the secrets of the undead from me!"
                [/message]
                [message]
                    speaker=Deoran
                    message = _ "What is this? Elves bear steel swords! The Urzas could not possibly have known that iron would hurt your kind so."
                [/message]
            [/else]
        [/if]
        
        [message]
            speaker=Mebrin
            message = _ "You knew, you knew! You all reveled in my hurt, relished each and every one of my cries of pain! Even as I begged for mercy, you would not relent. I did not know day from night... the light and the shadows, heat and cold, everything was one and the same as the iron bled itself into my veins."
        [/message]
        [message]
            speaker=Mebrin
            message = _ "At my lowest point, I broke. I was beyond humiliated, but I could bear it no longer. I offered to teach the secrets of the dead, if I would just be freed from the accursed shackles. I knew that once the first strand of black magic entwined itself within me, there would be no turning back. I knew, but what did it matter? What did I have left to lose? In hindsight, I had much to gain."
        [/message]
        [message]
            speaker=Mebrin
            message = _ "You humans are ultimately a weak breed. I taught the summoning of powers that your race can not control. In your greed, you never stopped to wonder if you could master the sorcery, or if it would master you and your minds in turn. Content with only meager tricks, you filthy tree-killers never even noticed as I siphoned away your energies for myself!"
        [/message]
        [message]
            speaker=Deoran
            message = _ "After all Ethiliel’s kind words about you, I had yet a glimmer of hope that you might still be reasoned with. But it is now clear that words are of no further use. $companion_name, are you with me?"
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"The rookie’s all grown up. Let’s do this."
            MESSAGE_GERRICK=_"On your order, Sir Deoran."
            MESSAGE_HYLAS=_"Evil never rests — nor does the light that seeks to exterminate it."
        }
        [message]
            speaker=Deoran
            message = _ "Attack!"
        [/message]
        [modify_side]
            side,gold=6,{ON_DIFFICULTY 25 50 75}
        [/modify_side]
    [/event]
    
    #############################
    # ATTACKING MEBRIN
    #############################
    [event]
        name=attack end
        {FILTER_SECOND id=Mebrin}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals bandit_alliance} )}
        [event]
            name=side 6 turn
            [message]
                speaker=Mebrin
                message = _ "You dare strike me?! Puny humans, I’m darkness incarnate! I’m power beyond your comprehension!"
            [/message]
            {SAY_COMPANION
                MESSAGE_MARI=_"Oh, I understand just fine: you’re nothing but a pile of dead bones glued together into a crude imitation of life. I’ve smashed plenty of skeletons before you, and I’ll smash plenty after."
                MESSAGE_GERRICK=_"Aye, beyond my comprehension you may be, but I don’ need to understand you to destroy you. I know you’re evil, an’ that’s enough. Prepare to meet your maker, lich."
                MESSAGE_HYLAS=_"You’re merely a servant of the power that corrupted you, lich! You’ve not mastered the darkness; it, instead, has enslaved you. We will put you out of your misery."
            }
            [message]
                speaker=Mebrin
                message = _ "<b><i>You</i></b> think you can destroy <b><i>me</i></b>? Were Ethiliel here I might have held back, but you humans are nothing but a worthless blight upon this wretched world. Now die."
            [/message]
            [gold]
                side,amount=6,{ON_DIFFICULTY 15 30 45}
            [/gold]
        [/event]
    [/event]
    
    #############################
    # MEBRIN DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Mebrin}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals bandit_alliance} )}
        
        {SAY_COMPANION
            MESSAGE_MARI=_"Time to un-die, un-dead. I am so done with this."
            MESSAGE_GERRICK=_"Ah’ve watched enough friends fall to yer creatures, lich. They didn’t die in vain."
            MESSAGE_HYLAS=_"As the scalpel cuts away a tumor, so shall I cut your corruption out of this world. Your blight is ended, Mebrin of the elves."
        }
        [message]
            speaker=Mebrin
            message = _ "Beaten by mere mortals... how has it come to this!? At least peace may finally come... for me. But not for you... Ethiliel will avenge me."
        [/message]
        [message]
            speaker=Mebrin
            message = _ "I felt her emotions, felt her intentions, <b><i>fed</i></b> her intentions... Accursed humans, you may have struck me down, but I have already won my revenge..."
        [/message]
    [/event]
    [event]
        name=die
        {FILTER id=Mebrin}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL s04_phase equals bandit_alliance} )}
        
        {CLEAR_VARIABLE s04_phase}
        {FULL_HEAL id=Afalas}
        [store_unit]
            {FILTER id=Afalas}
            variable=stored_afalas
        [/store_unit]
        [endlevel]
            result=victory
            bonus=yes
            next_scenario=05a_The_Long_March
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    #############################
    # TIME OVER
    #############################
    [event]
        name=turn {TURN_WARNING}
        [message]
            speaker=Deoran
            message= _ "I grow weary! Even holding my weapon is getting difficult. "
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"Yeah, I feel it too. Something’s very wrong in this forest. If we can’t finish our fight quickly, I’m not sure we’re getting out of here at all."
            MESSAGE_GERRICK=_"Aye, I feel it too. Somethin’s very wrong in this here forest. If we can’t finish our fight quick, I’m not sure we’re ever gettin’ back home."
            MESSAGE_HYLAS=_"I feel it too. Dark magic suffuses this forest — if we cannot finish our fight quickly, we may never be able to."
        }
        [message]
            speaker,image=narrator,wesnoth-icon.png
            {TUTOR: _"You are running out of turns to complete this scenario! See your objectives by pressing Ctrl+J, and remember that the turn limit can be seen in the top-left-hand corner."}
        [/message]
    [/event]
    [event]
        name=side 1 turn {TURN_LIMIT} end
        [message]
            speaker=Deoran
            message= _ "The darkness is so heavy... My soul burns; this forest’s foul magic has sapped all our our strength!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "I cannot keep fighting... We must— we must attempt to retreat..."
        [/message]
        [message]
            speaker,image=narrator,wesnoth-icon.png
            {TUTOR: _"You have run out of turns to complete the scenario, and have been defeated!"}
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
[/scenario]
