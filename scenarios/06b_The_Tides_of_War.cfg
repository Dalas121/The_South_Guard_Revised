#textdomain wesnoth-tsg


#define TURN_LIMIT
25#enddef

[scenario]
    id=06b_The_Tides_of_War
    map_file=06b_The_Tides_of_War.map
    name= _ "The Tides of War"
    next_scenario=06b_The_Tides_of_War
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER}
    
    {DEFAULT_SCHEDULE_MORNING} # remember that the braziers' ToD is tied to this. There are also ToD dialogue events
    turns={TURN_LIMIT}
    
    {SCENARIO_MUSIC nunc_dimittis.ogg}
    {EXTRA_SCENARIO_MUSIC heroes_rite.ogg}
    
    {SG_TIDES}
    {TSG_BIGMAP {JOURNEY_06b_NEW} }
    
    
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=good
        user_team_name=_"South Guard"
        gold=20
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
    [/side]
    
    #############################
    # TOWN
    #############################
    [side]
        side=2
        color=wesred
        controller=ai
        [ai]
            ai_algorithm=idle_ai # not controller=null, or else she doesn't rest-heal
        [/ai]
        team_name=good
        no_leader,hidden=yes,yes
    [/side]
    
    #############################
    # UNDEAD
    #############################
#define UNDEAD_SIDE SIDE INITIAL_GOLD INITLAL_INCOME RECRUITS
    [side]
        side={SIDE}
        color=black
        controller=ai
        no_leader=yes
        team_name=undead
        user_team_name=_"Undead"
        gold,income={INITIAL_GOLD},{INITLAL_INCOME}
        recruit={RECRUITS}
        {FLAG_VARIANT undead}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 1}
#enddef
    # enough for full initial keeps on all difficulties
    # we need to look overwhelming or else fleeing sounds dumb
    # instead, vary ToD with difficulty, and hold some of these guys back at first
    {UNDEAD_SIDE 3 {ON_DIFFICULTY 50 100 150} {ON_DIFFICULTY  3  8 13} "Skeleton Archer"}
    {UNDEAD_SIDE 4 {ON_DIFFICULTY 25  50  75} {ON_DIFFICULTY -1  1  3} "Walking Corpse"}
    {UNDEAD_SIDE 5 {ON_DIFFICULTY 25  50  75} {ON_DIFFICULTY -2 -1  0} "Walking Corpse"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 Skeleton {ON_DIFFICULTY 0 1 2}} # prefer archers over skeletons, to make mages (e.g. choosing Hylas) less strong
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Ghoul    {ON_DIFFICULTY 0 1 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Ghoul    {ON_DIFFICULTY 0 1 2}}
    [event]
        name=side 3 turn
        first_time_only=no
        {RESET_SIDE_AI 3   offensive 0.6 0.2}
        {RESET_SIDE_AI 4,5 offensive 0.9 0.1}
        {VARY_AI_BY_SCHEDULE 3,4,5}
        {MODIFY_SIDE_AI 3,4,5 retreat_factor=0}
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        
        #############################
        # SCENERY
        #############################
        {BRAZIER_ILLUMINATION_MORNING 18 8}
        {BRAZIER_ILLUMINATION_MORNING 22 9}
        {BRAZIER_ILLUMINATION_MORNING 17 13}
        
        {PLACE_IMAGE halo/stairway.png 23 7}
        {PLACE_IMAGE scenery/temple1.png 20 5}
        {PLACE_IMAGE scenery/tent-fancy-red.png 16 13}
        {PLACE_IMAGE scenery/tent-shop-weapons.png 17 14}
        [item]
            halo="units/statue-westin.png~FL()"
            x,y=23,9
        [/item]
        
        #############################
        # DEORAN
        #############################
        [unstore_unit]
            variable=stored_deoran
            x,y=24,8
        [/unstore_unit]
        {MODIFY_UNIT id=Deoran facing sw}
        [capture_village]
            side,x,y,radius=1,20,10,7
            {NOT( {FILTER side=2} )}
        [/capture_village]
        {VARIABLE ignore_companion_defeat yes}
        
        #############################
        # HEROES
        #############################
        [unit]
            side,x,y,facing=1,19,6,sw
            {SINGLEUNITWML_HYLAS}
        [/unit]
        [unit]
            side,x,y,facing=1,15,7,sw
            {SINGLEUNITWML_GERRICK}
        [/unit]
        [unit]
            side,x,y,facing=1,20,10,sw
            {SINGLEUNITWML_MARI}
        [/unit]
        {KILL id=$companion_id} # our companion is already dead
        
        #############################
        # GUARDS
        #############################
#define DO_IF_PEBBLES LIMIT WML
        [if] {VARIABLE_CONDITIONAL pebbles_defense_length greater_than_equal_to {LIMIT}}[then] {BR}{WML}{BR} [/then]{BR}[/if]
#enddef
#define DO_IF_EXACTLY LIMIT WML
        [if] {VARIABLE_CONDITIONAL pebbles_defense_length equals {LIMIT}}[then] {BR}{WML}{BR} [/then]{BR}[/if]
#enddef
        # these timings line up with the messages given in PEBBLES_DIALOGUE_SWITCH
        {WML_COMPANION
            (WML_MARI   ={VARIABLE tahn_type Fencer})
            (WML_GERRICK={VARIABLE tahn_type "Heavy Infantryman"})
            (WML_HYLAS  ={VARIABLE tahn_type Mage})
        }
        {DO_IF_PEBBLES  1 ( {GENERIC_UNIT 1 Peasant    14  7}{FACING sw} )}
        {DO_IF_PEBBLES  2 ( {GENERIC_UNIT 1 Woodsman   18  4}{FACING sw} )}
        {DO_IF_PEBBLES  3 ( {GENERIC_UNIT 1 Woodsman   19 11}{FACING se} )}
        {DO_IF_PEBBLES  4 ( {GENERIC_UNIT 1 Peasant    25  9}{FACING se} )}
        {DO_IF_PEBBLES  5 ( {GENERIC_UNIT 1 Woodsman   24  9}{FACING sw} )}
        {DO_IF_PEBBLES  6 ( {GENERIC_UNIT 1 Peasant    15  8}{FACING sw} )}
        {DO_IF_PEBBLES  7 ( {GENERIC_UNIT 1 Woodsman   20 11}{FACING se} )}
        {DO_IF_PEBBLES  8 ( {GENERIC_UNIT 1 Woodsman   18  9}{FACING se} )}
        {DO_IF_PEBBLES  9 ( {GENERIC_UNIT 1 Woodsman   19  9}{FACING se} )}
        {DO_IF_PEBBLES 10 ( {GENERIC_UNIT 1 Peasant    19  8}{FACING se} )}
        
        {DO_IF_PEBBLES 11 (
            {GENERIC_UNIT 1 $tahn_type 15 14}{FACING sw}
            {GENERIC_UNIT 1 $tahn_type 18 14}{FACING sw}
            {GENERIC_UNIT 1 $tahn_type 17 14}{FACING sw}
            {WML_COMPANION (WML_MARI={GENERIC_UNIT 1 $tahn_type 16 12}{FACING se})}
            {WML_COMPANION (WML_MARI={GENERIC_UNIT 1 $tahn_type 18 13}{FACING se})} # fencers are cheaper and weak vs undead, so spawn more of them
        )}
        {DO_IF_EXACTLY 11 ( {KILL x,y=19,8} {KILL x,y=19,9} {KILL x,y=18,9} {KILL x,y=20,11} {KILL x,y=15,8} )}
        {DO_IF_EXACTLY 12 ( {KILL x,y=19,8} {KILL x,y=19,9} {KILL x,y=18,9} {KILL x,y=20,11} )}
        {DO_IF_EXACTLY 13 ( {KILL x,y=19,8} {KILL x,y=19,9} {KILL x,y=18,9} )}
        {DO_IF_EXACTLY 14 ( {KILL x,y=19,8} {KILL x,y=19,9} )}
        {DO_IF_EXACTLY 15 ( {KILL x,y=19,8} )}
        {DO_IF_EXACTLY 16 ( )}
        
        {DO_IF_PEBBLES 17 ( {ADVANCE_UNIT x,y=14,7  Spearman} )}
        {DO_IF_PEBBLES 18 ( {ADVANCE_UNIT x,y=18,4  Bowman  } )}
        {DO_IF_PEBBLES 19 ( {ADVANCE_UNIT x,y=19,11 Bowman  } )}
        {DO_IF_PEBBLES 20 ( {ADVANCE_UNIT x,y=25,9  Spearman} )}
        {DO_IF_PEBBLES 21 ( {ADVANCE_UNIT x,y=24,9  Bowman  } )}
        {DO_IF_PEBBLES 22 ( {ADVANCE_UNIT x,y=15,8  Spearman} )}
        {DO_IF_PEBBLES 23 ( {ADVANCE_UNIT x,y=20,11 Bowman  } )}
        {DO_IF_PEBBLES 24 ( {ADVANCE_UNIT x,y=18,9  Bowman  } )}
        {DO_IF_PEBBLES 25 ( {ADVANCE_UNIT x,y=19,9  Bowman  } )}
        {DO_IF_PEBBLES 26 ( {ADVANCE_UNIT x,y=19,8  Spearman} )}
        
        {DO_IF_PEBBLES 27 ( [gold]
            side,amount=1,"$( ($pebbles_defense_length-26)*3 )" # 3 extra gold for each overflow turn survived
        [/gold] )}
        
        {CLEAR_VARIABLE tahn_type}
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
#define PEBBLES_DIALOGUE_SWITCH SPEAKER  MSG_NOT_ENOUGH_TIME  MSG_UNTRAINED_FARMERS  MSG_GARRISON_RECALLED  MSG_EQUIPPED_FARMERS
    [if] {VARIABLE_CONDITIONAL pebbles_defense_length greater_than_equal_to 20}
        [then]
            [message]
                speaker={SPEAKER}
                message={MSG_EQUIPPED_FARMERS}
            [/message]
        [/then]
        [elseif] {VARIABLE_CONDITIONAL pebbles_defense_length greater_than_equal_to 11}
            [then]
                [message]
                    speaker={SPEAKER}
                    message={MSG_GARRISON_RECALLED}
                [/message]
            [/then]
        [/elseif]
        [elseif] {VARIABLE_CONDITIONAL pebbles_defense_length greater_than_equal_to 5}
            [then]
                [message]
                    speaker={SPEAKER}
                    message={MSG_UNTRAINED_FARMERS}
                [/message]
            [/then]
        [/elseif]
        [else]
            [message]
                speaker={SPEAKER}
                message={MSG_NOT_ENOUGH_TIME}
            [/message]
        [/else]
    [/if]
#enddef
    [event]
        name=start
        {DELAY 500}
        {SCROLL_TO 24 29}
        {WML_COMPANION
            #############################
            # IF MARI DIED...
            #############################
            (WML_MARI=
                [message]
                    speaker,scroll=Deoran,no
                    message= _ "Look there! The undead army has broken through Sergeant Mari‘s lines! Alas, she is lost..."
                [/message]
                [message]
                    speaker=Sir Gerrick
                    message= _ "Your friend seemed the good sort, but I can‘t say I knew ‘er well. Now I‘ll never get the chance."
                [/message]
                {PEBBLES_DIALOGUE_SWITCH "Minister Hylas"
                    _"Another poor soul claimed by the spreading darkness. If only we‘d had more time to prepare... but we‘ve done our best."
                    _"Another poor soul claimed by the spreading darkness. At least her sacrifice was not in vain: we‘ve had sufficient time to gather most of the region‘s famers and woodsmen. They‘re not trained for battle, but will benefit greatly from your leadership, Deoran."
                    _"Another poor soul claimed by the spreading darkness. At least her sacrifice was not in vain: we‘ve had sufficient time to gather most of the region‘s famers and woodsmen, as well as recall the squad of mages garrisoning Fort Tahn."
                    _"Another poor soul claimed by the spreading darkness. At least her sacrifice was not in vain: we‘ve had sufficient time to gather, train, and equip most of the region‘s famers and woodsmen, as well as recall the squad of fencers garrisoning Fort Tahn."}
                [message]
                    speaker=Sir Gerrick
                    message= _ "Aye, an‘ I‘ve got most o‘ the civilians safe underground in th‘ cellars, with magistrate Fiore‘s daughter watchin‘ the entrance. Lucky for us Fiore himself ‘aint here to see this mess."
                [/message]
                [unit]
                    side,x,y=2,23,7
                    facing,animate=sw,yes
                    {SINGLEUNITWML_ASHEVIERE}
                [/unit]
                [message]
                    speaker=Asheviere
                    message= _ "I‘ve never had this much freedom before. Only in times of crisis, it should seem..."
                [/message]
                {DELAY 500}
                [message]
                    speaker=Deoran
                    message= _ "Sergeant Mari bought us time. I only hope it was enough, for this is our final fight. A mighty battle is upon us, but as surely as the dawn breaks after every night, the courage and valor of men will prevail over the wicked creatures of darkness."
                [/message]
                [message]
                    speaker=Deoran
                    message= _ "We must stand fast against the undead and defend our homes! We fight for the fallen! We fight for Wesnoth!"
                [/message]
            )
            
            #############################
            # IF GERRICK DIED...
            #############################
            (WML_GERRICK=
                [message]
                    speaker,scroll=Deoran,no
                    message= _ "Look there! The undead army has broken through Sir Gerrick‘s lines! Alas, he is lost... "
                [/message]
                [message]
                    speaker=Mari
                    message= _ "Shame. I didn‘t really get a chance to know him, but I know you don‘t survive to his age unless you‘re one hell of a soldier. We‘ll miss him."
                [/message]
                {PEBBLES_DIALOGUE_SWITCH "Minister Hylas"
                    _"Another poor soul claimed by the spreading darkness. If only we‘d had more time to prepare... but we‘ve done our best."
                    _"Another poor soul claimed by the spreading darkness. At least his sacrifice was not in vain: we‘ve had sufficient time to gather most of the region‘s famers and woodsmen. They‘re not trained for battle, but will benefit greatly from your leadership, Deoran."
                    _"Another poor soul claimed by the spreading darkness. At least his sacrifice was not in vain: we‘ve had sufficient time to gather most of the region‘s famers and woodsmen, as well as recall the squad of mages garrisoning Fort Tahn."
                    _"Another poor soul claimed by the spreading darkness. At least his sacrifice was not in vain: we‘ve had sufficient time to gather, train, and equip most of the region‘s famers and woodsmen, as well as recall the squad of heavy infantry garrisoning Fort Tahn."}
                [message]
                    speaker=Mari
                    message= _ "And I‘ve got most of the civilians safe underground in the cellars. Magistrate Fiore‘s daughter wanted to watch the entrance — probably trying to get herself killed so she doesn‘t have to get married and rule over our sorry behinds."
                [/message]
                [unit]
                    side,x,y=2,23,7
                    facing,animate=sw,yes
                    {SINGLEUNITWML_ASHEVIERE}
                [/unit]
                [message]
                    speaker=Asheviere
                    message= _ "I‘ve never had this much freedom before. Only in times of crisis, it should seem..."
                [/message]
                {DELAY 500}
                [message]
                    speaker=Deoran
                    message= _ "Sir Gerrick bought us time. I only hope it was enough, for this is our final fight. A mighty battle is upon us, but as surely as the dawn breaks after every night, the courage and valor of men will prevail over the wicked creatures of darkness."
                [/message]
                [message]
                    speaker=Deoran
                    message= _ "We must stand fast against the undead and defend our homes! We fight for the fallen! We fight for Wesnoth!"
                [/message]
            )
            
            #############################
            # IF HYLAS DIED...
            #############################
            (WML_HYLAS=
                [message]
                    speaker,scroll=Deoran,no
                    message= _ "Look there! The undead army has broken through Minister Hylas‘s lines! Alas, he is lost... "
                [/message]
                [message]
                    speaker=Sir Gerrick
                    message= _ "Th‘ good minister turned down the luxurious life o‘ a city mage to come down ‘ere an‘ care for us rural folk. ‘e was a good man."
                [/message]
                {PEBBLES_DIALOGUE_SWITCH "Mari"
                    _"Me, I‘d have taken the life of luxury — but maybe the world needs crazy people like Hylas. If only we‘d had more time... but we‘ve done our best."
                    _"Me, I‘d have taken the life of luxury. But maybe the world needs crazy people like him — Hylas‘s sacrifice bought us enough time to gather most of the region‘s famers and woodsmen. They‘re not trained for battle, but will benefit greatly from your leadership, Deoran."
                    _"Me, I‘d have taken the life of luxury. But maybe the world needs crazy people like him — Hylas‘s sacrifice bought us enough time to gather most of the region‘s famers and woodsmen, as well as recall the squad of mages garrisoning Fort Tahn."
                    _"Me, I‘d have taken the life of luxury. But maybe the world needs crazy people like him — Hylas‘s sacrifice bought us enough time to gather, train, and equip most of the region‘s famers and woodsmen, as well as recall the squad of mages garrisoning Fort Tahn."}
                [message]
                    speaker=Mari
                    message= _ "And I‘ve got most of the civilians safe underground in the cellars. Magistrate Fiore‘s daughter wanted to watch the entrance — probably trying to get herself killed so she doesn‘t have to get married and rule over our sorry behinds."
                [/message]
                [unit]
                    side,x,y=2,23,7
                    facing,animate=sw,yes
                    {SINGLEUNITWML_ASHEVIERE}
                [/unit]
                [message]
                    speaker=Asheviere
                    message= _ "I‘ve never had this much freedom before. Only in times of crisis, it should seem..."
                [/message]
                {DELAY 500}
                [message]
                    speaker=Deoran
                    message= _ "Minister Hylas bought us time. I only hope it was enough, for this is our final fight. A mighty battle is upon us, but as surely as the dawn breaks after every night, the courage and valor of men will prevail over the wicked creatures of darkness."
                [/message]
                [message]
                    speaker=Deoran
                    message= _ "We must stand fast against the undead and defend our homes! We fight for the fallen! We fight for Wesnoth!"
                [/message]
            )
        }
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            side=1
            [objective]
                description= _ "Survive until turns run out"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Deoran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Asheviere"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
        [/objectives]
    [/event]
    
    #############################
    # "FOR $COMPANION_NAME"
    #############################
    [event]
        name=attack
        {FILTER type_adv_tree=Mage,Fencer,"Heavy Infantryman"} # Mari/Gerrick/Hylas trained these units, so they're particularly attached
        
        {WML_COMPANION
            (WML_MARI   ={VARIABLE message _"For master Mari!"})
            (WML_GERRICK={VARIABLE message _"For master Gerrick!"})
            (WML_HYLAS  ={VARIABLE message _"For master Hylas!"})
        }
        [message]
            speaker=unit
            message=$message
        [/message]
        {CLEAR_VARIABLE message}
    [/event]
    
    #############################
    # MEBRIN TAUNTS DEORAN
    #############################
    [event]
        name=side 1 turn end
        [message]
            speaker=Mebrin
            message= _ "So, the fleshbags have managed to mount a defense. I would seem that the pesky fly turned out to be more than a minor annoyance after all."
        [/message]
        [message]
            speaker=Mebrin
            message= _ "No matter. My servants, slay them all! Even if w sustain heavy losses here, the town‘s inhabitants will be more than enough to replenish our ranks for our march to the Aethenwood."
        [/message]
    [/event]
    
    #############################
    # NIGHT FALLS
    #############################
    [event]
        name=turn 10
        [message]
            speaker=Mebrin
            message= _ "The shroud of darkness descends once more. Night seeps through the cracks and crannies in the humans‘ defenses, plaguing their minds and bodies with dreadful fear. As surely as the sanctity of the psyche is shattered, so is the physical form, and all that‘s left is unthinking, unfeeling servitude."
        [/message]
        [message]
            speaker=Deoran
            message= _ "We don‘t fear your unholy power, lich. We won‘t succumb to your dark magics and we won‘t be turned into your undead slaves."
        [/message]
        [message]
            speaker=Mebrin
            message= _ "Believe what you will, human. We shall see if you survive the night."
        [/message]
    [/event]
    [event]
        name=turn 13
        [message]
            speaker=Deoran
            message= _ "Dawn breaks over the horizon! We‘ve weathered the night and can now begin our counterattack against the undead!"
        [/message]
    [/event]
    
    #############################
    # PLAYER SUFFERS CASUALTIES
    #############################
    [event]
        name=die {FILTER side=1}
        [event]
            name=die {FILTER side=1}
            [event]
                name=die {FILTER side=1}
                [message]
                    speaker=Deoran
                    message= _ "Hold fast, men of the South Guard! No matter how daunting the evil that opposes us, we must weather this darkness and defend our homes!"
                [/message]
                [message]
                    speaker=Mebrin
                    message= _ "Fool boy, you overestimate the strength of these decrepit peasants that you call soldiers. The rivers will run red with your blood! The smoke and ashes from your ruined homes will blot out the sky, and from the swamps and the black earth, your bones will rise again to serve me!"
                [/message]
            [/event]
        [/event]
    [/event]
    
    #############################
    # PLAYER ATTACKS MEBRIN
    #############################
    [event]
        name=attack end
        {FILTER side=1}
        {FILTER_SECOND id=Mebrin}
        [message]
            speaker=Mebrin
            message = _ "You dare strike me?! Puny humans, I’m darkness incarnate! I’m power beyond your comprehension!"
        [/message]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                 ETHILIEL ARRIVES
    #######################################################################################################################################################
    [event]
        name=turn $( {TURN_LIMIT}-3 )
        
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                 VICTORY / DEFEAT
    #######################################################################################################################################################
    
[/scenario]



