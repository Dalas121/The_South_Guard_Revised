#textdomain wesnoth-tsg

[scenario]
    id=03_Vale_of_Tears
    map_file=03_Vale_of_Tears.map
    name= _ "Vale of Tears"
    next_scenario=04_Blight
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER_SCENARIO}
    
    {DEFAULT_SCHEDULE_DUSK}
    turns=10
    
    {SCENARIO_MUSIC elvish-theme.ogg}
    {TSG_BIGMAP {JOURNEY_03_NEW} }

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=good
        user_team_name=_"South Guard"
        gold=50
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
        fog=yes
    [/side]
    
    #############################
    # BANDITS
    #############################
    # wmllint: local spelling Nalmath
    [side]
        side=2
        color=blue
        controller=ai
        no_leader=yes
        facing=se
        team_name=bandits
        user_team_name=_"Urza Nalmath"
        gold,income=0,-2
        recruit=Ghoul
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 3} # since he has skirmisher, it's ok to let him move a little further than usual
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Walking Corpse" {ON_DIFFICULTY 3 4 5}} # 2 guards on all difficulties
    
    [side]
        side=3
        color=blue
        controller=ai
        no_leader=yes
        hidden=yes
        facing=se
        team_name=bandits
        user_team_name=_"Urza Nalmath"
        gold,income=0,-2
        recruit=Walking Corpse
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 3 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 Ghoul {ON_DIFFICULTY 2 3 4}} # 1 guard on all difficulties
    
    [side]
        side=4
        color=blue
        controller=ai
        no_leader=yes
        hidden=yes
        facing=se
        team_name=bandits
        user_team_name=_"Urza Nalmath"
        gold,income=0,-2
        recruit=Walking Corpse
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 4 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Ghoul {ON_DIFFICULTY 2 3 4}} # 1 guard on all difficulties
    
    [side]
        side=5
        color=blue
        controller=ai
        no_leader=yes
        hidden=yes
        facing=se
        team_name=bandits
        user_team_name=_"Urza Nalmath"
        gold,income=0,-2
        recruit=Walking Corpse
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 5 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Ghoul {ON_DIFFICULTY 2 3 4}} # 1 guard on all difficulties
    
    [side] # dummy side for the illusionary elves
        side=6
        color=green
        controller=null
        no_leader=yes
        hidden=yes
    [/side]
    
    #############################
    # BANDIT AI
    #############################
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2,3,4,5 offensive 0.99 0.01}
        {MODIFY_SIDE_AI 2,3,4,5 retreat_factor=0}
        
        # custom VARY_AI_BY_SCHEDULE. The normal macro has corpses retreat too far, because they're in water and move slowly
        {IF_TIME_OF_DAY morning}
            {AND_NO_ENEMIES_NEAR_MY_LEADER 2,3,4,5}
            [then]
                {MODIFY_SIDE_AI (2,3,4,5) ({GOAL_AVOID_SIDE_UNLESS_DEFENDING_LEADER 9 2,3,4,5 1 2})} # avoid staying too close
                {MODIFY_SIDE_AI (2,3,4,5) ({GOAL_SEEK_SIDE                          8         1 4})} # but seek staying close enough
                
                {MODIFY_SIDE_AI (2,3,4,5) (aggression=-9)}
                {MODIFY_SIDE_AI (2,3,4,5) (caution=9)}
            [/then]
        {ENDIF}
        {IF_TIME_OF_DAY afternoon}
            {AND_NO_ENEMIES_NEAR_MY_LEADER 2,3,4,5}
            [then]
                {MODIFY_SIDE_AI (2,3,4,5) ({GOAL_AVOID_SIDE_UNLESS_DEFENDING_LEADER 9 2,3,4,5 1 1})} # avoid staying too close
                {MODIFY_SIDE_AI (2,3,4,5) ({GOAL_SEEK_SIDE                          8         1 3})} # but seek staying close enough
                
                {MODIFY_SIDE_AI (2,3,4,5) (aggression=-9)}
                {MODIFY_SIDE_AI (2,3,4,5) (caution=9)}
            [/then]
        {ENDIF}
    [/event]
    
    # make zombies slightly less useless in shallow water.
    [event]
        name=unit placed
        first_time_only=no
        {FILTER type_adv_tree="Walking Corpse",Ghoul}
        [object]
            {FILTER id=$unit.id}
            [effect]
                apply_to=movement_costs
                replace=yes
                [movement_costs]
                    shallow_water=2
                [/movement_costs]
            [/effect]
        [/object]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        [item]
            x,y,halo=15,18,scenery/fountain-[01~13].png:100
        [/item]
        {PUT_TO_RECALL_LIST id=Deoran}
        {SCROLL_TO 38 2}
    [/event]
    #######################################################################################################################################################
    #                                                                     PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        #############################
        # DEORAN ARRIVES
        #############################
        {DELAY 500}
        {RECALL_XY Deoran 38 2}
        [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        {DELAY 500}{MOVE_UNIT id=Deoran 34  7} [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        {DELAY 500}{MOVE_UNIT id=Deoran 27  7} [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        {DELAY 500}{MOVE_UNIT id=Deoran 27 13} [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        {DELAY 250}
        [message]
            speaker=Deoran
            message= _ "Ugh, are we going in the right direction? I can hardly see a thing through this mist..."
        [/message]
        {SCROLL_TO 18 17}
        {MOVE_UNIT id=Deoran 20 16}
        [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        {RECALL $companion_id 20 15}
        {MODIFY_UNIT id=$companion_id facing sw}
        [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        {DELAY 250}
        
        #############################
        # ELVES APPEAR
        #############################
#define ELF TYPE IMAGE X Y ID NAME FACE GEND DURATION ALPHA
        {NAMED_NOTRAIT_UNIT 6 {TYPE} {X} {Y} {ID} {NAME}} {FACING {FACE}} {ANIMATE} {GENDER {GEND}} # no traits because 1) saves the trouble of staying comaptible with future portrayals, and 2) hints that these are illusions
        [modify_unit]
            {FILTER id={ID}}
            [object]
                {EFFECT new_animation([standing_anim]
                    base_score=99
                    [frame]
                        image=units/elves-wood/{IMAGE}
                        duration={DURATION} # make the elves fade in and out, since they're really illusions
                        alpha={ALPHA}
                    [/frame]
                [/standing_anim])}
                {EFFECT new_animation ([death]
                    base_score=99
                    [frame]
                        duration,image_mod=500,"~CS(127,0,127)~BL([15,10,20,30,40,50,60,70])"
                        blend_ratio,blend_color=0~1,255,255,255
                        alpha=1,1~0
                    [/frame]
                [/death] )}
            [/object]
        [/modify_unit]
#enddef
        {ELF (Elvish Marksman ) "marksman+female.png" 16 15 Mithalwe  _"Mithalwe" se female   6000 "1:1000,1~0.7:2250,0.7:500,0.7~1:2250"       }
        {ELF (Elvish Champion ) "champion.png"        19 18 Galdrad   _"Galdrad"  se   male   5000 "1:500, 1~0.6:2000,0.6:500,0.6~1:2000"       } # Galdrad from HttT
        {ELF (Elvish Sorceress) "sorceress.png"       24 15 Vaenuith  _"Vaenuith" sw female   6000        "1~0.8:2500,0.8:500,0.8~1:2500,1:500" }
        {ELF (Elvish Shyde    ) "shyde.png"           19 15 Ethiliel  _"Ethiliel" se female   5000        "1~0.7:2000,0.7:500,0.7~1:2000,1:500" }
        {ELF (Elvish Captain  ) "captain.png"         23 18 Ithelden  _"Ithelden" sw   male   6000        "1~0.9:2250,0.9:500,0.9~1:2250,1:1000"}
        {MODIFY_UNIT id=Ethiliel profile portraits/ethiliel.webp}
        
        #############################
        # ELVES SPEAK
        #############################
        [message]
            speaker=Galdrad
            message= _ "Halt! Who enters our sacred vale without leave?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Elves! Err... I—"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "Choose your words wisely, outlander. Speak, knowing that the penalty for trespass is death."
        [/message]
        [message]
            speaker=Deoran
            message= _ "I have come to—"
        [/message]
        [message]
            speaker=Vaenuith
            message= _ "To ask our help, no doubt. There is darkness in the air, corruption in the earth. Someone has been meddling in the black magic. Let us not forget that it is you humans who first brought this perverse sorcery to our great continent, when you arrived here centuries ago."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Well, I—"
        [/message]
        [message]
            speaker=Mithalwe
            message= _ "The past has shown that your race cannot be trusted. Why should we treat with you now, when it is your inaction that has allowed this blight to grow unchecked; allowed it to ensnare your minds and consume your souls?"
        [/message]
        {DELAY 500}
        [message]
            speaker,image=Deoran,portraits/deoran-mad.webp
            message= _ "—but, but, I have scarcely been here a month! I could not have acted on something that began before my arrival! And besides, this all is the fault of the Urza brothe—"
        [/message]
        [message]
            speaker,image=Deoran,misc/blank-hex.png
            message= _ "(deep breath)"
        [/message]
        [message]
            speaker=Deoran
            message= _ "...honorable elves, I am commander Deoran, of Westin’s South Guard. I cannot speak for the past, but in the present we need your help."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Our farms and villages are plundered by criminals, casting dark spells and defiling the dead. Whence did they learn their grim power? How do we find the source of this spreading corruption, so that we may destroy it?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "I swear, my men and I will never succumb to the lure of dark magic! Good people from the Aethenwood, can you not be of aid?"
        [/message]
        {DELAY 500}
        [message]
            speaker=Ithelden
            message= _ "..."
        [/message]
        [message]
            speaker=Ithelden
            message= _ "...very well, outlander. The challenge is passed. Enter, and greet us as we are in life."
        [/message]
        {SOUND skill-illusion-quiet}
        {KILL side=6 ANIMATE=yes}
        [message]
            speaker=Deoran
            message= _ "What??"
        [/message]
        {DELAY 250}
        
        #############################
        # REPLACE THE MAP
        #############################
        {SOUND lightning.ogg}
        {SCREEN_FADER 255,255,255 255 250}
        {FADE_MUSIC_OUT 500}
        [replace_map]
            map_file=04b_Vale_of_Tears.map
            expand,shrink=yes,yes
        [/replace_map]
        {REMOVE_IMAGE 15 18}
        {PLACE_IMAGE scenery/great-tree-smashed.png 17 13}
        {PLACE_IMAGE scenery/great-tree-smashed.png 23 13}
        {PLACE_IMAGE scenery/great-tree-smashed.png 15 22}
        
        {SCREEN_FADER 000,000,000 255 250}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        {FADE_MUSIC_IN 100}
        
        #############################
        # REVEAL UNDEAD
        #############################
        [message]
            speaker=Deoran
            message= _ "They weren’t real elves at all! It was some kind of... prerecorded illusion? Half-alive echo? Was that something to help protect the valley from intruders?"
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"If that’s what it was, it didn’t work. Look!"
            MESSAGE_GERRICK=_"If that’s what it were, it dinnae work. Look!"
            MESSAGE_HYLAS=_"If such was the intent, it does not seem to have worked. Look!"
        }
        {SCROLL_TO 
        {REPLACE_SCENARIO_MUSIC the_dangerous_symphony.ogg}
        {APPEND_MUSIC siege_of_laurelmor.ogg}
        [scroll to Ethiliel, in a cage, surrounded by undead]
        "A cage of sturdy metal bars. A prolonged stay inside would be highly unpleasant."
        
        [message]
            speaker=Deoran
            message= _ "Undead, here?! And a caged elf — we have to break her free. Soldiers of the South Guard, prepare for battle!"
        [/message]

        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Break the trapped elf’s cage"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
#         
#         {RECALL_XY $companion_id 28 12} {MODIFY_UNIT id=$companion_id facing sw}
#         [redraw][/redraw]
#         {SCROLL_TO 18 18}
#         [message]
#             speaker=Ethiliel
#             message= _ "Yes, this is the place. We have arrived at the Vale of Blossoming Trees, where our great Sage Mebrin came many decades ago in search of peace and enlightenment.
# 
# Choose your words carefully in his presence, humans, for Mebrin is ancient and bore witness to King Haldric the First’s betrayal of the elves hundreds of years ago — he has no love for your kind."
#         [/message]
#         [message]
#             speaker=Ethiliel
#             message= _ "Some other Aethenwood elves also live nearby: mostly artisans inspired by the tranquility of this valley. I see no sign of them now, but they and Mebrin will doubtless come out to greet us as we approach."
#         [/message]
#         {MOVE_UNIT id=Ethiliel      21 16} [redraw]{BR}clear_shroud=yes{BR}[/redraw]
#         {MOVE_UNIT id=Deoran        23 16} [redraw]{BR}clear_shroud=yes{BR}[/redraw]
#         {MOVE_UNIT id=$companion_id 21 15}
#         [reset_fog]
#             reset_view=yes
#         [/reset_fog]
#         [redraw]{BR}clear_shroud=yes{BR}[/redraw]
#         
#         #############################
#         # NALMATH APPEARS
#         #############################
#         {DELAY 250}
#         {NAMED_UNIT 2 Rogue 18 18 "Urza Nalmath" _"Urza Nalmath" (
#             canrecruit,facing,animate=yes,sw,yes
#             [modifications]
#                 {TRAIT_RESILIENT}
#                 {TRAIT_STRONG}
#             [/modifications]
#         )}
#         [object]
#             {FILTER id="Urza Nalmath"}
#             [effect]
#                 apply_to=new_animation
#                 id=urza_nalmath_black_magic
#                 [animation]
#                     apply_to=black_magic
#                     start_time=0
#                     [frame]
#                         image="units/human-outlaws/rogue-defend-1.png:150"
#                     [/frame]
#                     [frame]
#                         image="units/human-outlaws/rogue.png"
#                         halo=halo/undead/dark-magic-[1~6].png:50
#                         halo_x,halo_y=0,0
#                     [/frame]
#                     [frame]
#                         image="units/human-outlaws/rogue-defend-1.png:150"
#                     [/frame]
#                     sound_start_time=-40
#                     [sound_frame]
#                         sound=magic-dark.ogg
#                     [/sound_frame]
#                 [/animation]
#             [/effect]
#         [/object]
# #define MAGIC
#         {DELAY 150}
#         [animate_unit]
#             {FILTER id="Urza Nalmath"}
#             flag=black_magic
#         [/animate_unit]
#         {DELAY 150}
# #enddef
#         {MAGIC}
#         {GENERIC_UNIT 2 "Walking Corpse" 19 19}{ANIMATE}
#         {GENERIC_UNIT 2 "Walking Corpse" 17 18}{ANIMATE}
#         {MAGIC} 
#         {GENERIC_UNIT 2 "Walking Corpse" 18 19}{ANIMATE}
#         {GENERIC_UNIT 2 "Walking Corpse" 15 15}{ANIMATE}
# #ifndef EASY
#         {MAGIC}
#         {GENERIC_UNIT 2 "Walking Corpse" 16 15}{ANIMATE}
#         {GENERIC_UNIT 2 "Walking Corpse" 17 15}{ANIMATE}
#         {MAGIC}
#         {GENERIC_UNIT 2 "Walking Corpse" 13 18}{ANIMATE}
#         {GENERIC_UNIT 2 "Walking Corpse" 15 19}{ANIMATE}
# #endif
#         {REPEAT {ON_DIFFICULTY 1 2 4} ( # create some nearby undead to harry the player, before the recruited units arrive en masse
#             {GENERIC_UNIT 2 "Walking Corpse" 34 15}
#             {GENERIC_UNIT 2 "Walking Corpse" 16 28}
#             {GENERIC_UNIT 2 "Walking Corpse"  8 20}
#             {GENERIC_UNIT 2 "Walking Corpse" 10 12}
#             {GENERIC_UNIT 2 "Walking Corpse" 20 5}
#             {GENERIC_UNIT 2 "Walking Corpse" 31 7}
#         )}
#         [event]
#             name=turn 2 # it's not possible for the player to have vision here on turn 2, so it's safe to delay
#             {REPEAT {ON_DIFFICULTY 0 0 2} ( # make it a little harder to camp in the top-right corner (this is also why the terrain there is poor)
#                 {GENERIC_UNIT 2 "Ghoul" 38 1}
#                 {GENERIC_UNIT 2 "Walking Corpse" 38 1}
#                 {GENERIC_UNIT 2 "Walking Corpse" 38 1}
#             )}
#         [/event]
#         
#         #############################
#         # NALMATH SPEAKS
#         #############################
#         [message]
#             speaker=Urza Nalmath
#             message= _ "Such a beautiful tingling in my fintertips! Intoxicating, exalting... the master’s magic whispers promises of life eternal, whispers beautiful secrets..."
#         [/message]
#         {MODIFY_UNIT id="Urza Nalmath" facing ne}
#         [message]
#             speaker=Ethiliel
#             message= _ "What!? How can this be! Humans, defiling our hidden valley? And are those... undead elves!?"
#         [/message]
#         [message]
#             speaker=Urza Nalmath
#             message= _ "Undead elves, undead men... all together, all at peace. Isn’t it beautiful? Isn’t it perfect?"
#         [/message]
#         [message]
#             speaker=Urza Nalmath
#             message= _ "Welcome, welcome. I’m so pleased to have visitors, for I’ve seen nary a living soul since the last of my living followers joined the hordes of eternal life."
#         [/message]
#         [harm_unit]
#             {FILTER id="Urza Nalmath"}
#             {FILTER_SECOND x,y=17,18}
#             [primary_attack]
#                 range=melee
#             [/primary_attack]
#             amount,type,hits=6,impact,yes
#             animate,delay=yes,0
#         [/harm_unit]
#         [harm_unit]
#             {FILTER id="Urza Nalmath"}
#             {FILTER_SECOND x,y=19,19}
#             [primary_attack]
#                 range=melee
#             [/primary_attack]
#             amount,type,hits=6,impact,yes
#             animate,delay=yes,0
#         [/harm_unit]
#         [message]
#             speaker=Urza Nalmath
#             message= _ "Ack! They’re still a little hungry, you see... <b><i>HUNGER</i></b>... But I suppose it’s no surprise, really, after what I’ve been busy doing every waking hour for the last nine months. Are you curious?"
#         [/message]
#         {DELAY 250} {MOVE_UNIT id=$companion_id 22 16} {DELAY 250}
#         [redraw]{BR}clear_shroud=yes{BR}[/redraw]
#         {SAY_COMPANION MESSAGE_GENERIC=_"<i>(don’t ask)</i>"}
#         {DELAY 250} {MOVE_UNIT id=Deoran        23 17} {MODIFY_UNIT id=Deoran facing sw} {DELAY 250}
#         [redraw]{BR}clear_shroud=yes{BR}[/redraw]
#         [message]
#             speaker=Deoran
#             message= _ "...err, what have you been doing?"
#         [/message]
#         [message]
#             speaker=Urza Nalmath
#             message= _ "Obsessively reanimating every last scholar, sage, and artist who used to live here. From the oldest grandfather to the youngest child, all who were once perished now live anew under my thrall."
#         [/message]
#         [message]
#             speaker=Urza Nalmath
#             message= _ "And as a result, your little band is now completely surrounded."
#         [/message]
#         {FADE_MUSIC_OUT 700}
#         
#         #############################
#         # SPAWN ENEMIES
#         #############################
#         [modify_side]
#             side=2,3
#             gold={ON_DIFFICULTY 9 18 36}
#             income={ON_DIFFICULTY -2 1 7}
#         [/modify_side]
#         [modify_side] # fewer enemies from the SE, since they also get the NE auto-spawns helping out
#             side=4,5
#             gold={ON_DIFFICULTY 6 12 24}
#             income={ON_DIFFICULTY -2 -1 1}
#             hidden=no
#         [/modify_side]
#         
# #define REVEAL_DO X Y WML
#         [lift_fog]
#             side,x,y,radius=1,{X},{Y},3
#         [/lift_fog]
#         {WML}
#         {DELAY 1000}
#         [reset_fog]
#             reset_view=yes
#         [/reset_fog]
#         [redraw]
#             clear_shroud=yes
#         [/redraw]
# #enddef
#         {GENERIC_UNIT 2 (Ghoul)          10  4} {FACING sw} {ZONE_GUARDIAN 10  4 x,y,radius=11,4,5}
#         {GENERIC_UNIT 2 (Ghoul)          15  4} {FACING se} {ZONE_GUARDIAN 15  4 x,y,radius=11,4,5}
#         {GENERIC_UNIT 2 (Necrophage)     12  7} {FACING se} {ZONE_GUARDIAN 12  7 x,y,radius=11,4,5}
#         {GENERIC_UNIT 2 (Walking Corpse) 11  8} {FACING se} {ZONE_GUARDIAN 11  8 x,y,radius=11,4,5}
#         {GENERIC_UNIT 2 (Walking Corpse) 11  7} {FACING sw} {ZONE_GUARDIAN 11  7 x,y,radius=11,4,5}
#         
#         {MODIFY_TERRAIN Ker 12 4} # don't put these on the map initially, because these hexes are visible through the fog in the beginning
#         {MODIFY_TERRAIN Cer^Edt 13 4}
#         {MODIFY_TERRAIN Cer^Qhh 12 3}
#         {MODIFY_TERRAIN Cer^Edt 12 5}
#         {MODIFY_TERRAIN Cer     11 5}
#         {MODIFY_TERRAIN Cer^Edt 15 4}
#         {MODIFY_TERRAIN Cer^Edt 11 7}
#         {MODIFY_TERRAIN Cer^Edt 11 8}
#         {MODIFY_TERRAIN Cer^Edt 12 7}
#         
#         {MOVE_UNIT id="Urza Nalmath" 14 9}
#         {REVEAL_DO 12 4 ({MOVE_UNIT id="Urza Nalmath" 12 4})}
#         [event]
#             name=new turn
#             {FULL_HEAL id="Urza Nalmath"}
#         [/event]
#         
#         {GENERIC_UNIT 3 (Ghoul)           4 24} {FACING ne} {ZONE_GUARDIAN  4 24 x,y,radius=5,27,4}
#         {GENERIC_UNIT 3 (Walking Corpse)  5 27} {FACING nw} {ZONE_GUARDIAN  5 24 x,y,radius=5,27,4}
#         {GENERIC_UNIT 3 (Walking Corpse)  6 24} {FACING nw} {ZONE_GUARDIAN  6 24 x,y,radius=5,27,4}
#         
#         {GENERIC_UNIT 3 (Ghoul)           1 24} {FACING ne} {GUARDIAN} # extra guards for the southwest leader, since he's the most accessible one
#         {GENERIC_UNIT 3 (Walking Corpse)  1 26} {FACING ne} {GUARDIAN} # we don't want to make the optimal strategy to attack and hide in the corner
#         {GENERIC_UNIT 3 (Walking Corpse)  2 25} {FACING ne} {GUARDIAN}
#         {GENERIC_UNIT 3 (Ghoul)           1 21} {FACING ne} {GUARDIAN}
#         {GENERIC_UNIT 3 (Walking Corpse)  3 21} {FACING ne} {GUARDIAN}
#         {GENERIC_UNIT 3 (Walking Corpse)  4 19} {FACING ne} {GUARDIAN}
#         {REVEAL_DO  5 26 ({SOUND zombie-hit-6.ogg} {NAMED_UNIT 3 Necrophage  5 26 necrophage3 "" (canrecruit,facing,animate=yes,se,yes)})}
#         
#         {GENERIC_UNIT 4 (Ghoul)          23 25} {FACING nw} {ZONE_GUARDIAN 23 25 x,y,radius=26,26,4}
#         {GENERIC_UNIT 4 (Walking Corpse) 27 28} {FACING nw} {ZONE_GUARDIAN 27 28 x,y,radius=26,26,4}
#         {GENERIC_UNIT 4 (Walking Corpse) 23 28} {FACING ne} {ZONE_GUARDIAN 23 28 x,y,radius=26,26,4}
#         {REVEAL_DO 25 26 ({SOUND zombie-hit-3.ogg} {NAMED_UNIT 4 Necrophage 25 26 necrophage4 "" (canrecruit,facing,animate=yes,sw,yes)})}
#         
#         {GENERIC_UNIT 5 (Ghoul)          37 15} {FACING nw} {ZONE_GUARDIAN 37 15 x,y,radius=38,16,3}
#         {GENERIC_UNIT 5 (Walking Corpse) 35 18} {FACING ne} {ZONE_GUARDIAN 36 18 x,y,radius=38,16,3}
#         {GENERIC_UNIT 5 (Walking Corpse) 37 19} {FACING nw} {ZONE_GUARDIAN 38 19 x,y,radius=38,16,3}
#         {REVEAL_DO 38 17 ({SOUND zombie-hit-4.ogg} {NAMED_UNIT 5 Necrophage 38 17 necrophage5 "" (canrecruit,facing,animate=yes,sw,yes)})}
#         
#         #############################
#         # EXPLAIN OBJECTIVES
#         #############################
#         [message]
#             speaker=Deoran
#             message= _ "It’s am ambush! I’ve never seen so many foes! Ethiliel, this is elvish territory — what do you suggest we do?"
#         [/message]
#         [message]
#             speaker=Deoran
#             message= _ "...Ethiliel? I know you must be distraught after what has happened to your friends, but—"
#         [/message]
#         [message]
#             speaker,image=Ethiliel,portraits/ethiliel-mad.webp
#             message= _ "Distraught? <b><i>Distraught!?</i></b> I am angry! This— this <b><i>vermin</i></b> has slain my people without mercy and defiled their body with dark magic! If even a single finger has been laid on my sage Mebrin..."
#         [/message]
#         [message]
#             speaker,image=Ethiliel,portraits/ethiliel-mad.webp
#             message= _ "Deoran, you claim the South Guard is a friend of the Aethenwood. Prove it! Aid me in destroying this vermin outlaw, lest the vengeance of the elves fall upon you and Westin alike!"
#         [/message]
#         [message]
#             speaker=Deoran
#             message= _ "I’m not sure this Urza is going to give us much choice. We’ll have to survive defending these ruins until he runs out of undead — now brace for incoming attack!"
#         [/message]
#         {REPLACE_SCENARIO_MUSIC the_dangerous_symphony.ogg}
#         {APPEND_MUSIC siege_of_laurelmor.ogg}
#         {FADE_MUSIC_IN 100}
#         
#         [display_tip]
#             title=_"Turn Limits"
#             image=tutor/turns.png
#             message=_"Most scenarios have a turn limit, as
# shown in the upper-left-hand-corner.
# Usually, running out of turns will
# result in defeat — check your
# <i><b>objectives</b></i> by clicking the <i><b>“Menu”</b></i>
# button in the top-left corner 
# (or use the hotkey <i><b>Ctrl+J</b></i>).
# 
# Finishing early will usually reward 
# a gold boost (“early finish bonus”) 
# in the next scenario, so don’t delay!
# 
# <i><b>In this scenario, your objective is 
# to survive until turns run out.</b></i>"
#         [/display_tip]
#         {VARIABLE sg_turns_explained yes}
#         
#         #############################
#         # OBJECTIVES
#         #############################
#         [objectives]
#             side=1
#             [objective]
#                 description= _ "Survive until turns run out"
#                 condition=win
#             [/objective]
#             {COMPANION_DEATH_OBJECTIVES}
#             [gold_carryover]
#                 bonus=no
#                 carryover_percentage=40
#             [/gold_carryover]
#         [/objectives]
#     [/event]
#     
#     
#     #######################################################################################################################################################
#     #                                                                 TIPS AND MISC EVENTS
#     #######################################################################################################################################################   
#     #############################
#     # TIP: FOG
#     #############################
#     [event]
#         name=turn 1
#         {TUTORIAL_ENABLE_CONDITION}
#         [message]
#             speaker=Deoran
#             message= _ "I’m not used to fighting in fog like this! What a mess..."
#         [/message]
#         [display_tip]
#             title=_"Fog and Vision"
#             image=tutor/fog.png
#             message=_"In fog, <b><i>units can see 1 hex further
# than their movement</i></b>. Fast units,
# such as Deoran, make for great
# scouts.
# 
# Clearing fog will prevent you from
# using “undo”, so be careful where
# you move!"
#         [/display_tip]
#     [/event]
#     
#     #############################
#     # TIP: INCOME AND SUPPORT
#     #############################
#     [event]
#         name=turn 5
#         {TUTORIAL_ENABLE_CONDITION}
#         [message]
#             speaker,image=narrator,wesnoth-icon.png
#             # we mentioned this in S01, but bring it up again since the player had a lot on their mind in S01
#             {TUTOR: _"Reminder: Each village you own generates 1 gold per turn, and supports 1 unit’s worth of upkeep. Level 2 units cost 2 upkeep, level 3 units cost 3 upkeep, etc. To ensure a healthy supply of gold, capture as many villages as you can!"}
#         [/message]
#     [/event]
#     
#     #############################
#     # TIP: CLIFFS
#     #############################
#     [event]
#         name=turn 9
#         {TUTORIAL_ENABLE_CONDITION}
#         [display_tip]
#             title=_"Bluffs and Gulches"
#             image=tutor/bluffs.png
#             message=_"Have you been wondering
# what effect these cliffs
# have on gameplay?
# 
# They... don’t actually
# do anything. But they
# do look pretty! <i>(or at
# least we devs think so)</i>"
#         [/display_tip]
#     [/event]
#     
#     #############################
#     # EMERGENCY GOLD BOOST
#     #############################
#     # give enemies a small gold boost when you get near them
#     # not massive, but enough that they at least appear to be fighting back
# #define EMERGENCY_GOLD_BOOST SIDE AMOUNT
#     [event]
#         name=moveto
#         {FILTER side=1}
#         {FILTER_CONDITION({HAVE_UNIT( side,count=1,3-99 {FILTER_LOCATION( radius=6 {FILTER side,canrecruit,radius={SIDE},yes} )} )})}
#         [gold]
#             side={SIDE}
#             amount={AMOUNT}
#         [/gold]
#     [/event]
#     [event]
#         name=moveto
#         {FILTER side=1}
#         {FILTER_CONDITION({HAVE_UNIT( side,count=1,4-99 {FILTER_LOCATION( radius=2 {FILTER side,canrecruit,radius={SIDE},yes} )} )})}
#         [gold]
#             side={SIDE}
#             amount={AMOUNT}
#         [/gold]
#     [/event]
# #enddef
#     {EMERGENCY_GOLD_BOOST 2 {ON_DIFFICULTY 10 15 20}}
#     {EMERGENCY_GOLD_BOOST 3 {ON_DIFFICULTY 10 15 20}}
#     {EMERGENCY_GOLD_BOOST 4 {ON_DIFFICULTY 10 15 20}}
#     {EMERGENCY_GOLD_BOOST 5 {ON_DIFFICULTY 10 15 20}}
#     
#     #############################
#     # REMIND ABOUT RECRUITING
#     #############################
#     [event]
#         name=recruit
#         {FILTER side=1}
#         {VARIABLE s03_units_recruited yes}
#     [/event]
#     [event]
#         name=recall
#         {FILTER side=1}
#         {VARIABLE s03_units_recalled yes}
#     [/event]
#     [event]
#         name=turn 5
#         {FILTER_CONDITION({VARIABLE_CONDITIONAL s03_units_recalled not_equals yes})}
#         {TUTORIAL_ENABLE_CONDITION}
#         [if] {VARIABLE_CONDITIONAL s03_units_recruited not_equals yes}
#             [then]
#                 [message]
#                     speaker=Deoran
#                     message= _ "I will need to recruit units if I want to weather the undead assault! I should first move to a keep, then press <b>Ctrl+R</b> to recruit or <b>Alt+R</b> to recall."
#                 [/message]
#                 {TUTORIAL_ARROW 18 18}
#                 {TUTORIAL_ARROW 16 15}
#                 [event]
#                     name=recruit
#                     {FILTER side=1}
#                     {REMOVE_ARROW}
#                 [/event]
#                 [event]
#                     name=clear_tips
#                     {REMOVE_ARROW}
#                 [/event]
#             [/then]
#             [else]
#                 [message]
#                     speaker=Deoran
#                     message= _ "I have recruited fresh soldiers, but not yet recalled any of my veterans! If I have high-XP survivors from my previous battles, I should press <b>Alt+R</b> to recall them so they can continue gaining experience."
#                 [/message]
#             [/else]
#         [/if]
#     [/event]
#     
#     #############################
#     # EXPLAIN POISON (AGAIN)
#     #############################
#     [event]
#         name=attacker hits
#         {FILTER type_adv_tree=Ghoul}
#         {FIRE_EVENT explain_poison}
#     [/event]
#     [event]
#         name=defender hits
#         {FILTER_SECOND type_adv_tree=Ghoul}
#         {FIRE_EVENT explain_poison}
#     [/event]
#     [event]
#         name=explain_poison
#         [event]
#             name=attack end
#             {TUTORIAL_ENABLE_CONDITION}
#             [display_tip]
#                 title=_"Poison"
#                 image=tutor/poison.png
#                 message=_"Ghouls inflict <i><b>poison</b></i> whenever they
# damage one of your units. A poisioned
# unit will lose <i><b>8 hitpoints</b></i> at the start
# of every turn. Poison can never kill a unit,
# but it can reduce them to 1 hitpoint!
# 
# Receiving healing from a village or
# a healer (such as Ethiliel) will also
# <i><b>cure poison.</b></i>"
#             [/display_tip]
#         [/event]
#     [/event]
#     
#     #############################
#     # EXPLAIN POISON (THE THIRD TIME)
#     #############################
#     [event]
#         name=new turn
#         {TUTORIAL_ENABLE_CONDITION}
#         {FILTER_CONDITION( {HAVE_UNIT( side,count,status=1,4-99,poisoned )} )}
#         [message]
#             speaker=Deoran
#             message= _ "So many of my soldiers are poisoned! I should end their turn on a village or next to Ethiliel, so they can begin to recover."
#         [/message]
#     [/event]
#     
#     #############################
#     # CAPTURE MEBRIN'S VILLAGE
#     #############################
#     [event]
#         name=capture
#         {FILTER x,y=18,11}
#         [message]
#             speaker=Ethiliel
#             message= _ "This is the sage Mebrin’s house, barricaded shut. He is surely in hiding. We must focus our efforts on defeating these undead!"
#         [/message]
#     [/event]
#     
#     
#     
#     
#     
#     #######################################################################################################################################################
#     #                                                                     VICTORY
#     #######################################################################################################################################################
#     [event]
#         name=time over
#         [message]
#             speaker,image=Deoran,portraits/deoran-glad.webp
#             message= _ "Look! The fog is fading! I think we’ve survived the attack!"
#         [/message]
#         [modify_side]
#             side,fog=1,no
#         [/modify_side]
#         {FIRE_EVENT ending_cutscene}
#     [/event]
#     [event]
#         name=last breath
#         {FILTER id="Urza Nalmath"}
#         {ACHIEVE s03}
#         {MODIFY_UNIT id="Urza Nalmath" hitpoints 11}
#         {FIRE_EVENT ending_cutscene}
#     [/event]
#     [event]
#         name=ending_cutscene
#         #############################
#         # GURANTEE UNIT POSITIONS
#         #############################
#         {PUT_TO_RECALL_LIST x,y=10,4}
#         {PUT_TO_RECALL_LIST x,y=11,5}
#         {PUT_TO_RECALL_LIST x,y=12,5}
#         {PUT_TO_RECALL_LIST x,y=13,4}
#         {PUT_TO_RECALL_LIST x,y=13,5}
#         {RECALL_XY Deoran 15 7}
#         {RECALL_XY $companion_id 15 7}
#         {RECALL_XY Ethiliel 15 7}
#         {PUT_TO_RECALL_LIST x,y=12,4}
#         {RECALL_XY "Urza Nalmath" 12 4}
#         
#         #############################
#         # SUMMONING SKELETONS
#         #############################
#         [message]
#             speaker=Urza Nalmath
#             message= _ "No, my magic is waning! The beautiful whispers are fading! My hands shake, my face sweats; I need you back, please... I can’t bear to experience the world like this!"
#         [/message]
#         [message]
#             speaker=Urza Nalmath
#             message= _ "More power, I need more powerful minions. More power will exalt me again, intoxicate me again! The others warned me not to, but the master always told what I needed to know. Yes, yes!"
#         [/message]
#         {MAGIC} {GENERIC_UNIT 2 Revenant          13 4} {ANIMATE}
#         {MAGIC} {GENERIC_UNIT 2 Skeleton          12 3} {ANIMATE}
#         {MAGIC} {GENERIC_UNIT 2 "Skeleton Archer" 12 5} {ANIMATE}
#         {MAGIC} {GENERIC_UNIT 2 Deathblade        11 5} {ANIMATE}
#         {SAY_COMPANION
#             MESSAGE_MARI=_"Skeletons! Watch out rookie, these things are nasty!"
#             MESSAGE_GERRICK=_"Look sharp, skeletons! Those old bones are comin’ straight for us!"
#             MESSAGE_HYLAS=_"Skeletons! This makes for an unpleasant surprise."
#         }
#         
#         #############################
#         # SKELETONS TURN ON NALMATH
#         #############################
#         [harm_unit]
#             {FILTER id="Urza Nalmath"}
#             {FILTER_SECOND x,y=11,5}
#             [primary_attack]
#                 range=melee
#             [/primary_attack]
#             amount,type,hits=7,blade,yes
#             animate,delay=yes,0
#             kill=no
#         [/harm_unit]
#         [harm_unit]
#             {FILTER id="Urza Nalmath"}
#             {FILTER_SECOND x,y=12,3}
#             [primary_attack]
#                 range=melee
#             [/primary_attack]
#             amount,type,hits=7,blade,yes
#             animate,delay=yes,0
#             kill=no
#         [/harm_unit]
#         [message]
#             speaker=Urza Nalmath
#             message= _ "Nnrrgh!! No, I created you! Attack them, not me! The master never taught me how to control these things!"
#         [/message]
#         [harm_unit]
#             {FILTER id="Urza Nalmath"}
#             {FILTER_SECOND x,y=13,4}
#             [primary_attack]
#                 range=melee
#             [/primary_attack]
#             amount,type,hits=7,blade,yes
#             animate,delay=yes,0
#             kill=no
#         [/harm_unit]
#         [message]
#             speaker=Urza Nalmath
#             message= _ "You won’t even exist without me! My power is what keeps you standing! You’re sealing your own re-deaths!"
#         [/message]
#         [message]
#             type=Revenant # because its portrait is pretty
#             message= _ "More... power..."
#         [/message]
#         [message]
#             type=Deathblade # because its portrait is pretty
#             message= _ "More... death..."
#         [/message]
#         [harm_unit]
#             {FILTER id="Urza Nalmath"}
#             {FILTER_SECOND x,y=11,5}
#             [primary_attack]
#                 range=melee
#             [/primary_attack]
#             amount,type,hits=999,blade,yes
#             animate,delay=yes,0
#             kill=yes
#         [/harm_unit]
#         {KILL type=Skeleton          ANIMATE=YES}
#         {KILL type="Skeleton Archer" ANIMATE=YES}
#         {KILL type=Deathblade        ANIMATE=YES}
#         {KILL type=Revenant          ANIMATE=YES}
#         {KILL side=2,3,4,5}
#         {FADE_MUSIC_OUT 1000}
#         {REPLACE_SCENARIO_MUSIC silence.ogg}
#         {FADE_MUSIC_IN 100}
# 
#         #############################
#         # DETENTE
#         #############################
#         [message]
#             speaker,image=Deoran,portraits/deoran-mad.webp
#             message= _ "Slain by his own creations; a fitting end for such a villain! It’s finally over, then? This will make for an interesting report back in town."
#         [/message]
#         {MOVE_UNIT id=Ethiliel 17 13}
#         [message]
#             speaker=Ethiliel
#             message= _ "Mebrin? Sage Mebrin, it is I, Ethiliel! Are you hiding? You can come out!"
#         [/message]
#         {MOVE_UNIT id=Ethiliel 18 11}
#         [message]
#             speaker=Ethiliel
#             message= _ "His home is empty... but there’s no sign of a struggle..."
#         [/message]
#         [message]
#             speaker,image=Deoran,portraits/deoran-sad.webp
#             message= _ "I’m afraid he’s almost certainly been killed, Ethiliel. This valley looks to have fallen many months ago, and neither the Urza brothers nor their mysterious “master” seem the type to take prisoners."
#         [/message]
#         [message]
#             speaker,image=Ethiliel,portraits/ethiliel-mad.webp
#             message= _ "Do not say such things! No, my old teacher is wise and powerful, even in his old age. I refuse to believe Mebrin could have been slain by a handful of humans. We must find him!"
#         [/message]
#         {MOVE_UNIT id=Ethiliel 15 17} {DELAY 500}
#         {MOVE_UNIT id=Ethiliel 18 17} {DELAY 500}
#         {MOVE_UNIT id=Ethiliel 16 18} {DELAY 500}
#         [message]
#             speaker=Ethiliel
#             message= _ "I see footprints here. A crude track leads from this valley away to the south, a track made by feet both human and undead."
#         [/message]
#         [message]
#             speaker=Deoran
#             message= _ "I don’t suppose there’s any chance of reporting back to Westin? I truly want to help you, but this is also getting far beyond the scope of my original assignment, and I’m still just a junior commander!"
#         [/message]
#         [message]
#             speaker,image=Ethiliel,portraits/ethiliel-mad.webp
#             message= _ "<i>(glares)</i>"
#         [/message]
#         [message]
#             speaker=Deoran
#             message= _ "On second thought, you’re right, let’s go. <i>(And let’s make sure not to give her a reason to turn her rage — and the armies of the elves — against Westin...)</i>"
#         [/message]
#         
#         {CLEAR_VARIABLE s03_units_recruited,s03_units_recalled}
#         [endlevel]
#             result=victory
#             bonus=yes # usually 0 because turns are over, but if we rushed down the bandit we may get a bonus
#             {NEW_GOLD_CARRYOVER 40}
#         [/endlevel]
#     [/event]
[/scenario]
