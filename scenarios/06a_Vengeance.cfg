#textdomain wesnoth-tsg


[scenario]
    id=06a_Vengeance
    map_file=06a_Vengeance.map
    name= _ "Vengeance"
    next_scenario=06a_Vengeance
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER}
    
    {DEFAULT_SCHEDULE}
    turns=20
    
    {SCENARIO_MUSIC nunc_dimittis.ogg}
    {EXTRA_SCENARIO_MUSIC heroes_rite.ogg}
    
    {SG_LONGMARCH}
    {TSG_BIGMAP {JOURNEY_06a_NEW} }
    
    
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=good
        user_team_name=_"South Guard"
        gold=30
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
    [/side]
    
    #############################
    # TOWN GUARD
    #############################
    [side]
        side,controller,color=2,ai,wesred
        gold,income=15,{ON_DIFFICULTY 0 2 4}
        recruit=Spearman
        team_name=good
        user_team_name=_"Westin"
        no_leader=yes
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Bowman"   1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Woodsman" 2}
#define MAIN_AVOID_AREA
    x=0-23,  24,  24, 25,  25, 26,  26, 27,  27, 28, 28,   28, 29,  29,   30,   31,   32,   33
    y=0-99, 0-4,6-99,0-4,7-99,0-3,6-99,0-5,7-99,0-4,7-9,11-99,0-5,8-99,12-99,10-99,10-99,11-99
#enddef
    [event]
        name=side 2 turn refresh
        first_time_only=no
        {RESET_SIDE_AI 2 no -1 1}
        {MODIFY_SIDE_AI 2 ([avoid]
            {MAIN_AVOID_AREA}
        [/avoid])}
        
        # prevent our crucial units from getting themselves killed
        {MODIFY_UNIT side,id=2,Mari moves 0}
        {MODIFY_UNIT side,id=2,"Sir Gerrick" moves 0}
        {MODIFY_UNIT side,id=2,"Minister Hylas" moves 0}
        {MODIFY_UNIT side,id=2,Asheviere moves 0}
        
        # if we have units out of the main area, use a MAI to have them retreat
        [micro_ai]
            side,action,type=2,add,coward
            {FILTER( {FILTER_LOCATION {MAIN_AVOID_AREA}} )}
            distance,attack_if_trapped=20,yes
            seek_x,seek_y=31,7
        [/micro_ai]
        
        # if the player is being aggressive (and we have extra soldiers) we should help out
        [if]{HAVE_UNIT( side,count=2,5-999 )}
            {HAVE_UNIT( side,count=1,3-999 {FILTER_LOCATION( x,y,radius=14,9,6 {OR x,y,radius=1,9,11} )} )}
            [then]
                [micro_ai]
                    side,action,type=2,delete,coward
                [/micro_ai]
                {RESET_SIDE_AI 2 offensive 0.4 0.25}
                {MODIFY_SIDE_AI 2 ([avoid]
                    x=0-10,  11,  11, 12,  12, 13,   13, 14,   14, 15,   15, 16,   16, 17,   17, 18,   18, 19,   19, 20,   20, 21-99
                    y=0-99, 0-6,8-99,0-6,9-99,0-5,10-99,0-3,12-99,0-5,13-99,0-7,14-99,0-7,15-99,0-8,15-99,0-7,18-99,0-7,17-99, 19-99
                [/avoid])}
            [/then]
        [/if]
    [/event]
    
    #############################
    # ELVES
    #############################
    [side]
        side,controller,color=3,ai,green
        type,facing=Elvish Captain,ne
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_STRONG}
        [/modifications]
        gold,income={ON_DIFFICULTY 15 30 45},{ON_DIFFICULTY 0 2 4}
        recruit=Elvish Fighter
        team_name,user_team_name=elves,_"Aethenwood"
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Elvish Archer" ({ON_DIFFICULTY 0 1 1})}
    [side]
        side,controller,color=4,ai,green
        type,facing=Elvish Hero,ne
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
        gold,income={ON_DIFFICULTY 15 30 45},{ON_DIFFICULTY 0 2 4}
        recruit=Elvish Fighter
        team_name,user_team_name=elves,_"Aethenwood"
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Elvish Archer" ({ON_DIFFICULTY 1 1 2})}
    [side]
        side,controller,color=5,ai,green
        type,facing=Elvish Sorceress,ne
        [modifications]
            {TRAIT_QUICK}
            {TRAIT_STRONG}
        [/modifications]
        gold,income={ON_DIFFICULTY 15 30 45},{ON_DIFFICULTY 0 2 4}
        recruit=Elvish Shaman
        team_name,user_team_name=elves,_"Aethenwood"
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Elvish Fighter" ({ON_DIFFICULTY 0 1 2})}
    [event]
        name=side 3 turn
        first_time_only=no
        {RESET_SIDE_AI 3,4,5 offensive 0.4 0.25}
        {MODIFY_SIDE_AI 3,4,5 retreat_factor=0.75}
        {VARY_AI_BY_SCHEDULE 3,4,5}
        {MODIFY_SIDE_AI 3,4,5 ({GOAL_LOCATION 9 x,y=31,7})}
    [/event]
    
    # Ethiliel
    [side]
        side=6
        color=green
        controller=ai
        team_name=elves
        no_leader,hidden=yes,yes
        gold,income=0,-2
    [/side]
    [event]
        name=side 6 turn refresh
        first_time_only=no
        {RESET_SIDE_AI 6 no 0.4 0.25}
        {MODIFY_UNIT id=Ethiliel moves 3} # enough to reach a village if she needs healing
        {MODIFY_SIDE_AI 6 ({GOAL_LOCATION 99 x,y=4,6})}
        {MODIFY_AI_DELETE_CANDIDATE_ACTION 6 main_loop move_leader_to_keep}
    [/event]
    
    
    
    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        
        #############################
        # WESTIN SCENERY
        #############################
        [item]
            halo="units/statue-westin.png~FL()"
            x,y=31,9
        [/item]
        {PLACE_IMAGE halo/stairway.png 31 7}
        
        {PLACE_IMAGE scenery/temple1.png 28 5}
        {PLACE_IMAGE scenery/tent-fancy-red.png 24 13}
        {PLACE_IMAGE scenery/tent-shop-weapons.png 25 14}
        
        {PLACE_IMAGE items/archery-target-right.png 16 12}
        {PLACE_IMAGE items/archery-target-right.png 17 12}
        
        {BRAZIER_ILLUMINATION 26 8}
        {BRAZIER_ILLUMINATION 30 9}
        {BRAZIER_ILLUMINATION 25 13}
        
        #############################
        # ELVES
        #############################
        [unstore_unit]
            variable=stored_ethiliel
            side,x,y,facing=6,4,9,se
        [/unstore_unit]
        {GENERIC_UNITC 3 (Elvish Druid  )  13  9  ({ZONE_GUARDIAN 13  9 x,y,radius=13,10,4})}
        {GENERIC_UNITC 3 (Elvish Fighter)  16  8  ({ZONE_GUARDIAN 16  8 x,y,radius=13,10,4})}
        {GENERIC_UNITC 4 (Elvish Archer )   3 16  ({ZONE_GUARDIAN  3 16 x,y,radius=1,12,7})}
        {GENERIC_UNITC 4 (Elvish Archer )   1 17  ({ZONE_GUARDIAN  1 17 x,y,radius=1,12,7})}
        {GENERIC_UNITC 4 (Elvish Fighter)   2 14  ({ZONE_GUARDIAN  2 14 x,y,radius=1,12,7})}
        {GENERIC_UNITC 5 (Elvish Fighter)   4  6  ({ZONE_GUARDIAN  4  6 x,y,radius=1,7,10})}
        {GENERIC_UNITC 5 (Elvish Fighter)   1  6  ({ZONE_GUARDIAN  1  6 x,y,radius=1,7,10})}
        {GENERIC_UNITC 5 (Elvish Archer )   4  3  ({ZONE_GUARDIAN  4  3 x,y,radius=1,7,10})}
        {GENERIC_UNITC 5 (Elvish Archer )   3  3  ({ZONE_GUARDIAN  3  3 x,y,radius=1,7,10})}
        
        # archers are good against Deoran. These guys are here to hinder him if he tries to run straight in
        {GENERIC_UNITC 3 ({ON_DIFFICULTY "none" "Elvish Archer" "Elvish Archer")  22 15   ({ZONE_GUARDIAN 22 15 x,y,radius=23,16,7})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY "none" "Elvish Archer" "Elvish Archer")  19 17   ({ZONE_GUARDIAN 19 17 x,y,radius=23,16,7})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY "none" "none"          "Elvish Archer")  23 17   ({ZONE_GUARDIAN 23 17 x,y,radius=23,16,7})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY "none" "none"          "Elvish Archer")  25 15   ({ZONE_GUARDIAN 25 15 x,y,radius=23,16,7})}
        
        #############################
        # HEROES
        #############################
        [unit]
            side,x,y,facing=2,1,1,sw
            {SINGLEUNITWML_HYLAS}
        [/unit]
        [unit]
            side,x,y,facing=2,1,1,sw
            {SINGLEUNITWML_GERRICK}
        [/unit]
        [unit]
            side,x,y,facing=2,1,1,sw
            {SINGLEUNITWML_MARI}
        [/unit]
        {KILL side,id=2,$companion_id} # our companion is still on our recall list
        [if] {HAVE_UNIT side,id=2,"Minister Hylas"}
            [then]
                {MODIFY_UNIT   side,id=2,"Minister Hylas" canrecruit yes}
                {TELEPORT_UNIT side,id=2,"Minister Hylas" 32 8}
                
                {TELEPORT_UNIT side,id=2,Mari             30 7}
                {TELEPORT_UNIT side,id=2,"Sir Gerrick"    30 7}
            [/then]
            [else]
                {MODIFY_UNIT   side,id=2,"Sir Gerrick"    canrecruit yes}
                {TELEPORT_UNIT side,id=2,"Sir Gerrick"    32 8}
                
                {TELEPORT_UNIT side,id=2,Mari             30 7}
                {TELEPORT_UNIT side,id=2,"Minister Hylas" 30 7}
            [/else]
        [/if]
        [capture_village]
            side,x,y=2,23-99,0-15
        [/capture_village]
        
        [unit]
            side,x,y,facing=2,31,7,sw
            {SINGLEUNITWML_ASHEVIERE}
        [/unit]
        
        #############################
        # TOWN GUARDS
        #############################
        {GENERIC_UNITC 2 Spearman  24  5  ({ZONE_GUARDIAN 24  5 x,y,radius=24,5,1})}
        {GENERIC_UNITC 2 Spearman  28 10  ({ZONE_GUARDIAN 28 10 x,y,radius=28,10,1})}
        {GENERIC_UNITC 2 Peasant   28  6  ()}
        {GENERIC_UNITC 2 Woodsman  33  4  ()}
        {GENERIC_UNITC 2 Peasant   30  8  ()}
        
        {SCROLL_TO 32 8}
    [/event]

    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        #############################
        # GETTING TOWNSFOLK TO SAFETY 
        #############################
#         [start scrolled to Westin]
#         [townsfolk move into cellars. Asheivere moves on top]
        {SAY_IF_HAVE
            "Sir Gerrick" " C‘mon, keep movin‘, everyone get underground. We don‘ have much time left ‘til—"
            Mari "Could you go any slower? Come on, everyone get underground. We don‘t have much time left until—"
        }
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "This is your last warning, humans. Return to us our sage or I shall be forced to resume our attack!"
        [/message]
        
        #############################
        # DEORAN ARRIVES 
        #############################
        {SCROLL_TO               9 30} {DELAY 500}
        {RECALL_XY Deoran        9 30} {DELAY 500}
        {RECALL_XY $companion_id 8 30} {DELAY 500}
        
        [message]
            speaker,image=Deoran,portraits/deoran-mad.webp
            message= _ "Ethiliel! What is going on here! What have you done?!"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "Deoran — good, you‘re here. And even better, I see you no longer shelter that snake Afalas! Does this mean you humans have reconsidered your decisions, and have finally freed Mebrin from his bonds?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Mebrin is dead, Ethiliel. Afalas was right. I saw the lich Mal M’Brin with my own two eyes, heard his ravings with my own two ears! I watched him raise the dead up out of the ground!"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "Then where is his corpse, human? Where is the evidence for the horrible things of which you accuse? I have known Mebrin my whole life — you, scarely months. Who shall I believe?"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "No, I felt Mebrin‘s elfin presence. I felt him reaching out to me, I felt him in pain! No elf would fall to undeath, much less our wisest teacher."
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "I don‘t know why you won‘t just admit what you‘ve truly done with him — you fool humans‘ stubbornness will be all of your undoing! Until you return Mebrin to us I have no choice but to continue our attack!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Ethiliel, listen to yourself! ...there‘s no reasoning with her, is there?"
        [/message]
        
        #############################
        # DISCUSSING WHAT TO DO 
        #############################
        {MOVE_UNIT id=Deoran 10 28} {DELAY 150}
        {MODIFY_TERRAIN Ke 10 28} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Ce  9 27} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Ce 10 28} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Ce 11 28} [redraw][/redraw] {DELAY 150}
        
        [message]
            speaker=Deoran
            message= _ "Whether this rage is Ethiliel‘s herself, Mebrin‘s mischief, or a mix of both, it‘s clear that words alone are not going to change her mind."
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"Time to take her down, then? ."
            MESSAGE_GERRICK=_""
            MESSAGE_HYLAS=_""
        }
        [message]
            speaker=Deoran
            message= _ "No, absolutely not. I‘ve spent enough time with Ethiliel to understand her and her home. If we attack and kill an elf of this importance, never again in our lifetimes will there be peace between Wesnoth and the Aethenwood."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Instead we make for Westin. We rendezvous with the town defenders and hold the walls — the righteous fury that drives Ethiliel can only burn for so long. Once the dust settles, the elves may finally be willing to talk."
        [/message]
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            side=1
            [objective]
                description= _ "Reach Westin, then survive until turns run out"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Deoran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Asheviere"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Ethiliel"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
        [/objectives]
    [/event]
    
    #############################
    # REFUND ELVISH GOLD
    #############################
    [event]
        name=last breath
        {FILTER side=3,4,5}
        [message]
            speaker=unit
            message= _ "My kin will avenge me! For every one of us you strike down... more will come..."
        [/message]
        [event]
            name=die
            {DELAY 250}
            [message]
                speaker=Deoran
                message= _ "Every elf who dies only serves to further enrage the rest, drawing more warriors out of the Aethenwood!"
            [/message]
        [/event]
    [/event]
    [event]
        name=die
        first_time_only=no
        {FILTER side=3,4,5}
        [gold]
            side,amount=$unit.side,$unit.cost
        [/gold]
        [floating_text]
            x,y=$unit.x,$unit.y
            text= _ "<span color='#FFD700' size='x-small'>$unit.cost gold refunded</span>"
        [/floating_text]
    [/event]
#define TRANSFER_DEAD_LEADER_GOLD DEAD_SIDE LIVE_SIDE
    [event]
        name=new turn
        first_time_only=no
        {FILTER_CONDITION( {NOT({HAVE_UNIT side,canrecruit=3,yes})} )}
        [store_gold]
            side={DEAD_SIDE}
        [/store_gold]
        [gold]
            side,amount={LIVE_SIDE},$gold
        [/gold]
        [modify_side]
            side,gold={DEAD_SIDE},0
        [/modify_side]
        {CLEAR_VARIABLE gold}
    [/event]
#enddef
    {TRANSFER_DEAD_LEADER_GOLD 3 4}
    {TRANSFER_DEAD_LEADER_GOLD 4 5}
    {TRANSFER_DEAD_LEADER_GOLD 5 3}
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                DEORAN REACHES WESTIN
    #######################################################################################################################################################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION( radius=2 {FILTER side=2} )} )}
        
        
        
        [command]
            [capture_village]
                owner_side,side=2,1
            [/capture_village]
            {MODIFY_UNIT side,canrecruit=2,yes canrecruit no}
            {MODIFY_UNIT (side=2 {NOT id=Asheviere}) side 1}
        [/command]
        
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            side=1
            [objective]
                description= _ "Survive until turns run out"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Deoran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Asheviere"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Ethiliel"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
        [/objectives]
        
        #############################
        # FLAVOR
        #############################
        [event]
            name=new turn
            [event]
                name=new turn
                [event]
                    name=new turn
                    [message]
                        speaker=Deoran
                        message= _ "I curse our isolation, so far removed from the great cities of the north. The capitol garrison alone would make Westin‘s walls impenetrable, if only the city defenders could have contacted them in time!"
                    [/message]
                    # it's possible but extremely unlikely that both Hylas and Gerrick are dead here
                    {SAY_IF_HAVE
                        Mari _"That‘s assuming Weldyn would even bother to help out a podunk like this. Capitol of the southern province, sure, but that‘s not saying much. Without magistrate Fiore‘s capitol connections, I doubt anybody — you and I included — would much care what happened here."
                        "Minister Hylas" "Even then, Westin is small and inaccessible, and thus easy for others to overlook. Magistrate Fiore‘s political connections are the better part of the reason we have any significance at all — as well as the reason you were deployed here, Deoran."
                    }
                    {SAY_IF_HAVE
                        Gerrick "O‘ course, without them connections Fiore wouldn‘t‘ve needed to leave for Weldyn last month, an‘ then we might‘ve still had ‘is escort here t‘ help fight... "
                        Mari "Of course, without those political connections the magistrate wouldn‘t have had to leave for Weldyn last month, and we would‘ve still had his escort here to help fight..."
                    }
                [/event]
            [/event]
        [/event]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                 VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # ETHILIEL DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Ethiliel}
        [message]
            speaker=Ethiliel
            message = _"Mebrin, I’m sorry... I tried..."
        [/message]
        [event]
            name=die
            [message]
                speaker=Deoran
                message = _"Ethiliel is dead! Even if we win by force of arms today, there will never again be peace between Wesnoth and the Aethenwood..."
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
    [/event]
    
    
#     
#     #############################
#     # VICTORY
#     #############################
#     [event]
#         name=moveto
#         {FILTER( side=1 {FILTER_LOCATION {NORTH_OF_RIVER}} )}
#         {FILTER_CONDITION( {HAVE_UNIT( id=Deoran        {FILTER_LOCATION {NORTH_OF_RIVER}} )} )}
#         {FILTER_CONDITION( {HAVE_UNIT( id=$companion_id {FILTER_LOCATION {NORTH_OF_RIVER}} )} )}
#         [message]
#             speaker=Deoran
#             message = _"At last — we have crossed the river, and reached refuge. Who is in command of here?"
#         [/message]
#         [message]
#             side,level=2,2
#             message = _ "I am, lieutenant Deoran. And we’re relieved to see you and $companion_name alive and well! News was that you and your entire company had likely been lost in combat with the elves."
#         [/message]
#         [message]
#             speaker=Deoran
#             message = _ "Then the Aethenwood has attacked you as well? I had hoped your hamlet would serve a safe haven, but you will find myself and my men at the ready if we are needed to defend Southport."
#         [/message]
#         [message]
#             side,level=2,2
#             message = _ "Defend Southport? No— ...well, you’ll see soon enough. Sir, you should get back to Westin right away."
#         [/message]
#         
#         {CLEAR_VARIABLE ranger_delay,ranger_heal,stored_rangers,ranger_ai}
#         [endlevel]
#             result=victory
#             bonus=yes
#             {NEW_GOLD_CARRYOVER 40}
#         [/endlevel]
#     [/event]
#     
#     
#     #############################
#     # TIME OVER
#     #############################
#     [event]
#         name=turn {TURN_WARNING}
#         [message]
#             speaker=Deoran
#             message= _ "We must hurry north across the river! Should we delay too long in reaching safety, we shall surely fall to the elves."
#         [/message]
#         [message]
#             speaker,image=narrator,wesnoth-icon.png
#             {TUTOR: _"You are running out of turns to complete this scenario! See your objectives by pressing Ctrl+J, and remember that the turn limit can be seen in the top-left-hand corner."}
#         [/message]
#     [/event]
#     [event]
#         name=side 1 turn {TURN_LIMIT} end
#         [remove_shroud]
#             side,x,y,radius=1,8,1,2
#         [/remove_shroud]
#         [lift_fog]
#             side,x,y,radius=1,8,1,2
#         [/lift_fog]
#         {GENERIC_UNIT 2 Fencer 8 1} {ANIMATE}
#         [message]
#             side,type=2,Fencer
#             message= _ "Urgent news from Westin! The town has fallen, Westin has fallen to the elves! Run for your lives, for the elves come to kill us all!"
#         [/message]
#         [message]
#             speaker=Deoran
#             message= _ "No! How can this be? We were too slow returning home, and now there is no home to return to!"
#         [/message]
#         [message]
#             speaker,image=narrator,wesnoth-icon.png
#             {TUTOR: _"You have run out of turns to complete the scenario, and have been defeated!"}
#         [/message]
#         [endlevel]
#             result=defeat
#         [/endlevel]
#     [/event]
    
[/scenario]



