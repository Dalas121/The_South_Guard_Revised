#textdomain wesnoth-tsg


#define TURN_LIMIT
25#enddef

[scenario]
    id=06b_The_Tides_of_War
    map_file=06b_The_Tides_of_War.map
    name= _ "The Tides of War"
    next_scenario=06b_The_Tides_of_War
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER}
    
    {DEFAULT_SCHEDULE_MORNING} # remember that the braziers' ToD is tied to this. There are also ToD dialogue events
    turns={TURN_LIMIT}
    
    {SCENARIO_MUSIC nunc_dimittis.ogg}
    {EXTRA_SCENARIO_MUSIC heroes_rite.ogg}
    
    {SG_TIDES}
    {TSG_BIGMAP {JOURNEY_06b_NEW} }
    
    
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=good
        user_team_name=_"South Guard"
        gold=20
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
    [/side]
    
    #############################
    # ELVES (ALSO ASHEVIERE)
    #############################
    [side]
        side=2
        color=green
        controller=ai
        team_name=good
        no_leader,hidden=yes,yes
        recruit=Elvish Fighter # no archers. Archers are signature units, but pretty useless vs skeletons
        {FLAG_VARIANT wood-elvish}
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Elvish Shaman"    3}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Elvish Sorceress" 1}
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2 defensive 0.6 0.2}
        {VARY_AI_BY_SCHEDULE_NIGHTTIME 2}
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 99 x,y=24,29})}
        {MODIFY_SIDE_AI 2 retreat_factor=0.75}
        {MODIFY_AI_DELETE_CANDIDATE_ACTION 2 main_loop grab_villages} # go straight for the undead; don't spread out and cap villages (unless we retreat to them for healing)
    [/event]
    
    #############################
    # UNDEAD
    #############################
#define UNDEAD_SIDE SIDE INITIAL_GOLD INITLAL_INCOME RECRUITS
    [side]
        side={SIDE}
        color=black
        controller=ai
        no_leader=yes
        team_name=undead
        user_team_name=_"Undead"
        gold,income={INITIAL_GOLD},{INITLAL_INCOME}
        recruit={RECRUITS}
        {FLAG_VARIANT undead}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 1}
#enddef
    {UNDEAD_SIDE 3 {ON_DIFFICULTY 50 100 150} {ON_DIFFICULTY  3  8 13} "Skeleton Archer"}
    {UNDEAD_SIDE 4 {ON_DIFFICULTY 25  50  75} {ON_DIFFICULTY -1  1  3} "Walking Corpse"}
    {UNDEAD_SIDE 5 {ON_DIFFICULTY 20  40  60} {ON_DIFFICULTY -2 -1  0} "Walking Corpse"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 Skeleton         {ON_DIFFICULTY 1 2 3}} # (1 guard) Prefer archers over skeletons, to make mages (e.g. choosing Hylas) less strong
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Walking Corpse" {ON_DIFFICULTY 2 4 6}} # recruit some corpses (alongside the ghoul sides), so the player's pierce damage units are still useful
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Ghoul            {ON_DIFFICULTY 0 1 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Ghoul            {ON_DIFFICULTY 0 1 2}}
    [event]
        name=side 3 turn
        first_time_only=no
        {RESET_SIDE_AI 3   offensive 0.6 0.2}
        {RESET_SIDE_AI 4,5 offensive 0.9 0.1}
        {VARY_AI_BY_SCHEDULE 3,4,5}
        {MODIFY_SIDE_AI 3,4,5 retreat_factor=0}
        [if] {HAVE_UNIT id=Ethiliel}
            [then]
                {MODIFY_SIDE_AI 3,4,5 ([goal]
                    name=target_unit
                    [criteria]
                        race=elf # not side=2 because that includes Asheviere
                    [/criteria]
                    value=10
                [/goal])}
            [/then]
        [/if]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        
        #############################
        # SCENERY
        #############################
        {BRAZIER_ILLUMINATION_MORNING 18 8}
        {BRAZIER_ILLUMINATION_MORNING 22 9}
        {BRAZIER_ILLUMINATION_MORNING 17 13}
        
        {PLACE_IMAGE halo/stairway.png 23 7}
        {PLACE_IMAGE scenery/temple1.png 20 5}
        {PLACE_IMAGE scenery/tent-fancy-red.png 16 13}
        {PLACE_IMAGE scenery/tent-shop-weapons.png 17 14}
        [item]
            halo="units/statue-westin.png~FL()"
            x,y=23,9
        [/item]
        
        #############################
        # UNDEAD
        #############################
        [unit]
            side,x,y,facing=3,24,29,nw
            {SINGLEUNITWML_MEBRIN}
        [/unit]
        [unit]
            side,x,y,facing=4,4,27,nw
            type=Necrophage
        [/unit]
        [unit]
            side,x,y,facing=5,34,20,nw
            type=Necrophage
        [/unit]
        {GENERIC_UNITC 3 {ON_DIFFICULTY "Skeleton Archer" "Bone Shooter"    "Banebow"     } 21 28 ({ZONE_GUARDIAN 21 28 x,y,radius=24,29,4})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY "Skeleton Archer" "Bone Shooter"    "Banebow"     } 25 30 ({ZONE_GUARDIAN 25 30 x,y,radius=24,29,4})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY "Skeleton Archer" "Skeleton Archer" "Bone Shooter"} 27 28 ({ZONE_GUARDIAN 27 28 x,y,radius=24,29,4})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY "Skeleton"        "Skeleton"        "Revenant"    } 22 28 ({ZONE_GUARDIAN 22 28 x,y,radius=24,29,4})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY "Skeleton"        "Skeleton"        "Skeleton"    } 21 29 ({ZONE_GUARDIAN 21 29 x,y,radius=24,29,4})}
        
        # side 3 so we dont interfere with LIMIT_CONTEMPORANEOUS_RECRUITS
        {GENERIC_UNITC 3 (Ghoul)         5 26 ({ZONE_GUARDIAN  5 26 x,y,radius=4,28,4})}
        {GENERIC_UNITC 3 (Ghoul)         3 29 ({ZONE_GUARDIAN  3 29 x,y,radius=4,28,4})}
        {GENERIC_UNITC 3 (Ghoul)         6 29 ({ZONE_GUARDIAN  6 29 x,y,radius=4,28,4})}
        {GENERIC_UNITC 3 (Ghoul)        35 19 ({ZONE_GUARDIAN 35 19 x,y,radius=34,21,4})}
        {GENERIC_UNITC 3 (Ghoul)        31 20 ({ZONE_GUARDIAN 31 20 x,y,radius=34,21,4})}
        
        #############################
        # DEORAN
        #############################
        [unstore_unit]
            variable=stored_deoran
            x,y=24,8
        [/unstore_unit]
        {MODIFY_UNIT id=Deoran facing sw}
        [capture_village]
            side,x,y,radius=1,20,10,7
            {NOT( {FILTER side=2} )}
        [/capture_village]
        {VARIABLE ignore_companion_defeat yes}
        
        #############################
        # HEROES
        #############################
        [unit]
            side,x,y,facing=1,19,6,sw
            {SINGLEUNITWML_HYLAS}
        [/unit]
        [unit]
            side,x,y,facing=1,15,7,sw
            {SINGLEUNITWML_GERRICK}
        [/unit]
        [unit]
            side,x,y,facing=1,20,10,sw
            {SINGLEUNITWML_MARI}
        [/unit]
        {KILL id=$companion_id} # our companion died last scenario
        
        #############################
        # GUARDS
        #############################
#define DO_IF_PEBBLES LIMIT WML
        [if] {VARIABLE_CONDITIONAL pebbles_defense_length greater_than_equal_to {LIMIT}}[then] {BR}{WML}{BR} [/then]{BR}[/if]
#enddef
#define DO_IF_EXACTLY LIMIT WML
        [if] {VARIABLE_CONDITIONAL pebbles_defense_length equals {LIMIT}}[then] {BR}{WML}{BR} [/then]{BR}[/if]
#enddef
        # these timings line up with the messages given in PEBBLES_DIALOGUE_SWITCH
        {WML_COMPANION
            (WML_MARI   ={VARIABLE tahn_type Fencer})
            (WML_GERRICK={VARIABLE tahn_type "Heavy Infantryman"})
            (WML_HYLAS  ={VARIABLE tahn_type Mage})
        }
        {DO_IF_PEBBLES  1 ( {GENERIC_UNIT 1 Peasant    14  7}{FACING sw} )}
        {DO_IF_PEBBLES  2 ( {GENERIC_UNIT 1 Woodsman   18  4}{FACING sw} )}
        {DO_IF_PEBBLES  3 ( {GENERIC_UNIT 1 Woodsman   19 11}{FACING se} )}
        {DO_IF_PEBBLES  4 ( {GENERIC_UNIT 1 Peasant    25  9}{FACING se} )}
        {DO_IF_PEBBLES  5 ( {GENERIC_UNIT 1 Woodsman   24  9}{FACING sw} )}
        {DO_IF_PEBBLES  6 ( {GENERIC_UNIT 1 Peasant    15  8}{FACING sw} )}
        {DO_IF_PEBBLES  7 ( {GENERIC_UNIT 1 Woodsman   20 11}{FACING se} )}
        {DO_IF_PEBBLES  8 ( {GENERIC_UNIT 1 Woodsman   18  9}{FACING se} )}
        {DO_IF_PEBBLES  9 ( {GENERIC_UNIT 1 Woodsman   19  9}{FACING se} )}
        {DO_IF_PEBBLES 10 ( {GENERIC_UNIT 1 Peasant    19  8}{FACING se} )}
        
        {DO_IF_PEBBLES 11 (
            {GENERIC_UNIT 1 $tahn_type 15 14}{FACING sw}{ROLE tahn_garrison}
            {GENERIC_UNIT 1 $tahn_type 18 14}{FACING sw}{ROLE tahn_garrison}
            {GENERIC_UNIT 1 $tahn_type 17 14}{FACING sw}{ROLE tahn_garrison}
            {WML_COMPANION (WML_MARI={GENERIC_UNIT 1 $tahn_type 16 12}{FACING se}{ROLE tahn_garrison})}
            {WML_COMPANION (WML_MARI={GENERIC_UNIT 1 $tahn_type 18 13}{FACING se}{ROLE tahn_garrison})} # fencers are cheaper than HI/mages and also weak vs undead, so spawn more of them
        )}
        {DO_IF_EXACTLY 11 ( {KILL x,y=19,8} {KILL x,y=19,9} {KILL x,y=18,9} {KILL x,y=20,11} {KILL x,y=15,8} )}
        {DO_IF_EXACTLY 12 ( {KILL x,y=19,8} {KILL x,y=19,9} {KILL x,y=18,9} {KILL x,y=20,11} )}
        {DO_IF_EXACTLY 13 ( {KILL x,y=19,8} {KILL x,y=19,9} {KILL x,y=18,9} )}
        {DO_IF_EXACTLY 14 ( {KILL x,y=19,8} {KILL x,y=19,9} )}
        {DO_IF_EXACTLY 15 ( {KILL x,y=19,8} )}
        {DO_IF_EXACTLY 16 ( )}
        
        {DO_IF_PEBBLES 17 ( {ADVANCE_UNIT x,y=18,9  Bowman  } )}
        {DO_IF_PEBBLES 18 ( {ADVANCE_UNIT x,y=19,9  Bowman  } )}
        {DO_IF_PEBBLES 19 ( {ADVANCE_UNIT x,y=19,8  Spearman} )}
        
        {DO_IF_PEBBLES 20 ( {ADVANCE_UNIT x,y=14,7  Spearman} )}
        {DO_IF_PEBBLES 21 ( {ADVANCE_UNIT x,y=18,4  Bowman  } )}
        {DO_IF_PEBBLES 22 ( {ADVANCE_UNIT x,y=19,11 Bowman  } )}
        {DO_IF_PEBBLES 23 ( {ADVANCE_UNIT x,y=25,9  Spearman} )}
        {DO_IF_PEBBLES 24 ( {ADVANCE_UNIT x,y=24,9  Bowman  } )}
        {DO_IF_PEBBLES 25 ( {ADVANCE_UNIT x,y=15,8  Spearman} )}
        {DO_IF_PEBBLES 26 ( {ADVANCE_UNIT x,y=20,11 Bowman  } )}
        
        {DO_IF_PEBBLES 27 ( [gold]
            side,amount=1,"$( ($pebbles_defense_length-26)*3 )" # 3 extra gold for each overflow turn survived
        [/gold] )}
        
        {CLEAR_VARIABLE tahn_type}
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
#define PEBBLES_DIALOGUE_SWITCH SPEAKER  MSG_NOT_ENOUGH_TIME  MSG_UNTRAINED_FARMERS  MSG_GARRISON_RECALLED  MSG_EQUIPPED_FARMERS
    [if] {VARIABLE_CONDITIONAL pebbles_defense_length greater_than_equal_to 22}
        [then]
            [message]
                speaker={SPEAKER}
                message={MSG_EQUIPPED_FARMERS}
            [/message]
        [/then]
        [elseif] {VARIABLE_CONDITIONAL pebbles_defense_length greater_than_equal_to 11}
            [then]
                [message]
                    speaker={SPEAKER}
                    message={MSG_GARRISON_RECALLED}
                [/message]
            [/then]
        [/elseif]
        [elseif] {VARIABLE_CONDITIONAL pebbles_defense_length greater_than_equal_to 5}
            [then]
                [message]
                    speaker={SPEAKER}
                    message={MSG_UNTRAINED_FARMERS}
                [/message]
            [/then]
        [/elseif]
        [else]
            [message]
                speaker={SPEAKER}
                message={MSG_NOT_ENOUGH_TIME}
            [/message]
        [/else]
    [/if]
#enddef
    [event]
        name=start
        {DELAY 500}
        {SCROLL_TO 24 29}
        {WML_COMPANION
            #############################
            # IF MARI DIED...
            #############################
            (WML_MARI=
                [message]
                    speaker,scroll=Deoran,no
                    message= _ "Look there! The undead army has broken through Sergeant Mari‘s lines! Alas, she is lost..."
                [/message]
                [message]
                    speaker=Sir Gerrick
                    message= _ "Your friend seemed the good sort, but I can‘t say I knew ‘er well. Now I‘ll never get the chance."
                [/message]
                {PEBBLES_DIALOGUE_SWITCH "Minister Hylas"
                    _"Another poor soul claimed by the spreading darkness. If only we‘d had more time to prepare... but we‘ve done our best."
                    _"Another poor soul claimed by the spreading darkness. At least her sacrifice was not in vain: we‘ve had sufficient time to gather most of the region‘s famers and woodsmen. They‘re not trained for battle, but will benefit greatly from your leadership, Deoran."
                    _"Another poor soul claimed by the spreading darkness. At least her sacrifice was not in vain: we‘ve had sufficient time to gather most of the region‘s famers and woodsmen, as well as recall the squad of fencers garrisoning Fort Tahn."
                    _"Another poor soul claimed by the spreading darkness. At least her sacrifice was not in vain: we‘ve had sufficient time to gather, train, and equip most of the region‘s famers and woodsmen, as well as recall the squad of fencers garrisoning Fort Tahn."}
                [message]
                    speaker=Sir Gerrick
                    message= _ "Aye, an‘ I‘ve got most o‘ the civilians safe underground in th‘ cellars, with magistrate Fiore‘s daughter watchin‘ the entrance. Lucky for us Fiore himself ‘aint here to see this mess."
                [/message]
                [unit]
                    side,x,y=2,23,7
                    facing,animate=sw,yes
                    {SINGLEUNITWML_ASHEVIERE}
                    goto_x,goto_y=23,7
                [/unit]
                {TEAM_COLOR_OVERRIDE id=Asheviere wesred}
                [message]
                    speaker=Asheviere
                    message= _ "I‘ve never had this much freedom before. Only in times of crisis, it should seem..."
                [/message]
                {DELAY 500}
                [message]
                    speaker=Deoran
                    message= _ "Sergeant Mari bought us time. I only hope it was enough, for this is our final fight. A mighty battle is upon us, but as surely as the dawn breaks after every night, the courage and valor of men will prevail over the wicked creatures of darkness."
                [/message]
                [message]
                    speaker=Deoran
                    message= _ "We must stand fast against the undead and defend our homes! We fight for the fallen! We fight for Wesnoth!"
                [/message]
            )
            
            #############################
            # IF GERRICK DIED...
            #############################
            (WML_GERRICK=
                [message]
                    speaker,scroll=Deoran,no
                    message= _ "Look there! The undead army has broken through Sir Gerrick‘s lines! Alas, he is lost... "
                [/message]
                [message]
                    speaker=Mari
                    message= _ "Shame. I didn‘t really get a chance to know him, but I know you don‘t survive to his age unless you‘re one hell of a soldier. We‘ll miss him."
                [/message]
                {PEBBLES_DIALOGUE_SWITCH "Minister Hylas"
                    _"Another poor soul claimed by the spreading darkness. If only we‘d had more time to prepare... but we‘ve done our best."
                    _"Another poor soul claimed by the spreading darkness. At least his sacrifice was not in vain: we‘ve had sufficient time to gather most of the region‘s famers and woodsmen. They‘re not trained for battle, but will benefit greatly from your leadership, Deoran."
                    _"Another poor soul claimed by the spreading darkness. At least his sacrifice was not in vain: we‘ve had sufficient time to gather most of the region‘s famers and woodsmen, as well as recall the squad of heavy infantrymen garrisoning Fort Tahn."
                    _"Another poor soul claimed by the spreading darkness. At least his sacrifice was not in vain: we‘ve had sufficient time to gather, train, and equip most of the region‘s famers and woodsmen, as well as recall the squad of heavy infantry garrisoning Fort Tahn."}
                [message]
                    speaker=Mari
                    message= _ "And I‘ve got most of the civilians safe underground in the cellars. Magistrate Fiore‘s daughter wanted to watch the entrance — probably trying to get herself killed so she doesn‘t have to get married and rule over our sorry behinds."
                [/message]
                [unit]
                    side,x,y=2,23,7
                    facing,animate=sw,yes
                    {SINGLEUNITWML_ASHEVIERE}
                [/unit]
                [message]
                    speaker=Asheviere
                    message= _ "I‘ve never had this much freedom before. Only in times of crisis, it should seem..."
                [/message]
                {DELAY 500}
                [message]
                    speaker=Deoran
                    message= _ "Sir Gerrick bought us time. I only hope it was enough, for this is our final fight. A mighty battle is upon us, but as surely as the dawn breaks after every night, the courage and valor of men will prevail over the wicked creatures of darkness."
                [/message]
                [message]
                    speaker=Deoran
                    message= _ "We must stand fast against the undead and defend our homes! We fight for the fallen! We fight for Wesnoth!"
                [/message]
            )
            
            #############################
            # IF HYLAS DIED...
            #############################
            (WML_HYLAS=
                [message]
                    speaker,scroll=Deoran,no
                    message= _ "Look there! The undead army has broken through Minister Hylas‘s lines! Alas, he is lost... "
                [/message]
                [message]
                    speaker=Sir Gerrick
                    message= _ "Th‘ good minister turned down the luxurious life o‘ a city mage to come down ‘ere an‘ care for us rural folk. ‘e was a good man."
                [/message]
                {PEBBLES_DIALOGUE_SWITCH "Mari"
                    _"Me, I‘d have taken the life of luxury — but maybe the world needs crazy people like Hylas. If only we‘d had more time... but we‘ve done our best."
                    _"Me, I‘d have taken the life of luxury. But maybe the world needs crazy people like him — Hylas‘s sacrifice bought us enough time to gather most of the region‘s famers and woodsmen. They‘re not trained for battle, but will benefit greatly from your leadership, Deoran."
                    _"Me, I‘d have taken the life of luxury. But maybe the world needs crazy people like him — Hylas‘s sacrifice bought us enough time to gather most of the region‘s famers and woodsmen, as well as recall the squad of mages garrisoning Fort Tahn."
                    _"Me, I‘d have taken the life of luxury. But maybe the world needs crazy people like him — Hylas‘s sacrifice bought us enough time to gather, train, and equip most of the region‘s famers and woodsmen, as well as recall the squad of mages garrisoning Fort Tahn."}
                [message]
                    speaker=Mari
                    message= _ "And I‘ve got most of the civilians safe underground in the cellars. Magistrate Fiore‘s daughter wanted to watch the entrance — probably trying to get herself killed so she doesn‘t have to get married and rule over our sorry behinds."
                [/message]
                [unit]
                    side,x,y=2,23,7
                    facing,animate=sw,yes
                    {SINGLEUNITWML_ASHEVIERE}
                [/unit]
                [message]
                    speaker=Asheviere
                    message= _ "I‘ve never had this much freedom before. Only in times of crisis, it should seem..."
                [/message]
                {DELAY 500}
                [message]
                    speaker=Deoran
                    message= _ "Minister Hylas bought us time. I only hope it was enough, for this is our final fight. A mighty battle is upon us, but as surely as the dawn breaks after every night, the courage and valor of men will prevail over the wicked creatures of darkness."
                [/message]
                [message]
                    speaker=Deoran
                    message= _ "We must stand fast against the undead and defend our homes! We fight for the fallen! We fight for Wesnoth!"
                [/message]
            )
        }
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            side=1
            [objective]
                description= _ "Survive until turns run out"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Deoran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Asheviere"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
        [/objectives]
    [/event]
    
    #############################
    # "FOR $COMPANION_NAME"
    #############################
    [event]
        name=attack
        {FILTER type_adv_tree=Mage,Fencer,"Heavy Infantryman"} # Mari/Gerrick/Hylas trained these units, so they're particularly attached
        {FILTER( {NOT role=tahn_garrison} )}
        
        {WML_COMPANION
            (WML_MARI   ={VARIABLE message _"For master Mari!"})
            (WML_GERRICK={VARIABLE message _"For master Gerrick!"})
            (WML_HYLAS  ={VARIABLE message _"For master Hylas!"})
        }
        [message]
            speaker=unit
            message=$message
        [/message]
        {CLEAR_VARIABLE message}
    [/event]
    
    #############################
    # MEBRIN TAUNTS DEORAN
    #############################
    [event]
        name=side 1 turn end
        [message]
            speaker=Mebrin
            message= _ "So, the fleshbags have managed to mount a defense. I would seem that the pesky fly turned out to be more than a minor annoyance after all."
        [/message]
        [message]
            speaker=Mebrin
            message= _ "No matter. Slay them all, my servants! Even if we sustain losses here, the town‘s inhabitants will be more than enough to replenish our ranks."
        [/message]
    [/event]
    
    #############################
    # DISCUSSING FIORE
    #############################
#define SAY_IF_HAVE ID1 MESSAGE1 ID2 MESSAGE2
    [if] {HAVE_UNIT id={ID1}}
        [then]
            [message]
                speaker={ID1}
                message= _{MESSAGE1}
            [/message]
        [/then]
        [else]
            [message]
                speaker={ID2}
                message= _{MESSAGE2}
            [/message]
        [/else]
    [/if]
#enddef
    [event]
        name=turn 3
        [message]
            speaker=Deoran
            message= _ "If only Ethiliel had not fled! And I curse our isolation, so far removed from the great cities of the north. The capitol garrison alone would make short work of this lich, if only we could have contacted them in time!"
        [/message]
        # it's possible but extremely unlikely that both Hylas and Gerrick are dead here
        {SAY_IF_HAVE
            Mari _"That‘s assuming Weldyn would even bother to help out a podunk like this. Capitol of the southern province, sure, but that‘s not saying much. Without magistrate Fiore‘s capitol connections, I doubt anybody — you and I included — would much care what happened here."
            "Minister Hylas" "Even then, Westin is small and inaccessible, and thus easy for others to overlook. Magistrate Fiore‘s political connections are the better part of the reason we have any significance at all — as well as the reason you were deployed here, Deoran."
        }
        {SAY_IF_HAVE
            Gerrick "O‘ course, without them connections Fiore wouldn‘t‘ve needed to leave for Weldyn last month, an‘ then we might‘ve still had ‘is escort here t‘ help fight... "
            Mari "Of course, without those political connections the magistrate wouldn‘t have had to leave for Weldyn last month, and we would‘ve still had his escort here to help fight..."
        }
    [/event]
    
    #############################
    # NIGHT FALLS (AND DAY RISES)
    #############################
    [event]
        name=turn 10
        [message]
            speaker=Mebrin
            message= _ "The shroud of darkness descends once more. Night seeps through the cracks and crannies in the humans‘ defenses, plaguing their minds and bodies with dreadful fear. As surely as the sanctity of the psyche is shattered, so is the physical form, and all that‘s left is unthinking, unfeeling servitude."
        [/message]
        [message]
            speaker=Deoran
            message= _ "We don‘t fear your unholy power, lich. We won‘t succumb to your dark magics and we won‘t be turned into your undead slaves."
        [/message]
        [message]
            speaker=Mebrin
            message= _ "Believe what you will, human. We shall see if you survive the night."
        [/message]
    [/event]
    [event]
        name=turn 13
        [message]
            speaker=Deoran
            message= _ "Dawn breaks over the horizon! We‘ve weathered the night and can now begin our counterattack against the undead!"
        [/message]
    [/event]
    
    #############################
    # ASHEVIERE OBJECTIVE REMINDER
    #############################
    [event]
        name=moveto
        {FILTER( side=3,4,5 {FILTER_LOCATION( radius=3 {FILTER id=Asheviere} )} )}
        [message]
            speaker=Deoran
            message= _ "The undead are getting close to the cellars! If they slay the magistrate‘s daughter and get among the refugees, all will be lost."
        [/message]
    [/event]
    
    #############################
    # PLAYER SUFFERS CASUALTIES
    #############################
    [event]
        name=die {FILTER side=1}
        [event]
            name=die {FILTER side=1}
            [event]
                name=die {FILTER side=1}
                [message]
                    speaker=Deoran
                    message= _ "Hold fast, men of the South Guard! No matter how daunting the evil that opposes us, we must weather this darkness and defend our homes!"
                [/message]
                [message]
                    speaker=Mebrin
                    message= _ "Fool boy, you overestimate the strength of these decrepit peasants that you call soldiers. The rivers will run red with your blood! The smoke and ashes from your ruined homes will blot out the sky, and from the swamps and the black earth, your bones will rise again to serve me!"
                [/message]
            [/event]
        [/event]
    [/event]
    
    #############################
    # NECROPHAGE DIES
    #############################
    [event]
        name=die
        {FILTER type_adv_tree,canrecruit=Ghoul,yes}
#         {FILTER_SECOND side=1}
        [event]
            name=side 3 turn
            [message]
                speaker=Mebrin
                message = _ "So, you’ve defeated my lackey. A great accomplishment, for ones so pitiful."
            [/message]
            [message]
                speaker=Deoran
                message = _ "What’s truly pitiful is the plight you’ve put yourself in, once wise sage of the Elves. You’ve fallen to the black arts, twisted and corrupted by its use. Though you and your undead have ravaged our lands with your profane sorceries, I feel nothing but pity for the shambling shell you’ve become. Perhaps we can take solace in putting you out of your misery."
            [/message]
            [message]
                speaker=Mebrin
                message = _ "How little you understand. Such pompous words don’t benefit such an ignorant boy. Your foolish babble means nothing in the face of my insurmontable power! Rise, my warriors!"
            [/message]
            [gold]
                side,amount=3,{ON_DIFFICULTY 20 40 60}
            [/gold]
        [/event]
    [/event]
    
    #############################
    # PLAYER ATTACKS MEBRIN
    #############################
    [event]
        name=attack end
        {FILTER side=1}
        {FILTER_SECOND id=Mebrin}
        [message]
            speaker=Mebrin
            message = _ "You dare strike me?! Puny humans, I’m darkness incarnate! I’m power beyond your comprehension!"
        [/message]
    [/event]
    
    #############################
    # ELVES ATTACK MEBRIN
    #############################
    [event]
        name=attack end
        {FILTER side=2}
        {FILTER_SECOND id=Mebrin}
        [message]
            speaker=Mebrin
            message = _ "Ungrateful elves, you dare strike me?! I offer you secrets beyond your comprehension! I offer you immortality itself!"
        [/message]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                 ETHILIEL ARRIVES
    #######################################################################################################################################################
    # ensure Mebrin won't have troops near Ethiliel's spawn, to ensure she doesn't die
    # it helps that she spawns in the middle of snow, which slows down skeletons
    [event]
        name=side 3 turn $( {TURN_LIMIT}-7 ) refresh
        {MODIFY_SIDE_AI (3) ([avoid]{BR} x,y,radius=5,16,1 {BR}[/avoid])}
    [/event]
    [event]
        name=side 3 turn $( {TURN_LIMIT}-6 ) refresh
        {MODIFY_SIDE_AI (3) ([avoid]{BR} x,y,radius=5,16,2 {BR}[/avoid])}
    [/event]
    [event]
        name=side 3 turn $( {TURN_LIMIT}-5 ) refresh
        {MODIFY_SIDE_AI (3) ([avoid]{BR} x,y,radius=5,16,3 {BR}[/avoid])}
    [/event]
    [event]
        name=side 3 turn $( {TURN_LIMIT}-4 ) refresh
        {MODIFY_SIDE_AI (3) ([avoid]{BR} x,y,radius=5,16,4 {BR}[/avoid])}
    [/event]
    #############################
    # ETHILIEL ARRIVES
    #############################
    # if we make this happen when turns run out, you might still die before the elves arrive to help
    # instead, trigger it 3 turns early. If you could have survived for 3 more turns, you'll probably be fine with the elves' help
    # hopefully this timing feels exciting, not unfair...
    [event]
        name=side 3 turn $( {TURN_LIMIT}-3 )
        #############################
        # HORNS IN THE FOREST
        #############################
        {SOUND horn-2.ogg}
        {DELAY 1000}
        [message]
            speaker=Deoran
            message = _ "Did you hear that!? There are horns blowing in the west!"
        [/message]
        [unstore_unit]
            variable=stored_ethiliel
            x,y,facing,animate=1,14,se,yes
        [/unstore_unit]
        {MODIFY_UNIT id=Ethiliel canrecruit yes}
        {CLEAR_VARIABLE stored_ethiliel}
        {MOVE_UNIT id=Ethiliel 5 16} # 6 hexes away from her keep, so she can reach it in 1 turn
        
        #############################
        # ETHILIEL COMFRONTS MEBRIN
        #############################
        [message]
            speaker=Ethiliel
            message = _ "Mebrin! This has gone far enough."
        [/message]
        [message]
            speaker=Mebrin
            message = _ "Ethiliel, my student... How pleased am I to see you again! What wonderful secrets have I to share..."
        [/message]
        [message]
            speaker=Mebrin
            message = _ "I have touched the void at the heart of all things, and I have begun to probe the mystic arts far beyond what any living elf knows. There is infinity at the brink of death, Ethiliel... If you thought me wise before, I am now become omniscient!"
        [/message]
        [message]
            speaker=Ethiliel
            message = _ "You’ve become <b><i>evil</i></b>, Mebrin. Surely you see it! Take a good look at yourself! Your servants are abominations worse than any human. They stink of death, tainted magic and... and corruption! Even you! Mebrin... you were the kindest and gentlest of the sages..."
        [/message]
        [message]
            speaker=Ethiliel
            message = _ "No, the sage Mebrin is dead. You’re not the master I once revered. I have come to cleanse your soul and put you to rest, my beloved teacher."
        [/message]
        [message]
            speaker=Mebrin
            message = _ "Is that why you returned? Bah, I see you still have much foolishness to be rid of. You were always more of a hands-on learner, after all..."
        [/message]
        
        #############################
        # MEBRIN FOCUSES ON ETHILIEL
        #############################
        # only change attack/defend stats on the first turn
        {RESET_SIDE_AI 3,4,5 offensive -1 1} # still allow attacking the player this round, if we have a particularly juicy target
        {MODIFY_SIDE_AI 3,4,5 ([goal]
            name=target_unit
            [criteria]
                race=elf # not side=2 because that includes Asheviere
            [/criteria]
            value=10
        [/goal])}
        
        #############################
        # MORE ELVES ARRIVE
        #############################
        [event]
            name=side 3 turn end
            {GENERIC_UNIT 2 "Elvish Fighter"     3 13}{ANIMATE}{FACING ne} # none of these elves have NE sprites
            {GENERIC_UNIT 2 "Elvish Hero"        2 14}{ANIMATE}{FACING ne} # but spawn them NE so that if any sprites get added we have some facing variety
            {GENERIC_UNIT 2 "Elvish Shaman"      4 14}{ANIMATE}{FACING ne}
            {GENERIC_UNIT 2 "Elvish Enchantress" 2 15}{ANIMATE}{FACING ne}
            {GENERIC_UNIT 2 "Elvish Sorceress"   1 16}{ANIMATE}{FACING ne}
            {GENERIC_UNIT 2 "Elvish Fighter"     3 17}{ANIMATE}{FACING ne}
            {GENERIC_UNIT 2 "Elvish Shaman"      2 17}{ANIMATE}{FACING ne}
            {GENERIC_UNIT 2 "Elvish Fighter"     3 18}{ANIMATE}{FACING ne}
            {GENERIC_UNIT 2 "Elvish Fighter"     1 19}{ANIMATE}{FACING ne}
            [message]
                speaker=Ethiliel
                message = _ "Deoran, Mebrin is as much my peoples’ fault as he is yours. Forgive me for my cowardice in the forest. With me come warriors of the Aethenwood — together, men and elves shall finally put my teacher’s tortured soul to rest."
            [/message]
            
            # fixed amount of gold. On higher difficulties, the player may have to help fight
            # on lower difficulties, the elves should steamroll the undead all on their own
            [modify_side]
                side=2
                gold=100
                income=15
            [/modify_side]
            [modify_turns]
                value=-1
            [/modify_turns]
            
            #############################
            # OBJECTIVES
            #############################
            [objectives]
                side=1
                [objective]
                    description= _ "Defeat Mebrin"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Death of Deoran"
                    condition=lose
                [/objective]
                [objective]
                    description= _ "Death of Asheviere"
                    condition=lose
                [/objective]
                [objective]
                    description= _ "Death of Ethiliel"
                    condition=lose
                [/objective]
                {IS_LAST_SCENARIO}
            [/objectives]
        [/event]
    [/event]
    
    #############################
    # MEBRIN ASKS ETHILIEL TO JOIN HIM
    #############################
    [event]
        name=side 3 turn {TURN_LIMIT} refresh
        [message]
            speaker=Mebrin
            message = _ "Why do you aid these fools, Ethiliel? Join me! Stand by my side! We shall rise and eradicate the humans from the green world. Their corpses will serve us! Their bones will dance for our pleasure! We’ll make them into the mindless slaves that they deserve to be!"
        [/message]
        [message]
            speaker=Ethiliel
            message = _ "And when that’s done, what will we have become? Naught but hungering shadows, devouring all we once cherished."
        [/message]
        [message]
            speaker=Deoran
            message = _ "Even a mere human can see that you have become a mockery of all that you once believed in, Mebrin of the elves. We will destroy you and bury your perverse corruption!"
        [/message]
        [message]
            speaker=Mebrin
            message = _ "Ethiliel’s threat I respect, but you? Destroy me? Your man-flesh will provide a fine feast for my ghouls, and once they’re through with you, you’ll serve me forever in undeath!"
        [/message]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                 VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # MEBRIN DIES (TO HUMANS)
    #############################
    [event]
        name=last breath
        {FILTER id=Mebrin}
        {FILTER_SECOND side=1}
        [message]
            speaker=Mebrin
            message = _ "Fools! Imbeciles! You humans are a worthless blight upon this wretched world! I must purge you all — I must take revenge on all your race... I must..."
        [/message]
        [message]
            speaker=Deoran
            message = _ "These worthless humans just bested you and your armies. Your time has come, once wise sage of the elves."
        [/message]
        [message]
            speaker=Mebrin
            message = _ "I curse you, Deoran of Wesnoth! I curse you... may you one day know the same pain that your kind have inflicted on me..."
        [/message]  
        [event]
            name=die
            [message]
                speaker=Deoran
                message = _ "At long last, it is done."
            [/message]
            [endlevel]
                result=victory
                carryover_report=no
                save=no
            [/endlevel]
        [/event]
    [/event]
    
    #############################
    # MEBRIN DIES (TO ELVES)
    #############################
    [event]
        name=last breath
        {FILTER id=Mebrin}
        {FILTER_SECOND side=2}
        [message]
            speaker=Mebrin
            message = _ "Wait! Ethiliel... think about it! Think of everything you’re throwing away! We could build an empire together, where the humans are our slaves and you and I are the immortal rulers of the world! "
        [/message]
        [message]
            speaker=Ethiliel
            message = _ "It would only be an empire of misery, Mebrin. I wish it hadn’t come to this, but you’ve been corrupted beyond saving. Still, I’ll fondly cherish the memories I had with the old you."
        [/message]
        [message]
            speaker=Mebrin
            message = _ "You wouldn’t dare strike me! I’m the darkness incarnate! I’m your master! You’ll obey me! "
        [/message]
        [event]
            name=die
            [message]
                speaker=Ethiliel
                message = _ "Goodbye, Mebrin."
            [/message]
            [endlevel]
                result=victory
                carryover_report=no
                save=no
            [/endlevel]
        [/event]
    [/event]
[/scenario]



