#textdomain wesnoth-tsg
[scenario]
    id=04_Choice_in_the_Fog

    name= _ "Choice in the Fog"
    next_scenario=05_The_Long_March

    {SCENARIO_MUSIC the_deep_path.ogg}
    {EXTRA_SCENARIO_MUSIC suspense.ogg}
    {EXTRA_SCENARIO_MUSIC northerners.ogg}
    {EXTRA_SCENARIO_MUSIC heroes_rite.ogg}

    map_file=04_Choice_in_the_Fog.map

    {DEFAULT_SCHEDULE}

    {SG_BLIGHT}
    {TSG_BIGMAP {JOURNEY_04_NEW} }

    victory_when_enemies_defeated=yes
    {EXPERIENCE_MODIFIER}
    
    # this should be many more turns than you should actually need on easy
    {TURNS 45 41 37}
    
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=good
        user_team_name=_"South Guard"
        gold=75
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
        fog,shroud=yes,yes
    [/side]
    {STARTING_VILLAGES 1 5}
    
    #############################
    # BANDITS
    #############################
    # wmllint: local spelling Afalas
    [side]
        side=2
        color=blue
        controller=ai
        type=Outlaw
        id=Urza Afalas
        name= _ "Urza Afalas"
        profile=portraits/urza-afalas-masked.webp
        facing=se
        team_name=bandits
        user_team_name=_"Urza Nalmath"
        gold,income=0,{ON_DIFFICULTY 0 4 8}
        recruit=Thug
        {FLAG_VARIANT6 ragged}
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Poacher" {ON_DIFFICULTY 1 2 3}} # 1 poacher guard on all difficulties
    {SILENTLY_LIMIT_LEADER_MOVES 2 1}
    {STARTING_VILLAGES 2 5}
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2 defensive -1 1}
        {VARY_AI_BY_SCHEDULE 2}
    [/event]
    
    #############################
    # UNDEAD
    #############################
    [side]
        side=3
        color=black
        controller=ai
        type=Ghoul
        id=Gruth
        name= _ "Gruth"
        team_name=undead
        user_team_name=_"Undead"
        gold,income={ON_DIFFICULTY 15 30 45},{ON_DIFFICULTY -1 1 3}
        recruit=Walking Corpse
        {FLAG_VARIANT undead}
    [/side]
    {STARTING_VILLAGES 3 5}
    
    [side]
        side=4
        color=black
        controller=ai
        type=Ghoul
        id=Gerd
        name= _ "Gerd"
        team_name=undead
        user_team_name=_"Undead"
        gold,income={ON_DIFFICULTY 15 30 45},{ON_DIFFICULTY -1 1 3}
        recruit=Walking Corpse
        {FLAG_VARIANT undead}
    [/side]
    {STARTING_VILLAGES 4 5}
    
    [side]
        side=5
        color=black
        controller=ai
        type=Ghoul
        id=Gral
        name= _ "Gral"
        team_name=undead
        user_team_name=_"Undead"
        gold,income={ON_DIFFICULTY 15 30 45},{ON_DIFFICULTY -1 1 3}
        recruit=Walking Corpse
        {FLAG_VARIANT undead}
    [/side]
    {STARTING_VILLAGES 5 5}
    
    [side]
        side=6
        color=black
        controller=ai
        type=Lich
        id=Mebrin
        name= _ "Mal M’Brin"
        portrait="portraits/mal-mbrin.webp"
        team_name=undead
        user_team_name=_"Undead"
        gold,income=0,-2
        recruit=Ghoul
        {FLAG_VARIANT undead}
    [/side]
    {STARTING_VILLAGES 6 5}
    
    
    
    
    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
#define SOUTH_GUARD_LOCS
    x=17-22,   23, 24-25
    y= 5-12, 6-18,  6-12
#enddef
#define NORTH_GUARD_LOCS
    x=21-25,   26, 27-30 
    y= 6-11, 6-11,  7-10 
#enddef
    [event]
        name=prestart
        
        #############################
        # BANDIT GUARDS
        #############################
        {GENERIC_UNITC 2 ({ON_DIFFICULTY none    Thug    Thug   }) 18 11  ({ZONE_GUARDIAN 30  6 {SOUTH_GUARD_LOCS}})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY Thug    Thug    Thug   }) 23 12  ({ZONE_GUARDIAN 25  6 {SOUTH_GUARD_LOCS}})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY Poacher Poacher Poacher}) 29  8  ({ZONE_GUARDIAN 28  8 {NORTH_GUARD_LOCS}})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY none    none    Thug   }) 26  7  ({ZONE_GUARDIAN 27 12 {NORTH_GUARD_LOCS}})}
        
        #############################
        # UNDEAD GUARDS
        #############################
        {GENERIC_UNITC 3 ({ON_DIFFICULTY none "Walking Corpse" "Walking Corpse"})   8 14  ({ZONE_GUARDIAN  8 14 x,y,radius=8,17,4})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY none none             "Walking Corpse"})  12 15  ({ZONE_GUARDIAN 12 15 x,y,radius=12,17,4})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY none "Walking Corpse" "Walking Corpse"})  36 14  ({ZONE_GUARDIAN 36 14 x,y,radius=39,14,4})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY none none             "Walking Corpse"})  33 12  ({ZONE_GUARDIAN 33 12 x,y,radius=33,12,1})}
        
        # DELETEME - open up caves
#         {MODIFY_TERRAIN Rp     31 17}
#         {MODIFY_TERRAIN Rp^Es  30 16}
#         {MODIFY_TERRAIN Gll    29 17}
#         {MODIFY_TERRAIN Aa^Fdw 30 17}
#         {MODIFY_TERRAIN Ms     29 19}
#         {MODIFY_TERRAIN Aa^Fdw 30 17}
#         {MODIFY_TERRAIN Ha     29 18}
#         {MODIFY_TERRAIN Ms     28 19}
#         {MODIFY_TERRAIN Ms     28 18}
#         {MODIFY_TERRAIN Ha     28 17}
#         {MODIFY_TERRAIN Ms     27 19}
#         {MODIFY_TERRAIN Ha^Fdw 27 18}
#         {MODIFY_TERRAIN Aa^Fdw 30 17}
#         {MODIFY_TERRAIN Aa^Fdw 30 17}
        
        # DELETEME side-6-ghoul guards
#         {GENERIC_UNITC 6 (Walking Corpse)  30 18  ({ZONE_GUARDIAN 36 14 x,y,radius=34,19,4})}
#         {GENERIC_UNITC 6 (Walking Corpse)  33 17  ({ZONE_GUARDIAN 33 12 x,y,radius=34,19,4})}
#         {GENERIC_UNITC 6 (Walking Corpse)  36 19  ({ZONE_GUARDIAN 33 12 x,y,radius=36,19,2})}
        
        # DELETEME - side-6-mebrin guards
#         {GENERIC_UNITC 6 ({ON_DIFFICULTY "Walking Corpse" "Skeleton"        Revenant    })  30 18  ({ZONE_GUARDIAN 36 14 x,y,radius=34,19,4})}
#         {GENERIC_UNITC 6 ({ON_DIFFICULTY "Walking Corpse" "Skeleton Archer" Bone Shooter})  33 17  ({ZONE_GUARDIAN 33 12 x,y,radius=34,19,4})}
#         {GENERIC_UNITC 6 ({ON_DIFFICULTY "Walking Corpse" "Skeleton Archer" Bone Shooter})  36 19  ({ZONE_GUARDIAN 33 12 x,y,radius=36,19,2})}
        
        {SCROLL_TO 3 1}
    [/event]
    
    #######################################################################################################################################################
    #                                                                     PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        #############################
        # DISCUSSING THE SITUATION
        #############################
        {DELAY 500}
        {RECALL_XY Ethiliel 5 3}
        [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        {DELAY 500}
        {REACLL_XY $companion_id 3 5}
        [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        [message]
            speaker=Deoran
            message= _ "It’s so cold here! And this fog is so thick. This is quite a change from fighting bandits in the farmlands near Westin!"
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"This cannot be natural. Black Forest, this place is called? I see where it gets its name..."
            MESSAGE_GERRICK=_"Mus’ be black magic, sir. I’ve fought on many a dark and foggy night, but ne’er seen anything like this."
            MESSAGE_HYLAS=_"Dark magic — an apt name, in this case. It would take a powerful spell indeed to shadow such an expanse."
        }
        [message]
            speaker=Ethiliel
            message= _ "Before us lies the Black River — and too Mebrin, if he yet lives. And he must live, surely! I feel wisps of his magic reaching out to me from nearby..."
        [/message]
        [message]
            speaker=Deoran
            message= _ "With the three elder Urza brothers defeated, only one remains to oppose us. Mebrin must be his captive! Dangerous as these woods are, I will not break my promise to help rescue your sage, Ethiliel."
        [/message]
        {DELAY 500}
        
        #############################
        # NEW RECRUITS
        #############################
        {SAY_COMPANION
            MESSAGE_MARI=_"Rookie, you’re in luck. Despite looking like sacks of flour, some of our soldiers are suprisingly nimble. I’ve been training them during our march south — from now on, in addition to Spearmen and Bowmen you’ll also be able to recruit <b><i>Fencers</i></b>."
            MESSAGE_GERRICK=_"Deoran, we’ve got some brawny lads among us, an’ on the march I’ve been training ’em in heavy armor. From ’ere on out, in addition to Spearmen and Bowmen you’ll also be able to recruit <b><i>Heavy Infantrymen</i></b>."
            MESSAGE_HYLAS=_"Fortunate news, Deoran: several amongst our company once trained at the Mages’ Academy on Alduin. Though they dropped out before completion, our journey southwards has given me an opportunity to conclude their training."
        }
        {SAY_COMPANION
            MESSAGE_MARI=_"Like me, Fencers have the <b><i>skirmisher</i></b> ability. They’re fragile but fast, and their <b><i>blade damage</i></b> is more effective against Ghouls than our other recruits’ pierce damage."
            MESSAGE_GERRICK=_"Like me, Heavy Infantrymen are slow and tough. They ’aint so good at movin’ through forest, but their <b><i>impact damage</i></b> will be great for beatin’ down any Ghouls or Skeletons we run into."
            MESSAGE_HYLAS=_"In addition to Spearmen and Bowmen, you can now recruit <b><i>Mages</i></b>. Though frail and expensive, Mages’ ranged attack is <b><i>magical</i></b>, and deals <b><i>fire damage</i></b> — highly effective against both Ghouls and Skeletons."
        }
        [if] {HAVE_UNIT id=Mari}{BR}[then]
            [allow_extra_recruit]{BR}id,extra_recruit=Deoran,Fencer{BR}[/allow_extra_recruit]
        [/then]{BR}[/if]
        [if] {HAVE_UNIT id="Sir Gerrick"}{BR}[then]
            [allow_extra_recruit]{BR}id,extra_recruit=Deoran,Heavy Infantryman{BR}[/allow_extra_recruit]
        [/then]{BR}[/if]
        [if] {HAVE_UNIT id="Minister Hylas"}{BR}[then]
            [allow_extra_recruit]{BR}id,extra_recruit=Deoran,Mage{BR}[/allow_extra_recruit]
        [/then]{BR}[/if]

        [display_tip]
            title=_"Resistances and Damage Types"
            image=tutor/resistances.png
            message=_"Different units have resistances
to different damage types.
To see a unit’s resistances,
right-click on it and select
“Unit Description.”
{BR}
Most undead are resistant to
pierce damage, but vulnerable
to fire, impact, and arcane."
        [/display_tip]
        
        [message]
            speaker=Deoran
            message= _ "I am ready to brave the perils that lie in wait beyond the river. $companion_name, Ethiliel, we continue onwards!"
        [/message]
    [/event]

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
#         [objectives]
#             side=1
#             [objective]
#                 description= _ "Investigate the areas to the south of the Black River"
#                 condition=win
#                 [show_if]
#                     [variable]
#                         name=found_urza_afalas
#                         boolean_equals=no
#                     [/variable]
#                 [/show_if]
#             [/objective]
#             [objective]
#                 description= _ "Find the source of the undead and destroy it"
#                 condition=win
#                 [show_if]
#                     [variable]
#                         name=found_urza_afalas
#                         boolean_equals=yes
#                     [/variable]
#                     # Don't show this objective when the player sides with the
#                     # elves and kills the lich before killing the bandit leader.
#                     [have_unit]
#                         id="Mal M'Brin"
#                     [/have_unit]
#                 [/show_if]
#             [/objective]
#             [objective]
#                 description= _ "Defeat Urza Afalas"
#                 condition=win
#                 [show_if]
#                     [variable]
#                         name=found_urza_afalas
#                         boolean_equals=yes
#                     [/variable]
#                     [variable]
#                         name=side_with_bandits
#                         boolean_equals=no
#                     [/variable]
#                     [have_unit]
#                         id=Urza Afalas
#                     [/have_unit]
#                 [/show_if]
#             [/objective]
#             [objective]
#                 description= _ "Death of Captain Mari"
#                 condition=lose
#             [/objective]
#             [objective]
#                 description= _ "Death of Deoran"
#                 condition=lose
#             [/objective]
#             [objective]
#                 description= _ "Death of Ethiliel"
#                 condition=lose
#             [/objective]
# 
#             {TURNS_RUN_OUT}
# 
#             [gold_carryover]
#                 bonus=yes
#                 carryover_percentage=40
#             [/gold_carryover]
#         [/objectives]
    
    
    
    # The adventurers defeat the first zombie leader

    [event]
        name=die
        [filter]
            side=3
            canrecruit=yes
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [filter_condition]
            [have_unit]
                side=3
                canrecruit=yes
            [/have_unit]
        [/filter_condition]

        [message]
            speaker=second_unit
            # po: This message is shown when the frist zombie leader died.
            # po: There is a second one, a few hexes next to him, the player most likely saw him already.
            message= _ "He was not alone."
        [/message]
    [/event]

    # The adventurers defeat the second zombie leader

    [event]
        name=die
        [filter]
            side=3
            canrecruit=yes
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [filter_condition]
            [not]
                [have_unit]
                    side=3
                    canrecruit=yes
                [/have_unit]
            [/not]
        [/filter_condition]

        [if]
            [variable]
                name=know_about_lich
                boolean_equals=no
            [/variable]

            [then]
                [if]
                    [have_unit]
                        x,y=$x2,$y2
                        [not]
                            id=Ethiliel,Deoran,Mari
                        [/not]
                    [/have_unit]

                    [then]
                        [message]
                            speaker=second_unit
                            # po: Note that masters is in plural.
                            message= _ "The masters of the undead are defeated!"
                        [/message]
                    [/then]

                    [else]
                        [message]
                            speaker=Sir Gerrick
                            # po: Note that masters is in plural.
                            message= _ "The masters of the undead are defeated!"
                        [/message]
                    [/else]
                [/if]

                [message]
                    speaker=Mari
                    message= _ "No way. You cannot seriously think that a few stinky corpses are behind all of this. There’s definitely some necromancer at work here."
                [/message]
            [/then]

            [elseif]
                [have_unit]
                    id="Mal M'Brin"
                [/have_unit]

                [then]
                    [if]
                        [have_unit]
                            x,y=$x2,$y2
                        [/have_unit]

                        [then]
                            [message]
                                speaker=Mari
                                message= _ "Ew. These corpses stink. This smell is probably never going to come out of my armor."
                            [/message]
                        [/then]
                    [/if]
                [/then]
            [/elseif]
            [else]
                [message]
                    speaker=second_unit
                    message= _ "One fewer evil in this forest."
                [/message]
            [/else]
        [/if]
    [/event]

    # Activate side 2 on turn 3
    [event]
        name=turn 3

        [gold]
            side=2
            {QUANTITY amount 40 60 80}
        [/gold]
    [/event]

    [event]
        name=sighted
        [filter]
            side=2
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        {VARIABLE found_urza_afalas yes}

        [remove_shroud]
            [filter_side]
                side=1
            [/filter_side]
            x,y=$x1,$y1
            radius=1
        [/remove_shroud]

        [remove_shroud]
            [filter_side]
                side=1
            [/filter_side]
            x,y=23,14
            radius=6
        [/remove_shroud]

        [lift_fog]
            [filter_side]
                side=1
            [/filter_side]
            x,y=$x1,$y1
            radius=1
            multiturn=yes # To allow resetting the fog at the end of this event
        [/lift_fog]

        [lift_fog]
            [filter_side]
                side=1
            [/filter_side]
            x,y=23,14
            radius=6
            multiturn=yes # To allow resetting the fog at the end of this event
        [/lift_fog]

        [redraw]
            side=1
        [/redraw]

        [message]
            speaker=Urza Afalas
            message= _ "Thank the light, you’re alive!"
        [/message]

        [message]
            speaker=Ethiliel
            message= _ "You need not thank anyone that we are alive, wretched criminals! We know of your alliance with the undead and the evil you have brought to this land!"
        [/message]

        [message]
            speaker=Sir Gerrick
            message= _ "Aye, prepare to be slain, you abominable scum!"
        [/message]

        [message]
            speaker=Urza Afalas
            message= _ "Please, please, just hear me out. I know of these undead that you seek, and I know that you seek to destroy both them and us out of revenge. I am sorry my brothers attacked you. It was never my intention to cause everyone so much suffering."
        [/message]

        [message]
            speaker=Deoran
            message= _ "Tell us what you know of these undead. Make one wrong move and we will not hesitate to attack!"
        [/message]

        [message]
            speaker=Urza Afalas
            message= _ "I swear that I am not your enemy! I will gladly tell you what I know. A year ago, we ventured into the land of the elves in secret and we captured a great sage. We forced him to teach us the secrets of this forest."
        [/message]

        [message]
            speaker=Ethiliel
            image=portraits/ethiliel-mad.webp
            message= _ "You imprisoned Mebrin?! You loathsome vermin!"
        [/message]

        [message]
            speaker=Urza Afalas
            # po: this deliberately contradicts what Nalmath said in the last scenario. Could a bandit possibly be a liar?
            message= _ "Wait, wait, hear me out! He told us that in the woods to the south of here, there was a powerful nexus of dark energy. He took us there and taught us to summon the dead to fight for us. I saw the folly in doing such a thing, but my brothers were weak and foolish and soon fell under the sway of the corrupting magic. They summoned undead that they could not control, and soon, they became slaves of the power they had sought to master!"
        [/message]

        [message]
            speaker=Ethiliel
            message= _ "A complete and utter lie from complete and utter scum."
        [/message]

        [message]
            speaker=Mari
            message= _ "What happened to the sage?"
        [/message]

        [message]
            speaker=Urza Afalas
            message= _ "I am not sure... he was more powerful than any of the undead we summoned, and yet he did not resist them. They took him into the forest weeks ago and we have not seen him since. I suspect he leads the undead against us."
        [/message]

        [message]
            speaker=Ethiliel
            image=portraits/ethiliel-mad.webp
            message= _ "You dare spew such falsities! Mebrin would never fight for the undead, much less lead them!"
        [/message]

        [message]
            speaker=Minister Hylas
            message= _ "<i>Sages and mystics of great skill and age are often the first to succumb to the taint of black magic. Wisdom and power are not enough to master undeath — the only way to conquer it is to resist the temptation altogether. If this Mebrin played a part in the summoning of these undead, I do not doubt that he was corrupted as well.</i>"
        [/message]

        [message]
            speaker=Sir Gerrick
            message= _ "<i>These elves are not as incorruptible and pure as they like to believe they are. I suspect that this sage’s pride led him to believe that he could master a power that is uncontrollable.</i>"
        [/message]

        [message]
            speaker=Deoran
            message= _ "Even supposing what you tell us is true, you have caused this whole ordeal to begin with! I have done nothing but fight you outlaw brothers ever since coming to Kerlath."
        [/message]

        [message]
            speaker=Mari
            message= _ "Agreed. I hate to be captain obvious instead of Captain Mari, but you are criminals."
        [/message]

        [message]
            speaker=Urza Afalas
            message= _ "We have committed wrongdoings in the past, but at least in the fight against the undead, we can be your friends! They are as much our enemies as they are yours!"
        [/message]

        [message]
            speaker=Ethiliel
            image=portraits/ethiliel-mad.webp
            message= _ "No fake niceties can reverse the destruction you have wrought upon us! No action you take now can set right the transgressions you have already made! Be thankful only that only I, one aligned with the faerie path of peace and healing, am the only one to hear the venom you have thusly spewed. If it were Ithelden or Eltenmir..."
        [/message]

        [message]
            speaker=Mari
            message= _ "<i>What a scary paragon of peace and healing. I must consider our options carefully...</i>"
            [option]
                label= _ "Urza Afalas, I hate annoying bandits. Die with the undead."
                [command]
                    [message]
                        speaker=Urza Afalas
                        message= _ "Then this parley is over! You may have caused the doom of all of us!"
                    [/message]

                    [message]
                        speaker=Ethiliel
                        image=portraits/ethiliel-mad.webp
                        message= _ "You will pay for taking Mebrin from us! If he is harmed..."
                    [/message]

                    [set_variable]
                        name=side_with_bandits
                        value=no
                    [/set_variable]

                    [show_objectives][/show_objectives]
                [/command]
            [/option]
            [option]
                label= _ "Urza Afalas, we will spare your lives, but stay out of this battle and leave Kerlath forever. We will attack you on sight if we see you ever again."
                [command]
                    [message]
                        speaker=Ethiliel
                        message= _ "That is an acceptable resolution, Captain. <small>Though it does not make me as happy as the alternative...</small>"
                    [/message]

                    [message]
                        speaker=Urza Afalas
                        message= _ "A foolish decision! But I see that I am in no position to argue. We will stay out of your way as you wish."
                    [/message]

                    [kill]
                        side=2
                        animate=no
                    [/kill]

                    [show_objectives][/show_objectives]
                [/command]
            [/option]
            [option]
                label= _ "We cannot ally ourselves with criminals, but it would be advantageous if we did not attack Urza Afalas directly, and let him continue to battle the undead."
                [command]
                    [message]
                        speaker=Ethiliel
                        image=portraits/ethiliel-mad.webp
                        message= _ "That is the same as doing nothing! They will walk away without punishment and commit even greater crimes the next time—"
                    [/message]

                    [message]
                        speaker=Mari
                        message= _ "And after this battle, we shall fortify the borders and the Southern Outpost. Urza Afalas, we may turn a blind eye to you now, but should you ever think of returning to Kerlath, I will send you into the afterlife with the rest of your brothers."
                    [/message]

                    [message]
                        speaker=Urza Afalas
                        message= _ "A foolish decision! But I see that I am in no position to argue..."
                    [/message]

                    [message]
                        speaker=Ethiliel
                        message= _ "You had better keep your word, Captain. I am not pleased with this current course of action. While my own teachings may emphasize harmony and tranquility with all life, we elves are not so quick to ignore justice and forgive the wicked either."
                    [/message]

                    [message]
                        speaker=Mari
                        message= _ "My lady, I am deeply sorry, but battling both the bandits and undead simultaneously may be too difficult. Upon our return, I shall see to it personally that a bounty is placed on Urza Afalas’ head and order the South Guard to hunt down the remaining bandits starting with the border near the Aethenwood."
                    [/message]

                    [message]
                        speaker=Ethiliel
                        message= _ "Very well. I shall withhold judgment until we have finished our duty here first."
                    [/message]

                    [set_variable]
                        name=side_with_bandits
                        value=yes
                    [/set_variable]

                    [modify_side]
                        side=2
                        team_name=South_Guard
                    [/modify_side]

                    [show_objectives][/show_objectives]
                [/command]
            [/option]
        [/message]

        [reset_fog]
            [filter_side]
                side=1
            [/filter_side]
            x,y=$x1,$y1
            radius=1
        [/reset_fog]
        [reset_fog]
            [filter_side]
                side=1
            [/filter_side]
            x,y=23,14
            radius=6
        [/reset_fog]

        # give side 4 some gold
        [gold]
            side=4
            {QUANTITY amount 25 50 75}
        [/gold]
    [/event]

    # Urza Afalas is killed

    [event]
        name=last breath
        [filter]
            id=Urza Afalas
        [/filter]

        [if]
            [have_unit]
                id="Mal M'Brin"
            [/have_unit]
            [then]
                [message]
                    speaker=Urza Afalas
                    message= _ "Fools! The undead will be the death of us all!"
                [/message]
            [/then]
            [else]
                [fire_event]
                    name=bandits_and_lich_defeated
                [/fire_event]
            [/else]
        [/if]

        [set_achievement]
            content_for=The_South_Guard_Revised
            id=tsg_s04
        [/set_achievement]
    [/event]

    # A Water Serpent in the Deep

    [event]
        name=moveto
        [filter]
            side=1
            x,y=6,26
        [/filter]

        [unit]
            side=5
            type=Water Serpent
            id=Beast of the Lake
            name= _ "Beast of the Lake"
            x,y=2,25
            upkeep=loyal
            [status]
                slowed=yes
            [/status]
        [/unit]

        [message]
            speaker=Beast of the Lake
            message= _ "Graar!" # wmllint: no spellcheck
            # It's likely under fog.
            highlight=no
            scroll=no
            sound=bite-small.ogg
        [/message]
    [/event]

    # time over events

    [event]
        name=turn 30

        [sound]
            name=magic-dark-big.ogg
        [/sound]

        [message]
            speaker=Deoran
            message= _ "Ouch! Did anyone feel that?"
        [/message]
        [message]
            speaker=Sir Gerrick
            message= _ "Aye, I felt it too. A dreadful chill of perverse origin."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "It is the work of the undead. They have begun to cast a spell on us to drain our energy and trap us in these forests. We must hurry before they complete their dark magic, or we will not be able to escape this harrowing place, much less find and defeat them."
        [/message]
    [/event]
    [event]
        name=turn 33

        [sound]
            name=magic-dark-big.ogg
        [/sound]

        [message]
            speaker=Deoran
            message= _ "I grow weary! Even holding my weapon is getting difficult."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "The spell grows stronger by the moment."
        [/message]
    [/event]
    [event]
        name=turn 36

        [sound]
            name=magic-dark-big.ogg
        [/sound]

        [message]
            speaker=Deoran
            message= _ "The darkness is so heavy... I do not know how much longer I can go on..."
        [/message]
    [/event]
    [event]
        name=time over

        [sound]
            name=magic-dark-big.ogg
            repeat=1
        [/sound]

        [message]
            speaker=Deoran
            message= _ "It is... so cold..."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "The undead have ensnared us in their spell... we will not be able to escape now..."
        [/message]
    [/event]

    # Confrontation with Mal Brin
    [event]
        name=sighted
        [filter]
            id="Mal M'Brin"
        [/filter]

        [filter_second]
            side=1
        [/filter_second]

        [redraw][/redraw]
        [message]
            speaker="Ethiliel"
            message= _ "Mebrin? Is that truly you?"
        [/message]

        [message]
            speaker="Mal M'Brin"
            # wmllint: local spelling Eth
            message = _ "Eth... Ethiliel?"
        [/message]

        [message]
            speaker="Ethiliel"
            message= _ "Oh, it truly is you! How did you come to be here, shut away from the trees and the light of the sun?"
        [/message]

        [message]
            speaker="Mal M'Brin"
            message = _ "They bound me, the accursed humans, they took me and bound me in iron! Ahh, the cold iron on my skin... they burned me with it day and night for days, weeks, tormenting me endlessly as they tried to pry the secrets of the undead from me!"
        [/message]

        [message]
            speaker="Deoran"
            message= _ "What is this? Elves bear steel swords! I had no idea iron would hurt your kind so."
        [/message]

        [message]
            speaker="Ethiliel"
            message= _ "All elves feel the shadow of iron, and to those who walk our higher paths, it is a bane that breaks the body and twists the mind. This touches on mysteries that are not for men to know, human. I bind you never to speak of it. Cruel as those abominable brigands were, they could not have known the hurt they inflicted."
        [/message]

        [message]
            speaker="Mal M'Brin"
            message = _ "They knew, they knew! They reveled in my hurt, relished each and every one of my cries of pain! Even as I begged for mercy, they would not relent. I did not know day from night... the light and the shadows, heat and cold, everything was one and the same as the iron bled itself into my veins."
        [/message]

        [message]
            speaker="Ethiliel"
            message= _ "Mebrin..."
        [/message]

        [message]
            speaker="Mal M'Brin"
            message = _ "At my lowest point, they broke me. I was beyond humiliated, but I could bear it no longer. I told them that I would teach them to raise the dead if they would just take the accursed shackles off me. I knew that once the first strand of black magic entwined itself within me, there would be no turning back. I knew, but what did it matter? What did I have left to lose? In hindsight, I had much to gain."
        [/message]

        [message]
            speaker="Mal M'Brin"
            message = _ "Humans are ultimately a weak breed. I taught them to summon powers they could not control. In their greed, they never stopped to wonder if they could master the sorcery, or if it would master them and their minds in turn. Content with only meager tricks, those filthy tree-killers never even noticed as I siphoned away their energies and grew more powerful myself."
        [/message]

        [message]
            speaker="Ethiliel"
            message= _ "Mebrin, please..."
        [/message]

        [message]
            speaker="Mal M'Brin"
            message = _ "What, Ethiliel? Do you not remember what I taught you long ago? Do not fear the unknown out of a lack of understanding. It is that very discipline that acceded you the essence of the faerie. It is no different in this case. In a way, I am grateful to these humans. They, though indirectly, have opened my eyes to possibilities I would have never thought possible."
        [/message]

        [message]
            speaker="Ethiliel"
            message= _ "Mebrin... that’s enough. I am sorry. I should have protected you. I should never have let those humans take you and turn you into... into a monster!"
        [/message]

        [message]
            speaker="Mal M'Brin"
            message = _ "What are you saying..?"
        [/message]

        [message]
            speaker="Ethiliel"
            message= _ "Surely you see it! Take a good look at yourself! Your servants are abominations worse than any human. They stink of death, and tainted magic, and... and corruption! Even you! How could you become something like this? Mebrin, answer me!"
        [/message]

        [message]
            speaker="Mal M'Brin"
            message= _ "I am called Mal M’Brin now, Ethiliel. It is the name I took when I unchained myself from the shallow-mindedness of the elves and passed over into enlightenment. There is infinity at the brink of death. I have touched the void at the heart of all things, and I have begun to probe the mystic arts far beyond what any living human or elf knows. You, too, can partake of its boundless power."
        [/message]

        [message]
            speaker="Ethiliel"
            message= _ "You have become evil!"
        [/message]

        [message]
            speaker="Mal M'Brin"
            message= _ "Ethiliel... why do you speak so ingenuously? I was always quite fond of you, and still am. Come now, lay open your mind to the possibilities of the mystical black arts. With them at our command, we can at last extricate ourselves from our mundane relations with these petty humans! We can cleanse their blight from our lands and raise the Aethenwood to an eminence that rivals that of even the mighty Wesmere and Lintanir!"
        [/message]

        [message]
            speaker="Ethiliel"
            message= _ "And when that is done, what will we have become? Naught but hungering shadows, devouring all we once cherished."
            image=portraits/ethiliel-mad.webp
        [/message]

        [message]
            speaker="Ethiliel"
            message= _ "No... No. The sage Mebrin whom I once revered is dead. I will cleanse your soul and put you to rest, my beloved teacher."
        [/message]

        [message]
            speaker="Mal M'Brin"
            message= _ "I see that words have no further use. You were always more of a hands-on learner, after all..."
        [/message]

        {REPLACE_SCENARIO_MUSIC vengeful.ogg}
        {APPEND_MUSIC frantic.ogg}
        {APPEND_MUSIC northerners.ogg}

        [gold]
            side=4
            {QUANTITY amount 50 75 100}
        [/gold]

        {VARIABLE know_about_lich yes}
    [/event]

    [event]
        name=attack_end

        [filter]
            side=1
        [/filter]

        [filter_attack]
            type=pierce
        [/filter_attack]

        [filter_second]
            type_adv_tree=Skeleton,Skeleton Archer
        [/filter_second]

        # Only comment on pierce damage being useless if the player didn't
        # actually kill the skeleton with it.
        [filter_condition]
            [variable]
                name=second_unit.hitpoints
                greater_than=0
            [/variable]
        [/filter_condition]

        [message]
            speaker=unit
            message= _ "Our weapons are useless against these skeletons! They have nothing for our shafts to pierce but air!"
        [/message]
    [/event]

    [event]
        name=last breath

        [filter]
            id="Mal M'Brin"
        [/filter]

        [message]
            speaker="Mal M'Brin"
            message= _ "Ethiliel, wait!... think about it! Think of everything you are throwing away!"
        [/message]

        [message]
            speaker="Ethiliel"
            message= _ "I wish it had not come to this, but you have been corrupted beyond saving. Still, I will fondly cherish the memories I had with the old you."
        [/message]

        [message]
            speaker="Mal M'Brin"
            message= _ "You wouldn’t dare strike me!"
        [/message]

        [message]
            speaker="Ethiliel"
            message= _ "Goodbye, Mebrin."
        [/message]

        [kill]
            id="Mal M'Brin"
            animate=yes
        [/kill]

        [message]
            speaker="Ethiliel"
            message= _ "..."
        [/message]

        [if]
            [have_unit]
                id=Urza Afalas
            [/have_unit]
            [and]
                [variable]
                    name=side_with_bandits
                    boolean_equals=no
                [/variable]
            [/and]
            [then]
                [message]
                    speaker=Deoran
                    message= _ "Now the only thing left to do is get rid of these bandits."
                [/message]
                [show_objectives][/show_objectives]
            [/then]
            [else]
                [fire_event]
                    name=bandits_and_lich_defeated
                [/fire_event]
            [/else]
        [/if]
    [/event]

    [event]
        name=bandits_and_lich_defeated

        [message]
            speaker="Ethiliel"
            message= _ "It is done... just... let me gather my thoughts..."
        [/message]

        {CLEAR_VARIABLE side_with_bandits,found_urza_afalas,know_about_lich}
        {MAKE_LOYAL_NORMAL (Minister Hylas)}
        {MAKE_LOYAL_NORMAL (Sir Gerrick)}

        [endlevel]
            result=victory
            next_scenario=05_The_Long_March
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
[/scenario]
