#textdomain wesnoth-tsg
[scenario]
    id=01_Raising_the_Banner
    map_file=01a_Raising_the_Banner.map
    name= _ "Raising the Banner"
    next_scenario=01x_Westin
    victory_when_enemies_defeated=no
    
    {DEFAULT_SCHEDULE_DAWN} # so there's no ToD effects on the first turn
    turns=-1
    
    {SCENARIO_MUSIC loyalists.ogg}
    {EXTRA_SCENARIO_MUSIC battle.ogg}
    {EXTRA_SCENARIO_MUSIC knolls.ogg}
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]  # wmllint: validate-off
        side=1
        controller=human
        no_leader=yes
        team_name=South_Guard
        user_team_name=_"South Guard"
        gold=75
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
    [/side] # wmllint: validate-on
    
    #############################
    # MARI
    #############################
    [side]
        side=2
        color=red
        controller=null
        no_leader=yes
        hidden=yes
        team_name=South_Guard,quintain
    [/side]
    [side]
        side=3
        color=blue
        controller=ai
        no_leader=yes
        hidden=yes
        team_name=quintain
    [/side]
    
    #############################
    # BANDITS
    #############################
    [side]
        side=4
        color=blue
        controller=ai
        no_leader=yes
        hidden=yes
        team_name=bandits
        user_team_name=_"Bandits"
        recruit=Thug
        {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 4 1}
    [event]
        name=side 4 turn
        first_time_only=no
        {RESET_SIDE_AI 4 offensive 0.4 0.25}
        {MODIFY_SIDE_AI 4 ([avoid] # let's at least pretend the AI is smart. New players can wait until later to realize the AI is actually dumb
            terrain=Ww^*
        [/avoid])}
        
        {IF_TIME_OF_DAY morning}
            {AND_NO_ENEMIES_NEAR_MY_LEADER 4}
            [then]
                {MODIFY_SIDE_AI (4) ({GOAL_AVOID_SIDE_UNLESS_DEFENDING_LEADER 9  4 1 6})} # avoid staying too close
                {MODIFY_SIDE_AI (4) ({GOAL_LOCATION 99 x,y=16,20})}
                
                {MODIFY_SIDE_AI (4) (aggression=-9)}
                {MODIFY_SIDE_AI (4) (caution=9)}
                {MODIFY_SIDE_AI (4) (grouping=defensive)}
            [/then]
        {ENDIF}
        {IF_TIME_OF_DAY afternoon}
            {AND_NO_ENEMIES_NEAR_MY_LEADER 4}
            [then]
                {MODIFY_SIDE_AI (4) ({GOAL_AVOID_SIDE_UNLESS_DEFENDING_LEADER 9  4 1 3})} # avoid staying too close
                {MODIFY_SIDE_AI (4) ({GOAL_LOCATION 99 x,y=16,20})}
                
                {MODIFY_SIDE_AI (4) (aggression=-9)}
                {MODIFY_SIDE_AI (4) (caution=9)}
                {MODIFY_SIDE_AI (4) (grouping=defensive)}
            [/then]
        {ENDIF}
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        
        #############################
        # DEORAN AND MARI
        #############################
        [unit]
            side=2
            x,y=10,4
            facing=ne
            id=Mari
            name= _ "Mari"
            type=TSG Captain
            unrenamable=yes
            [modifications]
                {TRAIT_LOYAL_HERO}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]
    [/event]
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        {DELAY 500}
        [unit]
            id=Deoran
            name= _ "Deoran"
            profile=portraits/deoran.webp
            type=Junior Commander
            [modifications]
                [trait]
                    id,name=loyal_dummy,_"loyal"
                    description= _ "Zero upkeep"
                    [effect]
                        apply_to=loyal
                    [/effect]
                [/trait]
                {TRAIT_INTELLIGENT}
            [/modifications]
            canrecruit=yes
            unrenamable=yes
            side=1
            x,y=17,1
            facing=sw
            animate=yes
        [/unit]
        
        #############################
        # OPENING CUTSCENE
        #############################
        [message]
            speaker=Deoran
            image=portraits/deoran-glad.webp
            #po: deoran is fresh out of training, bright-eyed and eager to prove himself
            message= _ "Commander Deoran, reporting for duty SIR! ...err, ma’am."
        [/message]
        [message]
            speaker=Mari
            #po: "academy" refers to some sort of Wesnoth military academy
            message= _ "Relax, commander. Fresh from the academy, are we?"
        [/message]
        [message]
            speaker=Deoran
            #po: Deoran and Mari are here because Magistrate Fiore (from Westin) ordered them to come and make sure bandits don't interrupt Garard and Asheviere's upcoming wedding
            message= _ "Yes ma’am. —sir. And as the magistrate ordered, I’ve brought with me a contingent of fresh soldiers to ensure the king’s wedding goes exactly as planned."
        [/message]
        [message]
            speaker=Mari
            #po: Mari is somewhat sarcastic and not particularly emotive. She can come across as somewhat cold.
            message= _ "I’m Mari. Got the same orders as you; guess Magistrate Fiore wanted someone with experience to keep an eye on you and your “fresh” company. Can’t imagine why."
        [/message]
        [message]
            speaker=Mari
            # might not need the 1-armed thing after the portrait's done, depending on how obvious it is.
            #po: Mari only has 1 arm; she lost her left arm fighting undead in the Estmark hills.
            message= _ "I am elated to march to the end of civilization and supervise this extremely meaningful ceremony, rather than relaxing at home or practicing one-armed swordsmanship. Nope, nothing I’d rather be doing."
        [/message]
        [message]
            speaker=Mari
            message= _ "*sigh* Well, I guess orders are orders. Come on over here, Deoran — let’s get a closer look at you."
        [/message]
        [message]
            speaker=Deoran
            [option]
                label= _ "On my way!"
                [command]
                    {VARIABLE enable_tutorial_elements yes}
                    [fire_event]
                        name=play_tutorial
                    [/fire_event]
                [/command]
            [/option]
            [option]
                label= _ "I know what I’m doing. (Skip tutorial)"
                [command]
                    {VARIABLE enable_tutorial_elements no}
                    [message]
                        speaker=Mari
                        message= _ "Suit yourself. I’m sure you won’t need my help against those bandits anyway."
                    [/message]
                    [fire_event]
                        name=play_battle
                    [/fire_event]
                [/command]
            [/option]
        [/message]
    [/event]
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    PLAY TUTORIAL
    #######################################################################################################################################################
#define TUTORIAL_ARROW X Y
    [item]
        name=arrow
        x,y={X},{Y}
        image=misc/highlight-hex.png
        halo=misc/arrow[10~19,20~11].png
    [/item]
#enddef
#define REMOVE_ARROW
    [remove_item]
        name=arrow
    [/remove_item]
#enddef
#define EXPLAIN_UNDO VALID_HEXES
    [event]
        name=moveto
        id=explain_undo
        {FILTER( id=Deoran {FILTER_LOCATION( {NOT({VALID_HEXES})} )} )}
        [filter_condition]
            {VARIABLE_CONDITIONAL undo_explained not_equals yes}
        [/filter_condition]
        [message]
            speaker,image=narrator,wesnoth-icon.png
            {TUTOR: _"Press “u” if you need to undo a move."}
        [/message]
        [allow_undo]
        [/allow_undo]
        {VARIABLE undo_explained yes}
    [/event]
#enddef
    [event]
        name=play_tutorial
        
        #############################
        # TUTORIAL 1: MOVE DEORAN
        #############################
        {TUTORIAL_ARROW 17 1}
        [event]
            name=select
            {FILTER id=Deoran}
            {REMOVE_ARROW}
            {TUTORIAL_ARROW 11 5}
        [/event]
        {EXPLAIN_UNDO x,y=11,5}
        [disallow_end_turn]
            reason=_"Move Deoran next to Mari first!
(press “u” if you need to undo a move)"
        [/disallow_end_turn]
        
        #------------------------
        # SHOW DESTINATION HEX
        #------------------------
        [objectives]
            [objective]
                description= _ "Move Deoran next to Mari"
                condition=win
            [/objective]
            [objective]
                description= _ "Get yourself killed"
                condition=lose
            [/objective]
        [/objectives]

        
        #############################
        # TUTORIAL 2: ATTACK QUINTAIN
        #############################
        [event]
            name=moveto
            {FILTER id,x,y=Deoran,11,5}
            #------------------------
            # INTRO
            #------------------------
            {REMOVE_ARROW}
            [remove_event]
                id=explain_undo
            [/remove_event]
            [message]
                speaker=Deoran
                message= _ "*bowing* A pleasure to make your acquaintance, Captain Mari."
            [/message]
            [message]
                speaker=Mari
                #po: I feel that "stab your spear" sounds better than "stab with your spear"; it matches the cadence of "ride your horse"
                message= _ "Amazing, you know how to ride your horse. Now let’s see if you know how to stab your spear."
            [/message]
            [store_unit]
                {FILTER id=Mari}
                variable=stored_mari
                kill=yes
            [/store_unit]
            {NAMED_UNIT 3 Quintain 10 4 quintain "" ()} {FACING se} {GUARDIAN}
            {FAKE_UNIT_MOVE 10 9 4 5 2 (TSG Captain) ()}
            [unstore_unit]
                variable=stored_mari
                x,y=9,5
            [/unstore_unit]
            [message]
                speaker=Deoran
                message= _ "...a quintain? You want me to attack a practice dummy?"
            [/message]
            [message]
                speaker=Mari
                message= _ "Too dangerous for you? Perhaps I can find a stuffed doll instead."
            [/message]
            
            #------------------------
            # OBJECTIVES
            #------------------------
            [disallow_end_turn]
                reason=_"Attack the dummy first!"
            [/disallow_end_turn]
            [objectives]
                [objective]
                    description= _ "Attack the dummy"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]
            
            #------------------------
            # ATTACK INDICATORS
            #------------------------
            {TUTORIAL_ARROW 11 5}
            [event]
                name=select
                {REMOVE_ARROW}
                {TUTORIAL_ARROW 10 4}
            [/event]
            [event]
                name=attack
                {REMOVE_ARROW}
            [/event]
            
            #------------------------
            # HARDCODE HITS/MISSES
            #------------------------
            # make the tutorial more consistent, so that dialogue is guaranteed to be sensible regardless of RNG
#define FORCE_ACCURACY UNIT VALUE
            [remove_object]
                object_id=force_cth_{UNIT}
            [/remove_object]
            [modify_unit]
                {FILTER id={UNIT}}
                [object]
                    id=force_cth_{UNIT}
                    [effect]
                        apply_to=attack
                        [set_specials]
                            mode=append
                            [chance_to_hit]
                                value={VALUE}
                            [/chance_to_hit]
                        [/set_specials]
                    [/effect]
                [/object]
            [/modify_unit]
#enddef
            [event]
                name=attack
                {FILTER id=Deoran}
                    
                # hardcode Deoran's first 3 strikes - show the player what a hit looks like twice, then show them what a miss looks like
                {FORCE_ACCURACY Deoran 100}
                [event]
                    name=attacker hits
                    {FILTER id=Deoran}
                    [event]
                        name=attacker hits
                        {FILTER id=Deoran}
                        {FORCE_ACCURACY Deoran 0}
                        [event]
                            name=attacker misses
                            {FILTER id=Deoran}
                            [remove_object]
                                object_id=force_cth_Deoran
                            [/remove_object]
                        [/event]
                    [/event]
                [/event]
                
                # hardcode the quintian's first 4 strikes (2 defending, 2 attacking) - get Deoran low, but don't kill him
                {FORCE_ACCURACY quintain 100}
                [event]
                    name=defender hits
                    {FILTER_SECOND id=quintain}
                    {FORCE_ACCURACY quintain 0}
                    [event]
                        name=defender misses
                        {FILTER_SECOND id=quintain} # the quintain gets deleted and replaced after this
                        [event]
                            name=attack
                            {FORCE_ACCURACY quintain 100}
                            [event]
                                name=new turn
                                [remove_object]
                                    object_id=force_cth_quintain
                                [/remove_object]
                            [/event]
                        [/event]
                    [/event]
                [/event]
            [/event]
        [/event]
        
        
        #############################
        # TUTORIAL 3: TURNS
        #############################
        [event]
            name=attack end
            
            # or else the quintain keeps playing it's defense anim
            {STORE_UNIT_VAR id=quintain hitpoints hitpoints}
            {KILL id=quintain}
            {NAMED_UNIT 3 Quintain 10 4 quintain "" ( experience,hitpoints=1,$hitpoints )} {FACING se}  {GUARDIAN}
            {CLEAR_VARIABLE hitpoints}
            
            #------------------------
            # INTRO
            #------------------------
            [message]
                speaker=Deoran
                image=portraits/deoran-mad.webp
                message= _ "Ow! This dummy fights back!"
            [/message]
            [message]
                speaker=Mari
                message= _ "I definitely should have started with the doll."
            [/message]
            [message]
                speaker=Deoran
                message= _ "I’m not about to lose to a dummy. Let me attack again!"
            [/message]
            [message]
                speaker=Mari
                message= _ "Nice try, but you used up your turn attacking the quintain. The quintain now gets to attack."
            [/message]
            [message]
                speaker=Deoran
                message= _ "The <i>dummy</i> gets a turn?"
            [/message]
            [message]
                speaker=Mari
                message= _ "You expected this to be easy? It’s a magical quintain, on loan from the wizards’ academy at Alduin. It strikes twice per attack, and does 10 “impact” damage per strike. Brace yourself!"
            [/message]
            [message]
                speaker,image=narrator,wesnoth-icon.png
                {TUTOR: _"To end your turn, click the <b>“End Turn”</b> button in the bottom-right corner of the screen, or press <b>Ctrl+Space</b>"}
            [/message]
            [allow_end_turn][/allow_end_turn]
            
            #------------------------
            # OBJECTIVES
            #------------------------
            [objectives]
                [objective]
                    description= _ "End your turn"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]
        [/event]
        
        
        #############################
        # TUTORIAL 4: VILLAGES
        #############################
        [event]
            name=turn 2
            [message]
                speaker=Deoran
                image=portraits/deoran-sad.webp
                message= _ "I’m seriously injured; this is more dangerous than I expected. I need to retreat to a village and regain some hitpoints."
            [/message]
            {TUTORIAL_ARROW  8 6}
            {TUTORIAL_ARROW 12 7}
            [disallow_end_turn]
                reason=_"Move to a village first!
(press “u” if you need to undo a move)"
            [/disallow_end_turn]
            {EXPLAIN_UNDO terrain=*^V*}
            
            #------------------------
            # PREVENT ATTACKING
            #------------------------
            [event]
                name=pre attack
                id=prevent_attacking
                first_time_only=no
                [cancel_action]
                [/cancel_action]
                {STORE_UNIT_VAR id=Deoran hitpoints hitpoints}
                [message]
                    speaker=Deoran
                    message= _"I only have $hitpoints hitpoints left! If I attack now, I am sure to be vanquished. By a dummy, nonetheless."
                [/message]
                {CLEAR_VARIABLE hitpoints}
                [allow_undo]
                [/allow_undo]
            [/event]
            [event]
                name=side 1 turn end
                [remove_event]
                    id=prevent_attacking
                [/remove_event]
            [/event]
            
            #------------------------
            # OBJECTIVES
            #------------------------
            [objectives]
                [objective]
                    description= _ "End your turn on a village"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]
            
            #------------------------
            # VILLAGE EXPLANATION
            #------------------------
            [event]
                name=capture
                {REMOVE_ARROW}
                [remove_event]
                    id=explain_undo
                [/remove_event]
                [message]
                    speaker=Mari
                    message= _"You have captured a village, which now flies the fabulously pretty colors of our banner. Villages provide the shiny gold <i>income</i> we need to <i>recruit</i> units. The house icon at the top of the screen shows our total village count."
                [/message]
                [message]
                    speaker=Mari
                    message= _"More to the point, villages also provide healing. Starting your turn on a village will <i>heal</i> you for 8 hitpoints. End your turn now."
                [/message]
                [allow_end_turn][/allow_end_turn]
            [/event]
        [/event]
        
        
        #############################
        # TUTORIAL 5: RECRUITING
        #############################
#define EXPLAIN_TRAITS TRAIT1 TRAIT2 MESSAGE
        [if] {HAVE_UNIT id,trait=$unit.id,{TRAIT1}}
             {HAVE_UNIT id,trait=$unit.id,{TRAIT2}}
            [then]
                [message]
                    speaker=unit
                    message= _"Us soldiers may all look alike, but we’re different people! " + {MESSAGE}
                [/message]
                [message]
                    speaker,image=narrator,wesnoth-icon.png
                    {TUTOR: _"A unit’s traits are listed in the sidebar, under it’s race (e.g. “Human”). Mouse-over a trait to see what effects it has."}
                [/message]
            [/then]
        [/if]
#enddef
        [event]
            name=side 1 turn 3 refresh
            [message]
                speaker=Mari
                message= _"Congratulations, you ran away from the quintain and have regained 8 hitpoints from your village. I hope you’re proud."
            [/message]
            [message]
                speaker=Deoran
                message= _"I’ve had enough of being humiliated by this dummy. Time to recruit some proper soldiers and smash that thing to pieces."
            [/message]
            [message]
                speaker,image=narrator,wesnoth-icon.png
                {TUTOR: _"The golden crown in Deoran’s upper-left-hand corner indicates he’s a leader: he can <b>recruit</b> new units when standing on a castle’s <b>keep</b> hex.

In most scenarios, you will lose if your leader is killed. Don’t use Deoran too aggressively!"}
            [/message]
            {TUTORIAL_ARROW 9 10}
            [disallow_end_turn]
                reason=_"Recruit a soldier first!
(press “u” if you need to undo a move)"
            [/disallow_end_turn]
            {EXPLAIN_UNDO x,y=9,10}
            
            #------------------------
            # OBJECTIVES
            #------------------------
            [objectives]
                [objective]
                    description= _ "Recruit some soldiers"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]
            
            #------------------------
            # EXPLAIN RECRUITING
            #------------------------
            [event]
                name=moveto
                {FILTER id,x,y=Deoran,9,10}
                {REMOVE_ARROW}
                [message]
                    speaker=Deoran
                    message= _"Good, I’m on the keep. If I press <b>Ctrl-R</b>, I can recruit new soldiers to help me fight."
                [/message]
            [/event]
            
            [event]
                name=recruit
                priority=99
                [message]
                    speaker=unit
                    message= _"At your service, commander Deoran!"
                [/message]
            [/event]
            # in between these, we explain how spearman/bowmen work
            [event]
                name=recruit
                priority=-99
                [message]
                    speaker=Deoran
                    message= _"I’ll need to end my turn before my new recruits can move and attack."
                [/message]
                [allow_end_turn][/allow_end_turn]
                [event]
                    name=recruit
                    [event]
                        name=recruit
                        {EXPLAIN_TRAITS quick     intelligent _"I have the “quick” and “intelligent” traits, so I move faster and require less XP to level-up."}
                        {EXPLAIN_TRAITS quick     strong      _"I have the “quick” and “strong” traits, so I move faster and deal bonus damage in melee."}
                        {EXPLAIN_TRAITS quick     resilient   _"I have the “quick” and “resilient” traits, so I move faster and have extra hitpoints."}
                        {EXPLAIN_TRAITS strong    intelligent _"I have the “strong” and “intelligent” traits, so I deal bonus damage in melee and require less XP to level-up."}
                        {EXPLAIN_TRAITS strong    resilient   _"I have the “strong” and “resilient” traits, so I deal bonus damage in melee and have extra hitpoints."}
                        {EXPLAIN_TRAITS resilient intelligent _"I have the “resilient” and “intelligent” traits, so I have extra hitpoints and require less XP to level-up."}
                    [/event]
                [/event]
            [/event]
        [/event]
        
        
        #############################
        # TUTORIAL 6: KILLING THE QUINTAIN
        #############################
        [event]
            name=turn 4
            [message]
                speaker=Deoran
                message= _"The quintain is healing itself! Come on men, let’s go finish it off!"
            [/message]
            [message]
                speaker,image=narrator,wesnoth-icon.png
                {TUTOR: _"In addition to the +8 healing provided by a village, units will also regenerate 2 hitpoints if they spend their turn resting: neither moving nor fighting.

This “rest-healing” stacks with village healing."}
            [/message]
            
            #------------------------
            # OBJECTIVES
            #------------------------
            [objectives]
                [objective]
                    description= _ "Kill Mari’s quintain"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]
            
            #------------------------
            # QUINTAIN DIES
            #------------------------
            [event]
                name=die
                {FILTER id=quintain}
                [message]
                    speaker=second_unit
                    message= _ "Hooray! The quintain is destroyed, and I have gained 8 experience!"
                [/message]
                [message]
                    speaker,image=narrator,wesnoth-icon.png
                    {TUTOR: _"Units gain a small amount of experience when attacking or defending, but gain much more by striking a finishing blow, especially vs high-level enemies.

With enough experience, a soldier will advance to a powerful level-2 unit."}
                [/message]
                [message]
                    speaker=Mari
                    message= _ "Bravo, you’ve smashed it to pieces. I was supposed to return that dummy once we’d finished guarding the royal wedding."
                [/message]
                {DELAY 500}
                [message]
                    speaker=Mari
                    message= _ "Of course, we’ll have to fight our way past these bandits first."
                [/message]
                [fire_event]
                    name=play_battle
                [/fire_event]
            [/event]
        [/event]
        
        
        #############################
        # MARI GETS BORED EVENTUALLY
        #############################
        [event]
            name=turn 8
            {FILTER_CONDITION( {HAVE_UNIT id=quintain} )}
            [message]
                speaker=Mari
                message= _ "You’re doing a great job, just standing there. Either finish off the quintain or give up and go home."
            [/message]
        [/event]
        [event]
            name=turn 13
            {FILTER_CONDITION( {HAVE_UNIT id=quintain} )}
            [message]
                speaker=Mari
                message= _ "Very funny. You should consider becoming a comedian, because after this performance you’re definitely not going to be a knight. Go home, Deoran. I’ll handle things on my own here."
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
    [/event]
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                        PLAY BATTLE
    #######################################################################################################################################################
    [event]
        name=play_battle
        [message]
            speaker=Deoran
            message= _ "Bandits! Where?"
        [/message]
        
        #############################
        # PREPARE MAP
        #############################
        [replace_map]
            map_file=01_Raising_the_Banner.map
            expand,shrink=yes,yes
        [/replace_map]
        {NAMED_UNIT 4 Bandit 16 20 "Urza Mathin" _"Uzra Mathin" ( canrecruit=yes {MODIFICATIONS({TRAIT_QUICK}{TRAIT_INTELLIGENT})} )} # quick because easier to kill 
        [modify_side]
            side=4
            hidden=no
            gold={ON_DIFFICULTY 0 0 30}
            income={ON_DIFFICULTY -2 0 2} # plus 2-3 villages
        [/modify_side]
        [capture_village]
            side=4
            x,y,radius=19,19,10
        [/capture_village]
        {GENERIC_UNITC 4 ({ON_DIFFICULTY Thug Thug Thug}) 11 20 ()}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY Thug Thug Thug}) 13 22 ()}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY none Thug Thug}) 12 15 ()}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY none Thug Thug}) 11 15 ()}
        [modify_turns]
            value=25 # this includes the turns we spent fighting the dummy
                     # if you change this, also change the "turns almost over" event
        [/modify_turns]
        
        #############################
        # INTRO CUTSCENE
        #############################
        {SCROLL_TO 16 20}
        {DELAY 500}
        [message]
            speaker=Urza Mathin
            message= _ "Oh, what’s this? A lady and her loyal squire travelin’ south on this dangerous road? Tell ya what, we can offer ya protection ’round here for a small fee."
        [/message]
        [if] {HAVE_UNIT id,x,y=Deoran,17,1}
            [then]
                {TELEPORT_UNIT id=Deoran 9 10}
                [capture_village]
                    side=1
                    x,y,radius=10,6,3
                [/capture_village]
            [/then]
        [/if]
        [message]
            speaker=Deoran
            image=portraits/deoran-mad.webp
            message= _ "Do you take us for fools? I represent the newly-formed South Guard, on orders from Magistrate Fiore to ensure the countryside is kept safe and orderly for King Garard’s upcoming wedding."
        [/message]
        [message]
            speaker=Deoran
            image=portraits/deoran-mad.webp
            message= _ "The only danger around here is you, and I intend to put an end to your reign of terror, scum! Men, raise your spears!"
        [/message]
        [message]
            speaker=Urza Mathin
            message= _ "Hah, like it would be that easy, boy. I’m Urza Mathin, eldest of the four Uzra brothers, and these are my thugs. Time to show you who the real power is in these parts!"
        [/message]
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            side=1
            [objective]
                description= _ "Defeat Urza Mathin"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Deoran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Mari"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
        
        
        
        
        
        #######################################################################################################################################################
        #                                                                       S01 TIPS
        #######################################################################################################################################################
        #############################
        # MARI SPECTATES
        #############################
        [event]
            name=side 1 turn end
            [if] {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes}
                [then]
                    [store_unit]
                        {FILTER side=1}
                        variable=side_1_units
                    [/store_unit]
                    [message]
                        speaker=Mari
                        #po: sarcasm
                        message= _ "It only took $side_1_units.length of you to deal with that wooden dummy. I’m sure these few bandits won’t pose any problem."
                    [/message]
                    {CLEAR_VARIABLE side_1_units}
                [/then]
            [/if]
            {MOVE_UNIT id=Mari 14 9}
            {MODIFY_UNIT id=Mari facing sw}
            [message]
                speaker=Mari
                message= _ "I’ll keep an eye on things from here, but don’t expect me to fight. This might make genuinely good practice for you as your first real battle."
            [/message]
            [if] {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes}
                [then]
                    [message]
                        speaker,image=narrator,wesnoth-icon.png
                        {TUTOR: _"You may toggle tips on or off at any time during the campaign by right-clicking anywhere and selecting “Tips: On/Off” in the menu."}
                    [/message]
                [/then]
                [else]
                    [message]
                        speaker,image=narrator,wesnoth-icon.png
                        {TUTOR: _"You may toggle tips on or off at any time during the campaign by right-clicking anywhere and selecting “Tips: On/Off” in the menu.

Because you skipped the tutorial, tips are currently off."}
                    [/message]
                [/else]
            [/if]
            
            #############################
            # TUTORIAL TOGGLE
            #############################
            [set_menu_item]
                id=tutorial_toggle_on
                description= _ "Tips: On"
                image="wesnoth-icon.png~SCALE(18,18)"
                [show_if]
                    [variable]
                        name=enable_tutorial_elements
                        boolean_equals=yes
                    [/variable]
                [/show_if]
                [command]
                    {VARIABLE enable_tutorial_elements no}
                    [hint_message]
                        remove=yes
                    [/hint_message]
                [/command]
            [/set_menu_item]
            [set_menu_item]
                id=tutorial_toggle_off
                description= _ "Tips: Off"
                image="wesnoth-icon.png~SCALE(18,18)"
                [show_if]
                    [variable]
                        name=enable_tutorial_elements
                        boolean_equals=no
                    [/variable]
                [/show_if]
                [command]
                    {VARIABLE enable_tutorial_elements yes}
                [/command]
            [/set_menu_item]
        [/event]
        
        
        #############################
        # MARI EXPLAINS DEFENSE
        #############################
        [event]
            name=new turn
            {TUTORIAL_ENABLE_CONDITION}
            [message]
                speaker=Mari
                message= _ "Wondering about those percentages that appear on the ground every time you move a unit? That’s your units’ defense — their chance to <b>dodge</b> enemy attacks. Position your units on good terrain, and lure your opponents onto bad terrain."
            [/message]
        [/event]
        
        
        #############################
        # UZRA MATHIN TEACHES TIME OF DAY
        #############################
        [event]
            name=new turn
            first_time_only=no
            [store_time_of_day]
            [/store_time_of_day]
        [/event]
        [event]
            name=side 2 turn refresh
            {FILTER_CONDITION( {VARIABLE_CONDITIONAL time_of_day.id equals morning} )} # at morning, so it coincides with the AI's retreat
            {TUTORIAL_ENABLE_CONDITION}
            [message]
                speaker=Urza Mathin
                message= _ "Curses, the sun has risen! My thugs and I are feeble during the day, while these Wesnoth soldiers will be at their strongest!"
            [/message]
        [/event]
        [event]
            name=side 2 turn refresh
            {FILTER_CONDITION( {VARIABLE_CONDITIONAL time_of_day.id equals dusk} )} # at dusk, so it coincides with the AI's attack
            {TUTORIAL_ENABLE_CONDITION}
            [message]
                speaker=Urza Mathin
                message= _ "The sun begins to set! Soon these Wesnoth soldiers will falter in the dark, while my thugs and I will fight at our best!"
            [/message]
        [/event]
#define UNFAVORABLE_MELEE_ATTACK
        attack end
        {FILTER side=1}
        {FILTER_ATTACK range=melee} # since Mathin only recruits thugs, we know that any nighttime melee attack will be unfavorable
        {FILTER_CONDITION(          # ranged attacks are ok; don't count those
                 {VARIABLE_CONDITIONAL time_of_day.id equals first_watch}
            {OR( {VARIABLE_CONDITIONAL time_of_day.id equals second_watch} )}
        )}
#enddef
        [event]
            name={UNFAVORABLE_MELEE_ATTACK}
            [event]
                name={UNFAVORABLE_MELEE_ATTACK}
                [event]
                    name={UNFAVORABLE_MELEE_ATTACK}
                    [event]
                        name={UNFAVORABLE_MELEE_ATTACK}
                        {TUTORIAL_ENABLE_CONDITION}
                        [message]
                            speaker=Urza Mathin
                            message= _ "Ha, this will be an easy victory! These soldiers’ young commander must be a fool, for he fights my thugs at night while I am strong and he is weak!"
                        [/message]
                    [/event]
                [/event]
            [/event]
        [/event]
        
        
        #############################
        # MARI EXPLAINS BANDIT LEADER
        #############################
        [event]
            name=moveto
            {FILTER( side=1 {FILTER_ADJACENT id="Uzra Mathin"} )}
            {TUTORIAL_ENABLE_CONDITION}
            {TALK_ABOUT (Urza Mathin) ( _ "Urza Mathin is a <b>level 2</b> unit, with much stronger melee attacks than the <b>level 1</b> units that he commands. We should strike him with ranged attacks and during the day, unless you really enjoy getting clubbed.")}
            {UNDO_REMINDER}
        [/event]
    [/event]

    
    
    
    
    #######################################################################################################################################################
    #                                                                    VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # TIME ALMOST OVER
    #############################
    [event]
        name=turn 20
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL sg_turns_info not_equals yes} )}
        {TUTORIAL_ENABLE_CONDITION}
        [message]
            speaker=Mari
            message= _ "Deoran, could you move any slower? You’re running out of time to finish off these bandits. You can see the turn counter in the upper-left-hand corner — once you run out of turns, you’ll lose the scenario."
        [/message]
        {VARIABLE sg_turns_info yes}
    [/event]
    #############################
    # TIME OVER
    #############################
    [event]
        name=time over
        {GENERIC_UNIT 2 (Footpad) 10 23} {ANIMATE}
        {GENERIC_UNIT 2 (Outlaw)   9 22} {ANIMATE}
        {GENERIC_UNIT 2 (Footpad) 12 22} {ANIMATE}
        {GENERIC_UNIT 2 (Footpad)  7 23} {ANIMATE}
        {GENERIC_UNIT 2 (Footpad)  6 23} {ANIMATE}
        
        {GENERIC_UNIT 2 (Trapper)  1 17} {ANIMATE}
        {GENERIC_UNIT 2 (Poacher)  2 17} {ANIMATE}
        {GENERIC_UNIT 2 (Poacher)  1 15} {ANIMATE}
        {GENERIC_UNIT 2 (Poacher)  3 16} {ANIMATE}
        
        [message]
            speaker=Urza Mathin
            message= _ "Reinforcements from my brothers! Excellent. These lands belong to the brothers Urza!"
        [/message]
        [message]
            speaker=Mari
            message= _ "We’ve run out of turns, and now more enemies have arrived! We’ll have to retreat and bring more soldiers some other time. Maybe I should have helped fight..."
        [/message]
    [/event]
    #############################
    # UZRA MATHIN DIES
    #############################
    [event]
        name=last breath
        {FILTER( id=Urza Mathin )}
        
        #------------------------
        # UZRA MATHIN REANIMATES
        #------------------------
        [message]
            speaker=Deoran
            image=portraits/deoran-mad.webp
            message= _ "You are beaten, you bloodthirsty, balding bandit! Accosting travelers between Weldyn and Westin; what is the meaning of this? How have you become powerful enough to strike at even trained soldiers!?"
        [/message]
        [message]
            speaker=Urza Mathin
            message= _ "How... impossible... no! If I die... so will you!"
        [/message]
        {KILL id=$unit.id ANIMATE=yes}
        {NAMED_UNIT 4 Soulless $unit.x $unit.y "Zombie Mathin" _"Uzra Mathin" (canrecruit=yes)}
        [message]
            speaker=Zombie Mathin
            message= _ "Guhh... kill... bite..."
        [/message]
        {TELEPORT_UNIT id=Mari 12 15} # so she has less distance to walk
        [message]
            speaker=Mari
            message= _ "Look out!"
        [/message]
        {MOVE_UNIT id=Mari $unit.x $unit.y}
        [harm_unit]
            {FILTER id="Zombie Mathin"}
            {FILTER_SECOND id=Mari}
            amount=999
            animate=yes
            delay=0
        [/harm_unit]
        
        #------------------------
        # WONDERING ABOUT ZOMBIES
        #------------------------
        [message]
            speaker=Mari
            #po: Mari lost her left arm fighting undead in the Estmarks
            message= _ "Undead again. As if losing one arm to these things years ago wasn’t bad enough."
        [/message]
        [message]
            speaker=Deoran
            message= _ "I’ve never seen the like before in my life! That man clearly died, then stood right back up again! You say you’ve fought these things before, Mari?"
        [/message]
        [message]
            speaker=Mari
            message= _ "Yeah, I have. And no, simple bandits aren’t supposed to know how to create them. This reeks of black magic; powerful black magic."
        [/message]
        [message]
            speaker=Deoran
            message= _ "This brother said he was the eldest of four — the other three are doubtless still alive and causing trouble. We can’t allow anything to interfere with King Garard’s wedding!"
        [/message]
        [message]
            speaker=Mari
            message= _ "Never mind our assignment; how did petty outlaws get their hands on magic like this? We need to continue onwards to Westin, and meet with the magistrate. Maybe someone in town will know something about this..."
        [/message]
        
        [set_achievement]
            content_for=The_South_Guard_Revised
            id=tsg_s01
        [/set_achievement]
        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
    
    #############################
    # NARRATOR EXPLAINS VICTORY
    #############################
    [event]
        name=victory
        {TUTORIAL_ENABLE_CONDITION}
        [message]
            speaker,image=narrator,wesnoth-icon.png
            {TUTOR: _"You have completed all the <i>objectives</i> for this scenario and achieved victory! You will now see a pop-up detailing your <b>early finish bonus</b>, a gold bonus for finishing the scenario before the turn limit, and <b>gold carryover</b>, the amount of extra gold you will start the next scenario with. When you are done reading these, press the <b>End Scenario</b> button or <b>Ctrl+Space</b> to continue to the next scenario."}
        [/message]
    [/event]
    
    {~add-ons/The_South_Guard_Revised/utils/sg_deaths.cfg}
    {~add-ons/The_South_Guard_Revised/utils/sg_help.cfg}
    {SIDE_ONE_DESCRIPTIONS}
[/scenario]
