#textdomain wesnoth-tsg

#define TURN_LIMIT
35#enddef
#define TURN_WARNING
30#enddef

[scenario]
    id=05a_The_Long_March
    map_file=05a_The_Long_March.map
    name= _ "The Long March"
    next_scenario=05a_The_Long_March
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER}
    
    {DEFAULT_SCHEDULE}
    turns={TURN_LIMIT}
    
    {SCENARIO_MUSIC nunc_dimittis.ogg}
    {EXTRA_SCENARIO_MUSIC heroes_rite.ogg}
    
    {SG_LONGMARCH}
    {TSG_BIGMAP {JOURNEY_05b_NEW} }
    
    
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=good
        user_team_name=_"South Guard"
        gold=30
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
        shroud,fog=yes,yes
    [/side]
    
    #############################
    # TOWN GUARD
    #############################
    [side]
        side=2
        color=wesred
        controller=null
        team_name=good
        no_leader,hidden=yes,yes
    [/side]
    
    #############################
    # ELVES
    #############################
    # rangers
    [side]
        side=3
        color=green
        controller=ai
        team_name=elves
        no_leader,hidden=yes,yes
        [ai]
            [avoid]
                TODO - avoid the town areas, so we don't fight the town guard
            [/avoid]
        [/ai]
    [/side]
    # warriors
    [side]
        side=4
        color=green
        controller=ai
        team_name=elves
        no_leader,hidden=yes,yes
    [/side]
    # idle
    [side]
        side=5
        color=green
        controller=null
        team_name=elves
        no_leader,hidden=yes,yes
    [/side]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        
        #############################
        # BRAZIERS
        #############################
        {BRAZIER_ILLUMINATION 6 1}
        {BRAZIER_ILLUMINATION 9 2}
        
        #############################
        # TOWN GUARDS
        #############################
#define TOWN_GUARD TYPE X Y FACE
        [unit]
            side,x,y,facing=2,{X},{Y},{FACE}
            type,role={TYPE},guard{X}{Y}
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
        [event]
            name=side 2 turn refresh
            first_time_only=no
            {MODIFY_UNIT role=guard{X}{Y} moves 0}
        [/event]
#enddef
        {TOWN_GUARD Woodsman   13 7 sw}
        {TOWN_GUARD Peasant    10 6 se} # same as s05b
        {TOWN_GUARD Peasant    24 6 se}
        {TOWN_GUARD Peasant    12 2 sw}
        {TOWN_GUARD Peasant    13 2 se}
        {TOWN_GUARD Longbowman 12 1 se}
        {TOWN_GUARD Woodsman    4 2 sw}
        
        #############################
        # DEORAN AND CO
        #############################
        {RECALL_XY Deoran 8 4} {MODIFY_UNIT id=Deoran facing sw}
        
        #############################
        # ELVISH SQUADS
        #############################
        {GENERIC_UNITC 5 {ON_DIFFICULTY "Elvish Fighter" "Elvish Fighter" "Elvish Fighter"}  9 23 ({ROLE squad1})}
        {GENERIC_UNITC 5 {ON_DIFFICULTY "none"           "none"           "Elvish Fighter"} 11 23 ({ROLE squad1})}
        {GENERIC_UNITC 5 {ON_DIFFICULTY "none"           "Elvish Fighter" "Elvish Captain"} 10 21 ({ROLE squad1})}
        
        {GENERIC_UNITC 5 {ON_DIFFICULTY "Elvish Fighter" "Elvish Fighter" "Elvish Fighter"} 21 15 ({ROLE squad2})}
        {GENERIC_UNITC 5 {ON_DIFFICULTY "none"           "none"           "Elvish Fighter"} 20 15 ({ROLE squad2})}
        {GENERIC_UNITC 5 {ON_DIFFICULTY "none"           "Elvish Fighter" "Elvish Hero"   } 21 17 ({ROLE squad2})}
    [/event]

    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        {DELAY 500}
        {RECALL_XY $companion_id 16 37} {MODIFY_UNIT id=$companion_id facing nw}
        [if] {VARIABLE_CONDITIONAL afalas_fled not_equals yes}
            [then]
                [unstore_unit]
                    variable=stored_afalas
                    x,y,animate=13,38,yes
                [/unstore_unit]
                {CLEAR_VARIABLE stored_afalas}
                {MODIFY_UNIT id=Afalas facing ne}
            [/then]
        [/if]
        {DELAY 1000}
        
        #############################
        # AFALAS LEAVES
        #############################
        {SAY_COMPANION
            MESSAGE_GENERIC=_"Shh! Do you hear that? Quiet footsteps move amongst the trees."
            MESSAGE_GERRICK=_"Shh! Do you hear tha’? Quiet footsteps movin’ in th’ trees."
        }
        [if] {HAVE_UNIT id=Afalas}
            [then]
                [message]
                    speaker=Afalas
                    message= _ "Nope, I didn’ hear nothin’. But just in case, perhaps me boys an’ I should go and, err, scout around. ....don’ wait for us t’ come back."
                [/message]
                [message]
                    speaker=Deoran
                    message= _ "You’re leaving just like that? What happened to fighting loyally by my side forevermore? You are our guide through the forest!"
                [/message]
                [message]
                    speaker=Afalas
                    message= _ "Did I say somethin’ like that? Don’ ring a bell."
                [/message]
                {MOVE_UNIT id=Afalas 1 34}
                [store_unit]
                    {FILTER id=Afalas}
                    variable,kill=stored_afalas,yes
                [/store_unit]
                [message]
                    speaker=Deoran
                    message= _ "He’s gone! I suppose that’s what I get for trusting an outlaw..."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Deoran
                    message= _ "I wish Afalas were still with us. He knew these paths well, but without him we risk stumbling into all manner of ambushes!"
                [/message]
            [/else]
        [/if]
        {DELAY 500}
        
        #############################
        # ELVES ARRIVE
        #############################
        {GENERIC_UNIT 3 "Elvish Ranger"  14 31} {GENDER   male} {MOVE_UNIT x,y=14,31 14 32}
        {GENERIC_UNIT 3 "Elvish Ranger"  16 31} {GENDER female} {MOVE_UNIT x,y=16,31 16 32}
        {GENERIC_UNIT 3 "Elvish Avenger" 15 32} {GENDER female} {MODIFY_UNIT x,y=15,23 canrecruit yes} {MOVE_UNIT x,y=15,32 15 33}
        [message]
            x,y=15,33
            message= _ "Humans! You’re the curs who kidnapped the Sage Mebrin. Where is Mebrin? Where is Afalas? Produce the heads of those responsible, or we shall take yours!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Elves! Friends, there is no need for anger — we never harmed Mebrin while he was alive; that was all the bandits’ doing!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "I do confess that we were forced to slay him, but only because your sage had turned to the practice of necromancy and was raising an army of undead. Would you have had us stand idly by while his evil spread?"
        [/message]
        [message]
            x,y=14,32
            message= _ "How dare you speak of Mebrin thusly?! Ethiliel warned us of this lie — though Mebrin has knowledge of the undead, he’s no human, so easily corrupted by the temptation of such power."
        [/message]
        [message]
            speaker=Deoran
            message= _ "We’re not lying! Afalas has fled, but if you travel south and enter the undead lair you will see Mebrin’s remains. Even as a broken skeleton, the lich’s elven origin is unmistakable!"
        [/message]
        [message]
            x,y=15,33
            message= _ "Enough! I should have expected that the stupidity of humans knows no bounds. We’ve nothing more to say here. You won’t see us coming."
        [/message]
        {MOVE_UNIT x,y=15,33 15 32}
        {MOVE_UNIT x,y=16,32 16 31}
        {MOVE_UNIT x,y=14,32 14 31}
        {KILL side=3}
        
        #############################
        # EXPLAINING WHAT TO DO
        #############################
        {SAY_COMPANION
            MESSAGE_MARI=_"This is our reward for killing the lich? Figures that no good deed would go unpunished. Ethiliel must be a sore loser — she’s sent rangers to ambush us while we travel the forest."
            MESSAGE_GERRICK=_"This’s that blasted shyde’s doin’. Ethiliel must’ve flown back to the Aethenwood and turned her kin ’gainst us! Now these elves’ll be waitin’ to ambush us as we march."
            MESSAGE_HYLAS=_"Now we see the meaning of Mebrin’s final words — Ethiliel has returned to the Aethenwood and angered her kin. If the elves are wise, I suspect they will attempt to ambush us as we march."
        }
        [message]
            speaker=Deoran
            message= _ "This is awful! Figthing undead and bandits was bad enough, but now elves? If we can just reach Southport, the garrison there will surely keep us safe from enemy attack."
        [/message]
        [remove_shroud]
            side,x,y,radius=1,7,3,3
        [/remove_shroud]
        [remove_shroud]
            side,x,y,radius=1,11,4,5
        [/remove_shroud]
        [remove_shroud]
            side,x,y,radius=1,16,1,2
        [/remove_shroud]
        {SCROLL_TO 10 7}
        {DELAY 1000}
        [message]
            speaker=Deoran
            message= _ "But we’ll have to move quickly. The longer we wait, the more elves will arrive to harry us!"
        [/message]
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Move Deoran and $companion_name to the north shore"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]
    
    #############################
    # ACTIVATE "SQUADS"
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION( radius=6 {FILTER role=squad1} )} )}
        {MODIFY_UNIT role=squad1 side 4}
        {FIRE_EVENT squad_dialogue}
    [/event]
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION( radius=6 {FILTER role=squad2} )} )}
        {MODIFY_UNIT role=squad2 side 4}
        {FIRE_EVENT squad_dialogue}
    [/event]
    [event]
        name=squad_dialogue
        [message]
            side=4
            message= _ "Humans, bandits and abductors! Prepare to be slain!"
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"Let it be, will you! What happened to your whole elven holier-than-thou shtick? I just want to go home."
            MESSAGE_GERRICK=_"Out o’ the way, elf! We’ve got nothin’ ’gainst you or your kind, but we do want to get back home."
            MESSAGE_HYLAS=_"We have no quarrel with you, elves of the Aethenwood. We simply wish to return to our homes."
        }
        [message]
            side=4
            message= _ "And so does our sage Mebrin, yet you’ve not returned him to us! Even if you did, we’d still dispatch of you for your heinous transgressions, you treacherous scum!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "There’s no reasoning with the elves. We’ll either have to fight or run."
        [/message]
    [/event]
    
    
    
    
    #######################################################################################################################################################
    #                                                                 RANGER AI
    #######################################################################################################################################################
    #############################
    # RANGERS ATTACK
    #############################
    [event]
        name=rangers_attack
        [micro_ai]
            type,action,side=goto,delete,3
        [/micro_ai]
        [foreach]
            variable=stored_rangers
            [do]
                # pick a random hex out of all the hexes that:
                #	- are forest hexes
                #	- are not within 1-2 hexes of any enemies
                #	- are 3-5 hexes away from a player unit
                # we also prefer hexes that are also adjacent to a ranger/avenger
                [store_locations]
                    terrain=*^F*  {NOT(radius=1-2 {FILTER side=1,2})}  {FILTER_LOCATION(radius=3-5 {FILTER side=1})}
                    variable=ambush_locs_fallback
                [/store_locations]
                [store_locations]
                    find_in=$ambush_locs_fallback  {FILTER_ADJACENT_LOCATION({FILTER side,type_adv_tree=3,"Elvish Ranger"})}
                    variable=ambush_locs
                [/store_locations]
                [if] {VARIABLE_CONDITIONAL ambush_locs equals $null}[then] {VARIABLE ambush_locs $ambush_locs_fallback} [/then]{BR}[/if]
                
                # unstore our ranger on a randomly chosen hex meeting those criteria
                {VARIABLE_OP j rand "0..$($ambush_locs.length-1)"}
                [unstore_unit]
                    variable=this_unit
                    x,y=$ambush_locs[j].x,$ambush_locs[j].y
                [/unstore_unit]
                {CLEAR_VARIABLE j}
                [heal_unit]
                    id=$this_unit.id
                    amount=$ranger_heal
                [/heal_unit]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE stored_rangers}
        
        {FIRE_EVENT rangers_retreat}
    [/event]
    
    #############################
    # RANGERS RETREAT
    #############################
    [event]
        name=rangers_retreat
        [event]
            name=new turn
            # create goto MAI for our ranger side
            #	- seek hexes that are far away from player or town units
            #	- avoid hexes that are both non-forest and not near a player unit (or else we might get boxed in)
            [micro_ai]
                type,action,side=goto,add,3
                {FILTER type_adv_tree="Elvish Ranger"}
                {FILTER_LOCATION( terrain=F*^*  {NOT( radius=8 {FILTER side=1,2} )} )}
                [avoid] # goto avoid works different from normal avoid - we don't even more through non-forest, which is the desired behavior
                    {NOT( terrain=*^F* )}
                    {NOT( radius=2 {FILTER side=1} )}
                [/avoid]
                remove_movement=no
            [/micro_ai]
            {VARIABLE ranger_heal 4}
            
            {FIRE_EVENT rangers_regroup}
        [/event]
    [/event]
    
    #############################
    # RANGERS REGROUP
    #############################
    [event]
        name=rangers_regroup
        [event]
            name=side 3 turn
            # if rangers have safely escaped and are invisible, store them
            [store_unit]
                {FILTER( side,type_adv_tree=2,"Elvish Ranger" {FILTER_LOCATION terrain=*^F*} {NOT({FILTER_ADJACENT side=1})} )}
                variable,kill=stored_rangers,yes
                mode=append
            [/store_unit]
            
            # 1/3 chance of attacking first turn, 2/3 (net 45%) chance of attacking second turn, 3/3 (net 22%) to attack third turn
            {VARIABLE_OP attack_odds rand 5,50,9999}
            [if] {VARIABLE_CONDITIONAL attack_odds less_than_equal_to $ranger_heal}
                [then]{BR} {FIRE_EVENT rangers_attack } {BR}[/then]
                [else]{BR} {FIRE_EVENT rangers_regroup} {BR}[/else]
            [/if]
            {CLEAR_VARIABLE attack_odds}
            {VARIABLE_OP ranger_heal multiply {ON_DIFFICULTY 2 4 6}
        [/event]
    [/event]
    
    #############################
    # REINFORCE RANGERS
    #############################
#define STORE_NEW_RANGER TYPE
    {GENERIC_UNITC 3 {TYPE} 1 1 ()}
    [store_unit]
        {FILTER x,y=1,1}
        variable,kill=stored_rangers,yes
        mode=append
    [/store_unit]
#enddef
    [event]
        name=prestart
        {VARIABLE_OP reinforcement_turn1 rand 10,11}
        {VARIABLE_OP reinforcement_turn2 rand 18,19}
        {VARIABLE_OP reinforcement_turn3 rand 24,25}
        {VARIABLE_OP reinforcement_turn4 rand 28,29}
        {VARIABLE_OP reinforcement_turn5 rand 32,33}
    [/event]
    [event]
        name=turn $reinforcement_turn1
        {STORE_NEW_RANGER {ON_DIFFICULTY "none"          "Elvish Ranger" "Elvish Ranger" }}
        {STORE_NEW_RANGER {ON_DIFFICULTY "none"          "none"          "Elvish Ranger" }}
    [/event]
    [event]
        name=turn $reinforcement_turn2
        {STORE_NEW_RANGER {ON_DIFFICULTY "Elvish Ranger" "Elvish Ranger" "Elvish Avenger"}}
        {STORE_NEW_RANGER {ON_DIFFICULTY "none"          "Elvish Ranger" "Elvish Ranger" }}
        {STORE_NEW_RANGER {ON_DIFFICULTY "none"          "none"          "Elvish Ranger" }}
    [/event]
    [event]
        name=turn $reinforcement_turn3
        {STORE_NEW_RANGER {ON_DIFFICULTY "Elvish Ranger" "Elvish Ranger" "Elvish Avenger"}}
        {STORE_NEW_RANGER {ON_DIFFICULTY "Elvish Ranger" "Elvish Ranger" "Elvish Avenger"}}
        {STORE_NEW_RANGER {ON_DIFFICULTY "none"          "Elvish Ranger" "Elvish Ranger" }}
        {STORE_NEW_RANGER {ON_DIFFICULTY "none"          "none"          "Elvish Ranger" }}
    [/event]
    [event]
        name=turn $reinforcement_turn4
        {STORE_NEW_RANGER {ON_DIFFICULTY "none"          "Elvish Ranger" "Elvish Ranger" }}
        {STORE_NEW_RANGER {ON_DIFFICULTY "none"          "none"          "Elvish Ranger" }}
    [/event]
    [event]
        name=turn $reinforcement_turn5
        {STORE_NEW_RANGER {ON_DIFFICULTY "none"          "Elvish Ranger" "Elvish Ranger" }}
        {STORE_NEW_RANGER {ON_DIFFICULTY "none"          "none"          "Elvish Ranger" }}
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                 VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # TOWN IS SIGHTED
    #############################
    [event]
        name=sighted
        {FILTER side=2}
        {FILTER_SECOND side=1}
        [event]
            name=moveto
            {FILTER( side=1 {FILTER_LOCATION( radius=4 {FILTER side=2} )} )}
            
            [message]
                side=2 {FILTER_LOCATION( radius=4 {FILTER side=1} )}
                message = _ "Halt! Who comes to the border of Wesnoth?"
            [/message]
            [message]
                speaker=Deoran
                message = _ "Lower your arms, countrymen! ’tis I, commander Deoran of the South Guard!"
            [/message]
            [modify_side]
                side,fog,shroud=2,yes,yes # so we share vision with Deoran
            [/modify_side]
            [message]
                side,type=2,Swordsman
                message = _ "Deoran? It truly is you? We’d thought you’d been lost in combat with the elves!"
            [/message]
            [message]
                speaker=Deoran
                message = _ "Then the Aethenwood has been attacking you too? I had hoped Southport would serve a safe haven, but you will find myself and my men at the ready if we are needed to repel raids."
            [/message]
            [message]
                side,type=2,Swordsman
                message = _ "Raids? ...well, you’ll see soon enough. Sir, you should get back to Westin right away."
            [/message]
            
            {CLEAR_VARIABLE ranger_heal,stored_rangers}
            {CLEAR_VARIABLE reinforcement_turn1,reinforcement_turn2,reinforcement_turn3}
            [endlevel]
                result=victory
                {NEW_GOLD_CARRYOVER 0}
            [/endlevel]
        [/event]
    [/event]
    
    #############################
    # ANY UNIT MOVES NORTH OF THE RIVER
    #############################
#define NORTH_OF_RIVER
    x=  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30
    y=0-4,0-3,0-3,0-3,0-3,0-3,0-3,0-4,0-3,0-2,0-2,0-2,0-2,0-2,0-3,0-3,0-3,0-3,0-3,0-3,0-4,0-4,0-4,0-5,0-5,0-6,0-6,0-6,0-6,0-6
    radius=1
#enddef
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION {NORTH_OF_RIVER}} )}
        [message]
            speaker=Deoran
            #po: reminder that the objectives require moving both Deoran and $companion_name to Southport
            message = _"Keep moving, everyone! The sooner $companion_name and I reach Southport, the sooner we shall all be safe from these elves."
        [/message]
        [show_objectives]
        [/show_objectives]
    [/event]
    
    #############################
    # VICTORY
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION {NORTH_OF_RIVER}} )}
        {FILTER_CONDITION( {HAVE_UNIT(
            id=Deoran,$companion_id {AND count=2}
            {FILTER_LOCATION {NORTH_OF_RIVER}} )}
        )})}
        [message]
            speaker=Deoran
            message = _"Good, we’re across the river. Who is in command of Southport?"
        [/message]
        [message]
            side,type=2,Swordsman
            message = _ "Deoran? It truly is you? We thought you’d been lost in combat with the elves!"
        [/message]
        [message]
            speaker=Deoran
            message = _ "Then the Aethenwood has attacked you as well? I had hoped Southport would serve a safe haven, but you will find myself and my men at the ready if we are needed to repel a raid."
        [/message]
        [message]
            side,type=2,Swordsman
            message = _ "Raids? ...well, you’ll see soon enough. Sir, you should get back to Westin right away."
        [/message]
        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
    
    
    #############################
    # TIME OVER
    #############################
#     [event]
#         name=turn {TURN_WARNING}
#         [message]
#             speaker=Deoran
#             message= _ "I grow weary! Even holding my weapon is getting difficult. "
#         [/message]
#         {SAY_COMPANION
#             MESSAGE_MARI=_"Yeah, I feel it too. Something’s very wrong in this forest. If we can’t finish our fight quickly, I’m not sure we’re getting out of here at all."
#             MESSAGE_GERRICK=_"Aye, I feel it too. Somethin’s very wrong in this here forest. If we can’t finish our fight quick, I’m not sure we’re ever gettin’ back home."
#             MESSAGE_HYLAS=_"I feel it too. Dark magic suffuses this forest — if we cannot finish our fight quickly, we may never be able to."
#         }
#         [message]
#             speaker,image=narrator,wesnoth-icon.png
#             {TUTOR: _"You are running out of turns to complete this scenario! See your objectives by pressing Ctrl+J, and remember that the turn limit can be seen in the top-left-hand corner."}
#         [/message]
#     [/event]
    [event]
#         name=side 1 turn {TURN_LIMIT} end
#         [message]
#             speaker=Deoran
#             message= _ "The darkness is so heavy... My soul burns; this forest’s foul magic has sapped all our our strength!"
#         [/message]
#         [message]
#             speaker=Deoran
#             message= _ "I cannot keep fighting... We must— we must attempt to retreat..."
#         [/message]
        [message]
            speaker,image=narrator,wesnoth-icon.png
            {TUTOR: _"You have run out of turns to complete the scenario, and have been defeated!"}
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    
[/scenario]



