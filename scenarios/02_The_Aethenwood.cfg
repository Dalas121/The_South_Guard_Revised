#textdomain wesnoth-tsg
[scenario]
    id=02_The_Aethenwood
    map_file=02_The_Aethenwood.map
    name= _ "The Aethenwood"
    next_scenario=03_Vale_of_Tears
    victory_when_enemies_defeated=no
    
    {DEFAULT_SCHEDULE_DAWN}
    turns=25
    
    {SCENARIO_MUSIC wanderer.ogg}
    {EXTRA_SCENARIO_MUSIC traveling_minstrels.ogg}
    {EXTRA_SCENARIO_MUSIC legends_of_the_north.ogg}

    {TSG_BIGMAP {JOURNEY_02_NEW} }

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=good
        user_team_name=_"South Guard"
        gold=75
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
    [/side]
    
    #############################
    # BANDITS (UNDEAD)
    #############################
    [side]
        side=2
        color=blue
        controller=ai
        type=Trapper
        id=Urza Fastik
        name= _ "Urza Fastik"
        team_name=bandits
        gold={ON_DIFFICULTY 15 30 45}
        income={ON_DIFFICULTY -2 1 4} # plus 3 villages
        recruit=Walking Corpse # no variants or soulless; keep things simple for a new player to understand
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 1}
    {STARTING_VILLAGES 2 4}
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2 offensive 0.4 0.25}
        # don't vary by AI. Most humans are ZONE_GUARDIANs, and zombies are dumb.
        {RETREAT_WHEN_WEAK 2 {ON_DIFFICULTY 0-1 0-2 0-3} (
            {GOAL_LOCATION 99 x,y=23,15}
            {GOAL_LOCATION 88 x,y=22,13}
            {GOAL_LOCATION 77 x,y=22,15}
        )}
        {MODIFY_SIDE_AI 2 ([avoid]
            x,y,radius=6,4,9
        [/avoid])}
    [/event]
    
    #############################
    # ELVES
    #############################
    [side]
        side=3
        color=blue
        controller=ai
        no_leader=yes
        hidden=yes
        team_name=good
        {FLAG_VARIANT wood-elvish}
        
        # She is already in the game if she is on the recall list, which allows
        # the victory event to work, if it is triggered using debug mode commands.
        [unit]
            type=Elvish Shyde
            id=Ethiliel
            name= _ "Ethiliel"
            unrenamable=yes
            profile=portraits/ethiliel.webp
            x,y=recall,recall
            random_traits=no
            [modifications]
                {TRAIT_LOYAL_HERO}
                {TRAIT_RESILIENT}
                {TEAM_COLOR_OVERRIDE () green}
            [/modifications]
        [/unit]
    [/side]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        
        {SET_LABEL 6 4 _"Aethenwood Outpost"}
        
        #############################
        # BANDIT GUARDS
        #############################
        {GENERIC_UNITC 4 ({ON_DIFFICULTY Poacher Poacher Trapper})  30  6  ({ROLE guard}{ZONE_GUARDIAN 30  6 (  x,y,radius=25,4,6 {OR x,y,radius=28,8,1} {OR x,y=17-23,0-99}  )})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY Thug    Thug    Bandit })  25  6  ({ROLE guard}{ZONE_GUARDIAN 25  6 (  x,y,radius=25,4,6 {OR x,y,radius=28,8,1} {OR x,y=17-23,0-99}  )})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY Poacher Poacher Trapper})  28  8  ({ROLE guard}{ZONE_GUARDIAN 28  8 (  x,y,radius=25,4,6 {OR x,y,radius=28,8,1} {OR x,y=17-23,0-99}  )})}
#ifdef EASY
        {MODIFY_TERRAIN Hhd 27 12}
        {MODIFY_TERRAIN Hhd 26 16}
#endif
        {GENERIC_UNITC 4 ({ON_DIFFICULTY none    Thug    Thug   })  27 12  ({ROLE guard}{ZONE_GUARDIAN 27 12 x,y,radius=22,9,6})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY none    Thug    Thug   })  26 16  ({ROLE guard}{ZONE_GUARDIAN 26 16 x,y,radius=22,16,5})}
    [/event]

    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        #############################
        # DEORAN SETS UP
        #############################
        {DELAY 500}
        {RECALL_XY Deoran 46 8}
        {MOVE_UNIT id=Deoran 43 8}
        {MODIFY_TERRAIN Ke 43 8} [redraw][/redraw] {DELAY 250}
        {MODIFY_TERRAIN Ce 42 7} [redraw][/redraw] {DELAY 250}
        {MODIFY_TERRAIN Ce 42 8} [redraw][/redraw] {DELAY 250}
        {MODIFY_TERRAIN Ce 43 9} [redraw][/redraw] {DELAY 250}
        
        #############################
        # BANDIT SPEAKS
        #############################
        [message]
            speaker=Urza Fastik
            message= _ "So, the South Guard dares set foot outside their derelict hovel of a city? We were warned you might seek out the elves!"
        [/message]
        [message]
            speaker=Urza Fastik
            message= _ "Fools. I am second of the Urza brothers, and since the death of my elder sibling I have been preparing to face you! Behold my new powers!"
        [/message]
        [object]
            {FILTER id="Urza Fastik"}
            [effect]
                apply_to=new_animation
                id=urza_fastik_black_magic
                [animation]
                    apply_to=black_magic
                    start_time=0
                    [frame]
                        image="units/human-outlaws/trapper-bow-attack1.png:150"
                    [/frame]
                    [frame]
                        image="units/human-outlaws/trapper-bow-defend.png"
                        halo=halo/undead/dark-magic-[1~6].png:50
                        halo_x,halo_y=0,0
                    [/frame]
                    [frame]
                        image="units/human-outlaws/trapper-bow-attack1.png:150"
                    [/frame]
                    sound_start_time=-40
                    [sound_frame]
                        sound=magic-dark.ogg
                    [/sound_frame]
                [/animation]
            [/effect]
        [/object]
        [animate_unit]
            {FILTER id="Urza Fastik"}
            flag=black_magic
        [/animate_unit]
        {GENERIC_UNIT 2 "Walking Corpse" 23 15} {ANIMATE}
        {DELAY 250}
        [animate_unit]
            {FILTER id="Urza Fastik"}
            flag=black_magic
        [/animate_unit]
        {GENERIC_UNIT 2 "Walking Corpse" 22 15} {ANIMATE}
#ifndef EASY
        {DELAY 250}
        [animate_unit]
            {FILTER id="Urza Fastik"}
            flag=black_magic
        [/animate_unit]
        {GENERIC_UNIT 2 "Walking Corpse" 22 13} {ANIMATE}
#endif
#ifdef HARD
        {DELAY 250}
        [animate_unit]
            {FILTER id="Urza Fastik"}
            flag=black_magic
        [/animate_unit]
        {GENERIC_UNIT 2 "Walking Corpse" 21 14} {ANIMATE}
#endif
        
        #############################
        # DEORAN STRATEGIZES
        #############################
        {RECALL_XY $companion_id 42 7}
        {SAY_COMPANION
            MESSAGE_MARI=_"[TODO] So the rumors are true. Nasty, squishy things those corpses are, but none too bright. Make sure to fight them during the day, and from superior terrain."
            MESSAGE_GERRICK=_"So the rumors are true. Nasty, squishy things those corpses are, but none too bright. Make sure to fight them during the day, and from superior terrain."
            MESSAGE_HYLAS=_"[TODO] So the rumors are true. Nasty, squishy things those corpses are, but none too bright. Make sure to fight them during the day, and from superior terrain."
        }
        [message]
            speaker=Deoran
            message= _ "This outlaw is stronger than the last one we faced, but we have become stronger too! If we have any veteran soldiers from the previous battle, I may wish to recall them so they can continue to gain experience and level up."
        [/message]
        [if] {TUTORIAL_ENABLE_CONDITION}
            [then]
                [message]
                    speaker,image=narrator,wesnoth-icon.png
                    {TUTOR: _"Press <b>Alt+R</b> to <i>recall</i> veteran soldiers from the previous scenario. Recalling a veteran only costs 20 gold, no matter how powerful they are."}
                [/message]
                {SAY_COMPANION
                    MESSAGE_GENERIC=_"Deoran, recalling and leveling-up soldiers is very important! By protecting your veterans and recalling them each scenario so they continue to gain experience, you can build a very powerful army!

And if you need to recruit new soldiers, you can always do so by pressing <b>Ctrl+R</b>. Don’t forget: <b>Ctrl+R</b> to recruit, <b>Alt+R</b> to recall."
                }
            [/then]
        [/if]
        [message]
            speaker=Deoran
            message= _ "Nevertheless, violence alone won’t prevail here. My quest is to meet with the elves — even if I defeat the bandits first, I can only win by approaching the elvish castle in the western forest."
        [/message]
        {HIGHLIGHT_IMAGE 6 4 items/gohere.png ()}
        [message]
            speaker=Deoran
            message= _ "From what $companion_name tells me, no man has set foot in these woods for many a year. These elves have never been friendly toward humankind, and have grown colder still after the magistrate spurned them. Who knows how they might react when we approach."
        [/message]
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            side=1
            [objective]
                description= _ "Move Deoran to the Aethenwood outpost"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]
    
    
    
    
    #######################################################################################################################################################
    #                                                                     S02 TIPS
    #######################################################################################################################################################
    
    
    
    
    
    
    
    
    [event]
        name=last breath
        [filter]
            id=Urza Fastik
        [/filter]

        [message]
            speaker=unit
            message= _ "Even with the power of darkness... at my command... I..."
        [/message]

        [message]
            speaker=Mari
            message= _ "Hey wait, I need to ask you some—"
        [/message]

        [kill]
            x,y=$x1,$y1
            animate=yes
        [/kill]

        [message]
            speaker=Mari
            message= _ "—questions. Or you can die instantly, that works too. You died even faster than your baldy brother."
        [/message]

        [message]
            speaker=Deoran
            message= _ "Let us be positive, Captain, at least he was carrying some gold!"
        [/message]

        [sound]
            sound=gold.ogg
        [/sound]

        [gold]
            side=1
            {QUANTITY amount 60 40 20}
        [/gold]

        [set_achievement]
            content_for=The_South_Guard_Revised
            id=tsg_s02
        [/set_achievement]
    [/event]

    # The elvish citadel
    [event]
        name=moveto
        [filter]
            id=Deoran,Mari
            x,y=11,7
        [/filter]

        {MOVE_UNIT (id=Mari) 11 7}
        {MOVE_UNIT (id=Deoran) 11 7}

        [hint_message]
            remove=yes
        [/hint_message]

        [remove_item]
            x,y=11,7
        [/remove_item]

        {NAMED_LOYAL_UNIT 3 (Elvish Ranger) 9 4 (Linderion) (_"Linderion")}
        {NAMED_LOYAL_UNIT 3 (Elvish Marksman) 13 4 (Mithalwe) (_"Mithalwe")}
        {NAMED_LOYAL_UNIT 3 (Elvish Hero) 9 10 (Vardanos) (_"Vardanos")}
        {NAMED_LOYAL_UNIT 3 (Elvish Avenger) 13 10 (Talchar) (_"Talchar")}

        [unit]
            side=3
            type=Elvish Marshal
            id=Ithelden
            name= _ "Ithelden"
            profile=portraits/ithelden.webp
            x=7
            y=7
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]

        [unit]
            side=3
            type=Elvish Outrider
            id=Eltenmir
            name= _ "Eltenmir"
            profile=portraits/eltenmir.webp
            x=15
            y=7
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]

        [modify_unit]
            [filter]
                side=3
                ability=ambush
            [/filter]
            [status]
                uncovered=yes
            [/status]
        [/modify_unit]

        [recall]
            id=Ethiliel
            x,y=11,6
            show=no
        [/recall]
        
#         [message]
#             speaker=Deoran
#             message= _ "We cannot fear and shun everything we do not understand! Though these elves may be wary of men, and though the magistrate may be distrustful of them, it will do us no good to disparage them while seeking their help!"
#         [/message]
        
        [message]
            speaker=Linderion
            message= _ "Halt! Who enters our sacred grove without leave?"
        [/message]

        [message]
            speaker=Deoran
            message= _ "I—"
        [/message]

        [message]
            speaker=Linderion
            message= _ "Choose your words wisely, human. Speak, knowing that the penalty for trespassing on our lands is death."
        [/message]

        [message]
            speaker=Deoran
            message= _ "We—"
        [/message]

        [message]
            speaker=Ethiliel
            # wmllint: local spelling Elrath
            message= _ "Stay your hand, Linderion. These humans bear the banner of the South Guard and appear to come to us in peace. What brings you to the hallowed grove of Elrath?"
        [/message]

        [message]
            speaker=Mari
            message= _ "My lady, we seek your guidance. Bandits and criminals have summoned the dead to help them plunder our farms and villages. We seek the origins of their newfound power, as well as the means to stop it."
        [/message]

        [message]
            speaker=Ithelden
            message= _ "We sent you a messenger regarding the undead, did we not? Despite being forewarned, your commander has failed to prepare adequately yet again."
        [/message]

        [message]
            speaker=Deoran
            message= _ "But we have scarcely been here a week! We could not have acted on something that happened before our arrival. And besides, that is the fault of the previous—"
        [/message]

        [message]
            speaker=Mari
            message= _ "Peace, Deoran, now is not the time to argue.

Noble elves, I am Captain Mari, the new commander of the South Guard, and this is my deputy, Officer Deoran. I do not know all the actions of the previous commander, only that we would be grateful for your aid and that we mean to not repeat any mistakes that may have been made in the past."
        [/message]

        [message]
            speaker=Ithelden
            message= _ "For your own sake, I hope that you do not. Ask your questions."
        [/message]

        [message]
            speaker=Mari
            message= _ "What do you know of the undead?"
        [/message]

        [message]
            speaker=Ethiliel
            message= _ "My answer will depend on your motives, human. What would you do, knowing such unholy secrets?"
        [/message]

        [message]
            speaker=Deoran
            message= _ "We should seek out the source of these beings of darkness and destroy it!"
        [/message]

        [message]
            speaker=Vardanos
            message= _ "A fanciful delusion! A human untrained in the mystic arts is much more likely to be corrupted by such a force than to have the knowledge or ability to banish it."
        [/message]

        [message]
            speaker=Deoran
            message= _ "Unlike those reproachable bandits, we would never be corrupted by such evil! No matter what, we have to try."
        [/message]

        [message]
            speaker=Eltenmir
            message= _ "I have known many a human to utter these words, only to be swallowed by the allure of a power they could not possibly hope to understand."
        [/message]

        [message]
            speaker=Talchar
            message= _ "Let us not forget that historically, you humans are the origin of this perverse sorcery as well. No matter what words you may say, the past has shown that your race cannot be trusted with black magic."
        [/message]

        [message]
            speaker=Sir Gerrick
            message= _ "<i>I knew that the elves would not easily agree to help us.</i>"
        [/message]

        [message]
            speaker=Minister Hylas
            message= _ "<i>They must have seen too many bandits turn to necromancy to trust us with this information.</i>"
        [/message]

        [message]
            speaker=Ithelden
            message= _ "Enough, all of you. Ethiliel is the only one of us who has encountered the undead — she will be the best judge of what aid we would grant the humans against these abominations."
        [/message]

        [message]
            speaker=Ethiliel
            message= _ "Officer, your words are encouraging. Captain, I would also know your view of black magic."
        [/message]

        [message]
            speaker=Mari
            message= _ "My lady, as you can see, I myself was terribly injured in the Estmarks fighting undead. I personally abhor them, and like my deputy, I would see them destroyed."
        [/message]

        [message]
            speaker=Ethiliel
            message= _ "I hope that you will remain true to your word. Then know this, humans. South of here, past your southernmost borders and beyond the Black River lies the ancient Black Forest. Dark forces have always resided amongst its trees and corruption has long infested its concealed heart. It is most certainly there where these undead originate."
        [/message]

        [message]
            speaker=Ethiliel
            message= _ "Yet even I have not set foot past the boundary of the profane Black Forest; I know of only one elf who has done so. He is the Sage Mebrin and he resides in the Vale of Blossoming Trees."
        [/message]

        [message]
            speaker=Ithelden
            message= _ "Are you sure about this? The road south is no longer as safe as it once was, and Mebrin is no warrior. You would not presume to put one of our great sages in danger, Ethiliel."
        [/message]

        [message]
            speaker=Ethiliel
            message= _ "<i>I</i> will accompany the humans to Mebrin, and he can decide whether or not he wants to help us. I will not ask you to place yourselves in danger for these humans, but you will not presume to tell me — nor Mebrin — what to do. Is that fair?"
        [/message]

        [message]
            speaker=Ithelden
            message= _ "Yes, very well."
        [/message]

        [message]
            speaker=Deoran
            image=portraits/deoran-glad.webp
            message= _ "We welcome your aid, my lady."
        [/message]

        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    [event]
        name=victory

        [store_unit]
            [filter]
                id=Ethiliel
            [/filter]
            variable=EthilielV
            kill=no # Current Ethiliel may remain on the field for visual reasons.
        [/store_unit]
        # Stores a copy of Ethiel onto the recall list. The recall list cannot be
        # viewed in linger mode. Give here as well the loyal trait.
        {VARIABLE EthilielV.side 1}
        {VARIABLE EthilielV.x recall}
        {VARIABLE EthilielV.y recall}
        {CLEAR_VARIABLE EthilielV.modifications}

        [set_variables]
            name=EthilielV.modifications
            mode=insert
            [value]
                {TRAIT_LOYAL_HERO}
                {TRAIT_RESILIENT}
                {TEAM_COLOR_OVERRIDE () green}
            [/value]
        [/set_variables]

        {CLEAR_VARIABLE EthilielV.upkeep}

        [unstore_unit]
            variable=EthilielV
        [/unstore_unit]
        {CLEAR_VARIABLE EthilielV}
    [/event]

    [event]
        name=time over

        [unit]
            type=Dragoon
            side=1
            x,y=43,20
            animate=yes
        [/unit]

        [message]
            x,y=43,20
            message= _ "The magistrate of Westin sends a message. Captain Mari, you are to return to the city at once and accompany him to Weldyn. Officer Deoran shall assume command of the South Guard."
        [/message]

        [message]
            speaker=Mari
            message= _ "I’m not sure Deoran can handle this alone without me..."
        [/message]
    [/event]
    
    {~add-ons/The_South_Guard_Revised/utils/sg_deaths.cfg}
    
    # tutorial stuff
    {TSG_TUTORIAL_EVENTS_S2}
    {SIDE_ONE_DESCRIPTIONS}
[/scenario]
