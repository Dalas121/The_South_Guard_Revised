#textdomain wesnoth-tsg

[scenario]
    id=03_Vale_of_Tears
    map_file=03a_Vale_of_Tears.map
    name= _ "Vale of Tears"
    next_scenario=04_Blight
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER}
    
    {DEFAULT_SCHEDULE}
    turns=-1
    
    {SCENARIO_MUSIC elvish-theme.ogg}
    {EXTRA_SCENARIO_MUSIC knolls.ogg}
    {EXTRA_SCENARIO_MUSIC nunc_dimittis.ogg}

    {TSG_BIGMAP {JOURNEY_03_NEW} }

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=good
        user_team_name=_"South Guard"
        gold=75
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
    [/side]
    
    #############################
    # BANDITS
    #############################
    # wmllint: local spelling Nalmath
    [side]
        side=2
        color=blue
        controller=ai
        no_leader=yes
        facing=se
        team_name=bandits
        gold,income=0,{ON_DIFFICULTY -2 1 4}
        recruit=Ghoul
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 3} # since he has skirmisher, it's ok to let him move a little further than usual
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Walking Corpse" {ON_DIFFICULTY 1 2 3}}
    
    [side]
        side=3
        color=blue
        controller=ai
        no_leader=yes
        facing=se
        team_name=bandits
        gold,income=0,{ON_DIFFICULTY -2 1 4}
        recruit=Walking Corpse
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 3 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 Ghoul {ON_DIFFICULTY 1 2 3}}
    
    [side]
        side=4
        color=blue
        controller=ai
        no_leader=yes
        facing=se
        team_name=bandits
        gold,income=0,{ON_DIFFICULTY -2 1 4}
        recruit=Walking Corpse
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 4 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Ghoul {ON_DIFFICULTY 1 2 3}}
    
    #############################
    # BANDIT AI
    #############################
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2,3,4 offensive 0.9 0.1}
        {VARY_AI_BY_SCHEDULE 2,3,4}
        {MODIFY_SIDE_AI 2,3,4 (retreat_factor=0)}
    [/event]
    # make zombies slightly less useless in shallow water.
    [event]
        name=unit placed
        first_time_only=no
        {FILTER type_adv_tree="Walking Corpse",Ghoul}
        [object]
            {FILTER id=$unit.id}
            {EFFECT movement_costs (replace=yes
                [movement_costs]
                    shallow_water=2
                [/movement_costs])}
        [/object]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        {PUT_TO_RECALL_LIST id=Deoran}
    [/event]
    
    
    #######################################################################################################################################################
    #                                                                     PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        #############################
        # ETHILIEL ARRIVES
        #############################
        {DELAY 500}
        {RECALL_XY Ethilel 31 1}
        {MOVE_UNIT id=Ethiliel 27 7}
        {RECALL_XY Deoran        28 7} {MODIFY_UNIT id=Deoran        facing sw}
        {RECALL_XY $companion_id 28 6} {MODIFY_UNIT id=$companion_id facing sw}
        [message]
            speaker=Ethilel
            message= _ "This is the Vale of Blossoming Trees. Our great Sage Mebrin came here many decades ago, to find peace and enlightenment. Choose your words carefully in his presence, humans, for Mebrin is ancient and bore witness to King Haldric the First’s betrayal of the elves hundreds of years ago."
        [/message]
        [message]
            speaker=Ethilel
            message= _ "Some other Aethenwood elves also live nearby — mostly artisans inspired by the tranquility of this valley. I see no sign of them now, but they and Mebrin will doubtless come out to greet us as we approach."
        [/message]
        {MOVE_UNIT id=Ethiliel 21 10}
        
        #############################
        # NALMATH APPEARS
        #############################
        {NAMED_UNIT 2 Rogue 18 12 "Urza Namlath" _"Urza Nalmath" (canrecruit,facing,animate=yes,sw,yes)}
        [object]
            {FILTER id="Urza Nalmath"}
            [effect]
                apply_to=new_animation
                id=urza_nalmath_black_magic
                [animation]
                    apply_to=black_magic
                    start_time=0
                    [frame]
                        image="units/human-outlaws/rogue-defend-1.png:150"
                    [/frame]
                    [frame]
                        image="units/human-outlaws/rogue-defend-w.png"
                        halo=halo/undead/dark-magic-[1~6].png:50
                        halo_x,halo_y=0,0
                    [/frame]
                    [frame]
                        image="units/human-outlaws/rogue-defend-1.png:150"
                    [/frame]
                    sound_start_time=-40
                    [sound_frame]
                        sound=magic-dark.ogg
                    [/sound_frame]
                [/animation]
            [/effect]
        [/object]
        [animate_unit]
            {FILTER id="Urza Nalmath"}
            flag=black_magic
        [/animate_unit]
        {DELAY 250}
        [animate_unit]
            {FILTER id="Urza Nalmath"}
            flag=black_magic
        [/animate_unit]
        {DELAY 250}
        [animate_unit]
            {FILTER id="Urza Nalmath"}
            flag=black_magic
        [/animate_unit]
        {GENERIC_UNIT 2 "Ghoul" 19 13} {ANIMATE}
        
        #############################
        # NALMATH SPEAKS
        #############################
        [message]
            speaker=Urza Nalmath
            message= _ "Ah ha, ha ha ha ha, it works! It WORKS! The master’s instruction never fails."
        [/message]
        [harm_unit]
            {FILTER id="Urza Nalmath"}
            {FILTER_SECOND type=Ghoul}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount,type,hits=4,blade,yes
            animate,delay=yes,0
        [/harm_unit]
        [message]
            speaker=Urza Nalmath
            message= _ "Ack! Insolent thing, I created you! The master never said anything about vying for control..."
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "But wait, someone new approaches. An elf from the Aethenwood, come to save her fallen brethren? You are far too late, far too late! My brothers and I took what we wanted from this place months ago!"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "How can this be? Humans, defiling our sacred valley! And is that... an undead elf!?"
        [/message]
        [message]
            type=Ghoul
            message= _ "Graahh..."
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "Undead? UNDEAD!? You insult me, madam, you insult me — this beautiful being is still alive! ...although come to think of it, she might wish she weren’t."
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "...but I don’t have time for visitors; don’t have time, no time at all. Too busy plumbing the secrets of life and death, you see. You visitors should run along now. Get out of here before one of you gets hurt."
        [/message]
        
        #############################
        # ETHILIEL REACTS
        #############################
        {SAY_COMPANION
            MESSAGE_MARI=_"Just what we needed: a ghoul. I’ve fought these things before, and I don’t miss the smell. But the worst part is their claws — one scratch and you’ll be poisoned until healed at a village, or by a healer like Ethiliel."
            MESSAGE_GERRICK=_"By Haldric, they’re real! The old-timers used to talk about bloated, half-dead, half-alive “ghouls”... they say it takes but one scratch to poison a man half-dead, unless healed at a village or by a healer like Ethiliel."
            MESSAGE_HYLAS=_"Ghouls. The corruption is spreading; we must work quickly. Be wary of their claws, Deoran — one scratch and you’ll be poisoned until healed at a village, or by a healer like me or Ethiliel."
        }
        [message]
            speaker=Deoran
            message= _ "That... <i>thing</i> looks dangerous, but it isn’t making any hostile moves towards us yet. Perhaps we should inform Fiore and return with more specialized soldi—"
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            #po: the elves have encountered the Urzas before, as mentioned in S02. That's why she knows his name (but mostly because I think Ethiliel's line sounds better that way)
            message= _ "Profane blasphemers!! This is a transgression most unforgivable! Urza Nalmath, your death shall be slow and painful!"
        [/message]
        {MOVE_UNIT id=Ethiliel 19 12}
        [harm_unit]
            {FILTER id="Urza Nalmath"}
            {FILTER_SECOND id=Ethiliel}
            [primary_attack]
                range=melee # melee attack is more obvious to a new player than the ranged attack
            [/primary_attack]
            amount,type,hits=7,impact,yes
            animate,delay=yes,0
        [/harm_unit]
        [message]
            speaker=Urza Nalmath
            message= _ "Ah ha ha ha, you think to fight me here, at the birthplace of the Urzas’ dark powers? Your late brethren also fought when we first came to this valley, and you can see how well they fared!"
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "You may have defeated my two elder brothers, but they had not given themselves to the dark magic as wholly as I. This valley is mine!!"
        [/message]
#define MAGIC
        {DELAY 250}
        [animate_unit]
            {FILTER id="Urza Nalmath"}
            flag=black_magic
        [/animate_unit]
        {DELAY 250}
#enddef
#ifndef EASY
        {MAGIC}{GENERIC_UNIT 2 "Walking Corpse" 18 13}
        {MAGIC}{GENERIC_UNIT 2 Ghoul 17 14}
#endif
#ifdef HARD
        {MAGIC}{GENERIC_UNIT 2 "Walking Corpse" 17 13}
        {MAGIC}{GENERIC_UNIT 2 "Walking Corpse" 17 12}
#endif
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "Deoran, you claim the South Guard is a friend of the Aethenwood. Prove it! Aid me in destroying this vermin Nalmath, lest the vengeance of the elves fall upon you and Westin alike!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "(to self) Geez, and I thought elves were supposed to be a peaceful bunch."
        [/message]
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            side=1
            [objective]
                description= _ "Defeat Urza Nalmath"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

    
    #######################################################################################################################################################
    #                                                                     PLAY PART 2
    #######################################################################################################################################################
    [event]
        name=attacker hits
        [filter_second]
            id=Urza Nalmath
            formula=(self.hitpoints < self.max_hitpoints/2)
        [/filter_second]
        {FIRE_EVENT part_2}
    [/event]
    [event]
        name=defender hits
        [filter]
            id=Urza Nalmath
            formula=(self.hitpoints < self.max_hitpoints/2)
        [/filter]
        {FIRE_EVENT part_2}
    [/event]
    [event]
        name=turn 5
        {FIRE_EVENT part_2}
    [/event]
    [event]
        name=part_2
        #############################
        # URZA SUMMONS FOG
        #############################
        [message]
            speaker=Urza Nalmath
            message= _ "I am second youngest of the Urzas — you will not find me such feeble a foe as my two late brothers! With the two elders slain at your hand, only I and Afalas remain alive."
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "And the master has given me the power to stay that way! You are surrounded, interlopers — this valley is full of undead, and soon you shall join them."
        [/message]
        {MAGIC}
        [message]
            speaker=Urza Nalmath
            message= _ "Arise, my servants, from your slumber! Arise to slay my foes! And arise mists, fog, putrid clouds from the water to shroud this land in darkness, and to hide my movements!"
        [/message]
        {MAGIC}
        {SOUND wind.ogg}
        {DELAY 250}
        [modify_side]
            side,fog=1,yes
        [/modify_side]
        
        #############################
        # REPLACE MAP
        #############################
        {KILL side=2 {
        [replace_map]
            map_file=03_Vale_of_Tears.map
            expand,shrink=yes,yes
        [/replace_map]
        [store_unit]
            {FILTER()}
            variable=stored_reposition_units
        [/store_unit]
        [foreach]
            array=stored_reposition_units
            [do]
                {STORE_UNIT_VAR id=$this_item.id x x}
                {STORE_UNIT_VAR id=$this_item.id  y y}
                {TELEPORT_UNIT  id=$this_item.id  "$($x+0)" "$($y+5)"}
                {CLEAR_VARIABLE x,y}
            [/do]
        [/foreach]
        {CLEAR_VARIABLE stored_reposition_units}
        {VARIABLE first_turn $turn_number}
        [modify_turns]
            value="$($turn_number + 15)"
        [/modify_turns]
        {MOVE_UNIT id="Urza Nalmath" 12 4}
        
        #############################
        # SPAWN ENEMIES
        #############################
        
        
        #############################
        # DEORAN STRATEGIZES
        #############################
        [message]
            speaker=Deoran
            message= _ "Where did he go! I can’t see anything through this thick fog! And more talk about this “master”..."
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"The bandit says we’re surrounded — kind of him to warn us. Ethiliel is far too angry for retreat, so it seems we’ll have to defend this island as long as we can."
            MESSAGE_GERRICK=_"No time for talk; brace for incomin’ attack! The bandit says we’re surrounded, an’ with th’ elf too angry for retreat, that means we’ll have to defend this island!"
            MESSAGE_HYLAS=_"My eyes are as blind as yours, Deoran, but my ears are sharp. The bandit speaks true — we are surrounded by undead. And with Ethiliel out for blood, retreat may not be an option.{BR}{BR}My lack of military training nonwithstanding, I suggest we defend this island as long as we can."
        }
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            side=1
            [objective]
                description= _ "Survive until turns run out"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
        
        
        
        
        
        #######################################################################################################################################################
        #                                                                     ASSORTED EVENTS
        #######################################################################################################################################################
        #############################
        # ETHILIEL REFUSES TO LEAVE
        #############################
        [event]
            name=enter hex
            first_time_only=no
            {FILTER( id=Ethiliel {NOT({FILTER_LOCATION x,y,radius=19,7,8})} )}
            [cancel_action]
            [/cancel_action]
            [message]
                speaker=Ethiliel
                message= _ "I refuse to leave until I’ve found Mebrin! He was my mentor for many years."
            [/message]
        [/event]
        
        #############################
        # TURN 3
        #############################
        [event]
            name=turn $first_turn
            [message]
                speaker,image=Ethiliel,portraits/ethiliel-mad.webp
                message= _ "How dare these Urzas defile our most sacred valley! How dare they slay so many of my kin, and raise them with their dark magic! If you humans have laid even a single finger on Mebrin..."
            [/message]
            [message]
                speaker,image=Deoran,portraits/deoran-mad.webp
                message= _ "Hey, “<i><b>us</b></i> humans” had nothing to do with this!"
            [/message]
        [/event]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     VICTORY
    #######################################################################################################################################################
    [event]
        name=time over
        {FIRE_EVENT ending_cutscene}
    [/event]
    [event]
        name=last breath
        {FILTER id="Urza Nalmath"}
        {MODIFY_UNIT id="Urza Nalmath" hitpoints 11}
    [/event]
    [event]
        name=ending_cutscene
        #############################
        # GURANTEE UNIT POSITIONS
        #############################
        {PUT_TO_RECALL_LIST x,y=10,4}
        {PUT_TO_RECALL_LIST x,y=11,5}
        {PUT_TO_RECALL_LIST x,y=12,5}
        {PUT_TO_RECALL_LIST x,y=13,4}
        {PUT_TO_RECALL_LIST x,y=13,5}
        {RECALL_XY Deoran 15 7}
        {RECALL_XY $companion_id 15 7}
        {RECALL_XY Ethiliel 15 7}
        {PUT_TO_RECALL_LIST x,y=12,4}
        {RECALL_XY "Urza Nalmath" 12 4}
        
        #############################
        # FOG IS GONE
        #############################
        [message]
            speaker,image=Deoran,portraits/deoran-glad.webp
            message= _ "Look! The fog is fading! We’ve survived the attack!"
        [/message]
        [modify_side]
            side,fog=1,no
        [/modify_side]
        [message]
            speaker=Urza Nalmath
            message= _ "What!? No, that wasn’t supposed to happen! My magic is waning!"
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "More power, I need more power. More poweful minions. Yes, yes!"
        [/message]
        
        #############################
        # SUMMONING SKELETONS
        #############################
        {MAGIC} {GENERIC_UNIT 2 Skeleton          13 4} {ANIMATE}
        {MAGIC} {GENERIC_UNIT 2 Revenant          13 5} {ANIMATE}
        {MAGIC} {GENERIC_UNIT 2 "Skeleton Archer" 12 5} {ANIMATE}
        {MAGIC} {GENERIC_UNIT 2 Deathblade        11 5} {ANIMATE}
        {MAGIC} {GENERIC_UNIT 2 Skeleton          10 4} {ANIMATE}
        {SAY_COMPANION
            MESSAGE_MARI=_"Skeletons! These things are nasty; watch out!"
            MESSAGE_GERRICK=_"Look sharp, those old bones be comin’ for us!"
            MESSAGE_HYLAS=_"Skeletons! This is an unfortunate surprise."
        }
        
        #############################
        # SKELETONS TURN ON NALMATH
        #############################
        [harm_unit]
            {FILTER id="Urza Nalmath"}
            {FILTER_SECOND x,y=13,5}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount,type,hits=7,blade,yes
            animate,delay=yes,0
            kill=no
        [/harm_unit]
        [harm_unit]
            {FILTER id="Urza Nalmath"}
            {FILTER_SECOND x,y=13,4}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount,type,hits=7,blade,yes
            animate,delay=yes,0
            kill=no
        [/harm_unit]
        [message]
            speaker=Urza Nalmath
            message= _ "Nnrrgh!! What is this!? Attack them, not me! How do I control these things!?"
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "You won’t even exist without me! My power is what keeps you standing! You’re sealing your own re-deaths!"
        [/message]
        [message]
            type=Revenant # because its core portrait is pretty
            message= _ "More... power..."
        [/message]
        [message]
            type=Deathblade # because its core portrait is pretty
            message= _ "More... death..."
        [/message]
        [harm_unit]
            {FILTER id="Urza Nalmath"}
            {FILTER_SECOND x,y=11,5}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount,type,hits=999,blade,yes
            animate,delay=yes,0
            kill=yes
        [/harm_unit]
        {KILL type=Skeleton          ANIMATE=YES}
        {KILL type="Skeleton Archer" ANIMATE=YES}
        {KILL type=Deathblade        ANIMATE=YES}
        {KILL side=2,3,4}

        #############################
        # DETENTE
        #############################
        [message]
            speaker,image=Deoran,portraits/deoran-mad.webp
            message= _ "Slain by his own creations; a fitting end for such a villain. It’s over, then?"
        [/message]
        {MOVE_UNIT id=Ethiliel 17 13}
        [message]
            speaker=Ethiliel
            message= _ "Mebrin? Sage Mebrin, it is I, Ethiliel! You can come out from hiding!"
        [/message]
        {MOVE_UNIT id=Ethiliel 18 11}
        [message]
            speaker=Ethiliel
            message= _ "His home is empty... There are several sets of footprints leading away to the south..."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Perhaps he was taken by the undead? Captured and brought before this “master” the Urzas spoke of?"
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"No blood, no sign of struggle. I’ve seen undead at work; they would have slain him and made him one of them."
            MESSAGE_GERRICK=_"Praps so, praps not. If’n it were the undead, wouldn’t there be some blood or sign o’ struggle? Wouldn’t they have made him one ’o them?"
            MESSAGE_HYLAS=_"Possible, but doubtful. No blood, no sign of struggle. If it had been the undead, I suspect they would have simply slain him."
        }
        [message]
            speaker=Deoran
            message= _ "Then maybe the Urzas took him? I should think that he’d have put up a fight, but if he were ambushed or taken by surprise, he may not have had the chance. Ethiliel, what do you think?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "..Ethiliel? I know you must be distraught, but—"
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "Distraught? <b><i>Distraught!?</i></b> I am angry! We must follow these footprints into the woods! Whoever took our greatest sage must pay! Nothing shall stop the vengeance of the elves!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "I suppose there’s no chance of reporting back to Magistrate Fiore at Westin? I do want to help you find your sage, but this is also getting way beyond the scope of my original assignment."
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "(glares)"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Erm yes, you’re right, let’s go. <i>And let’s make sure not to give her a reason to turn her rage on us...</i>"
        [/message]
        
        {CLEAR_VARIABLE first_turn}
        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
[/scenario]
