#textdomain wesnoth-tsg

[scenario]
    id=03_Vale_of_Tears
    map_file=03_Vale_of_Tears.map
    name= _ "Vale of Tears"
    next_scenario=04_Blight
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER}
    
    {DEFAULT_SCHEDULE_DUSK}
    turns=15
    
    {SCENARIO_MUSIC elvish-theme.ogg}
    {EXTRA_SCENARIO_MUSIC knolls.ogg}
    {EXTRA_SCENARIO_MUSIC nunc_dimittis.ogg}

    {TSG_BIGMAP {JOURNEY_03_NEW} }

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=good
        user_team_name=_"South Guard"
        gold=50
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
        fog=yes
    [/side]
    
    #############################
    # BANDITS
    #############################
    # wmllint: local spelling Nalmath
    [side]
        side=2
        color=blue
        controller=ai
        no_leader=yes
        facing=se
        team_name=bandits
        user_team_name=_"Urza Nalmath"
        gold,income=0,-2
        recruit=Ghoul
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 3} # since he has skirmisher, it's ok to let him move a little further than usual
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Walking Corpse" {ON_DIFFICULTY 3 4 5}} # 2 guards on all difficulties
    
    [side]
        side=3
        color=blue
        controller=ai
        no_leader=yes
        hidden=yes
        facing=se
        team_name=bandits
        user_team_name=_"Urza Nalmath"
        gold,income=0,-2
        recruit=Walking Corpse
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 3 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 Ghoul {ON_DIFFICULTY 2 3 4}} # 1 guard on all difficulties
    
    [side]
        side=4
        color=blue
        controller=ai
        no_leader=yes
        hidden=yes
        facing=se
        team_name=bandits
        user_team_name=_"Urza Nalmath"
        gold,income=0,-2
        recruit=Walking Corpse
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 4 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Ghoul {ON_DIFFICULTY 2 3 4}} # 1 guard on all difficulties
    
    [side]
        side=5
        color=blue
        controller=ai
        no_leader=yes
        hidden=yes
        facing=se
        team_name=bandits
        user_team_name=_"Urza Nalmath"
        gold,income=0,-2
        recruit=Walking Corpse
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 5 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Ghoul {ON_DIFFICULTY 2 3 4}} # 1 guard on all difficulties
    
    #############################
    # BANDIT AI
    #############################
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2,3,4,5 offensive 0.9 0.1}
        {VARY_AI_BY_SCHEDULE 2,3,4,5}
        {MODIFY_SIDE_AI 2,3,4,5 retreat_factor=0}
    [/event]
    
    # make zombies slightly less useless in shallow water.
    [event]
        name=unit placed
        first_time_only=no
        {FILTER type_adv_tree="Walking Corpse",Ghoul}
        [object]
            {FILTER id=$unit.id}
            [effect]
                apply_to=movement_costs
                replace=yes
                [movement_costs]
                    shallow_water=2
                [/movement_costs]
            [/effect]
        [/object]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        {PUT_TO_RECALL_LIST id=Deoran}
        {SCROLL_TO 38 2}
    [/event]
    
    
    #######################################################################################################################################################
    #                                                                     PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        #############################
        # ETHILIEL ARRIVES
        #############################
        {DELAY 500}
        {RECALL_XY Deoran 38 2}
        [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        {DELAY 250}
        [message]
            speaker=Deoran
            message= _ "Ethiliel, am I going in the right direction? I can hardly see a thing through this fog..."
        [/message]
        {DELAY 500}{MOVE_UNIT id=Deoran 35  7} [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        {DELAY 500}{MOVE_UNIT id=Deoran 27  7} [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        {DELAY 500}{MOVE_UNIT id=Deoran 27 13} [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        {RECALL_XY Ethiliel      28 13} {MODIFY_UNIT id=Ethiliel      facing sw}
        {RECALL_XY $companion_id 28 12} {MODIFY_UNIT id=$companion_id facing sw}
        [redraw][/redraw]
        {SCROLL_TO 18 18}
        [message]
            speaker=Ethiliel
            message= _ "Yes, this is the place. We have arrived at the Vale of Blossoming Trees, where our great Sage Mebrin came many decades ago in search of peace and enlightenment.

Choose your words carefully in his presence, humans, for Mebrin is ancient and bore witness to King Haldric the First’s betrayal of the elves hundreds of years ago — he has no love for your kind."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "Some other Aethenwood elves also live nearby: mostly artisans inspired by the tranquility of this valley. I see no sign of them now, but they and Mebrin will doubtless come out to greet us as we approach."
        [/message]
        {MOVE_UNIT id=Ethiliel      21 16} [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        {MOVE_UNIT id=Deoran        23 16} [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        {MOVE_UNIT id=$companion_id 21 15}
        [reset_fog]
            reset_view=yes
        [/reset_fog]
        [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        
        #############################
        # NALMATH APPEARS
        #############################
        {DELAY 250}
        {NAMED_UNIT 2 Rogue 18 18 "Urza Nalmath" _"Urza Nalmath" (
            canrecruit,facing,animate=yes,sw,yes
            [modifications]
                {TRAIT_RESILIENT}
                {TRAIT_STRONG}
            [/modifications]
        )}
        [object]
            {FILTER id="Urza Nalmath"}
            [effect]
                apply_to=new_animation
                id=urza_nalmath_black_magic
                [animation]
                    apply_to=black_magic
                    start_time=0
                    [frame]
                        image="units/human-outlaws/rogue-defend-1.png:150"
                    [/frame]
                    [frame]
                        image="units/human-outlaws/rogue.png"
                        halo=halo/undead/dark-magic-[1~6].png:50
                        halo_x,halo_y=0,0
                    [/frame]
                    [frame]
                        image="units/human-outlaws/rogue-defend-1.png:150"
                    [/frame]
                    sound_start_time=-40
                    [sound_frame]
                        sound=magic-dark.ogg
                    [/sound_frame]
                [/animation]
            [/effect]
        [/object]
#define MAGIC
        {DELAY 150}
        [animate_unit]
            {FILTER id="Urza Nalmath"}
            flag=black_magic
        [/animate_unit]
        {DELAY 150}
#enddef
        {MAGIC}
        {GENERIC_UNIT 2 "Walking Corpse" 19 19}{ANIMATE}
        {GENERIC_UNIT 2 "Walking Corpse" 17 18}{ANIMATE}
        {MAGIC} 
        {GENERIC_UNIT 2 "Walking Corpse" 18 19}{ANIMATE}
        {GENERIC_UNIT 2 "Walking Corpse" 15 15}{ANIMATE}
#ifndef EASY
        {MAGIC}
        {GENERIC_UNIT 2 "Walking Corpse" 16 15}{ANIMATE}
        {GENERIC_UNIT 2 "Walking Corpse" 17 15}{ANIMATE}
        {MAGIC}
        {GENERIC_UNIT 2 "Walking Corpse" 13 18}{ANIMATE}
        {GENERIC_UNIT 2 "Walking Corpse" 15 19}{ANIMATE}
#endif
        {REPEAT {ON_DIFFICULTY 1 2 4} ( # create some nearby undead to harry the player, before the recruited units arrive en masse
            {GENERIC_UNIT 2 "Walking Corpse" 34 15}
            {GENERIC_UNIT 2 "Walking Corpse" 16 28}
            {GENERIC_UNIT 2 "Walking Corpse"  8 20}
            {GENERIC_UNIT 2 "Walking Corpse" 10 12}
            {GENERIC_UNIT 2 "Walking Corpse" 20 5}
            {GENERIC_UNIT 2 "Walking Corpse" 31 7}
        )}
        [event]
            name=turn 2 # it's not possible for the player to have vision here on turn 2, so it's safe to delay
            {REPEAT {ON_DIFFICULTY 1 2 3} ( # make it a little harder to camp in the top-right corner (this is also why the terrain there is poor)
                {GENERIC_UNIT 2 "Ghoul" 38 1}
                {GENERIC_UNIT 2 "Walking Corpse" 38 1}
                {GENERIC_UNIT 2 "Walking Corpse" 38 1}
            )}
        [/event]
        
        #############################
        # NALMATH SPEAKS
        #############################
        [message]
            speaker=Urza Nalmath
            message= _ "Such a beautiful tingling in my fintertips! Intoxicating, exalting... the master’s magic whispers promises of life eternal, whispers beautiful secrets..."
        [/message]
        {MODIFY_UNIT id="Urza Nalmath" facing ne}
        [message]
            speaker=Ethiliel
            message= _ "What!? How can this be! Humans, defiling our sacred valley? And are those... undead elves!?"
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "But I don’t have time for visitors! No no, I’m far too busy, far too busy plumbing the secrets of life and death, you see. I’ve seen nary a living soul since the last of my human followers joined the hordes of eternal life."
        [/message]
        [harm_unit]
            {FILTER id="Urza Nalmath"}
            {FILTER_SECOND x,y=17,18}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount,type,hits=6,impact,yes
            animate,delay=yes,0
        [/harm_unit]
        [harm_unit]
            {FILTER id="Urza Nalmath"}
            {FILTER_SECOND x,y=19,19}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount,type,hits=6,impact,yes
            animate,delay=yes,0
        [/harm_unit]
        [message]
            speaker=Urza Nalmath
            message= _ "Ack! ...some of them still bite a little, but no matter. Soon I will learn the secret of properly controlling my creations, and the whole world shall tremble before the brothers Urza! ...those of us who yet live, at least."
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "Just... move along now before someone gets hurt. Run along now."
        [/message]
        {DELAY 500}
        [message]
            speaker=Deoran
            message= _ "This is clearly a dreadfully evil man, but he and his undead aren’t making any hostile moves towards us yet. Perhaps he’s right: it might be wise to update Magistrate Fiore at Westin, and gather a larger force before returning to fight. What do you think, $companion_name?"
        [/message]
        {MOVE_UNIT id=Ethiliel 20 16} [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "“Run along”!? You profane blasphemer! You come into this most sacred place, slay my people without mercy, defile their bodies with your dark magic — and then you dare order me to “run along”?!?"
        [/message]
        {MOVE_UNIT id=Ethiliel 19 17} [redraw]{BR}clear_shroud=yes{BR}[/redraw]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            #po: the elves have encountered the Urzas before, as mentioned in S02. That's why she knows his name (but mostly because I think Ethiliel's line sounds better that way)
            message= _ "Urza Nalmath, your death shall be slow and painful! If you have laid a single finger on our sage Mebrin, I warn you..."
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "I said I was busy! Busy! ...if you want a fight, I won’t shy away. But first, it may interest you to learn just what has been keeping me so busy for the last nine months."
        [/message]
        {SAY_COMPANION MESSAGE_GENERIC=_"(don’t ask)"}
        [message]
            speaker=Deoran
            message= _ "...what have you been doing?"
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "Obsessively reanimating every last scholar, sage, and artist who used to live in this tranquil valley. From the oldest grandfather to the youngest child, all who were once perished now live anew under my thrall."
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "And as a result, your little band is now completely surrounded."
        [/message]
        {FADE_MUSIC_OUT 700}
        
        #############################
        # SPAWN ENEMIES
        #############################
        [modify_side]
            side=2
            gold={ON_DIFFICULTY 25 50 75}
            income={ON_DIFFICULTY -2 2 6}
        [/modify_side]
        [modify_side]
            side=3,4,5
            gold={ON_DIFFICULTY 10 20 30}
            income={ON_DIFFICULTY -2 0 2}
            hidden=no
        [/modify_side]
        
#define REVEAL_DO X Y WML
        [lift_fog]
            side,x,y,radius=1,{X},{Y},3
        [/lift_fog]
        {WML}
        {DELAY 1000}
        [reset_fog]
            reset_view=yes
        [/reset_fog]
        [redraw]
            clear_shroud=yes
        [/redraw]
#enddef
        {GENERIC_UNIT 2 (Ghoul)          10  4} {FACING sw} {ZONE_GUARDIAN 10  4 x,y,radius=11,4,5}
        {GENERIC_UNIT 2 (Ghoul)          15  4} {FACING se} {ZONE_GUARDIAN 15  4 x,y,radius=11,4,5}
        {GENERIC_UNIT 2 (Necrophage)     12  7} {FACING se} {ZONE_GUARDIAN 12  7 x,y,radius=11,4,5}
        {GENERIC_UNIT 2 (Walking Corpse) 11  8} {FACING se} {ZONE_GUARDIAN 11  8 x,y,radius=11,4,5}
        {GENERIC_UNIT 2 (Walking Corpse) 11  7} {FACING sw} {ZONE_GUARDIAN 11  7 x,y,radius=11,4,5}
        
        {MODIFY_TERRAIN Ker 12 4} # don't put these on the map initially, because these hexes are visible through the fog in the beginning
        {MODIFY_TERRAIN Cer^Edt 13 4}
        {MODIFY_TERRAIN Cer^Qhh 12 3}
        {MODIFY_TERRAIN Cer^Edt 12 5}
        {MODIFY_TERRAIN Cer     11 5}
        {MODIFY_TERRAIN Cer^Edt 15 4}
        {MODIFY_TERRAIN Cer^Edt 11 7}
        {MODIFY_TERRAIN Cer^Edt 11 8}
        {MODIFY_TERRAIN Cer^Edt 12 7}
        
        {MOVE_UNIT id="Urza Nalmath" 5 19}
        {REVEAL_DO 12 4 ({MOVE_UNIT id="Urza Nalmath" 12 4})}
        [event]
            name=new turn
            {FULL_HEAL id="Urza Nalmath"}
        [/event]
        
        {GENERIC_UNIT 3 (Ghoul)           4 24} {FACING ne} {ZONE_GUARDIAN  4 24 x,y,radius=5,27,4}
        {GENERIC_UNIT 3 (Walking Corpse)  5 27} {FACING nw} {ZONE_GUARDIAN  5 24 x,y,radius=5,27,4}
        {GENERIC_UNIT 3 (Walking Corpse)  6 24} {FACING nw} {ZONE_GUARDIAN  6 24 x,y,radius=5,27,4}
        {REVEAL_DO  5 26 ({SOUND zombie-hit-6.ogg} {NAMED_UNIT 3 Necrophage  5 26 necrophage3 "" (canrecruit,facing,animate=yes,se,yes)})}
        
        {GENERIC_UNIT 4 (Ghoul)          23 25} {FACING nw} {ZONE_GUARDIAN 23 25 x,y,radius=26,26,4}
        {GENERIC_UNIT 4 (Walking Corpse) 27 28} {FACING nw} {ZONE_GUARDIAN 27 28 x,y,radius=26,26,4}
        {GENERIC_UNIT 4 (Walking Corpse) 23 28} {FACING ne} {ZONE_GUARDIAN 23 28 x,y,radius=26,26,4}
        {REVEAL_DO 25 26 ({SOUND zombie-hit-3.ogg} {NAMED_UNIT 4 Necrophage 25 26 necrophage4 "" (canrecruit,facing,animate=yes,sw,yes)})}
        
        {GENERIC_UNIT 5 (Ghoul)          37 15} {FACING nw} {ZONE_GUARDIAN 37 15 x,y,radius=38,16,3}
        {GENERIC_UNIT 5 (Walking Corpse) 35 18} {FACING ne} {ZONE_GUARDIAN 35 18 x,y,radius=38,16,3}
        {GENERIC_UNIT 5 (Walking Corpse) 37 19} {FACING nw} {ZONE_GUARDIAN 37 19 x,y,radius=38,16,3}
        {REVEAL_DO 38 17 ({SOUND zombie-hit-4.ogg} {NAMED_UNIT 5 Necrophage 38 17 necrophage5 "" (canrecruit,facing,animate=yes,sw,yes)})}
        
        #############################
        # EXPLAIN OBJECTIVES
        #############################
        {SAY_COMPANION
            MESSAGE_MARI=_"Not too bright of him to warn us. From what I can <s>tell</s> smell, the undead in this valley far outnumber anything we’ve fought before."
            MESSAGE_GERRICK=_"Surrounded and outnumbered, eh? Sounds like my kind o’ fight."
            MESSAGE_HYLAS=_"The bandit speaks true — my arcane senses reveal undead in all directions, far more than we’ve fought before."
        }
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "Deoran, you claim the South Guard is a friend of the Aethenwood. Prove it! Aid me in destroying this vermin outlaw, lest the vengeance of the elves fall upon you and Westin alike!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "I’m not sure this bandit is going to give us much choice. We’ll have to survive defending these ruins until he runs out of undead — now brace for incoming attack!"
        [/message]
        {REPLACE_SCENARIO_MUSIC the_dangerous_symphony.ogg}
        {APPEND_MUSIC siege_of_laurelmor.ogg}
        {FADE_MUSIC_IN 100}
        
        [display_tip]
            title=_"Turn Limits"
            image=tutor/turns.png
            message=_"Most scenarios have a turn limit, as
shown in the upper-left-hand-corner.
Usually, running out of turns will
result in defeat — check your
<i><b>objectives</b></i> by clicking the <i><b>“Menu”</b></i>
button in the top-left corner 
(or use the hotkey <i><b>Ctrl+J</b></i>).

Finishing early will usually reward 
a gold boost (“early finish bonus”) 
in the next scenario, so don’t delay!

In this scenario, your objective is 
to survive until turns run out."
        [/display_tip]
        {VARIABLE sg_turns_explained yes}
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            side=1
            [objective]
                description= _ "Survive until turns run out"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]
    
    
    #######################################################################################################################################################
    #                                                                 TIPS AND MISC EVENTS
    #######################################################################################################################################################   
    #############################
    # TIP: ETHILIEL
    #############################
    [event]
        name=turn 1 end
        {FILTER id=Ethiliel}
        {TUTORIAL_ENABLE_CONDITION}
        [message]
            speaker=Ethiliel
            message= _ "Deoran, as a <b><i>level 3 unit</i></b>, I am a valuable asset in battle. If you haven’t already realized, my nature magic can <i><b>heal adjacent units</b></i> for 8 hitpoints every turn. This doesn’t stack with healing from villages or other healers."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "I also have powerful ranged attacks: a mighty <b><i>magical</i></b> thorns that is highly accurate, and an ensnare that <b><i>slows</i></b> enemy units, halving their movement and damage dealt. Finally, my faerie wings help me to fly across rough terrain without being hindered."
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"(to Deoran) She also has quite a temper, if not for which we might be safely back in Westin. Though I suppose I can’t blame her for wanting to avenge her friends..."
            MESSAGE_GERRICK=_"(to Deoran) ’an she’s got a fightin’ spirit too! Can’t blame her for wantin’ to avenge her friends, though this is a bit of a mess she’s gotten us into."
            MESSAGE_HYLAS=_"(to Deoran) She also has quite a temper. I understand her desire for vengeance, yet it remains unfortunate that we were forced into this fight unprepared."
        }
    [/event]
    
    #############################
    # TIP: FOG
    #############################
    [event]
        name=turn 3
        {TUTORIAL_ENABLE_CONDITION}
        [message]
            speaker=Deoran
            message= _ "I’m not used to fighting in fog like this! What a mess..."
        [/message]
        [display_tip]
            title=_"Fog and Vision"
            image=tutor/fog.png
            message=_"In fog, <b><i>units can see 1 hex further
than their movement</i></b>. Fast units,
such as Deoran or Ethiliel, make
for great scouts.

Clearing fog will prevent you from
using “undo”, so be careful where
you move!"
        [/display_tip]
    [/event]
    
    #############################
    # TIP: CLIFFS
    #############################
    [event]
        name=turn 7
        {TUTORIAL_ENABLE_CONDITION}
        [display_tip]
            title=_"Bluffs and Gulches"
            image=tutor/bluffs.png
            message=_"
Have you ever wondered
what effect these cliffs
have on gameplay?

They... don’t actually
do anything. But they
do look pretty! <i>(or at
least we devs think so)</i>"
        [/display_tip]
    [/event]
    
    #############################
    # EMERGENCY GOLD BOOST
    #############################
    # give enemies a small gold boost when you get near them
    # not massive, but enough that they at least appear to be fighting back
#define EMERGENCY_GOLD_BOOST SIDE AMOUNT
    [event]
        name=moveto
        {FILTER side=1}
        {FILTER_CONDITION( {HAVE_UNIT( side,count=1,3-99 {FILTER_LOCATION side,canrecruit,radius={SIDE},yes,4} )} )}
        [gold]
            side={SIDE}
            amount={AMOUNT}
        [/gold]
    [/event]
#enddef
    {EMERGENCY_GOLD_BOOST 2 {ON_DIFFICULTY 20 30 40}}
    {EMERGENCY_GOLD_BOOST 3 {ON_DIFFICULTY 15 20 25}}
    {EMERGENCY_GOLD_BOOST 4 {ON_DIFFICULTY 15 20 25}}
    {EMERGENCY_GOLD_BOOST 5 {ON_DIFFICULTY 15 20 25}}
    
    #############################
    # REMIND ABOUT RECRUITING
    #############################
    [event]
        name=recruit
        {FILTER side=1}
        {VARIABLE s03_units_recruited yes}
    [/event]
    [event]
        name=recall
        {FILTER side=1}
        {VARIABLE s03_units_recalled yes}
    [/event]
    [event]
        name=turn 5
        {FILTER_CONDITION({VARIABLE_CONDITIONAL s03_units_recalled not_equals yes})}
        {TUTORIAL_ENABLE_CONDITION}
        [if] {VARIABLE_CONDITIONAL s03_units_recruited not_equals yes}
            [then]
                [message]
                    speaker=Deoran
                    message= _ "I will need to recruit units if I want to weather the undead assault! I should first move to a keep, then press <b>Ctrl+R</b> to recruit or <b>Alt+R</b> to recall."
                [/message]
                {TUTORIAL_ARROW 18 18}
                {TUTORIAL_ARROW 16 15}
                [event]
                    name=recruit
                    {FILTER side=1}
                    {REMOVE_ARROW}
                [/event]
                [event]
                    name=clear_tips
                    {REMOVE_ARROW}
                [/event]
            [/then]
            [else]
                [message]
                    speaker=Deoran
                    message= _ "I have recruited fresh soldiers, but not yet recalled any of my veterans! If I have high-XP survivors from my previous battles, I should press <b>Alt+R</b> to recall them so they can continue gaining experience."
                [/message]
            [/else]
        [/if]
    [/event]
    
    #############################
    # EXPLAIN POISON (AGAIN)
    #############################
    [event]
        name=attacker hits
        {FILTER type_adv_tree=Ghoul}
        {FIRE_EVENT explain_poison}
    [/event]
    [event]
        name=defender hits
        {FILTER_SECOND type_adv_tree=Ghoul}
        {FIRE_EVENT explain_poison}
    [/event]
    [event]
        name=explain_poison
        [event]
            name=attack end
            {TUTORIAL_ENABLE_CONDITION}
            [display_tip]
                title=_"Poison"
                image=tutor/poison.png
                message=_"Ghouls inflict <i><b>poison</b></i> whenever they
damage one of your units. A poisioned
unit will lose <i><b>8 hitpoints</b></i> at the start
of every turn. Poison can never kill a unit,
but it can reduce them to 1 hitpoint!

Receiving healing from a village or
a healer (such as Ethiliel) will also
<i><b>cure poison.</b></i>"
            [/display_tip]
        [/event]
    [/event]
    
    #############################
    # EXPLAIN POISON (THE THIRD TIME)
    #############################
    [event]
        name=new turn
        {TUTORIAL_ENABLE_CONDITION}
        {FILTER_CONDITION( {HAVE_UNIT( side,count,status=1,4-99,poisoned )} )}
        [message]
            speaker=Deoran
            message= _ "So many of my soldiers are poisoned! I should end their turn on a village or next to Ethiliel, so they can begin to recover."}
        [/message]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     VICTORY
    #######################################################################################################################################################
    [event]
        name=time over
        [message]
            speaker,image=Deoran,portraits/deoran-glad.webp
            message= _ "Look! The fog is fading! I think we’ve survived the attack!"
        [/message]
        [modify_side]
            side,fog=1,no
        [/modify_side]
        {FIRE_EVENT ending_cutscene}
    [/event]
    [event]
        name=last breath
        {FILTER id="Urza Nalmath"}
        {MODIFY_UNIT id="Urza Nalmath" hitpoints 11}
        {FIRE_EVENT ending_cutscene}
    [/event]
    [event]
        name=ending_cutscene
        #############################
        # GURANTEE UNIT POSITIONS
        #############################
        {PUT_TO_RECALL_LIST x,y=10,4}
        {PUT_TO_RECALL_LIST x,y=11,5}
        {PUT_TO_RECALL_LIST x,y=12,5}
        {PUT_TO_RECALL_LIST x,y=13,4}
        {PUT_TO_RECALL_LIST x,y=13,5}
        {RECALL_XY Deoran 15 7}
        {RECALL_XY $companion_id 15 7}
        {RECALL_XY Ethiliel 15 7}
        {PUT_TO_RECALL_LIST x,y=12,4}
        {RECALL_XY "Urza Nalmath" 12 4}
        
        #############################
        # SUMMONING SKELETONS
        #############################
        [message]
            speaker=Urza Nalmath
            message= _ "No, my magic is waning! The beautiful whispers are fading! My hands are shaking, my face is sweating; I need you back, please... I can’t bear to experience the world like this!"
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "More power, I need more powerful minions. More power will exalt me again, intoxicate me again! The others warned me not to, but the master always told what I needed to know. Yes, yes!"
        [/message]
        {MAGIC} {GENERIC_UNIT 2 Skeleton          13 4} {ANIMATE}
        {MAGIC} {GENERIC_UNIT 2 Revenant          13 5} {ANIMATE}
        {MAGIC} {GENERIC_UNIT 2 "Skeleton Archer" 12 5} {ANIMATE}
        {MAGIC} {GENERIC_UNIT 2 Deathblade        11 5} {ANIMATE}
        {MAGIC} {GENERIC_UNIT 2 Skeleton          10 4} {ANIMATE}
        {SAY_COMPANION
            MESSAGE_MARI=_"Skeletons! Watch out rookie, these things are nasty!"
            MESSAGE_GERRICK=_"Look sharp, those old bones be comin’ for us!"
            MESSAGE_HYLAS=_"Skeletons! This makes for an unpleasant surprise."
        }
        
        #############################
        # SKELETONS TURN ON NALMATH
        #############################
        [harm_unit]
            {FILTER id="Urza Nalmath"}
            {FILTER_SECOND x,y=13,5}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount,type,hits=7,blade,yes
            animate,delay=yes,0
            kill=no
        [/harm_unit]
        [harm_unit]
            {FILTER id="Urza Nalmath"}
            {FILTER_SECOND x,y=13,4}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount,type,hits=7,blade,yes
            animate,delay=yes,0
            kill=no
        [/harm_unit]
        [message]
            speaker=Urza Nalmath
            message= _ "Nnrrgh!! No, I created you! Attack them, not me! The master never taught me how to control these things!"
        [/message]
        [message]
            speaker=Urza Nalmath
            message= _ "You won’t even exist without me! My power is what keeps you standing! You’re sealing your own re-deaths!"
        [/message]
        [message]
            type=Revenant # because its portrait is pretty
            message= _ "More... power..."
        [/message]
        [message]
            type=Deathblade # because its portrait is pretty
            message= _ "More... death..."
        [/message]
        [harm_unit]
            {FILTER id="Urza Nalmath"}
            {FILTER_SECOND x,y=11,5}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount,type,hits=999,blade,yes
            animate,delay=yes,0
            kill=yes
        [/harm_unit]
        {KILL type=Skeleton          ANIMATE=YES}
        {KILL type="Skeleton Archer" ANIMATE=YES}
        {KILL type=Deathblade        ANIMATE=YES}
        {KILL side=2,3,4}

        #############################
        # DETENTE
        #############################
        [message]
            speaker,image=Deoran,portraits/deoran-mad.webp
            message= _ "Slain by his own creations; a fitting end for such a villain! It’s over, then? This will make for an interesting report back in town."
        [/message]
        {MOVE_UNIT id=Ethiliel 17 13}
        [message]
            speaker=Ethiliel
            message= _ "Mebrin? Sage Mebrin, it is I, Ethiliel! You can come out from hiding!"
        [/message]
        {MOVE_UNIT id=Ethiliel 18 11}
        [message]
            speaker=Ethiliel
            message= _ "His home is empty... There are several sets of footprints leading away to the south..."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Perhaps he was taken by the undead? Captured and brought before this mysterious “master” the Urzas have spoken of?"
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"No blood, no sign of struggle. I’ve seen undead at work; they would have slain him and made him one of them."
            MESSAGE_GERRICK=_"Praps so, praps not. If’n it were the undead, wouldn’t there be some blood or sign o’ struggle? Wouldn’t they have made him one ’o them?"
            MESSAGE_HYLAS=_"Possible, but doubtful. No blood, no sign of struggle. If it had been the undead, I suspect they would have simply slain him and been done with it."
        }
        [message]
            speaker=Deoran
            message= _ "Then maybe the Urzas took him? I should think that he’d have put up a fight, but if he were ambushed or taken by surprise, he may not have had the chance. Ethiliel, what do you think?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "..Ethiliel? I know you must be distraught, but—"
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "Distraught? <b><i>Distraught!?</i></b> I am angry! We must follow these footprints south! Find the last Urza brother! Whoever took our greatest sage must pay! Nothing shall stop the vengeance of the elves!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "I don’t suppose there’s any chance of reporting back to Magistrate Fiore at Westin? I truly want to help you find your sage, but this is also getting far beyond the scope of my original assignment, and I’m still a junior commander."
        [/message]
        [message]
            speaker,image=Ethiliel,portraits/ethiliel-mad.webp
            message= _ "(glares)"
        [/message]
        [message]
            speaker=Deoran
            message= _ "On second thought, you’re right, let’s go. (And let’s make sure not to give her a reason to turn her rage — and the armies of the elves — against Westin...)"
        [/message]
        
        {CLEAR_VARIABLE s03_units_recruited,s03_units_recalled}
        [endlevel]
            result=victory
            bonus=yes # usually 0 because turns are over, but if we rushed down the bandit we may get a bonus
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
[/scenario]
