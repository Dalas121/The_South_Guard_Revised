#textdomain wesnoth-tsg

#define TURN_LIMIT
25#enddef
#define TURN_WARNING
20#enddef

[scenario]
    id=01_Born_to_the_Banner
    map_file=01a_Born_to_the_Banner.map
    name= _ "Born to the Banner"
    next_scenario=01x_Westin
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER}
    
    {DEFAULT_SCHEDULE_DUSK} # so there's no ToD effects on the first turn, and so that it's daytime when our recruits fight the quintain
    turns=-1
    
    {SCENARIO_MUSIC loyalists.ogg}
    {EXTRA_SCENARIO_MUSIC battle.ogg}
    {EXTRA_SCENARIO_MUSIC knolls.ogg}
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=South_Guard
        user_team_name=_"South Guard"
        gold=75
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
    [/side]
    
    #############################
    # MARI
    #############################
    [side]
        side=2
        color=red
        controller=null
        no_leader=yes
        hidden=yes
        team_name=South_Guard,quintain
    [/side]
    [side]
        side=3
        color=blue
        controller=ai
        no_leader=yes
        hidden=yes
        team_name=quintain
    [/side]
    
    #############################
    # BANDITS
    #############################
    [side]
        side=4
        color=blue
        controller=ai
        no_leader=yes
        hidden=yes
        team_name=bandits
        user_team_name=_"Bandits"
        recruit=Thug
        {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 4 1}
    [event]
        name=side 4 turn
        first_time_only=no
        {RESET_SIDE_AI 4 offensive 0.4 0.25}
        {MODIFY_SIDE_AI 4 ([avoid] # let's at least pretend the AI is smart. New players can wait until later to realize the AI is actually dumb
            terrain=Ww^*
        [/avoid])}
        
        {IF_TIME_OF_DAY morning}
            {AND_NO_ENEMIES_NEAR_MY_LEADER 4}
            [then]
                {MODIFY_SIDE_AI (4) ({GOAL_AVOID_SIDE_UNLESS_DEFENDING_LEADER 9  4 1 6})} # avoid staying too close
                {MODIFY_SIDE_AI (4) ({GOAL_LOCATION 999 x,y,radius=16,20,4})}
                
                {MODIFY_SIDE_AI (4) (aggression=-2)}
                {MODIFY_SIDE_AI (4) (caution=2)}
            [/then]
        {ENDIF}
        {IF_TIME_OF_DAY afternoon}
            {AND_NO_ENEMIES_NEAR_MY_LEADER 4}
            [then]
                {MODIFY_SIDE_AI (4) ({GOAL_AVOID_SIDE_UNLESS_DEFENDING_LEADER 9  4 1 3})} # avoid staying too close
                {MODIFY_SIDE_AI (4) ({GOAL_LOCATION 999 x,y,radius=16,20,4})}
                
                {MODIFY_SIDE_AI (4) (aggression=-2)}
                {MODIFY_SIDE_AI (4) (caution=2)}
            [/then]
        {ENDIF}
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        
        #############################
        # MARI
        #############################
        [unit]
            id=Mari
            name= _ "Mari"
            type=TSG Captain
            unrenamable=yes
            [modifications]
                {TRAIT_LOYAL_HERO}
                {TRAIT_QUICK}
            [/modifications]
            side=2
            x,y=10,4
            facing=ne
        [/unit]
    [/event]
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        {DELAY 500}
        [unit]
            id=Deoran
            name= _ "Deoran"
            profile=portraits/deoran.webp
            type=Cavalryman Commander
            [modifications]
                [trait]
                    id,name=loyal_dummy,_"loyal"
                    description= _ "Zero upkeep"
                    [effect]
                        apply_to=loyal
                    [/effect]
                [/trait]
                {TRAIT_INTELLIGENT}
            [/modifications]
            canrecruit=yes
            unrenamable=yes
            side=1
            x,y=17,1
            facing=sw
            animate=yes
        [/unit]
        
        #############################
        # OPENING CUTSCENE
        #############################
        [message]
            speaker=Deoran
            image=portraits/deoran-glad.webp
            #po: deoran is fresh out of training, bright-eyed and eager to prove himself
            message= _ "Commander Deoran, reporting for duty SIR! ...err, ma’am."
        [/message]
        [message]
            speaker=Mari
            #po: "academy" refers to some sort of Wesnoth military academy
            message= _ "Relax, commander. Fresh from the academy, are we?"
        [/message]
        [message]
            speaker=Deoran
            #po: Deoran and Mari are here because Magistrate Fiore (from Westin) ordered them to come and make sure bandits don't interrupt Garard and Asheviere's upcoming wedding
            message= _ "Yes ma’am. —sir. And as the magistrate ordered, I’ve brought with me a contingent of fresh soldiers to ensure the king’s wedding goes exactly as planned."
        [/message]
        [message]
            speaker=Mari
            #po: Mari is somewhat sarcastic and not particularly emotive. She can come across as somewhat cold.
            message= _ "I’m Mari. Got the same orders as you; guess Magistrate Fiore wanted someone with experience to keep an eye on you and your “fresh” company. Can’t imagine why."
        [/message]
        [message]
            speaker=Mari
            # might not need the 1-armed thing after the portrait's done, depending on how obvious it is.
            #po: Mari only has 1 arm; she lost her left arm fighting undead in the Estmark hills.
            message= _ "I am elated to march to the end of civilization and supervise this extremely meaningful ceremony, rather than relaxing at home or practicing one-armed swordsmanship. Nope, nothing I’d rather be doing."
        [/message]
        [message]
            speaker=Mari
            message= _ "*sigh* Well, I guess orders are orders. Come on over here, Deoran — let’s get a closer look at you."
        [/message]
        [message]
            speaker=Deoran
            [option]
                label= _ "On my way!"
                [command]
                    {VARIABLE enable_tutorial_elements yes}
                    [fire_event]
                        name=play_tutorial
                    [/fire_event]
                [/command]
            [/option]
            [option]
                label= _ "I know what I’m doing. (Skip tutorial)"
                [command]
#                     {VARIABLE enable_tutorial_elements no}
                    {VARIABLE enable_tutorial_elements yes} # leave tips on by default, unless the player makes a point of disabling them
                    [modify_turns]
                        current=7 # same ToD so it's not as noticeable, but make sure we don't get a time advantage by skipping the tutorial
                    [/modify_turns]
                    [message]
                        speaker=Mari
                        message= _ "Suit yourself. I’m sure you won’t need my help against those bandits anyway."
                    [/message]
                    [fire_event]
                        name=play_battle
                    [/fire_event]
                [/command]
            [/option]
        [/message]
    [/event]
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    PLAY TUTORIAL
    #######################################################################################################################################################
#define TUTORIAL_ARROW X Y
    [item]
        name=arrow
        x,y={X},{Y}
        image=misc/highlight-hex.png
        halo=misc/arrow[10~19,20~11].png
    [/item]
#enddef
#define REMOVE_ARROW
    [remove_item]
        name=arrow
    [/remove_item]
#enddef
#define EXPLAIN_UNDO VALID_HEXES
    [event]
        name=moveto
        id=explain_undo
        {FILTER( id=Deoran {FILTER_LOCATION( {NOT({VALID_HEXES})} )} )}
        [filter_condition]
            {VARIABLE_CONDITIONAL tutorial_undo_explained not_equals yes}
        [/filter_condition]
        {UNDO_REMINDER}
        {VARIABLE tutorial_undo_explained yes}
    [/event]
#enddef
    [event]
        name=play_tutorial
        
        #############################
        # TUTORIAL 1: MOVE DEORAN
        #############################
        {TUTORIAL_ARROW 17 1}
        [event]
            name=select
            {FILTER id=Deoran}
            {REMOVE_ARROW}
            {TUTORIAL_ARROW 11 5}
        [/event]
        {EXPLAIN_UNDO x,y=11,5}
        [disallow_end_turn]
            reason=_"Move Deoran next to Mari first!
(press “u” if you need to undo a move)"
        [/disallow_end_turn]
        
        #------------------------
        # SHOW DESTINATION HEX
        #------------------------
        [objectives]
            [objective]
                description= _ "Move Deoran next to Mari"
                condition=win
            [/objective]
            [objective]
                description= _ "Get yourself killed"
                condition=lose
            [/objective]
        [/objectives]

        
        #############################
        # TUTORIAL 2: ATTACK QUINTAIN
        #############################
        [event]
            name=moveto
            {FILTER id,x,y=Deoran,11,5}
            #------------------------
            # INTRO
            #------------------------
            {REMOVE_ARROW}
            [remove_event]
                id=explain_undo
            [/remove_event]
            [message]
                speaker=Deoran
                message= _ "*bowing* A pleasure to make your acquaintance, Captain Mari."
            [/message]
            [message]
                speaker=Mari
                message= _ "Amazing, you know how to ride your horse. Now let’s see if you know how to swing your sword."
            [/message]
            [store_unit]
                {FILTER id=Mari}
                variable=stored_mari
                kill=yes
            [/store_unit]
            {NAMED_UNIT 3 Quintain 10 4 quintain "" ()} {FACING se} {GUARDIAN}
            {FAKE_UNIT_MOVE 10 9 4 5 2 (TSG Captain) ()}
            [unstore_unit]
                variable=stored_mari
                x,y=9,5
            [/unstore_unit]
            [message]
                speaker=Deoran
                message= _ "...a quintain? You want me to attack a practice dummy?"
            [/message]
            [message]
                speaker=Mari
                message= _ "Too dangerous for you? Would you like me to bring out a stuffed doll instead?"
            [/message]
            
            #------------------------
            # OBJECTIVES
            #------------------------
            [disallow_end_turn]
                reason=_"Attack the dummy first!"
            [/disallow_end_turn]
            [objectives]
                [objective]
                    description= _ "Attack the dummy"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]
            
            #------------------------
            # ATTACK INDICATORS
            #------------------------
            {TUTORIAL_ARROW 11 5}
            [event]
                name=select
                {REMOVE_ARROW}
                {TUTORIAL_ARROW 10 4}
            [/event]
            [event]
                name=attack
                {REMOVE_ARROW}
            [/event]
            
            #------------------------
            # HARDCODE HITS/MISSES
            #------------------------
            # make the tutorial more consistent, so that dialogue is guaranteed to be sensible regardless of RNG
#define FORCE_ACCURACY UNIT VALUE
            [remove_object]
                object_id=force_cth_{UNIT}
            [/remove_object]
            [modify_unit]
                {FILTER id={UNIT}}
                [object]
                    id=force_cth_{UNIT}
                    [effect]
                        apply_to=attack
                        [set_specials]
                            mode=append
                            [chance_to_hit]
                                value={VALUE}
                            [/chance_to_hit]
                        [/set_specials]
                    [/effect]
                [/object]
            [/modify_unit]
#enddef
            [event]
                name=attack
                {FILTER id=Deoran}
                    
                # hardcode Deoran's first 3 strikes - show the player what a hit looks like twice, then show them what a miss looks like
                {FORCE_ACCURACY Deoran 100}
                [event]
                    name=attacker hits
                    {FILTER id=Deoran}
                    [event]
                        name=attacker hits
                        {FILTER id=Deoran}
                        {FORCE_ACCURACY Deoran 0}
                        [event]
                            name=attacker misses
                            {FILTER id=Deoran}
                            [remove_object]
                                object_id=force_cth_Deoran
                            [/remove_object]
                        [/event]
                    [/event]
                [/event]
                
                # hardcode the quintian's first 4 strikes (2 defending, 2 attacking) - get Deoran low, but don't kill him
                {FORCE_ACCURACY quintain 100}
                [event]
                    name=defender hits
                    {FILTER_SECOND id=quintain}
                    {FORCE_ACCURACY quintain 0}
                    [event]
                        name=defender misses
                        {FILTER_SECOND id=quintain} # the quintain gets deleted and replaced after this
                        [event]
                            name=attack
                            {FORCE_ACCURACY quintain 100}
                            [event]
                                name=new turn
                                [remove_object]
                                    object_id=force_cth_quintain
                                [/remove_object]
                            [/event]
                        [/event]
                    [/event]
                [/event]
            [/event]
        [/event]
        
        
        #############################
        # TUTORIAL 3: TURNS
        #############################
        [event]
            name=attack end
            
            # or else the quintain keeps playing it's defense anim
            {STORE_UNIT_VAR id=quintain hitpoints hitpoints}
            {KILL id=quintain}
            {NAMED_UNIT 3 Quintain 10 4 quintain "" ( experience,hitpoints=1,$hitpoints )} {FACING se}  {GUARDIAN}
            {CLEAR_VARIABLE hitpoints}
            
            #------------------------
            # INTRO
            #------------------------
            [message]
                speaker=Deoran
                image=portraits/deoran-mad.webp
                message= _ "Hey! This dummy fights back!"
            [/message]
            [message]
                speaker=Mari
                message= _ "I definitely should have started with the doll."
            [/message]
            [message]
                speaker=Deoran
                message= _ "I’m not about to lose to a dummy. Let me attack again!"
            [/message]
            [message]
                speaker=Mari
                message= _ "Nice try, but you used up your turn attacking the quintain. The quintain now gets to attack."
            [/message]
            [message]
                speaker=Deoran
                message= _ "The <i>dummy</i> gets a turn?"
            [/message]
            [message]
                speaker=Mari
                message= _ "You expected this to be easy? It’s a magical quintain, on loan from the wizards’ academy at Alduin. It strikes twice per attack, and does 10 “impact” damage per strike. Brace yourself!"
            [/message]
            [message]
                speaker,image=narrator,wesnoth-icon.png
                {TUTOR: _"To end your turn, click the <b>“End Turn”</b> button in the bottom-right corner of the screen, or press <b>Ctrl+Space</b>"}
            [/message]
            [allow_end_turn][/allow_end_turn]
            
            #------------------------
            # OBJECTIVES
            #------------------------
            [objectives]
                [objective]
                    description= _ "End your turn"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]
        [/event]
        
        
        #############################
        # TUTORIAL 4: VILLAGES
        #############################
        [event]
            name=turn 2
            [message]
                speaker=Deoran
                image=portraits/deoran-sad.webp
                message= _ "I’m injured; this is more dangerous than I expected. I need to retreat to a village and regain some hitpoints."
            [/message]
            {TUTORIAL_ARROW  8 6}
            {TUTORIAL_ARROW 12 7}
            [disallow_end_turn]
                reason=_"Move to a village first!
(press “u” if you need to undo a move)"
            [/disallow_end_turn]
            {EXPLAIN_UNDO terrain=*^V*}
            
            #------------------------
            # PREVENT ATTACKING
            #------------------------
            # need to check for moveto as well, because [allow_undo] doesn't work in an attack event
            [event]
                name=pre attack
                first_time_only=no
                id=prevent_attacking1
                [fire_event]
                    name=prevent_attacking3
                [/fire_event]
                [allow_undo][/allow_undo]
            [/event]
            [event]
                name=moveto
                first_time_only=no
                id=prevent_attacking2
                {FILTER( {FILTER_ADJACENT id=quintain} )}
                [fire_event]
                    name=prevent_attacking3
                [/fire_event]
                [allow_undo][/allow_undo]
            [/event]
            [event]
                name=prevent_attacking3
                id=prevent_attacking3
                first_time_only=no
                {STORE_UNIT_VAR id=Deoran hitpoints hitpoints}
                [message]
                    speaker=Deoran
                    message= _"I have only $hitpoints hitpoints left! If I attack now, I am sure to be vanquished. By a dummy, nonetheless."
                [/message]
                {CLEAR_VARIABLE hitpoints}
                [cancel_action][/cancel_action]
                [allow_undo][/allow_undo]
            [/event]
            
            #------------------------
            # OBJECTIVES
            #------------------------
            [objectives]
                [objective]
                    description= _ "End your turn on a village"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]
            
            #------------------------
            # VILLAGE EXPLANATION
            #------------------------
            [event]
                name=capture
                {REMOVE_ARROW}
                [remove_event]
                    id=explain_undo
                [/remove_event]
                [message]
                    speaker=Mari
                    message= _"You have captured a village, which now flies the fabulously pretty colors of our banner. Villages provide the shiny gold <i>income</i> we need to <i>recruit</i> units. The house icon at the top of the screen shows our total village count."
                [/message]
                [message]
                    speaker=Mari
                    message= _"More to the point, villages also provide healing. Starting your turn on a village will <i>heal</i> you for 8 hitpoints. End your turn now."
                [/message]
                [allow_end_turn][/allow_end_turn]
            [/event]
        [/event]
        
        
        #############################
        # TUTORIAL 5: RECRUITING
        #############################
#define EXPLAIN_TRAITS TRAIT1 TRAIT2 MESSAGE
        [if] {HAVE_UNIT id,trait=$unit.id,{TRAIT1}}
             {HAVE_UNIT id,trait=$unit.id,{TRAIT2}}
            [then]
                [message]
                    speaker=unit
                    message= _"I may look just like any other $unit.type, but each of us is a little different! " + {MESSAGE}
                [/message]
                [display_tip]
                    title=_"Traits"
                    image=tutor/traits.png
                    message=_"Most units have a random{BR}combination of traits.{BR}{BR}A unit’s traits are listed in the{BR}sidebar — mouse-over a trait{BR}to see what effects it has."
                [/display_tip]
            [/then]
        [/if]
#enddef
        [event]
            name=side 1 turn 3 refresh
            [remove_event]
                id=prevent_attacking1 # remove this early, or else it's possible to get softlocked
            [/remove_event]
            [message]
                speaker=Mari
                message= _"Congratulations, you ran away from the quintain and have regained 8 hitpoints from your village. I hope you’re proud."
            [/message]
            [message]
                speaker=Deoran
                message= _"I’ve had enough of being humiliated by this dummy. Time to recruit some proper soldiers and smash that thing to pieces."
            [/message]
            [message]
                speaker,image=narrator,wesnoth-icon.png
                {TUTOR: _"The golden crown in Deoran’s upper-left-hand corner indicates that he’s a leader: he can <b>recruit</b> new units when standing on a castle’s <b>keep</b> hex.

In most scenarios, you will lose if your leader is killed. Don’t use Deoran too aggressively!"}
            [/message]
            {TUTORIAL_ARROW 9 10}
            [disallow_end_turn]
                reason=_"Use “Ctrl+R” to recruit a soldier first!
(press “u” if you need to undo a move)"
            [/disallow_end_turn]
            {EXPLAIN_UNDO x,y=9,10} # don't remove this 3rd undo explanation, even after we're past the risk of being softlocked. This is useful info for the player to know regardless
            
            #------------------------
            # OBJECTIVES
            #------------------------
            [objectives]
                [objective]
                    description= _ "Recruit some soldiers"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]
            
            #------------------------
            # EXPLAIN RECRUITING
            #------------------------
            [event]
                name=moveto
                {FILTER id,x,y=Deoran,9,10}
                {REMOVE_ARROW}
                [message]
                    speaker=Deoran
                    message= _"Good, I’m on the keep. If I press <b>Ctrl+R</b>, I can recruit new soldiers to help me fight."
                [/message]
            [/event]
            
            [event]
                name=recruit
                priority=99
                [message]
                    speaker=unit
                    message= _"At your service, commander Deoran! I’m still a little disoriented; you’ll need to wait until next turn before I can move or attack."
                [/message]
                [remove_event]
                    id=prevent_attacking2
                [/remove_event]
                [remove_event]
                    id=prevent_attacking3
                [/remove_event]
                [allow_end_turn][/allow_end_turn] # at this point we never disallow ending the turn again, so there's no longer any risk of being softlocked
                [event]
                    name=recruit
                    [event]
                        name=recruit
                        {EXPLAIN_TRAITS quick     intelligent _"I have the “quick” and “intelligent” traits, so I move faster and require less XP to level-up."}
                        {EXPLAIN_TRAITS quick     strong      _"I have the “quick” and “strong” traits, so I move faster and deal bonus damage in melee."}
                        {EXPLAIN_TRAITS quick     resilient   _"I have the “quick” and “resilient” traits, so I move faster and have extra hitpoints."}
                        {EXPLAIN_TRAITS strong    intelligent _"I have the “strong” and “intelligent” traits, so I deal bonus damage in melee and require less XP to level-up."}
                        {EXPLAIN_TRAITS strong    resilient   _"I have the “strong” and “resilient” traits, so I deal bonus damage in melee and have extra hitpoints."}
                        {EXPLAIN_TRAITS resilient intelligent _"I have the “resilient” and “intelligent” traits, so I have extra hitpoints and require less XP to level-up."}
                    [/event]
                [/event]
            [/event]
        [/event]
        
        
        #############################
        # TUTORIAL 6: KILLING THE QUINTAIN
        #############################
        [event]
            name=turn 4
            [message]
                speaker=Deoran
                message= _"The quintain is healing itself! Come on men, let’s go finish it off!"
            [/message]
            [message]
                speaker,image=narrator,wesnoth-icon.png
                {TUTOR: _"In addition to the +8 healing provided by a village, units will also regenerate 2 hitpoints if they spend their turn resting: neither moving nor fighting.

This “rest-healing” stacks with village healing."}
            [/message]
            
            #------------------------
            # OBJECTIVES
            #------------------------
            [objectives]
                [objective]
                    description= _ "Destroy Mari’s quintain"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Get yourself killed"
                    condition=lose
                [/objective]
            [/objectives]
            
            #------------------------
            # QUINTAIN KILLS
            #------------------------
            [event]
                name=die
                {FILTER( {NOT id=Deoran} )}
                {FILTER_SECOND id=quintain}
                [message]
                    speaker=Mari
                    message= _ "...he’s fine. Just out cold, and of no use to you for the rest of this fight."
                [/message]
            [/event]
            
            #------------------------
            # QUINTAIN DIES
            #------------------------
            [event]
                name=die
                {FILTER id=quintain}
                [message]
                    speaker=second_unit
                    message= _ "Hooray! The dummy is destroyed, and I have gained 8 experience!"
                [/message]
                [message]
                    speaker,image=narrator,wesnoth-icon.png
                    {TUTOR: _"Units gain a small amount of experience when attacking or defending, but gain much more by striking a finishing blow, especially vs high-level enemies.

With enough experience, a soldier will advance to a powerful level-2 unit."}
                [/message]
                [message]
                    speaker=Mari
                    message= _ "Bravo, you’ve smashed it to pieces. I was supposed to return that quintain we finished guarding the royal wedding."
                [/message]
                {DELAY 500}
                [message]
                    speaker=Mari
                    message= _ "Of course, we’ll have to fight our way past these bandits first."
                [/message]
                [fire_event]
                    name=play_battle
                [/fire_event]
            [/event]
        [/event]
        
        
        #############################
        # MARI GETS BORED EVENTUALLY
        #############################
        [event]
            name=turn 8
            {FILTER_CONDITION( {HAVE_UNIT id=quintain} )}
            [message]
                speaker=Mari
                message= _ "You’re doing a great job, just standing there. Either finish off the quintain or give up and go home."
            [/message]
        [/event]
        [event]
            name=turn 12
            {FILTER_CONDITION( {HAVE_UNIT id=quintain} )}
            [message]
                speaker=Mari
                message= _ "Last chance. Defeat the quintain."
            [/message]
        [/event]
        [event]
            name=turn 13
            {FILTER_CONDITION( {HAVE_UNIT id=quintain} )}
            [message]
                speaker=Mari
                message= _ "Very funny. You should consider becoming a comedian, because after this performance you’re definitely not going to be a knight. Go home, Deoran. I’ll handle things on my own here."
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
    [/event]
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                        PLAY BATTLE
    #######################################################################################################################################################
    [event]
        name=play_battle
        [message]
            speaker=Deoran
            message= _ "Bandits! Where?"
        [/message]
        
        #############################
        # PREPARE MAP
        #############################
        [replace_map]
            map_file=01_Born_to_the_Banner.map
            expand,shrink=yes,yes
        [/replace_map]
        {NAMED_UNIT 4 Bandit 16 20 "Urza Mathin" _"Urza Mathin" ( canrecruit=yes {MODIFICATIONS({TRAIT_QUICK}{TRAIT_INTELLIGENT})} )} # quick because easier to kill
        [modify_side]
            side=4
            hidden=no
            gold={ON_DIFFICULTY 0 0 30}
            income={ON_DIFFICULTY -2 -2 2} # plus 3 villages
        [/modify_side]
        [capture_village]
            side=4
            x,y,radius=19,20,8
        [/capture_village]
        {GENERIC_UNITC 4 ({ON_DIFFICULTY Thug Thug Thug}) 11 20 ()}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY Thug Thug Thug}) 13 22 ()}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY none Thug Thug}) 12 15 ()}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY none Thug Thug}) 11 15 ()}
        [modify_turns]
            value={TURN_LIMIT} # this includes the turns we spent fighting the dummy
                               # if you change this, also change the "turns almost over" event
        [/modify_turns]
        
        #############################
        # INTRO CUTSCENE
        #############################
        {SCROLL_TO 16 20}
        {DELAY 500}
        [message]
            speaker=Urza Mathin
            message= _ "Oh, what’s this? A lady and her loyal squire travelin’ south on this dangerous road? Tell ya what, we can offer ya protection ’round here for a small fee."
        [/message]
        [if] {HAVE_UNIT id,x,y=Deoran,17,1}
            [then]
                {TELEPORT_UNIT id=Deoran 9 10}
                [capture_village]
                    side=1
                    x,y,radius=10,6,3
                [/capture_village]
            [/then]
        [/if]
        [message]
            speaker=Deoran
            image=portraits/deoran-mad.webp
            message= _ "Do you take us for fools? I ride south to reinforce the venerable South Guard, on orders from Magistrate Fiore to ensure the countryside is kept safe and orderly for King Garard’s upcoming wedding."
        [/message]
        [message]
            speaker=Deoran
            image=portraits/deoran-mad.webp
            message= _ "The only danger around here is you, and I intend to put an end to your reign of terror, scum! Men, raise your spears!"
        [/message]
        [message]
            speaker=Urza Mathin
            message= _ "Hah, like it would be that easy, boy. I’m Urza Mathin, eldest of the four Uzra brothers, and these are my thugs. Time to show you who the real power is in these parts!"
        [/message]
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            side=1
            [objective]
                description= _ "Defeat Urza Mathin"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Deoran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Mari"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
        
        
        
        
        
        #######################################################################################################################################################
        #                                                                       S01 TIPS
        #######################################################################################################################################################
        #############################
        # MARI SPECTATES
        #############################
        [event]
            name=side 1 turn end
            [if] {TUTORIAL_ENABLE_CONDITION}
                [then]
                    [store_unit]
                        {FILTER side=1}
                        variable=side_1_units
                    [/store_unit]
                    [message]
                        speaker=Mari
                        #po: sarcasm
                        message= _ "It only took $side_1_units.length of you to deal with that wooden dummy. I’m sure these few bandits won’t pose any problem."
                    [/message]
                    {CLEAR_VARIABLE side_1_units}
                [/then]
            [/if]
            {MOVE_UNIT id=Mari 14 9}
            {MODIFY_UNIT id=Mari facing sw}
            [message]
                speaker=Deoran
                message= _ "Aren’t you going to help? We must drive these villains from the road!"
            [/message]
            [message]
                speaker=Mari
                message= _ "If you need my sword just to beat this glorified pickpocket, then you have no business being in command. This might make genuinely good practice for you as your first real battle."
            [/message]
            [if] {TUTORIAL_ENABLE_CONDITION}
                [then]
                    [message]
                        speaker,image=narrator,wesnoth-icon.png
                        {TUTOR: _"You may now toggle tips on or off at any time during the campaign by right-clicking anywhere and selecting “Tips: On/Off” in the menu."}
                    [/message]
                [/then]
                [else]
                    [message]
                        speaker,image=narrator,wesnoth-icon.png
                        {TUTOR: _"You may toggle tips on or off at any time during the campaign by right-clicking anywhere and selecting “Tips: On/Off” in the menu.

Because you skipped the tutorial, tips are currently off."}
                    [/message]
                [/else]
            [/if]
            
            #############################
            # TUTORIAL TOGGLE
            #############################
            [set_menu_item]
                id=tutorial_toggle_on
                description= _ "Tips: On"
                image="wesnoth-icon.png~SCALE(18,18)"
                [show_if]
                    [variable]
                        name=enable_tutorial_elements
                        boolean_equals=yes
                    [/variable]
                [/show_if]
                [command]
                    {VARIABLE enable_tutorial_elements no}
                    [hint_message]
                        remove=yes
                    [/hint_message]
                [/command]
            [/set_menu_item]
            [set_menu_item]
                id=tutorial_toggle_off
                description= _ "Tips: Off"
                image="wesnoth-icon.png~SCALE(18,18)"
                [show_if]
                    [variable]
                        name=enable_tutorial_elements
                        boolean_equals=no
                    [/variable]
                [/show_if]
                [command]
                    {VARIABLE enable_tutorial_elements yes}
                [/command]
            [/set_menu_item]
        [/event]
        
        
        #############################
        # MARI EXPLAINS DEFENSE
        #############################
        [event]
            name=new turn
            [event]
                name=new turn
                {TUTORIAL_ENABLE_CONDITION}
                [message]
                    speaker=Mari
                    message= _ "Wondering about those percentages that appear on the ground every time you go to move a unit? That’s your units’ terrain defense — their <i><b>chance to dodge</b></i> enemy attacks."
                [/message]
                [display_tip]
                    title=_"Dodging Attacks"
                    image=tutor/dodge.png
                    message=_"In Wesnoth, every attack has a chance to miss.{BR}{BR}Units on favorable terrain (such as castles, villages,{BR}or hills) are more likely to dodge attacks, while{BR}units on poor terrain (such as water, sand, or ice){BR}are much easier to hit.{BR}{BR}Try to position your units on good terrain, and attack{BR}your enemies while they’re on poor terrain!"
                [/display_tip]
            [/event]
        [/event]
        
        
        #############################
        # URZA MATHIN TEACHES TIME OF DAY
        #############################
        [event]
            name=tod_popup
            {TUTORIAL_ENABLE_CONDITION}
            [display_tip]
                title=_"Time of Day"
                image=tutor/tod.png
                message=_"Every turn, the time of day changes,{BR}affecting how much damage units do.{BR}{BR}In this campaign, <b>most of your units{BR}will be deadliest during the day</b>,{BR}while most of your enemies will{BR}be deadliest at night.{BR}{BR}See the current time of day and its{BR}effects by mousing over the{BR}side panel."
            [/display_tip]
        [/event]
        [event]
            name=new turn # don't trigger this on the initial turn, regardless of the ToD
            [event]
                name=new turn
                first_time_only=no
                [store_time_of_day]
                [/store_time_of_day]
            [/event]
            [event]
                name=side 2 turn refresh
                {FILTER_CONDITION( {VARIABLE_CONDITIONAL time_of_day.id equals morning} )} # at morning, so it coincides with the AI's retreat
                {TUTORIAL_ENABLE_CONDITION}
                [message]
                    speaker=Urza Mathin
                    message= _ "Curses, the sun has risen! My thugs and I are feeble during the day, while these Wesnoth soldiers will be at their strongest!"
                [/message]
                [fire_event]
                    name=tod_popup
                [/fire_event]
            [/event]
            [event]
                name=side 2 turn refresh
                {FILTER_CONDITION( {VARIABLE_CONDITIONAL time_of_day.id equals dusk} )} # at dusk, so it coincides with the AI's attack
                {TUTORIAL_ENABLE_CONDITION}
                [message]
                    speaker=Urza Mathin
                    message= _ "The sun begins to set! Soon these Wesnoth soldiers will falter in the dark, while my thugs and I will fight at our best!"
                [/message]
                [fire_event]
                    name=tod_popup
                [/fire_event]
            [/event]
        [/event]
#define UNFAVORABLE_MELEE_ATTACK
        attack end
        {FILTER side=1}
        {FILTER_ATTACK range=melee} # since Mathin only recruits thugs, we know that any nighttime melee attack will be unfavorable
        [filter_second]
            formula=(self.hitpoints>1)# ignore attacks that ended with us killing the defender; those were favorable
        [/filter_second]
        {FILTER_CONDITION(          
                 {VARIABLE_CONDITIONAL time_of_day.id equals first_watch}
            {OR( {VARIABLE_CONDITIONAL time_of_day.id equals second_watch} )} )}
        {TUTORIAL_ENABLE_CONDITION}
#enddef
        [event]
            name={UNFAVORABLE_MELEE_ATTACK}
            [event]
                name={UNFAVORABLE_MELEE_ATTACK}
                [message]
                    speaker=Urza Mathin
                    message= _ "Ha, this will be an easy victory! These soldiers’ young commander must be a fool, for he fights my thugs at night while I am strong and he is weak."
                [/message]
                [fire_event]
                    name=tod_popup
                [/fire_event]
            [/event]
        [/event]
        
        
        #############################
        # MARI EXPLAINS BANDIT LEADER
        #############################
        [event]
            name=moveto
            {FILTER( side=1 {FILTER_ADJACENT id="Urza Mathin"} )}
            {TUTORIAL_ENABLE_CONDITION}
            {TALK_ABOUT (Urza Mathin) ( _ "Urza Mathin is a <b>level 2</b> unit, with much stronger melee attacks than the <b>level 1</b> units that he commands. We should strike him with ranged attacks or during the day, unless you really enjoy getting clubbed.")}
            {UNDO_REMINDER}
        [/event]
    [/event]

    
    
    
    
    #######################################################################################################################################################
    #                                                                    VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # TIME ALMOST OVER
    #############################
    [event]
        name=turn {TURN_WARNING}
        {TUTORIAL_ENABLE_CONDITION}
        [message]
            speaker=Mari
            message= _ "Deoran, can you move any slower? You’re running out of time to finish off these bandits. You can see the turn counter in the upper-left-hand corner — once you run out of turns, you’ll lose the scenario."
        [/message]
        [fire_event]
            name=explain_turn_limit
        [/fire_event]
    [/event]
    #############################
    # TIME OVER
    #############################
    [event]
        name=side 1 turn {TURN_LIMIT} end
        {GENERIC_UNIT 2 (Footpad) 10 23} {ANIMATE}
        {GENERIC_UNIT 2 (Outlaw)   9 22} {ANIMATE}
        {GENERIC_UNIT 2 (Footpad) 12 22} {ANIMATE}
        {GENERIC_UNIT 2 (Footpad)  7 23} {ANIMATE}
        {GENERIC_UNIT 2 (Footpad)  6 23} {ANIMATE}
        
        {GENERIC_UNIT 2 (Trapper)  1 17} {ANIMATE}
        {GENERIC_UNIT 2 (Poacher)  2 17} {ANIMATE}
        {GENERIC_UNIT 2 (Poacher)  1 15} {ANIMATE}
        {GENERIC_UNIT 2 (Poacher)  3 16} {ANIMATE}
        
        [message]
            speaker=Urza Mathin
            message= _ "Reinforcements from my brothers! Excellent. These lands belong to the brothers Urza!"
        [/message]
        [message]
            speaker=Mari
            message= _ "We’ve run out of turns, and now more enemies have arrived! We’ll have to retreat and bring more soldiers some other time. I thought Deoran could handle this on his own..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    
    
    #############################
    # URZA MATHIN DIES
    #############################
    [event]
        name=last breath
        {FILTER( id=Urza Mathin )}
        
        #------------------------
        # URZA MATHIN DIES
        #------------------------
        [message]
            speaker=Deoran
            image=portraits/deoran-mad.webp
            message= _ "You are beaten, you bloodthirsty, balding bandit! Accosting travelers between Weldyn and Westin; what is the meaning of this? How have you become so bold as to strike at even trained soldiers!?"
        [/message]
        [message]
            speaker=Urza Mathin
            message= _ "How... impossible... no! If I die... so will you!"
        [/message]
        [object]
            {FILTER id="Urza Mathin"}
            [effect]
                apply_to=new_animation
                id=urza_mathin_black_magic
                [animation]
                    apply_to=black_magic
                    start_time=0
                    [frame]
                        image="units/human-outlaws/bandit-defend-1.png:150"
                    [/frame]
                    [frame]
                        image="units/human-outlaws/bandit-defend-2.png"
                        halo=halo/undead/dark-magic-[1~6].png:50
                        halo_x,halo_y=0,0
                    [/frame]
                    [frame]
                        image="units/human-outlaws/bandit-defend-1.png:150"
                    [/frame]
                    sound_start_time=-40
                    [sound_frame]
                        sound=magic-dark.ogg
                    [/sound_frame]
                [/animation]
            [/effect]
        [/object]
        [animate_unit]
            {FILTER id="Urza Mathin"}
            flag=black_magic
        [/animate_unit]
        {DELAY 250}
        [animate_unit]
            {FILTER id="Urza Mathin"}
            flag=black_magic
        [/animate_unit]
        {DELAY 250}
        [animate_unit]
            {FILTER id="Urza Mathin"}
            flag=black_magic
        [/animate_unit]
        {KILL id=$unit.id ANIMATE=yes}
        
        #------------------------
        # ZOMBIE APPEARS
        #------------------------
        {NAMED_UNIT 4 Soulless $unit.x $unit.y "Zombie Mathin" _"Urza Mathin" (canrecruit=yes)} {ANIMATE}
        [message]
            speaker=Zombie Mathin
            message= _ "Guhh... kill... bite..."
        [/message]
        {TELEPORT_UNIT id=Mari 11 17} # so she has less distance to walk
        [message]
            speaker=Mari
            message= _ "Look out!"
        [/message]
        {MOVE_UNIT id=Mari $unit.x $unit.y}
        [harm_unit]
            {FILTER id="Zombie Mathin"}
            {FILTER_SECOND id=Mari}
            [primary_attack]
                range=melee
            [/primary_attack]
            amount=999
            animate=yes
            delay=0
            experience=no
        [/harm_unit]
        
        #------------------------
        # WONDERING ABOUT ZOMBIES
        #------------------------
        [message]
            speaker=Mari
            #po: Mari lost her left arm fighting undead in the Estmarks
            message= _ "Undead again. As if losing one arm to these things wasn’t bad enough, now they’re back for my other one."
        [/message]
        [message]
            speaker=Deoran
            message= _ "I’ve never seen the like before in my life! That man clearly died, then stood right back up again! You say you’ve fought these things before, Mari?"
        [/message]
        [message]
            speaker=Mari
            message= _ "Yeah, I have. And no, simple bandits aren’t supposed to know how to create them. This reeks of black magic; powerful black magic."
        [/message]
        [message]
            speaker=Deoran
            message= _ "This brother said he was the eldest of four — the other three are doubtless still alive and causing trouble. We can’t allow anything to interfere with King Garard’s wedding!"
        [/message]
        [message]
            speaker=Mari
            message= _ "Never mind our assignment; how did petty outlaws get their hands on magic like this? We need to continue onwards to Westin, and meet with the magistrate. Maybe someone in town will know something about this..."
        [/message]
        
        [set_achievement]
            content_for=The_South_Guard_Revised
            id=tsg_s01
        [/set_achievement]
        [store_unit]
            {FILTER id=Mari}
            variable=stored_mari
            kill=yes
        [/store_unit]
        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
    #############################
    # NARRATOR EXPLAINS VICTORY
    #############################
    [event]
        name=victory
        {TUTORIAL_ENABLE_CONDITION}
        [message]
            speaker,image=narrator,wesnoth-icon.png
            {TUTOR: _"You have completed all the <b><i>objectives</i></b> for this scenario and achieved victory! You will now see a pop-up detailing your <i><b>early finish bonus</b></i>, a gold bonus for finishing the scenario before the turn limit, and <b>gold carryover</b>, the amount of extra gold you will start the next scenario with. When you are done reading these, press the <i><b>End Scenario</b></i> button or <i><b>Ctrl+Space</b></i> to continue to the next scenario."}
        [/message]
    [/event]
[/scenario]

#undef TURN_LIMIT
#undef TURN_WARNING
