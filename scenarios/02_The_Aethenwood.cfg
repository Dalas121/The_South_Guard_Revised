#textdomain wesnoth-tsg

#define TURN_LIMIT
25#enddef
#define TURN_WARNING
20#enddef

[scenario]
    id=02_The_Aethenwood
    map_file=02_The_Aethenwood.map
    name= _ "The Aethenwood"
    next_scenario=03_Vale_of_Tears
    victory_when_enemies_defeated=no
    {EXPERIENCE_MODIFIER_SCENARIO}
    
    {DEFAULT_SCHEDULE_MORNING}
    turns={TURN_LIMIT}
    
    {SCENARIO_MUSIC legends_of_the_north.ogg}
    {EXTRA_SCENARIO_MUSIC breaking_the_chains.ogg}

    {TSG_BIGMAP {JOURNEY_02_NEW} }

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DEORAN
    #############################
    [side]
        side=1
        controller=human
        no_leader=yes
        team_name=good
        user_team_name=_"South Guard"
        gold=50
        recruit=Spearman,Bowman
        {CUSTOM_SG_FLAG}
        defeat_condition=never
        save_id=player_side
    [/side]
    
    #############################
    # BANDITS (UNDEAD)
    #############################
    [side]
        side=2
        color=blue
        controller=ai
        type=Trapper
        id=Urza Fastik
        name= _ "Urza Fastik"
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_STRONG}
        [/modifications]
        facing=se
        team_name=bandits
        user_team_name=_"Urza Fastik"
        gold={ON_DIFFICULTY 11 22 44}
        income={ON_DIFFICULTY -2 0 4}
        recruit=Walking Corpse # no variants or soulless; keep things simple for a new player to understand
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 1}
    {STARTING_VILLAGES 2 4}
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2 offensive 0.9 0.1}
        # don't vary by AI. Most humans are ZONE_GUARDIANs, and zombies are dumb.
        {RETREAT_WHEN_WEAK 2 {ON_DIFFICULTY 0-2 0-3 0-5} (
            {GOAL_LOCATION 99 x,y=23,15}
            {GOAL_LOCATION 88 x,y=22,13}
            {GOAL_LOCATION 77 x,y=22,15}
            {GOAL_LOCATION 11 x,y=23,16}
        )}
        {MODIFY_SIDE_AI 2 ([avoid]
            x,y,radius=6,4,9
        [/avoid])}
    [/event]
    
    #############################
    # ELVES
    #############################
    [side]
        side=3
        color=green
        controller=ai
        no_leader=yes
        hidden=yes
        team_name=good
        {FLAG_VARIANT wood-elvish}
        
        # She is already in the game if she is on the recall list, which allows
        # the victory event to work, if it is triggered using debug mode commands.
        [unit]
            type=Elvish Shyde
            id=Ethiliel
            name= _ "Ethiliel"
            unrenamable=yes
            profile=portraits/ethiliel.webp
            x,y=recall,recall
            random_traits=no
            [modifications]
                {TRAIT_LOYAL_HERO}
                {TRAIT_RESILIENT}
                {TEAM_COLOR_OVERRIDE () green}
            [/modifications]
        [/unit]
    [/side]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     PREPARE MAP
    #######################################################################################################################################################
#define NORTH_GUARD_LOCS
    # guards have issues with multiple x,y,radius, or maybe I'm doing something wrong
    x=16-24, 25-27,  28, 29, 30, 31
    y= 0-99,  0-13, 0-9,0-9,5-7,6-7
#enddef
    [event]
        name=prestart
        {SET_LABEL 6 4 _"Aethenwood Outpost"}
        
        #############################
        # BANDIT GUARDS
        #############################
        {GENERIC_UNITC 2 ({ON_DIFFICULTY Thug    Thug    Thug   })  25  6  ({ROLE guard}{ZONE_GUARDIAN 25  6 {NORTH_GUARD_LOCS}})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY Poacher Poacher Poacher})  28  8  ({ROLE guard}{ZONE_GUARDIAN 28  8 {NORTH_GUARD_LOCS}})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY none    Thug    Thug   })  27 12  ({ROLE guard}{ZONE_GUARDIAN 27 12 x,y,radius=22,9,6})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY none    Thug    Thug   })  26 16  ({ROLE guard}{ZONE_GUARDIAN 26 16 x,y,radius=22,16,5})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY none    none    Poacher})  30  6  ({ROLE guard}{ZONE_GUARDIAN 30  6 {NORTH_GUARD_LOCS}})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY none    none    Thug   })  20 16  ({ROLE guard}{ZONE_GUARDIAN 20 16 x,y,radius=22,9,6})}
#ifdef EASY
        {MODIFY_TERRAIN Hhd 27 12}
        {MODIFY_TERRAIN Hhd 26 16}
#endif
#ifndef HARD
        {MODIFY_TERRAIN Hhd^Qhh 30 6}
#endif
    [/event]

    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        #############################
        # DEORAN SETS UP
        #############################
        {DELAY 500}
        {RECALL_XY Deoran 46 8}
        {MOVE_UNIT id=Deoran 43 8}
        {DELAY 150}
        {MODIFY_TERRAIN Ke 43 8} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Ce 42 7} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Ce 42 8} [redraw][/redraw] {DELAY 150}
        {MODIFY_TERRAIN Ce 43 9} [redraw][/redraw] {DELAY 150}
        
        #############################
        # BANDIT SPEAKS
        #############################
        [message]
            speaker=Urza Fastik
            #po: lich Mebrin is probably the one who warned the Urza brothers
            message= _ "So, the South Guard dares set foot outside their derelict hovel of a city? The master warned that you might go looking for the elves!"
        [/message]
        [message]
            speaker=Urza Fastik
            message= _ "Fools. I am second of the Urza brothers, and since the death of my elder sibling I have been preparing to face you! Behold my new powers!"
        [/message]
        [object]
            {FILTER id="Urza Fastik"}
            [effect]
                apply_to=new_animation
                id=urza_fastik_black_magic
                [animation]
                    apply_to=black_magic
                    start_time=0
                    [frame]
                        image="units/human-outlaws/trapper-bow-attack1.png:150"
                    [/frame]
                    [frame]
                        image="units/human-outlaws/trapper-bow-defend.png"
                        halo=halo/undead/dark-magic-[1~6].png:50
                        halo_x,halo_y=0,0
                    [/frame]
                    [frame]
                        image="units/human-outlaws/trapper-bow-attack1.png:150"
                    [/frame]
                    sound_start_time=-40
                    [sound_frame]
                        sound=magic-dark.ogg
                    [/sound_frame]
                [/animation]
            [/effect]
        [/object]
        [animate_unit]
            {FILTER id="Urza Fastik"}
            flag=black_magic
        [/animate_unit]
        {GENERIC_UNIT 2 "Walking Corpse" 23 15} {ANIMATE}
        [animate_unit]
            {FILTER id="Urza Fastik"}
            flag=black_magic
        [/animate_unit]
        {GENERIC_UNIT 2 "Walking Corpse" 22 15} {ANIMATE}
#ifndef EASY
        [animate_unit]
            {FILTER id="Urza Fastik"}
            flag=black_magic
        [/animate_unit]
        {GENERIC_UNIT 2 "Walking Corpse" 22 13} {ANIMATE}
#endif
#ifdef HARD
        [animate_unit]
            {FILTER id="Urza Fastik"}
            flag=black_magic
        [/animate_unit]
        {GENERIC_UNIT 2 "Walking Corpse" 21 14} {ANIMATE}
#endif
        
        #############################
        # DEORAN STRATEGIZES
        #############################
        {RECALL_XY $companion_id 42 7}
        {SAY_COMPANION
            MESSAGE_MARI=_"More undead, just what we needed. I came here to get away from these things.{BR}{BR}Rookie, these primitive walking corpses can be deadly in numbers, but they’re also dumb and slow. Make sure to fight them during the day, and from superior terrain."
            MESSAGE_GERRICK=_"So the rumors’re true. Nasty, squishy things them corpses are, and deadly in a horde, but I hear they ’aint so bright.{BR}{BR}Sir, I say we fight ’em at day, and from superior terrain. Just don’t let anyone die to ’em, or they’ll stand right back up as undead!"
            MESSAGE_HYLAS=_"More zombies. Such corruption must not be allowed to spread.{BR}{BR}Deoran, these walking corpses are the most basic type of undead. Dumb and slow, but deadly in numbers. I advise you fight them during the day, and from superior terrain."
        }
        [message]
            speaker=Deoran
            message= _ "This outlaw appears stronger than the last one we faced, but we have become stronger too! If I have any veteran soldiers from the previous battle, I may wish to recall them so they can continue to gain experience and level up."
        [/message]
        [if] {VARIABLE_CONDITIONAL enable_tutorial_elements equals yes}
            [then]
                [message]
                    speaker,image=narrator,wesnoth-icon.png
                    {TUTOR: _"Press <b>Alt+R</b> to <i>recall</i> veteran soldiers from the previous scenario. Recalling a veteran only ever costs 20 gold, no matter how powerful (or weak) they are."}
                [/message]
                {SAY_COMPANION
                    MESSAGE_GERRICK=_"Deoran, recallin’ and levelin’-up soldiers is very important! By recalling veterans every scenario and buildin’ up their experience, over time you can create a very powerful army!{BR}{BR}And if you need to recruit new soldiers, you can always do so by pressing <b>Ctrl+R</b>. Don’ forget: <b>Ctrl+R</b> to recruit, <b>Alt+R</b> to recall."
                    MESSAGE_GENERIC=_"Deoran, recalling and leveling-up soldiers is very important. By recalling veterans every scenario and building up their experience, over time you can create a very powerful army.{BR}{BR}And if you need to recruit new soldiers, you can always do so by pressing <b>Ctrl+R</b>. Don’t forget: <b>Ctrl+R</b> to recruit, <b>Alt+R</b> to recall."
                }
            [/then]
        [/if]
        {SCROLL_TO 6 4}
        [message]
            speaker=Deoran
            message= _ "Still, violence alone won’t prevail here. My quest is to meet with the elves — even if I defeat the bandits first, I must still approach the elvish outpost in the western forest."
            scroll=no
        [/message]
        {HIGHLIGHT_IMAGE 6 4 items/gohere.png ()}
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            side=1
            [objective]
                description= _ "Move Deoran to the Aethenwood outpost"
                condition=win
            [/objective]
            {COMPANION_DEATH_OBJECTIVES}
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]
    
    
    #############################
    # ZOMBIE ATTACKS FASTIK
    #############################
    [event]
        name=turn 3
        [event]
            name=recruit
            {FILTER type="Walking Corpse"}
            [harm_unit]
                {FILTER id="Urza Fastik"}
                {FILTER_SECOND id=$unit.id}
                [primary_attack]
                    range=melee
                [/primary_attack]
                amount=0
                hits=no
                animate=yes
                delay=0
                experience=no
            [/harm_unit]
            [message]
                speaker=Urza Fastik
                message= _ "Hey! This corpse just tried to attack me! Imbecile; eat them, not me."
            [/message]
        [/event]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     S02 TIPS
    #######################################################################################################################################################
    #############################
    # TIP: TRAITS
    #############################
#define EXPLAIN_TRAITS TRAIT1 TRAIT2 MESSAGE
    [if] {HAVE_UNIT id,trait=$unit.id,{TRAIT1}}
            {HAVE_UNIT id,trait=$unit.id,{TRAIT2}}
        [then]
            [message]
                speaker=unit
                message= _"I may look just like any other $unit.type, but each of us is a little different! " + {MESSAGE}
            [/message]
            [display_tip]
                title=_"Traits"
                image=tutor/traits.png
                message=_"Most units have a random
combination of traits.

A unit’s traits are listed
in the right-side panel — 
mouse-over a trait to see 
what effects it has."
            [/display_tip]
        [/then]
    [/if]
#enddef
    [event]
        name=recruit,recall
        {FILTER side=1}
        [event]
            name=recruit,recall
            {FILTER side=1}
            {TUTORIAL_ENABLE_CONDITION}
            {EXPLAIN_TRAITS quick     intelligent _"I have the “quick” and “intelligent” traits, so I move faster and require less XP to level-up."}
            {EXPLAIN_TRAITS quick     strong      _"I have the “quick” and “strong” traits, so I move faster and deal bonus damage in melee."}
            {EXPLAIN_TRAITS quick     resilient   _"I have the “quick” and “resilient” traits, so I move faster and have extra hitpoints."}
            {EXPLAIN_TRAITS strong    intelligent _"I have the “strong” and “intelligent” traits, so I deal bonus damage in melee and require less XP to level-up."}
            {EXPLAIN_TRAITS strong    resilient   _"I have the “strong” and “resilient” traits, so I deal bonus damage in melee and have extra hitpoints."}
            {EXPLAIN_TRAITS resilient intelligent _"I have the “resilient” and “intelligent” traits, so I have extra hitpoints and require less XP to level-up."}
        [/event]
    [/event]
    
    
    #############################
    # TIP: OBJECTIVES
    #############################
    [event]
        name=side 1 turn end
        {TUTORIAL_ENABLE_CONDITION}
        [message]
            speaker=Deoran
            message= _ "If I ever forget what I need to do to win, I can always check my <i><b>Objectives</b></i> by clicking the <i><b>“Menu”</b></i> button in the top-left corner (or using the hotkey <i><b>Ctrl+J</b></i>). The objectives also show my early finish bonus and gold carryover, which allow me to gain and retain gold for future scenarios."
        [/message]
    [/event]
    
    
    #############################
    # TIP: ZOC
    #############################
    [event]
        name=enter hex
        {TUTORIAL_ENABLE_CONDITION}
        {FILTER( side=1 {FILTER_ADJACENT type="Walking Corpse"} )}
        [message]
            speaker=unit
            message= _ "Ha, this zombie is so slow and weak! Usually, moving next to an enemy unit consumes all my remaining movement. But this frail, level-0 Walking Corpse is easy to outmaneuver."
        [/message]
        [display_tip]
            title=_"Zone of Control"
            image=tutor/zoc.png
            message=_"The hexes immediately around a unit 
constitute its <i><b>Zone of Control</b></i>. 
When an enemy unit enters those hexes, 
they cannot move any further that turn.

Level 0 units, such as zombies, do not
have a Zone of Control.

To see which hexes enemies can move to
on their’ turn, press <b><i>Ctrl+V</i></b>."
        [/display_tip]
    [/event]
    
    
    #############################
    # TIP: COMPANION TOD
    #############################
    [event]
        name=turn 3
        {TUTORIAL_ENABLE_CONDITION}
        {SAY_COMPANION
            MESSAGE_GERRICK=_"Night’s comin’! Deoran, don’ forget that our units are <i>lawful</i>: their attacks are 25% stronger by day and 25% weaker at night. Them bandits and undead are <i>chaotic</i>: weaker during the day an’ stronger durin’ the night. I’ve seen many a lawful rookie try an’ fight chaotic enemies at night — it don’ end well."
            MESSAGE_GENERIC=_"Night is coming! Deoran, let me remind you that our units are <i>lawful</i>: their attacks are 25% stronger by day and 25% weaker at night. The bandits and undead are <i>chaotic</i>: weaker during the day and stronger during the night. I’ve seen many a lawful rookie try to fight chaotic enemies at night — it doesn’t end well."
        }
    [/event]
    [event]
        name=turn 6
        {TUTORIAL_ENABLE_CONDITION}
        {SAY_COMPANION
            MESSAGE_GERRICK=_"Sun’s back! Time to go on the attack."
            MESSAGE_GENERIC=_"The sun has returned! Time to go on the attack."
        }
    [/event]
    
    
    #############################
    # TIP: ZOMBIE TOD
    #############################
    [event]
        name=new turn
        first_time_only=no
        [store_time_of_day]
        [/store_time_of_day]
    [/event]
    
#define UNFAVORABLE_ZOMBIE_ATTACK
        attack end
        {FILTER side,trait=2,undead}
        [filter_second]
            formula=(self.hitpoints>1)# ignore attacks that ended with us killing the defender; those were favorable
        [/filter_second]
        {FILTER_CONDITION(          
                 {VARIABLE_CONDITIONAL time_of_day.id equals morning}
            {OR( {VARIABLE_CONDITIONAL time_of_day.id equals afternoon} )} )}
        {TUTORIAL_ENABLE_CONDITION}
#enddef
    [event]
        name={UNFAVORABLE_ZOMBIE_ATTACK}
        [event]
            name={UNFAVORABLE_ZOMBIE_ATTACK}
            [message]
                speaker=Urza Fastik
                message= _ "Idiot corpses, what are you doing? Don’t attack the South Guard during the day! You’re weakest in the light, while they’re strongest! ...how do I control these blasted things?"
            [/message]
        [/event]
    [/event]
#define FAVORABLE_ZOMBIE_ATTACK
        attack end
        {FILTER side,trait=2,undead}
        [filter_second]
            formula=(self.hitpoints>1)# ignore attacks that ended with us killing the defender; those were favorable
        [/filter_second]
        {FILTER_CONDITION(          
                 {VARIABLE_CONDITIONAL time_of_day.id equals first_watch}
            {OR( {VARIABLE_CONDITIONAL time_of_day.id equals second_watch} )} )}
        {TUTORIAL_ENABLE_CONDITION}
#enddef
    [event]
        name={FAVORABLE_ZOMBIE_ATTACK}
        [event]
            name={FAVORABLE_ZOMBIE_ATTACK}
            [message]
                speaker=Urza Fastik
                message= _ "Ah, excellent! The South Guard fights my undead at night, when we are strong and they are weak! I am fortunate that their commander is so inexperienced."
            [/message]
        [/event]
    [/event]
    
    
    #############################
    # TIP: WATER TERRAIN
    #############################
#define UNFAVORABLE_WATER_ATTACK
        attack end
        {FILTER( side=1 {FILTER_LOCATION terrain=W*^*} )}
        [filter_second]
            {FILTER_LOCATION terrain=Cer^*,H*^*}
            formula=(self.hitpoints>1) # ignore attacks that ended with us killing the defender; those were favorable
        [/filter_second]
        {TUTORIAL_ENABLE_CONDITION}
#enddef
    [event]
        name={UNFAVORABLE_WATER_ATTACK}
        [event]
            name={UNFAVORABLE_WATER_ATTACK}
            [message]
                speaker=Urza Fastik
                message= _ "Yes that’s right, you foolish South Guard commander! Fight in the water while my bandits are safe in their encampaments! Behind walls my bandits will dodge 60% of your attacks, while your soldiers in water can only dodge 20% of mine!"
            [/message]
            [if] {VARIABLE_CONDITIONAL time_of_day.id equals morning}
                 {VARIABLE_CONDITIONAL time_of_day.id equals afternoon}
                [then]
                    [message]
                        speaker=Urza Fastik
                        message= _ "If only it weren’t daytime, this would be the perfect fight for me."
                    [/message]
                [/then]
            [/if]
            [if] {VARIABLE_CONDITIONAL time_of_day.id equals first_watch}
                 {VARIABLE_CONDITIONAL time_of_day.id equals second_watch}
                [then]
                    [message]
                        speaker=Urza Fastik
                        message= _ "At in the middle of the night too! This young commander must truly be a fool."
                    [/message]
                [/then]
            [/if]
        [/event]
    [/event]
    
    
    #############################
    # TIP: LURE ENEMIES
    #############################
#define BANDIT_LURED_AWAY
        attack
        {FILTER( side,race=2,human {FILTER_LOCATION terrain=R*^*,G*^*,D*^*,W*^*} )}
        {TUTORIAL_ENABLE_CONDITION}
#enddef
    [event]
        name={BANDIT_LURED_AWAY}
        [event]
            name={BANDIT_LURED_AWAY}
            [message]
                speaker=Urza Fastik
                message= _ "What are you doing, you incompetent bandit! Stand on encampaments and hills, not dirt and water! You’re making us look like fools in front of the South Guard!"
            [/message]
        [/event]
    [/event]
    
    
    #############################
    # DEORAN GOES AROUND
    #############################
    [event]
        name=moveto
        {FILTER_CONDITION( {HAVE_UNIT( id=Deoran {FILTER_LOCATION x,y,radius=27,1,5} )} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL turn_number less_than 7)} )} # if the turn is too late, you're probably fighting normally, not flanking
        [message]
            speaker=Urza Fastik
            message= _ "That’s not fair! I spent ages fortifying the road, you can’t just go around!"
        [/message]
    [/event]
    
    
    #############################
    # APPROACHING ELVES
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=6,4,9} )}
        [event]
            name=new turn
            [message]
                speaker=Deoran
                message= _ "From what you tell me, $companion_name, no man has set foot in these elven woods for many a year. These elves have never been friendly toward humankind, and have grown colder still after the magistrate spurned them. Who knows how they might react when we approach."
            [/message]
        [/event]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                 VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # TIME LOW
    #############################
    [event]
        name=turn {TURN_WARNING} end
        [message]
            speaker=Deoran
            message= _ "I had better hurry and reach the elven outpost! If we wish to counsel with the elves, we will be ill-served by fighting a lengthy battle right on their doorstep."
        [/message]
        [fire_event]
            name=explain_turn_limit
        [/fire_event]
    [/event]
    
    #############################
    # TIME OVER
    #############################
    [event]
        name=side 1 turn {TURN_LIMIT} end
        [unit]
            side=3
            type=Elvish Marshal
            id=Ithelden
            name= _ "Ithelden"
            profile=portraits/ithelden.webp
            x,y=6,4
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]
        [message]
            speaker=Ithelden
            message= _ "What is the meaning of this? Men and undead, fighting on our doorstep?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Elves! My pardon, I mean no offense by this warfare! I come seeking your wisdom!"
        [/message]
        [message]
            speaker=Ithelden
            message= _ "If you come seeking wisdom, you should have sought us quickly, not dallied on our doorstep these long days and nights! I will not counsel with any of those responsible for bringing blood to our home. Begone with you!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    
    #############################
    # TRAPPER DIES
    #############################
    [event]
        name=last breath
        {FILTER id="Urza Fastik"}
        {ACHIEVE s02}
        [message]
            speaker=unit
            message= _ "Even with the power of darkness... at my command... I..."
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"Hey wait! How did you learn to raise the dead? I need to ask you some—"
            MESSAGE_GERRICK=_"Drop the dagger, Fastik! Where did you and yer brothers learn to raise the dead? Dark magic is dangerous stuff! We’ll be stoppin’ you before anyone else becomes corrupted."
            MESSAGE_HYLAS=_"Pitiable thing, I already sense the corruption taking hold inside you. Not even my light can save you now. How did you and your brothers learn to summon undead?"
        }
    [/event]
    [event]
        name=die
        {FILTER id="Urza Fastik"}
        {SAY_COMPANION MESSAGE_MARI=_"—questions. Or you can die instantly, that works too. You died even faster than your baldy brother."}
        [message]
            speaker=Deoran
            message= _ "No last gasp spells this time, but no information either. Perhaps the elves hold the answers we seek. We must still seek them out."
        [/message]
        [set_achievement]
            content_for=The_South_Guard_Revised
            id=tsg_s02
        [/set_achievement]
        [show_objectives]
        [/show_objectives]
        {VARIABLE fastik_dead yes}
    [/event]
    
    #############################
    # NOT-DEORAN REACHES THE ELVES
    #############################
    [event]
        name=moveto
        {FILTER( x,y,radius=6,4,5 {NOT id=Deoran} )}
        [message]
            speaker=Deoran
            message= _ "Remember, I should be the one to meet with the elves, personally. We must be careful to speak diplomatically."
        [/message] # needs to be Deoran so he can participate in the cutscene, but also so the player gets the idea that they can move and use their leader, not just leave them on the keep
    [/event]
    
    #############################
    # DEORAN REACHES THE ELVES
    #############################
    [event]
        name=moveto
        {FILTER id,x,y=Deoran,6,4}
        
        #------------------------
        # FASTIK DIES
        #------------------------
        [if] {HAVE_UNIT id="Urza Fastik"}
            [then]
                [message]
                    speaker=Urza Fastik
                    message= _ "Uh oh, time to get out of here and go into hiding! If that commander speaks with the elves, they’re sure to hunt me down!"
                [/message]
                {MOVE_UNIT id="Urza Fastik" 20 17}
                {KILL id="Urza Fastik"}
            [/then]
            [else]
                [message]
                    speaker=Deoran
                    message= _ "This is the place, but it looks abandoned. Hello? Is anyone there?"
                [/message]
            [/else]
        [/if]
        
        #------------------------
        # ELVES APPEAR
        #------------------------
        {REMOVE_IMAGE 6 4}
        {FADE_MUSIC_OUT 1000}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        {FADE_MUSIC_IN 100}
        
        {RECALL_XY Ethiliel 2 4}
        {NAMED_UNIT 3 (Elvish Sharpshooter) 8 7 Mithalwe  _"Mithalwe" ()} {ANIMATE} {GENDER female}
        {NAMED_UNIT 3 (Elvish Sorceress   ) 9 3 Vaenuith  _"Vaenuith" ()} {ANIMATE}
        {NAMED_UNIT 3 (Elvish Champion    ) 4 1 Talchar   _"Talchar"  ()} {ANIMATE}
        {NAMED_UNIT 3 (Elvish Marshal     ) 4 7 Ithelden  _"Ithelden" ()} {ANIMATE}
        [+unit]
            profile=portraits/ithelden.webp
            [modifications] {TRAIT_LOYAL_HERO} [/modifications]
        [/unit]
        
        #------------------------
        # SPEAKING OVER DEORAN
        #------------------------
        [message]
            speaker=Talchar
            message= _ "Halt! Who enters our sacred grove without leave?"
        [/message]
        [message]
            speaker=Talchar
            message= _ "Choose your words wisely, bandit. Speak, knowing that the penalty for trespassing on our lands is death."
        [/message]
        [message]
            speaker=Deoran
            message= _ "I—"
        [/message]
        [message]
            speaker=Ethiliel
            # wmllint: local spelling Elrath
            message= _ "This is no bandit, for these humans bear the banner of the South Guard, not those rags of the Urzas. Though it remains to be seen whether this proves an improvement — why do you enter the hallowed grove of Elrath?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "To—"
        [/message]
        [message]
            speaker=Mithalwe
            message= _ "Black magic, no doubt. You want our help. Yet we already sent you a messenger regarding the undead, did we not?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "We—"
        [/message]
        [message]
            speaker=Ithelden
            message= _ "Despite being forewarned, you mayflies have failed to respond adequately yet again. Why should we treat with you now, if you spurn our wisdom thusly?"
        [/message]
        
        #------------------------
        # ASKING ABOUT THE UNDEAD
        #------------------------
        {DELAY 500}
        [message]
            speaker,image=Deoran,portraits/deoran-mad.webp
            message= _ "—but, but, I have scarcely been here a month! I could not have acted on something that happened before our arrival. And besides, that is the fault of the magistrat—"
        [/message]
        [message]
            speaker,image=Deoran,misc/blank-hex.png
            message= _ "(deep breath)"
        [/message]
        {REPLACE_SCENARIO_MUSIC elvish-theme.ogg}
        [message]
            speaker=Deoran
            message= _ "...honorable elves, I am commander Deoran, of Westin’s South Guard. I do not know all the actions of my peers, only that I would be grateful for your aid and that we mean to not repeat any mistakes that may have been made in the past."
        [/message]
        [message]
            speaker=Deoran
            message= _ "For in the present, our farms and villages are plundered by criminals, casting dark spells and defiling the dead. Whence did they learn their grim power? How do we find the source of this spreading corruption, so that we may destroy it?"
        [/message]
        [message]
            speaker=Vaenuith
            message= _ "A fanciful delusion! A human untrained in the mystic arts is much more likely to be corrupted by such a force than to have the knowledge or ability to banish it."
        [/message]
        [message]
            speaker,image=Deoran,portraits/deoran-mad.webp
            message= _ "Unlike those reproachable bandits, we would never be corrupted by such evil! No matter what, we have to try."
        [/message]
        [message]
            speaker=Vaenuith
            message= _ "I have known many a human to utter these words, only to be swallowed by the allure of a power they could not possibly hope to understand."
        [/message]
        [message]
            speaker=Mithalwe
            message= _ "Let us not forget that it is you humans who first brought this perverse sorcery to our great continent, when you arrived here centuries ago. No matter what words you may say, the past has shown that your race cannot be trusted with black magic."
        [/message]
        {SAY_COMPANION
            MESSAGE_MARI=_"<i>(to Deoran) Helpful, aren’t they? Listening to elves argue is only marginally better than wedding prep back with Fiore.</i>"
            MESSAGE_GERRICK=_"<i>(to Deoran) Seems simple enough to me. We got an undead problem. We got orders from Fiore. I intend to find a solution, with or without the elves.</i>"
            MESSAGE_HYLAS=_"<i>(to Deoran) This is a concerning development. Dark magic spreads; it corrupts. Yet it also divides, as we see here.</i>"
        }
        [message]
            speaker=Deoran
            message= _ "<i>(to $companion_name) I’ve heard elves can be xenophobic, but surely this is going too far. If we cannot stand together, we will surely fall alone.</i>"
        [/message]
        [message]
            speaker=Ithelden
            message= _ "Enough, all of you. Among us Ethiliel has had the most dealings with the men of Wesnoth — she will be the best judge of what aid we would grant the humans against these abominations."
        [/message]
        {DELAY 500}
        
        #------------------------
        # ETHILIEL DECIDES
        #------------------------
        [message]
            speaker=Ethiliel
            message= _ "My answer will depend on your motives, human. What would you do, knowing such unholy secrets?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "I should seek out the source of these beings of darkness and destroy it!"
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "So you claim."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "...I will help you. I only hope that you will remain true to your word."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "Now listen well, human. Knowledge of the kind you seek is not something that most of my kind wish to remember. There is but one elf who still studies the dark secrets that we first learned when your foul lich-lord came to our land."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "His name is Mebrin, and he was once my teacher. Now, he lives secluded some distance south of our Aethenwood, on a tranquil lake within a hidden valley, meditating in search of peace and enlightenment."
        [/message]
#         [message]
#             speaker=Deoran # foreshadow the black forest
#             message= _ "To the south — he surely does not reside amidst the Black Forest? I am new to this province, yet even I have heard the foul tales of corruption and darkness infesting those evil trees."
#         [/message]
#         [message]
#             speaker=Ethiliel
#             message= _ "Do not presume, man of Wesnoth! Neither him nor I have ever set foot within the borders of that profane place. He resides in the Vale of Blossoming Trees, on a tranquil lake within a hidden valley."
#         [/message]
        [message]
            speaker=Ithelden
            message= _ "Are you sure about this? The road south is no longer as safe as it once was, and Mebrin is no warrior. You would not presume to put one of our great sages in danger, Ethiliel."
        [/message]
        [message]
            speaker=Ethiliel
            message= _ "<i>I</i> will personally accompany the humans to Mebrin, and he can decide whether or not he wants to help us. I will not ask you to place yourselves in danger for these humans, but you will not presume to tell me — nor Mebrin — what to do. Is that fair?"
        [/message]
        [message]
            speaker=Ithelden
            message= _ "Yes, very well."
        [/message]
        [message]
            speaker=Deoran
            image=portraits/deoran-glad.webp
            message= _ "We welcome your aid, lady Ethiliel."
        [/message]
        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
    
    [event]
        name=victory

        [store_unit]
            {FILTER id=Ethiliel}
            variable=EthilielV
            kill=no # Current Ethiliel may remain on the field for visual reasons.
        [/store_unit]
        # Stores a copy of Ethiel onto the recall list. The recall list cannot be
        # viewed in linger mode. Give here as well the loyal trait.
        {VARIABLE EthilielV.side 1}
        {VARIABLE EthilielV.x recall}
        {VARIABLE EthilielV.y recall}
        {CLEAR_VARIABLE EthilielV.modifications}
        
        [set_variables]
            name=EthilielV.modifications
            mode=insert
            [value]
                {TRAIT_LOYAL_HERO}
                {TRAIT_RESILIENT}
                {TEAM_COLOR_OVERRIDE () green}
            [/value]
        [/set_variables]
        {CLEAR_VARIABLE EthilielV.upkeep}
        
        [unstore_unit]
            variable=EthilielV
        [/unstore_unit]
        {CLEAR_VARIABLE EthilielV}
    [/event]
[/scenario]

#undef TURN_LIMIT
#undef TURN_WARNING
#undef NORTH_GUARD_LOCS
